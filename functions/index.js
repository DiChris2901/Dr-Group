const { onCall, onRequest, HttpsError } = require('firebase-functions/v2/https');
const { onSchedule } = require('firebase-functions/v2/scheduler');
const { initializeApp } = require('firebase-admin/app');
const { getAuth } = require('firebase-admin/auth');
const { getFirestore } = require('firebase-admin/firestore');
const { getStorage } = require('firebase-admin/storage');

// Inicializar Firebase Admin
initializeApp();

// Importar funciones de notificaciones (Email + Telegram)
// TODO: Implementar nuevas funciones de notificaciones

/**
 * Cloud Function para eliminar usuario completo (Auth + Firestore)
 * Solo disponible para administradores
 */
exports.deleteUserComplete = onCall(async (request) => {
  const { auth, data } = request;

  // Verificar autenticaci√≥n
  if (!auth) {
    throw new HttpsError('unauthenticated', 'Usuario no autenticado');
  }

  const { userEmail, userId } = data;

  if (!userEmail || !userId) {
    throw new HttpsError('invalid-argument', 'Email y ID de usuario requeridos');
  }

  try {
    const db = getFirestore();
    const adminAuth = getAuth();

    // 1. Verificar que el usuario que llama es administrador
    const callerDoc = await db.collection('users')
      .where('authUid', '==', auth.uid)
      .limit(1)
      .get();

    if (callerDoc.empty) {
      throw new HttpsError('permission-denied', 'Usuario no encontrado en sistema');
    }

    const callerData = callerDoc.docs[0].data();
    if (callerData.role !== 'ADMIN') {
      throw new HttpsError('permission-denied', 'Solo administradores pueden eliminar usuarios');
    }

    // 2. Obtener datos del usuario a eliminar
    const userDoc = await db.collection('users').doc(userId).get();
    
    if (!userDoc.exists) {
      throw new HttpsError('not-found', 'Usuario no encontrado');
    }

    const userData = userDoc.data();

    // 3. Verificar que no es el √∫ltimo admin
    if (userData.role === 'ADMIN') {
      const adminQuery = await db.collection('users')
        .where('role', '==', 'ADMIN')
        .where('isActive', '!=', false)
        .get();
      
      if (adminQuery.size <= 1) {
        throw new HttpsError('failed-precondition', 'No puedes eliminar el √∫ltimo administrador');
      }
    }

    // 4. Prevenir auto-eliminaci√≥n
    if (userData.email === callerData.email) {
      throw new HttpsError('failed-precondition', 'No puedes eliminar tu propio usuario');
    }

    // 5. Eliminar de Firebase Auth si tiene authUid
    let deletedFromAuth = false;
    if (userData.authUid) {
      try {
        await adminAuth.deleteUser(userData.authUid);
        deletedFromAuth = true;
        console.log('‚úÖ Usuario eliminado de Firebase Auth:', userData.authUid);
      } catch (authError) {
        console.warn('‚ö†Ô∏è Error eliminando de Auth:', authError.code, authError.message);
        // Si no existe en Auth, no es error cr√≠tico
        if (authError.code === 'auth/user-not-found') {
          deletedFromAuth = true; // Ya no existe, considerarlo como eliminado
        }
      }
    } else {
      // Si no tiene authUid, buscar por email en Auth
      try {
        const userRecord = await adminAuth.getUserByEmail(userData.email);
        await adminAuth.deleteUser(userRecord.uid);
        deletedFromAuth = true;
        console.log('‚úÖ Usuario eliminado de Firebase Auth (por email):', userRecord.uid);
      } catch (authError) {
        console.warn('‚ö†Ô∏è Usuario no encontrado en Auth o error:', authError.code, authError.message);
        if (authError.code === 'auth/user-not-found') {
          deletedFromAuth = true; // Ya no existe en Auth
        }
      }
    }

    // 6. Eliminar de Firestore
    await db.collection('users').doc(userId).delete();
    console.log('‚úÖ Usuario eliminado de Firestore:', userId);

    // 7. Log de auditor√≠a
    await db.collection('audit_logs').add({
      action: 'DELETE_USER',
      targetUser: userData.email,
      performedBy: callerData.email,
      performedByUid: auth.uid,
      timestamp: new Date(),
      details: {
        deletedUser: {
          email: userData.email,
          role: userData.role,
          displayName: userData.displayName
        }
      }
    });

    return {
      success: true,
      message: `Usuario ${userData.email} eliminado completamente`,
      deletedFromAuth: deletedFromAuth,
      deletedFromFirestore: true
    };

  } catch (error) {
    console.error('‚ùå Error en deleteUserComplete:', error);
    console.error('Error details:', {
      code: error.code,
      message: error.message,
      stack: error.stack
    });
    
    if (error instanceof HttpsError) {
      throw error;
    }
    
    // Proporcionar m√°s detalles del error
    let errorMessage = 'Error interno desconocido';
    if (error.message) {
      errorMessage = error.message;
    }
    
    throw new HttpsError('internal', `Error interno: ${errorMessage}`);
  }
});

/**
 * HTTP proxy para descargar archivos de Storage evitando CORS en el cliente.
 * Uso: GET /storageProxy?path=<ruta en el bucket>
 */
exports.storageProxy = onRequest(async (req, res) => {
  // Permitir CORS b√°sico
  res.set('Access-Control-Allow-Origin', '*');
  res.set('Access-Control-Allow-Methods', 'GET, OPTIONS');
  res.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');

  if (req.method === 'OPTIONS') {
    return res.status(204).send('');
  }

  try {
    const path = req.query.path;
    if (!path || typeof path !== 'string') {
      return res.status(400).json({ error: 'Missing required query param: path' });
    }

    const bucket = getStorage().bucket();
    const file = bucket.file(path);
    const [exists] = await file.exists();
    if (!exists) {
      return res.status(404).json({ error: 'File not found' });
    }

    const [metadata] = await file.getMetadata();
    res.setHeader('Content-Type', metadata.contentType || 'application/octet-stream');
    res.setHeader('Cache-Control', 'private, max-age=0, no-cache');

    file.createReadStream()
      .on('error', (err) => {
        console.error('storageProxy stream error:', err);
        res.status(500).json({ error: 'Stream error', details: err.message });
      })
      .pipe(res);
  } catch (err) {
    console.error('storageProxy error:', err);
    res.status(500).json({ error: 'Internal error', details: err.message });
  }
});

/**
 * Helper: Enviar mensaje de Telegram
 */
const sendTelegramMessage = async (chatId, text, options = {}) => {
  const BOT_TOKEN = process.env.VITE_TELEGRAM_BOT_TOKEN || 
                    process.env.TELEGRAM_BOT_TOKEN ||
                    '8430298503:AAEVPOGrIp5_UdUNGXSy3AD9rI8mS2OKipQ';
  
  const payload = {
    chat_id: chatId,
    text: text,
    parse_mode: 'HTML',
    disable_notification: options.silent || false,
    ...options
  };

  const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  return await response.json();
};

/**
 * Helper: Obtener resumen del dashboard
 */
const getDashboardSummary = async (userId = null) => {
  const db = getFirestore();
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // Obtener compromisos
  let commitmentsQuery = db.collection('commitments');
  const commitmentsSnapshot = await commitmentsQuery.get();
  
  const commitments = commitmentsSnapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));

  // Filtrar compromisos por estado
  const overdue = commitments.filter(c => {
    const dueDate = c.dueDate?.toDate ? c.dueDate.toDate() : new Date(c.dueDate);
    return dueDate < today && c.status !== 'paid';
  });

  const dueToday = commitments.filter(c => {
    const dueDate = c.dueDate?.toDate ? c.dueDate.toDate() : new Date(c.dueDate);
    const dueDateOnly = new Date(dueDate);
    dueDateOnly.setHours(0, 0, 0, 0);
    return dueDateOnly.getTime() === today.getTime() && c.status !== 'paid';
  });

  const next7Days = commitments.filter(c => {
    const dueDate = c.dueDate?.toDate ? c.dueDate.toDate() : new Date(c.dueDate);
    const diff = (dueDate - today) / (1000 * 60 * 60 * 24);
    return diff > 0 && diff <= 7 && c.status !== 'paid';
  });

  const pending = commitments.filter(c => c.status === 'pending' || c.status === 'overdue');
  
  // Calcular totales
  const totalPending = pending.reduce((sum, c) => sum + (c.amount || 0), 0);
  const totalOverdue = overdue.reduce((sum, c) => sum + (c.amount || 0), 0);

  return {
    totalCommitments: commitments.length,
    overdue: overdue.length,
    overdueAmount: totalOverdue,
    dueToday: dueToday.length,
    next7Days: next7Days.length,
    pendingCount: pending.length,
    totalPending: totalPending
  };
};

/**
 * Webhook para Telegram Bot (Mejorado con comandos)
 */
exports.telegramWebhook = onRequest(async (req, res) => {
  // Solo aceptar POST requests
  if (req.method !== 'POST') {
    return res.status(200).send('OK');
  }

  try {
    const update = req.body;
    
    // Verificar si hay un mensaje
    if (!update.message) {
      return res.status(200).send('OK');
    }

    const message = update.message;
    const chatId = message.chat.id;
    const text = message.text;
    const firstName = message.from.first_name || 'Usuario';
    const username = message.from.username || '';

    const BOT_TOKEN = process.env.VITE_TELEGRAM_BOT_TOKEN || 
                      process.env.TELEGRAM_BOT_TOKEN ||
                      '8430298503:AAEVPOGrIp5_UdUNGXSy3AD9rI8mS2OKipQ';

    if (!BOT_TOKEN) {
      console.error('‚ùå TELEGRAM_BOT_TOKEN no configurado');
      return res.status(200).send('OK');
    }

    // Comando /start
    if (text && text.toLowerCase() === '/start') {
      const responseMessage = 
        `üéâ ¬°Hola ${firstName}! üëã\n\n` +
        `Tu bot de DR Group est√° listo para enviarte notificaciones.\n\n` +
        `üì± <b>Tu Chat ID es:</b> <code>${chatId}</code>\n\n` +
        `‚úÖ Copia este n√∫mero y p√©galo en la configuraci√≥n de notificaciones del dashboard.\n\n` +
        `üí° <b>Instrucciones:</b>\n` +
        `1. Ve a la p√°gina de Usuarios en el dashboard\n` +
        `2. Haz clic en el bot√≥n de configuraci√≥n (‚öôÔ∏è)\n` +
        `3. Activa Telegram\n` +
        `4. Pega tu Chat ID: <code>${chatId}</code>\n` +
        `5. Guarda y prueba la notificaci√≥n\n\n` +
        `üìã <b>Comandos disponibles:</b>\n` +
        `/help - Ver todos los comandos\n` +
        `/dashboard - Resumen del dashboard\n` +
        `/compromisos - Ver compromisos pr√≥ximos\n` +
        `/pagos - Resumen de pagos pendientes\n\n` +
        `ü§ñ <i>DR Group Bot</i>`;

      await sendTelegramMessage(chatId, responseMessage);
      console.log(`‚úÖ /start - ${firstName} (${username}) - Chat ID: ${chatId}`);
    }
    
    // Comando /help
    else if (text && text.toLowerCase() === '/help') {
      const helpMessage = 
        `üìö <b>Ayuda - DR Group Bot</b>\n\n` +
        `<b>Comandos Disponibles:</b>\n\n` +
        `üè† /dashboard - Resumen general del sistema\n` +
        `üìÖ /compromisos - Ver compromisos pr√≥ximos a vencer\n` +
        `üí∞ /pagos - Resumen de pagos pendientes\n` +
        `üìä /reporte - Solicitar reporte del d√≠a\n` +
        `‚ùì /help - Mostrar esta ayuda\n\n` +
        `<b>Notificaciones Autom√°ticas:</b>\n` +
        `‚Ä¢ Reporte diario a las 8:00 AM\n` +
        `‚Ä¢ Alertas de compromisos vencidos\n` +
        `‚Ä¢ Notificaciones de pagos registrados\n` +
        `‚Ä¢ Eventos del calendario\n\n` +
        `üí° <b>Configuraci√≥n:</b>\n` +
        `Administra tus notificaciones desde el dashboard en la secci√≥n de Usuarios.\n\n` +
        `üîó <b>Dashboard:</b> https://dr-group-cd21b.web.app`;

      await sendTelegramMessage(chatId, helpMessage);
      console.log(`‚úÖ /help - ${firstName}`);
    }
    
    // Comando /dashboard
    else if (text && text.toLowerCase() === '/dashboard') {
      try {
        const summary = await getDashboardSummary();
        const dashboardMessage = 
          `üìä <b>Resumen del Dashboard</b>\n\n` +
          `üìÖ <b>Compromisos:</b>\n` +
          `‚Ä¢ Total: ${summary.totalCommitments}\n` +
          `‚Ä¢ Pendientes: ${summary.pendingCount}\n` +
          `‚Ä¢ Vencidos: ${summary.overdue} ‚ö†Ô∏è\n` +
          `‚Ä¢ Vencen hoy: ${summary.dueToday}\n` +
          `‚Ä¢ Pr√≥ximos 7 d√≠as: ${summary.next7Days}\n\n` +
          `üí∞ <b>Montos:</b>\n` +
          `‚Ä¢ Total pendiente: $${summary.totalPending.toLocaleString('es-CO')}\n` +
          `‚Ä¢ Vencido: $${summary.overdueAmount.toLocaleString('es-CO')} ${summary.overdueAmount > 0 ? '‚ö†Ô∏è' : '‚úÖ'}\n\n` +
          `üïê Actualizado: ${new Date().toLocaleString('es-CO')}\n\n` +
          `üîó <a href="https://dr-group-cd21b.web.app">Abrir Dashboard</a>`;

        await sendTelegramMessage(chatId, dashboardMessage);
        console.log(`‚úÖ /dashboard - ${firstName}`);
      } catch (error) {
        console.error('Error en /dashboard:', error);
        await sendTelegramMessage(chatId, '‚ùå Error al obtener resumen. Intenta nuevamente.');
      }
    }
    
    // Comando /compromisos
    else if (text && text.toLowerCase() === '/compromisos') {
      try {
        const db = getFirestore();
        const today = new Date();
        const next7Days = new Date(today);
        next7Days.setDate(today.getDate() + 7);

        const snapshot = await db.collection('commitments')
          .where('status', 'in', ['pending', 'overdue'])
          .orderBy('dueDate', 'asc')
          .limit(10)
          .get();

        if (snapshot.empty) {
          await sendTelegramMessage(chatId, '‚úÖ No hay compromisos pendientes pr√≥ximos.');
          return res.status(200).send('OK');
        }

        let message = `üìÖ <b>Compromisos Pr√≥ximos</b>\n\n`;
        
        snapshot.docs.forEach((doc, index) => {
          const data = doc.data();
          const dueDate = data.dueDate?.toDate ? data.dueDate.toDate() : new Date(data.dueDate);
          const isOverdue = dueDate < today;
          const icon = isOverdue ? 'üî¥' : 'üü°';
          
          message += `${icon} <b>${data.concept || 'Sin concepto'}</b>\n`;
          message += `   üí∞ $${(data.amount || 0).toLocaleString('es-CO')}\n`;
          message += `   üìÖ Vence: ${dueDate.toLocaleDateString('es-CO')}\n`;
          if (data.companyName) message += `   üè¢ ${data.companyName}\n`;
          message += `\n`;
        });

        message += `\nüîó <a href="https://dr-group-cd21b.web.app/commitments">Ver todos</a>`;

        await sendTelegramMessage(chatId, message);
        console.log(`‚úÖ /compromisos - ${firstName}`);
      } catch (error) {
        console.error('Error en /compromisos:', error);
        await sendTelegramMessage(chatId, '‚ùå Error al obtener compromisos.');
      }
    }
    
    // Comando /pagos
    else if (text && text.toLowerCase() === '/pagos') {
      try {
        const summary = await getDashboardSummary();
        const pagosMessage = 
          `üí∞ <b>Resumen de Pagos</b>\n\n` +
          `üìä <b>Estad√≠sticas:</b>\n` +
          `‚Ä¢ Compromisos pendientes: ${summary.pendingCount}\n` +
          `‚Ä¢ Total a pagar: $${summary.totalPending.toLocaleString('es-CO')}\n` +
          `‚Ä¢ Vencidos: ${summary.overdue} compromisos\n` +
          `‚Ä¢ Monto vencido: $${summary.overdueAmount.toLocaleString('es-CO')}\n\n` +
          `‚ö†Ô∏è <b>Urgente:</b>\n` +
          `‚Ä¢ Vencen hoy: ${summary.dueToday}\n` +
          `‚Ä¢ Pr√≥ximos 7 d√≠as: ${summary.next7Days}\n\n` +
          `üîó <a href="https://dr-group-cd21b.web.app/payments">Registrar pago</a>`;

        await sendTelegramMessage(chatId, pagosMessage);
        console.log(`‚úÖ /pagos - ${firstName}`);
      } catch (error) {
        console.error('Error en /pagos:', error);
        await sendTelegramMessage(chatId, '‚ùå Error al obtener informaci√≥n de pagos.');
      }
    }
    
    // Comando /reporte
    else if (text && text.toLowerCase() === '/reporte') {
      try {
        const summary = await getDashboardSummary();
        const now = new Date();
        const reporteMessage = 
          `üìä <b>Reporte Diario - DR Group</b>\n` +
          `üìÖ ${now.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n\n` +
          `<b>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</b>\n\n` +
          `üìã <b>Compromisos:</b>\n` +
          `‚Ä¢ Total activos: ${summary.totalCommitments}\n` +
          `‚Ä¢ Pendientes: ${summary.pendingCount}\n` +
          `‚Ä¢ üî¥ Vencidos: ${summary.overdue}\n` +
          `‚Ä¢ ‚ö†Ô∏è Vencen hoy: ${summary.dueToday}\n` +
          `‚Ä¢ üü° Pr√≥ximos 7 d√≠as: ${summary.next7Days}\n\n` +
          `üí∞ <b>Situaci√≥n Financiera:</b>\n` +
          `‚Ä¢ Total pendiente: $${summary.totalPending.toLocaleString('es-CO')}\n` +
          `‚Ä¢ Monto vencido: $${summary.overdueAmount.toLocaleString('es-CO')}\n\n` +
          `${summary.overdue > 0 ? '‚ö†Ô∏è <b>ATENCI√ìN:</b> Hay compromisos vencidos que requieren acci√≥n inmediata.\n\n' : ''}` +
          `<b>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</b>\n\n` +
          `üïê Generado: ${now.toLocaleTimeString('es-CO')}\n` +
          `üîó <a href="https://dr-group-cd21b.web.app">Abrir Dashboard</a>`;

        await sendTelegramMessage(chatId, reporteMessage);
        console.log(`‚úÖ /reporte - ${firstName}`);
      } catch (error) {
        console.error('Error en /reporte:', error);
        await sendTelegramMessage(chatId, '‚ùå Error al generar reporte.');
      }
    }
    
    // Comando no reconocido
    else if (text && text.startsWith('/')) {
      const unknownMessage = 
        `‚ùì Comando no reconocido: <code>${text}</code>\n\n` +
        `Usa /help para ver los comandos disponibles.`;
      await sendTelegramMessage(chatId, unknownMessage);
    }

    return res.status(200).send('OK');
  } catch (error) {
    console.error('‚ùå Error en webhook:', error);
    return res.status(200).send('OK'); // Siempre retornar 200 para Telegram
  }
});

/**
 * Reporte Autom√°tico Diario (8:00 AM Colombia)
 * Enviado a todos los usuarios con Telegram habilitado
 */
exports.dailyTelegramReport = onSchedule({
  schedule: '0 8 * * *',
  timeZone: 'America/Bogota',
  memory: '256MiB'
}, async (event) => {
  console.log('ü§ñ Iniciando reporte diario autom√°tico...');
  
  try {
    const db = getFirestore();
    
    // Obtener todos los usuarios con Telegram habilitado
    const usersSnapshot = await db.collection('users').get();
    const summary = await getDashboardSummary();
    
    const now = new Date();
    const greeting = now.getHours() < 12 ? '‚òÄÔ∏è Buenos d√≠as' : 'üå§Ô∏è Buenas tardes';
    
    let sentCount = 0;
    let errorCount = 0;
    
    for (const userDoc of usersSnapshot.docs) {
      const userData = userDoc.data();
      const settings = userData.notificationSettings;
      
      // Verificar si tiene Telegram habilitado y Chat ID configurado
      if (!settings || !settings.telegramEnabled || !settings.telegramChatId) {
        continue;
      }
      
      const userName = userData.displayName || userData.name || 'Usuario';
      
      const reportMessage = 
        `${greeting} <b>${userName}</b> üëã\n\n` +
        `üìä <b>Reporte Diario - DR Group</b>\n` +
        `üìÖ ${now.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n\n` +
        `<b>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</b>\n\n` +
        `üìã <b>Compromisos:</b>\n` +
        `‚Ä¢ Total activos: ${summary.totalCommitments}\n` +
        `‚Ä¢ Pendientes: ${summary.pendingCount}\n` +
        `‚Ä¢ üî¥ Vencidos: ${summary.overdue}\n` +
        `‚Ä¢ ‚ö†Ô∏è Vencen hoy: ${summary.dueToday}\n` +
        `‚Ä¢ üü° Pr√≥ximos 7 d√≠as: ${summary.next7Days}\n\n` +
        `üí∞ <b>Situaci√≥n Financiera:</b>\n` +
        `‚Ä¢ Total pendiente: $${summary.totalPending.toLocaleString('es-CO')}\n` +
        `‚Ä¢ Monto vencido: $${summary.overdueAmount.toLocaleString('es-CO')}\n\n` +
        `${summary.overdue > 0 ? '‚ö†Ô∏è <b>ATENCI√ìN:</b> Hay compromisos vencidos que requieren acci√≥n inmediata.\n\n' : ''}` +
        `${summary.dueToday > 0 ? 'üìå <b>RECORDATORIO:</b> Hay compromisos que vencen hoy.\n\n' : ''}` +
        `<b>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</b>\n\n` +
        `üí° Usa /help para ver comandos disponibles\n` +
        `üîó <a href="https://dr-group-cd21b.web.app">Abrir Dashboard</a>`;
      
      try {
        await sendTelegramMessage(settings.telegramChatId, reportMessage);
        sentCount++;
        console.log(`‚úÖ Reporte enviado a ${userName} (${settings.telegramChatId})`);
      } catch (error) {
        errorCount++;
        console.error(`‚ùå Error enviando a ${userName}:`, error);
      }
    }
    
    console.log(`‚úÖ Reporte diario completado: ${sentCount} enviados, ${errorCount} errores`);
    return { success: true, sent: sentCount, errors: errorCount };
    
  } catch (error) {
    console.error('‚ùå Error en reporte diario:', error);
    throw error;
  }
});

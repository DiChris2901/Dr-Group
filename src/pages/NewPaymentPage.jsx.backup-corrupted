import React, { useState, useEffect } from 'react';
import {
  Box,
  Paper,
  Typography,
  Grid,
  TextField,
  Button,
  Card,
  CardContent,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Divider,
  Alert,
  AlertTitle,
  InputAdornment,
  Stepper,
  Step,
  StepLabel,
  Autocomplete,
  Chip,
  CircularProgress,
  LinearProgress,
  List,
  ListItem,
  ListItemIcon,
  ListItemText,
  ListItemSecondaryAction,
  IconButton,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Badge,
  Tooltip,
  Collapse,
  alpha,
  Checkbox,
  FormControlLabel,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Tabs,
  Tab,
  Stepper as InstallmentStepper,
  Step as InstallmentStep,
  StepLabel as InstallmentStepLabel
} from '@mui/material';
import {
  AttachMoney as MoneyIcon,
  Business as CompanyIcon,
  Receipt as ReceiptIcon,
  Save as SaveIcon,
  Cancel as CancelIcon,
  Schedule as ScheduleIcon,
  TrendingUp as InterestIcon,
  CloudUpload as UploadIcon,
  AttachFile as AttachIcon,
  Delete as DeleteIcon,
  InsertDriveFile as FileIcon,
  Visibility as ViewIcon,
  Description as PdfIcon,
  Image as ImageIcon,
  Launch as ExternalLinkIcon,
  FullscreenExit as MinimizeIcon,
  Fullscreen as MaximizeIcon,
  Person as PersonIcon,
  Refresh as RefreshIcon,
  ArrowBack as ArrowBackIcon,
  AccountBalance as InstallmentIcon,
  DateRange as DateRangeIcon,
  Payment as PaymentIcon,
  Timeline as TimelineIcon,
  CheckCircle as CheckCircleIcon,
  RadioButtonUnchecked as PendingIcon,
  CreditCard as CreditCardIcon
} from '@mui/icons-material';
import { useTheme } from '@mui/material/styles';
import { useNavigate } from 'react-router-dom';
import { useNotifications } from '../context/NotificationsContext';
import { useAuth } from '../context/AuthContext';
import { collection, query, where, getDocs, addDoc, updateDoc, doc, getDoc, Timestamp, onSnapshot, orderBy } from 'firebase/firestore';
import { db, storage } from '../config/firebase';
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage';
import { PDFDocument } from 'pdf-lib';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
// ðŸ—œï¸ IMPORTAR SISTEMA DE COMPRESIÃ“N
import PDFCompressionPreview from '../components/common/PDFCompressionPreview';
import { drGroupCompressor } from '../utils/pdfCompressor';

const NewPaymentPage = () => {
  const theme = useTheme();
  const navigate = useNavigate();
  const { addNotification } = useNotifications();
  const { user } = useAuth();
  
  // Helper para crear fecha local sin problemas de zona horaria
  const createLocalDate = (dateString) => {
    if (!dateString) return new Date();
    
    // Si es una fecha en formato YYYY-MM-DD del input
    if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
      const [year, month, day] = dateString.split('-').map(Number);
      return new Date(year, month - 1, day); // month - 1 porque Date usa base 0 para meses
    }
    
    return new Date(dateString);
  };

  // ðŸ’° FunciÃ³n para calcular 4x1000 automÃ¡ticamente
  const calculate4x1000Visual = (amount, method, sourceAccount) => {
    // 4x1000 se aplica a TODOS los pagos que requieren movimiento bancario
    // Para mÃ©todos como "Efectivo", se asume retiro de cuenta bancaria
    if (amount > 0) {
      return Math.round((amount * 4) / 1000);
    }
    return 0;
  };

  // ðŸ’° Funciones para formateo de moneda colombiana
  const formatCurrency = (value) => {
    if (!value && value !== 0) return '';
    
    // Remover todo excepto dÃ­gitos
    const cleanValue = value.toString().replace(/[^\d]/g, '');
    if (!cleanValue) return '';
    if (cleanValue === '0') return '0';
    
    // Formatear con separadores de miles
    const numValue = parseInt(cleanValue);
    if (isNaN(numValue)) return '';
    
    return numValue.toLocaleString('es-CO');
  };

  const parseCurrency = (formattedValue) => {
    if (!formattedValue) return 0;
    const cleanValue = formattedValue.toString().replace(/[^\d]/g, '');
    return parseInt(cleanValue) || 0;
  };

  const formatCurrencyDisplay = (value) => {
    if (!value && value !== 0) return '$0';
    return new Intl.NumberFormat('es-CO', {
      style: 'currency',
      currency: 'COP',
      minimumFractionDigits: 0
    }).format(value);
  };

  // ï¿½ FUNCIÃ“N DE VERIFICACIÃ“N DE PAGOS EN FIREBASE
    }
  };

  // ï¿½ FUNCIÃ“N DE VERIFICACIÃ“N DE CUOTAS EN FIREBASE
  const verifyInstallmentsInFirebase = async (parentPaymentId) => {
    try {
      console.log('ðŸ” VERIFICANDO CUOTAS EN FIREBASE...');
      
      // Buscar todas las cuotas relacionadas al pago padre
      const installmentsQuery = query(
        collection(db, 'payments'),
        where('parentPaymentId', '==', parentPaymentId),
        where('isInstallment', '==', true),
        orderBy('installmentNumber', 'asc')
      );
      
      const installmentsSnapshot = await getDocs(installmentsQuery);
      const foundInstallments = [];
      
      installmentsSnapshot.forEach((doc) => {
        foundInstallments.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      console.log('ðŸ“Š RESULTADOS DE VERIFICACIÃ“N:');
      console.log(`âœ… Cuotas encontradas: ${foundInstallments.length}`);
      
      foundInstallments.forEach((installment, index) => {
        console.log(`ðŸ“‹ Cuota ${installment.installmentNumber}:`, {
          id: installment.id,
          monto: installment.amount,
          estado: installment.status,
          vencimiento: installment.dueDate?.toDate?.()?.toLocaleDateString() || 'Sin fecha'
        });
      });
      
      // Verificar tambiÃ©n el pago padre
      const parentDoc = await getDoc(doc(db, 'payments', parentPaymentId));
      if (parentDoc.exists()) {
        const parentData = parentDoc.data();
        console.log('ðŸ‘¨â€ðŸ‘¦ PAGO PADRE:', {
          hasInstallments: parentData.hasInstallments,
          totalInstallments: parentData.totalInstallments,
          installmentIds: parentData.installmentIds?.length || 0
        });
      }
      
      return foundInstallments;
    } catch (error) {
      console.error('âŒ Error verificando cuotas:', error);
      return [];
    }
  };

  // ï¿½ðŸ’³ FUNCIONES PARA SISTEMA DE CUOTAS
  const generateInstallmentPlan = (totalAmount, numberOfInstallments, startDate = new Date()) => {
    if (numberOfInstallments < 2 || numberOfInstallments > 6) {
      return [];
    }

    const installmentAmount = Math.round(totalAmount / numberOfInstallments);
    const remainder = totalAmount - (installmentAmount * numberOfInstallments);
    const installments = [];

    for (let i = 0; i < numberOfInstallments; i++) {
      const installmentDate = new Date(startDate);
      installmentDate.setMonth(startDate.getMonth() + i);
      
      // La primera cuota incluye cualquier residuo de la divisiÃ³n
      const amount = i === 0 ? installmentAmount + remainder : installmentAmount;
      
      installments.push({
        installmentNumber: i + 1,
        amount: amount,
        dueDate: installmentDate,
        status: 'pending',
        paymentId: null,
        createdAt: new Date(),
        updatedAt: new Date()
      });
    }

    return installments;
  };

  const handleInstallmentToggle = (checked) => {
    setUseInstallments(checked);
    if (checked && formData.finalAmount > 0) {
      const preview = generateInstallmentPlan(
        formData.finalAmount, 
        installmentPlan.numberOfInstallments,
        createLocalDate(formData.date)
      );
      setInstallmentPreview(preview);
    } else {
      setInstallmentPreview([]);
    }
  };

  const handleInstallmentNumberChange = (numberOfInstallments) => {
    setInstallmentPlan(prev => ({ ...prev, numberOfInstallments }));
    
    if (useInstallments && formData.finalAmount > 0) {
      const preview = generateInstallmentPlan(
        formData.finalAmount, 
        numberOfInstallments,
        createLocalDate(formData.date)
      );
      setInstallmentPreview(preview);
    }
  };

  const openInstallmentModal = () => {
    if (!formData.finalAmount || formData.finalAmount <= 0) {
      addNotification({
        type: 'warning',
        title: 'Monto requerido',
        message: 'Debe ingresar el monto del pago antes de configurar las cuotas',
        icon: 'warning'
      });
      return;
    }

    const preview = generateInstallmentPlan(
      formData.finalAmount, 
      installmentPlan.numberOfInstallments,
      createLocalDate(formData.date)
    );
    setInstallmentPreview(preview);
    setInstallmentModalOpen(true);
  };

  const confirmInstallmentPlan = () => {
    setInstallmentPlan(prev => ({ 
      ...prev, 
      installments: installmentPreview 
    }));
    setInstallmentModalOpen(false);
    
    addNotification({
      type: 'success',
      title: 'Plan de cuotas confirmado',
      message: `Se crearÃ¡ un plan de ${installmentPreview.length} cuotas mensuales`,
      icon: 'success'
    });
  };

  // Estado para compromisos pendientes
  const [pendingCommitments, setPendingCommitments] = useState([]);
  const [loadingCommitments, setLoadingCommitments] = useState(true);
  const [selectedCommitment, setSelectedCommitment] = useState(null);
  
  // Estado para empresas y cuentas bancarias
  const [companies, setCompanies] = useState([]);
  const [loadingCompanies, setLoadingCompanies] = useState(true);
  const [personalAccounts, setPersonalAccounts] = useState([]);
  
  const [formData, setFormData] = useState({
    commitmentId: '',
    method: '',
    reference: '',
    date: new Date().toISOString().split('T')[0],
    notes: '',
    sourceAccount: '', // NUEVO: cuenta de origen del pago
    sourceBank: '',    // NUEVO: banco de origen (se autocompleta)
    tax4x1000: 0,     // NUEVO: campo visual para 4x1000
    // Campos calculados automÃ¡ticamente
    originalAmount: 0,
    interests: 0,
    // Campos especÃ­ficos para Coljuegos
    interesesDerechosExplotacion: 0,
    interesesGastosAdministracion: 0,
    derechosExplotacion: 0,        // NUEVO: monto base derechos
    gastosAdministracion: 0,       // NUEVO: monto base gastos
    finalAmount: 0
  });

  const [errors, setErrors] = useState({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  
  // Estado para archivos
  const [files, setFiles] = useState([]);
  const [uploading, setUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState(0);
  const [dragActive, setDragActive] = useState(false);
  
  // ðŸ—œï¸ ESTADO PARA COMPRESIÃ“N DE PDFs
  const [compressionPreviewOpen, setCompressionPreviewOpen] = useState(false);
  const [pendingPDFFile, setPendingPDFFile] = useState(null);
  const [compressionEnabled, setCompressionEnabled] = useState(true); // CompresiÃ³n habilitada por defecto

  // ðŸ“„ Estado para visor PDF de factura del compromiso
  const [pdfViewerOpen, setPdfViewerOpen] = useState(false);
  const [invoiceUrl, setInvoiceUrl] = useState(null);
  const [invoiceLoading, setInvoiceLoading] = useState(false);
  const [pdfViewerSize, setPdfViewerSize] = useState('medium'); // small, medium, large

  // FunciÃ³n de refresh manual
  const [refreshing, setRefreshing] = useState(false);
  
  // ðŸ’³ ESTADOS PARA SISTEMA DE CUOTAS
  const [installmentModalOpen, setInstallmentModalOpen] = useState(false);
  const [useInstallments, setUseInstallments] = useState(false);
  const [installmentPlan, setInstallmentPlan] = useState({
    numberOfInstallments: 2,
    installments: []
  });
  const [installmentPreview, setInstallmentPreview] = useState([]);
  const [savingInstallments, setSavingInstallments] = useState(false);
  
  const handleRefresh = async () => {
    setRefreshing(true);
    await loadPendingCommitments();
    await loadCompanies();
    setTimeout(() => {
      setRefreshing(false);
    }, 500);
  };

  // Cargar compromisos pendientes de pago
  useEffect(() => {
    loadPendingCommitments();
  }, []);

  // Cargar empresas con cuentas bancarias
  useEffect(() => {
    loadCompanies();
  }, []);

  // Limpiar intereses cuando la fecha ya no los requiere
  useEffect(() => {
    if (selectedCommitment && formData.date) {
      const needsInterests = requiresInterests(selectedCommitment, formData.date);
      
      if (!needsInterests) {
        // Limpiar todos los tipos de intereses si no se requieren
        setFormData(prev => ({
          ...prev,
          interests: 0,
          interesesDerechosExplotacion: 0,
          interesesGastosAdministracion: 0,
          finalAmount: prev.originalAmount
        }));
      }
    }
  }, [formData.date, selectedCommitment]);

  // ðŸ”„ useEffect para calcular 4x1000 automÃ¡ticamente
  useEffect(() => {
    const tax4x1000Amount = calculate4x1000Visual(
      formData.finalAmount, 
      formData.method, 
      formData.sourceAccount
    );
    
    if (tax4x1000Amount !== formData.tax4x1000) {
      setFormData(prev => ({
        ...prev,
        tax4x1000: tax4x1000Amount
      }));
    }
  }, [formData.finalAmount, formData.method, formData.sourceAccount]);

  // ðŸ’³ useEffect para recalcular cuotas cuando cambie el monto o fecha
  useEffect(() => {
    if (useInstallments && formData.finalAmount > 0) {
      const preview = generateInstallmentPlan(
        formData.finalAmount,
        installmentPlan.numberOfInstallments,
        createLocalDate(formData.date)
      );
      setInstallmentPreview(preview);
    }
  }, [useInstallments, formData.finalAmount, formData.date, installmentPlan.numberOfInstallments]);

  // Cargar cuentas personales desde Firebase
  useEffect(() => {
    if (!user?.uid) {
      setPersonalAccounts([]);
      return;
    }

    const q = query(
      collection(db, 'personal_accounts'),
      where('userId', '==', user.uid)
    );

    const unsubscribe = onSnapshot(
      q,
      (snapshot) => {
        const accounts = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          accounts.push({
            id: doc.id,
            ...data
          });
        });
        setPersonalAccounts(accounts);
      },
      (error) => {
        console.error('Error cargando cuentas personales:', error);
      }
    );

    return () => unsubscribe();
  }, [user]);

  const loadPendingCommitments = async () => {
    try {
      setLoadingCommitments(true);
      
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth(); // 0-11
      
      // Sin lÃ­mite inferior (para capturar todos los pendientes del pasado)
      // LÃ­mite superior: inicio del mes que estÃ¡ 3 meses adelante
      const startOfThreeMonthsLater = new Date(currentYear, currentMonth + 3, 1);
      
      console.log('ðŸ“… Cargando compromisos pendientes:', {
        currentDate: now.toISOString(),
        limiteSuperior: startOfThreeMonthsLater.toISOString(),
        currentMonth: currentMonth + 1,
        nextMonth1: currentMonth + 2,
        nextMonth2: currentMonth + 3,
        currentYear
      });
      
      // ðŸ“‹ CONSULTAR SOLO COMPROMISOS REGULARES
      const commitmentsQuery = query(
        collection(db, 'commitments'),
        where('dueDate', '<', startOfThreeMonthsLater),
        orderBy('dueDate', 'asc')
      );
      
      const snapshot = await getDocs(commitmentsQuery);
      
      console.log(`ðŸ“Š Compromisos encontrados: ${snapshot.size}`);
      
      // TambiÃ©n consultar todos los pagos para verificar cuÃ¡les compromisos ya tienen pago
      const paymentsQuery = query(
        collection(db, 'payments')
      );
      
      const paymentsSnapshot = await getDocs(paymentsQuery);
      const commitmentsWithPayments = new Set();
      
      // Crear set de commitmentIds que ya tienen pagos
      paymentsSnapshot.forEach((doc) => {
        const paymentData = doc.data();
        if (paymentData.commitmentId) {
          commitmentsWithPayments.add(paymentData.commitmentId);
        }
      });
      
      console.log('ðŸ“Š Compromisos que ya tienen pagos:', Array.from(commitmentsWithPayments));
      
      const pendingItems = [];
      
      // ðŸ“‹ PROCESAR SOLO COMPROMISOS REGULARES
      snapshot.forEach((doc) => {
        const data = doc.data();
        
        // âœ… LÃ“GICA SIMPLE: Verificar si estÃ¡ pagado
        const status = data.status || 'pending';
        const isPaidByStatus = status === 'paid' || status === 'completed';
        const isPaidByFlag = data.paid === true || data.isPaid === true;
        const isPaidByPaymentStatus = data.paymentStatus === 'paid' || data.paymentStatus === 'Pagado' || data.paymentStatus === 'pagado';
        const hasPayment = commitmentsWithPayments.has(doc.id);
        
        // Cualquier indicador de que estÃ¡ pagado
        const isAlreadyPaid = isPaidByStatus || isPaidByFlag || isPaidByPaymentStatus || hasPayment;
        
        // ðŸ“‹ MOSTRAR SOLO COMPROMISOS COMPLETAMENTE PENDIENTES
        if ((status === 'pending' || status === 'overdue') && !isAlreadyPaid) {
          console.log('âœ… Compromiso agregado:', doc.id, `"${data.companyName} - ${data.concept}"`);
          pendingItems.push({
            id: doc.id,
            type: 'commitment',
            ...data,
            displayName: `${data.companyName || 'Sin empresa'} - ${data.concept || data.name || 'Sin concepto'}`,
            formattedDueDate: data.dueDate ? format(data.dueDate.toDate(), 'dd/MMM/yyyy', { locale: es }) : 'Sin fecha',
            formattedAmount: new Intl.NumberFormat('es-CO', {
              style: 'currency',
              currency: 'COP',
              minimumFractionDigits: 0
            }).format(data.amount || 0)
          });
        } else {
          console.log('ðŸš« Compromiso OMITIDO:', doc.id, `"${data.companyName} - ${data.concept}"`, { 
            reason: isAlreadyPaid ? 'YA PAGADO' : 'NO PENDIENTE', 
            status 
          });
        }
      });
      
      // Ordenar por fecha de vencimiento
      pendingItems.sort((a, b) => {
        const dateA = a.dueDate ? a.dueDate.toDate() : new Date(0);
        const dateB = b.dueDate ? b.dueDate.toDate() : new Date(0);
        return dateA - dateB;
      });
      
      console.log(`ðŸŽ¯ RESUMEN: ${pendingItems.length} compromisos pendientes cargados`);
      
      setPendingCommitments(pendingItems);
      
    } catch (error) {
      console.error('âŒ Error cargando compromisos pendientes:', error);
      addNotification({
        type: 'error',
        title: 'Error',
        message: 'Error al cargar los compromisos pendientes',
        icon: 'error'
      });
    } finally {
      setLoadingCommitments(false);
    }
  };

  // Cargar empresas con informaciÃ³n bancaria
  const loadCompanies = async () => {
    try {
      setLoadingCompanies(true);
      const companiesQuery = query(collection(db, 'companies'));
      const snapshot = await getDocs(companiesQuery);
      
      const companiesData = [];
      snapshot.forEach((doc) => {
        const data = doc.data();
        companiesData.push({
          id: doc.id,
          ...data
        });
      });
      
      setCompanies(companiesData);
    } catch (error) {
      console.error('Error cargando empresas:', error);
      addNotification({
        type: 'error',
        title: 'Error al cargar empresas',
        message: 'No se pudieron cargar las empresas',
        icon: 'error'
      });
    } finally {
      setLoadingCompanies(false);
    }
  };

  // Obtener cuentas bancarias disponibles (empresariales y personales)
  const getBankAccounts = () => {
    // Cuentas empresariales
    const businessAccounts = companies
      .filter(company => company.bankAccount && company.bankName)
      .map(company => ({
        id: company.id,
        type: 'business',
        companyName: company.name,
        bankAccount: company.bankAccount,
        bankName: company.bankName,
        displayText: `${company.bankAccount} - ${company.bankName} (${company.name})`
      }));

    // Cuentas personales  
    const personalAccountsList = personalAccounts.map(account => ({
      id: account.id,
      type: 'personal',
      companyName: account.holderName,
      bankAccount: account.accountNumber, // Mapear accountNumber a bankAccount para consistencia
      bankName: account.bankName,
      displayText: `${account.accountNumber} - ${account.bankName} (${account.holderName})`
    }));

    return [...businessAccounts, ...personalAccountsList];
  };

  // Manejar selecciÃ³n de cuenta bancaria
  const handleSourceAccountSelect = (selectedAccount) => {
    if (selectedAccount) {
      const accountInfo = getBankAccounts().find(acc => acc.bankAccount === selectedAccount);
      if (accountInfo) {
        setFormData(prev => ({
          ...prev,
          sourceAccount: accountInfo.bankAccount,
          sourceBank: accountInfo.bankName
        }));
      }
    } else {
      setFormData(prev => ({
        ...prev,
        sourceAccount: '',
        sourceBank: ''
      }));
    }
  };

  // FunciÃ³n para formatear moneda
  const formatCurrencyBalance = (amount) => {
    return new Intl.NumberFormat('es-CO', {
      style: 'currency',
      currency: 'COP',
      minimumFractionDigits: 0
    }).format(amount || 0);
  };

  // FunciÃ³n para calcular y crear registro del 4x1000 MEJORADA
  const create4x1000Record = async (paymentAmount, sourceAccount, sourceBank, companyName, paymentDate, parentPaymentId = null) => {
    // Calcular 4x1000: 4 pesos por cada 1000 pesos transferidos
    const tax4x1000 = Math.round((paymentAmount * 4) / 1000);
    
    // Solo crear si el impuesto es mayor a 0
    if (tax4x1000 <= 0) return null;

    try {
      // ðŸ”— REGISTRO DEL 4x1000 CON RELACIÃ“N MEJORADA
      const tax4x1000Data = {
        // InformaciÃ³n bÃ¡sica del impuesto
        concept: '4x1000 - Impuesto Gravamen Movimientos Financieros',
        amount: tax4x1000,
        originalAmount: tax4x1000,
        method: 'Transferencia',
        notes: `Impuesto 4x1000 generado automÃ¡ticamente (${formatCurrencyBalance(paymentAmount)} x 0.004)`,
        reference: `4x1000-${Date.now()}`,
        
        // InformaciÃ³n de la empresa y cuentas
        companyName: companyName,
        sourceAccount: sourceAccount,
        sourceBank: sourceBank,
        date: paymentDate,
        
        // ðŸ“Š CAMPOS DE RELACIÃ“N MEJORADOS
        parentPaymentId: parentPaymentId,           // ID del pago principal que generÃ³ este impuesto
        parentPaymentAmount: paymentAmount,         // Monto base que generÃ³ el impuesto
        taxRate: 0.004,                            // Tasa aplicada (4/1000)
        taxType: '4x1000',                         // Tipo especÃ­fico de impuesto
        
        // Metadatos tÃ©cnicos
        createdAt: Timestamp.now(),
        updatedAt: Timestamp.now(),
        interests: 0,
        interesesDerechosExplotacion: 0,
        interesesGastosAdministracion: 0,
        
        // ðŸ·ï¸ FLAGS DE IDENTIFICACIÃ“N MEJORADOS
        is4x1000Tax: true,                         // Flag principal
        relatedToPayment: true,                    // Es un impuesto relacionado
        isAutomaticTax: true,                      // Generado automÃ¡ticamente
        category: 'tax',                           // CategorÃ­a: impuesto
        subcategory: 'transaction_tax',            // SubcategorÃ­a: impuesto transaccional
        tags: ['impuesto', '4x1000', 'automatico', 'gmf']
      };

      // Agregar a la colecciÃ³n de pagos
      const taxRef = await addDoc(collection(db, 'payments'), tax4x1000Data);
      
      console.log('âœ… Registro 4x1000 creado:', formatCurrencyBalance(tax4x1000));
      return { amount: tax4x1000, id: taxRef.id };
    } catch (error) {
      console.error('âŒ Error creando registro 4x1000:', error);
      return null;
    }
  };

  // Verificar si los intereses requeridos estÃ¡n completos
  const areInterestsComplete = () => {
    // Si no se requieren intereses, siempre estÃ¡ completo
    if (!requiresInterests(selectedCommitment, formData.date)) {
      return true;
    }
    
    // Si se requieren intereses
    if (isColjuegosCommitment(selectedCommitment)) {
      // Para Coljuegos: al menos uno de los dos tipos debe estar definido (puede ser 0)
      return formData.interesesDerechosExplotacion !== undefined && formData.interesesGastosAdministracion !== undefined;
    } else {
      // Para otros compromisos: debe estar definido (puede ser 0)
      return formData.interests !== undefined;
    }
  };

  // Verificar si la fecha de pago requiere intereses (posterior al vencimiento)
  const requiresInterests = (commitment, paymentDate) => {
    if (!commitment?.dueDate || !paymentDate) return false;
    
    const dueDate = commitment.dueDate.toDate();
    const payment = new Date(paymentDate);
    
    // Resetear horas para comparar solo fechas
    dueDate.setHours(0, 0, 0, 0);
    payment.setHours(0, 0, 0, 0);
    
    console.log('Checking interests requirement:', {
      dueDate: dueDate.toDateString(),
      paymentDate: payment.toDateString(),
      isLater: payment > dueDate
    });
    
    return payment > dueDate;
  };

  // Detectar si es un compromiso de Coljuegos
  const isColjuegosCommitment = (commitment) => {
    if (!commitment) return false;
    const companyName = commitment.companyName?.toLowerCase() || '';
    const concept = commitment.concept?.toLowerCase() || '';
    
    console.log('Checking Coljuegos for:', { companyName, concept });
    
    // Buscar por nombre de empresa o concepto relacionado a Coljuegos
    const isColjuegos = companyName.includes('coljuegos') || 
           companyName.includes('col juegos') ||
           concept.includes('derechos de explotaciÃ³n') ||
           concept.includes('derechos de explotacion') ||
           concept.includes('gastos de administraciÃ³n') ||
           concept.includes('gastos de administracion');
           
    console.log('Is Coljuegos:', isColjuegos);
    return isColjuegos;
  };

  // Calcular si hay intereses basado en la fecha de pago vs fecha de vencimiento
  const calculateInterestsForPaymentDate = (dueDate, amount, paymentDate) => {
    if (!dueDate || !amount || !paymentDate) return 0;
    
    const due = dueDate.toDate();
    const payment = new Date(paymentDate);
    const diffTime = payment - due;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    // Si no estÃ¡ vencido en la fecha de pago, no hay intereses
    if (diffDays <= 0) return 0;
    
    // Calcular interÃ©s: 1% mensual (0.033% diario) por dÃ­as de retraso
    const dailyRate = 0.01 / 30; // 1% mensual dividido en 30 dÃ­as
    const interestAmount = amount * dailyRate * diffDays;
    
    return Math.round(interestAmount);
  };

  // Manejar selecciÃ³n de compromiso
  const handleCommitmentSelect = (commitment) => {
    if (!commitment) {
      setSelectedCommitment(null);
      setFormData(prev => ({
        ...prev,
        commitmentId: '',
        originalAmount: 0,
        interests: 0,
        interesesDerechosExplotacion: 0,
        interesesGastosAdministracion: 0,
        derechosExplotacion: 0,
        gastosAdministracion: 0,
        finalAmount: 0
      }));
      // Limpiar URL de factura al deseleccionar compromiso
      setInvoiceUrl(null);
      return;
    }

    console.log('ðŸŽ¯ Compromiso/Cuota seleccionado:', {
      id: commitment.id,
      type: commitment.type,
      concept: commitment.concept,
      amount: commitment.amount,
      isInstallment: commitment.type === 'installment',
      installmentInfo: commitment.installmentInfo
    });

    setSelectedCommitment(commitment);
    
    // No calcular intereses automÃ¡ticamente, dejar en 0
    const finalAmount = commitment.amount || 0;

    setFormData(prev => ({
      ...prev,
      commitmentId: commitment.id,
      originalAmount: commitment.amount || 0,
      interests: 0,
      interesesDerechosExplotacion: 0,
      interesesGastosAdministracion: 0,
      // CARGAR VALORES BASE DESDE EL COMPROMISO/CUOTA
      derechosExplotacion: commitment.derechosExplotacion || 0,
      gastosAdministracion: commitment.gastosAdministracion || 0,
      finalAmount: finalAmount
    }));

    // ðŸ“„ Obtener URL de la factura del compromiso
    // ðŸ’³ Para cuotas, intentar obtener la factura del pago padre si estÃ¡ disponible
    if (commitment.type === 'installment' && commitment.parentPaymentId) {
      console.log('ðŸ’³ Es una cuota - verificando factura del pago padre:', commitment.parentPaymentId);
      // Por ahora usar la extracciÃ³n normal, podrÃ­as mejorar esto para buscar en el pago padre
    }
    extractInvoiceUrl(commitment);
  };

  // ðŸ“„ FUNCIONES DEL VISOR PDF DE FACTURA DEL COMPROMISO
  
  // Extraer URL de la factura del compromiso seleccionado
  const extractInvoiceUrl = (commitment) => {
    if (!commitment) {
      setInvoiceUrl(null);
      return;
    }

    console.log('ðŸ” Extrayendo URL de factura para compromiso:', commitment.id);
    console.log('ðŸ“„ DATOS COMPLETOS DEL COMPROMISO:', commitment);
    console.log('ðŸ“„ Analizando campos de archivos:', {
      'invoice.url': commitment.invoice?.url,
      'invoice': commitment.invoice,
      receiptUrl: commitment.receiptUrl,
      receiptUrls: commitment.receiptUrls,
      attachments: commitment.attachments,
      attachmentUrls: commitment.attachmentUrls,
      invoiceUrl: commitment.invoiceUrl,
      fileUrl: commitment.fileUrl,
      fileUrls: commitment.fileUrls
    });

    let foundUrl = null;

    // PRIORIDAD 1: invoice.url (campo especÃ­fico de factura - ESTRUCTURA CORRECTA)
    if (commitment.invoice && commitment.invoice.url && commitment.invoice.url.trim() !== '') {
      foundUrl = commitment.invoice.url;
      console.log('âœ… URL de factura encontrada en invoice.url:', foundUrl);
    }
    // PRIORIDAD 2: invoiceUrl (campo directo de factura)
    else if (commitment.invoiceUrl && commitment.invoiceUrl.trim() !== '') {
      foundUrl = commitment.invoiceUrl;
      console.log('âœ… URL de factura encontrada en invoiceUrl:', foundUrl);
    }
    // PRIORIDAD 3: attachments (URLs mÃ¡s frescas)
    else if (commitment.attachments && commitment.attachments.length > 0) {
      foundUrl = commitment.attachments[commitment.attachments.length - 1]; // MÃ¡s reciente
      console.log('âœ… URL de factura encontrada en attachments:', foundUrl);
    }
    // PRIORIDAD 4: receiptUrls (mÃºltiples archivos)
    else if (commitment.receiptUrls && commitment.receiptUrls.length > 0) {
      foundUrl = commitment.receiptUrls[commitment.receiptUrls.length - 1]; // MÃ¡s reciente
      console.log('âœ… URL de factura encontrada en receiptUrls:', foundUrl);
    }
    // PRIORIDAD 5: receiptUrl (archivo Ãºnico)
    else if (commitment.receiptUrl && commitment.receiptUrl.trim() !== '') {
      foundUrl = commitment.receiptUrl;
      console.log('âœ… URL de factura encontrada en receiptUrl:', foundUrl);
    }
    // PRIORIDAD 6: attachmentUrls (legacy)
    else if (commitment.attachmentUrls && commitment.attachmentUrls.length > 0) {
      foundUrl = commitment.attachmentUrls[commitment.attachmentUrls.length - 1];
      console.log('âœ… URL de factura encontrada en attachmentUrls:', foundUrl);
    }
    // PRIORIDAD 7: fileUrls (otro campo posible)
    else if (commitment.fileUrls && commitment.fileUrls.length > 0) {
      foundUrl = commitment.fileUrls[commitment.fileUrls.length - 1];
      console.log('âœ… URL de factura encontrada en fileUrls:', foundUrl);
    }
    // PRIORIDAD 8: fileUrl (archivo Ãºnico)
    else if (commitment.fileUrl && commitment.fileUrl.trim() !== '') {
      foundUrl = commitment.fileUrl;
      console.log('âœ… URL de factura encontrada en fileUrl:', foundUrl);
    }

    if (foundUrl) {
      // Verificar que la URL sea vÃ¡lida
      if (foundUrl.includes('firebase') && (foundUrl.includes('googleapis.com') || foundUrl.includes('firebasestorage'))) {
        setInvoiceUrl(foundUrl);
        console.log('ðŸ“„ âœ… URL de factura establecida (Firebase Storage):', foundUrl);
        console.log('ðŸ“„ âœ… Nombre del archivo:', commitment.invoice?.fileName || 'Nombre no disponible');
      } else {
        setInvoiceUrl(foundUrl);
        console.log('ðŸ“„ âœ… URL de factura establecida (otro origen):', foundUrl);
      }
    } else {
      setInvoiceUrl(null);
      console.log('âš ï¸ NINGÃšN CAMPO DE ARCHIVO ENCONTRADO');
      console.log('ðŸ” Estructura del campo invoice:', commitment.invoice);
      console.log('ðŸ” Todos los campos disponibles:', Object.keys(commitment));
      
      // Debug adicional: buscar cualquier campo que contenga palabras clave
      Object.keys(commitment).forEach(key => {
        const value = commitment[key];
        if (key.toLowerCase().includes('file') || 
            key.toLowerCase().includes('url') || 
            key.toLowerCase().includes('attachment') || 
            key.toLowerCase().includes('receipt') ||
            key.toLowerCase().includes('invoice') ||
            key.toLowerCase().includes('document')) {
          console.log(`ðŸ” Campo sospechoso encontrado: ${key} =`, value);
        }
      });
    }
  };

  // Abrir visor PDF
  const handleOpenPdfViewer = () => {
    if (invoiceUrl) {
      setPdfViewerOpen(true);
      console.log('ðŸ“„ Abriendo visor PDF con URL:', invoiceUrl);
    } else {
      addNotification({
        type: 'warning',
        title: 'Sin factura',
        message: 'Este compromiso no tiene factura adjunta',
        icon: 'warning'
      });
    }
  };

  // Cerrar visor PDF
  const handleClosePdfViewer = () => {
    setPdfViewerOpen(false);
  };

  // Cambiar tamaÃ±o del visor
  const toggleViewerSize = () => {
    setPdfViewerSize(prev => {
      if (prev === 'medium') return 'large';
      if (prev === 'large') return 'small';
      return 'medium';
    });
  };

  // Abrir PDF en nueva pestaÃ±a
  const handleOpenInNewTab = () => {
    if (invoiceUrl) {
      window.open(invoiceUrl, '_blank');
      console.log('ðŸ”— Abriendo PDF en nueva pestaÃ±a:', invoiceUrl);
    }
  };

  const paymentMethods = [
    'Transferencia',
    'PSE',
    'Efectivo'
  ];

  const handleInputChange = (field) => (event) => {
    setFormData({
      ...formData,
      [field]: event.target.value
    });
    // Limpiar error cuando el usuario empiece a escribir
    if (errors[field]) {
      setErrors({
        ...errors,
        [field]: ''
      });
    }
  };

  const validateForm = () => {
    const newErrors = {};

    if (!formData.commitmentId) newErrors.commitmentId = 'Debe seleccionar un compromiso';
    if (!formData.method) newErrors.method = 'El mÃ©todo de pago es requerido';
    if (!formData.reference) newErrors.reference = 'La referencia es requerida';
    if (!formData.date) newErrors.date = 'La fecha es requerida';
    
    // Validar intereses si se requieren
    if (requiresInterests(selectedCommitment, formData.date)) {
      if (!areInterestsComplete()) {
        if (isColjuegosCommitment(selectedCommitment)) {
          newErrors.interests = 'Debe ingresar al menos uno de los tipos de intereses de Coljuegos';
        } else {
          newErrors.interests = 'Debe ingresar el monto de intereses por mora';
        }
      }
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async (event) => {
    event.preventDefault();
    console.log('ðŸŽ¯ handleSubmit INICIADO - event:', event);
    
    // Verificar autenticaciÃ³n
    if (!user) {
      addNotification({
        type: 'error',
        title: 'No autenticado',
        message: 'Debe iniciar sesiÃ³n para registrar pagos',
        icon: 'error'
      });
      return;
    }
    
    if (!validateForm()) {
      addNotification({
        type: 'error',
        title: 'Formulario incompleto',
        message: 'Por favor complete todos los campos requeridos',
        icon: 'error'
      });
      return;
    }

    setIsSubmitting(true);
    
    try {
      console.log('ðŸš€ Iniciando proceso de pago...');
      console.log('ðŸ‘¤ Usuario autenticado:', user?.uid, user?.email);
      console.log('ðŸ“‹ Selected commitment completo:', JSON.stringify(selectedCommitment, null, 2));
      console.log('ðŸ“ Form data completo:', JSON.stringify(formData, null, 2));
      
      // Subir archivos primero
      console.log('ðŸ“Ž Subiendo archivos...');
      const uploadedFileUrls = await uploadFiles();
      console.log('âœ… Archivos subidos:', uploadedFileUrls);
      
      // Preparar datos del pago incluyendo URLs de archivos
      const paymentData = {
        commitmentId: selectedCommitment.id,
        companyName: selectedCommitment.companyName || selectedCommitment.company || 'Sin empresa',
        concept: selectedCommitment.name || selectedCommitment.concept || selectedCommitment.description || 'Sin concepto',
        amount: formData.finalAmount || 0,
        originalAmount: formData.originalAmount || 0,
        interests: formData.interests || 0,  // Intereses generales (sin Coljuegos)
        // ðŸŽ° NUEVOS CAMPOS ESPECÃFICOS DE COLJUEGOS
        interesesDerechosExplotacion: formData.interesesDerechosExplotacion || 0,
        interesesGastosAdministracion: formData.interesesGastosAdministracion || 0,
        derechosExplotacion: formData.derechosExplotacion || 0,        // NUEVO: monto base derechos
        gastosAdministracion: formData.gastosAdministracion || 0,      // NUEVO: monto base gastos
        method: formData.method || '',
        reference: formData.reference || '',
        date: Timestamp.fromDate(createLocalDate(formData.date)),
        notes: formData.notes || '',
        sourceAccount: formData.sourceAccount || '',  // NUEVO: cuenta de origen
        sourceBank: formData.sourceBank || '',        // NUEVO: banco de origen
        
        // ðŸ’³ INFORMACIÃ“N DEL 4x1000 (REFERENCIAL)
        tax4x1000Amount: Math.round((formData.finalAmount * 4) / 1000), // Monto calculado
        includesTax4x1000: formData.finalAmount > 0,                     // Indica si genera 4x1000
        taxInfo: {
          rate4x1000: 0.004,                                             // Tasa aplicada
          base: formData.finalAmount,                                     // Base gravable
          calculated: Math.round((formData.finalAmount * 4) / 1000)       // Impuesto calculado
        },
        
        status: 'completed',
        attachments: uploadedFileUrls || [],
        processedBy: user.uid,
        processedByEmail: user.email,
        createdAt: Timestamp.now(),
        updatedAt: Timestamp.now()
      };
      
      // Validar que los campos crÃ­ticos no estÃ©n vacÃ­os
      console.log('ðŸ” Validando paymentData antes de guardar:', paymentData);
      
      if (!paymentData.commitmentId) {
        throw new Error('ID del compromiso no vÃ¡lido');
      }
      if (!paymentData.concept || paymentData.concept === 'Sin concepto') {
        console.warn('âš ï¸ Concepto no encontrado en selectedCommitment:', selectedCommitment);
      }
      
      // Guardar el pago en la colecciÃ³n payments
      console.log('ðŸ’¾ Guardando pago en Firebase:', paymentData);
      const paymentRef = await addDoc(collection(db, 'payments'), paymentData);
      console.log('âœ… Pago guardado con ID:', paymentRef.id);
      
      // =====================================================
      // GENERAR 4x1000 AUTOMÃTICAMENTE (SI APLICA)
      // =====================================================
      // Generar 4x1000 para CUALQUIER pago que requiera movimiento bancario
      // Esto incluye transferencias, PSE, e incluso retiros para efectivo
      // Para efectivo, se usarÃ¡ una cuenta por defecto si no hay cuenta especÃ­fica
      if (paymentData.amount > 0) {
        
        // Para pagos sin cuenta especÃ­fica (ej: efectivo), usar la primera cuenta disponible
        const effectiveSourceAccount = paymentData.sourceAccount || 'Cuenta Corriente Principal';
        const effectiveSourceBank = paymentData.sourceBank || 'Banco Principal';
        
        console.log('ðŸ’° Generando 4x1000 para mÃ©todo', paymentData.method, 'de:', formatCurrencyBalance(paymentData.amount));
        
        const tax4x1000Result = await create4x1000Record(
          paymentData.amount,
          effectiveSourceAccount,
          effectiveSourceBank,
          paymentData.companyName,
          paymentData.date,
          paymentRef.id  // ðŸ”— PASAR ID DEL PAGO PRINCIPAL
        );

        if (tax4x1000Result) {
          console.log('â„¹ï¸ 4x1000 generado automÃ¡ticamente:', formatCurrencyBalance(tax4x1000Result.amount));
          
          // ðŸ”„ ACTUALIZAR EL PAGO PRINCIPAL CON LA REFERENCIA AL 4x1000
          await updateDoc(paymentRef, {
            tax4x1000PaymentId: tax4x1000Result.id,    // ID del registro de 4x1000 generado
            hasTax4x1000: true,                        // Flag indicando que tiene impuesto asociado
            updatedAt: Timestamp.now()
          });
        }
      }
      
      // Actualizar el compromiso/cuota como pagado
      console.log('ðŸ”„ Actualizando compromiso/cuota como pagado...');
      
      if (selectedCommitment.type === 'installment') {
        // ðŸ’³ ES UNA CUOTA - Actualizar el registro de cuota en la colecciÃ³n payments
        console.log('ðŸ’³ Actualizando cuota pendiente como pagada:', selectedCommitment.id);
        
        const installmentRef = doc(db, 'payments', selectedCommitment.id);
        await updateDoc(installmentRef, {
          status: 'completed',
          paid: true,
          isPaid: true,
          paidAt: Timestamp.fromDate(createLocalDate(formData.date)),
          paymentDate: Timestamp.fromDate(createLocalDate(formData.date)),
          actualPaymentAmount: formData.finalAmount,
          actualPaymentDate: Timestamp.fromDate(createLocalDate(formData.date)),
          actualPaymentMethod: formData.method,
          actualPaymentReference: formData.reference,
          actualPaymentNotes: formData.notes,
          actualPaymentAttachments: uploadedFileUrls || [],
          processedBy: user.uid,
          processedByEmail: user.email,
          updatedAt: Timestamp.now()
        });
        
        console.log('âœ… Cuota actualizada como pagada');
        
        // ðŸ“Š ACTUALIZAR RESUMEN DEL PLAN DE CUOTAS SI EXISTE
        if (selectedCommitment.parentPaymentId) {
          console.log('ðŸ“Š Actualizando resumen del plan de cuotas para:', selectedCommitment.parentPaymentId);
          try {
            await updateInstallmentSummary(selectedCommitment.parentPaymentId);
            console.log('âœ… Resumen del plan actualizado');
          } catch (summaryError) {
            console.error('âŒ Error actualizando resumen del plan:', summaryError);
          }
        }
        
      } else {
        // ðŸ“‹ ES UN COMPROMISO REGULAR
        console.log('ðŸ“‹ Procesando compromiso regular:', selectedCommitment.id);
        
        // ðŸŽ¯ LÃ“GICA CONDICIONAL: Solo marcar como pagado si NO se van a crear cuotas
        if (useInstallments && installmentPlan.installments.length > 1) {
          // ðŸ’³ SE VA A PAGAR A CUOTAS - El compromiso permanece pendiente
          console.log('ï¿½ Compromiso se pagarÃ¡ a cuotas - mantener como pendiente hasta completar todas las cuotas');
          
          const commitmentRef = doc(db, 'commitments', selectedCommitment.id);
          await updateDoc(commitmentRef, {
            // âŒ NO marcar como pagado aÃºn
            status: 'partial_payment', // Estado especial para pagos parciales
            hasInstallments: true,     // Flag para indicar que tiene plan de cuotas
            installmentPlanId: paymentRef.id, // Referencia al pago padre del plan
            firstInstallmentPaid: true,
            firstInstallmentDate: Timestamp.fromDate(createLocalDate(formData.date)),
            firstInstallmentAmount: formData.finalAmount,
            firstPaymentId: paymentRef.id,
            totalInstallments: installmentPlan.installments.length,
            paidInstallments: 1,
            pendingInstallments: installmentPlan.installments.length - 1,
            // Mantener datos del primer pago para referencia
            firstPaymentMethod: formData.method,
            firstPaymentReference: formData.reference,
            firstPaymentNotes: formData.notes,
            receiptUrl: uploadedFileUrls && uploadedFileUrls.length > 0 ? uploadedFileUrls[0] : null,
            receiptUrls: uploadedFileUrls || [],
            updatedAt: Timestamp.now()
          });
          
          console.log('âœ… Compromiso actualizado con estado de pago parcial (primera cuota)');
          
        } else {
          // ðŸ’° PAGO COMPLETO - Marcar como pagado totalmente
          console.log('ðŸ’° Pago completo - marcar compromiso como pagado');
          
          const commitmentRef = doc(db, 'commitments', selectedCommitment.id);
          await updateDoc(commitmentRef, {
            isPaid: true,
            paid: true,
            status: 'paid',
            paymentDate: Timestamp.fromDate(createLocalDate(formData.date)),
            paidAt: Timestamp.fromDate(createLocalDate(formData.date)),
            paymentAmount: formData.finalAmount,
            paymentId: paymentRef.id,
            interestPaid: (formData.interests || 0) + (formData.interesesDerechosExplotacion || 0) + (formData.interesesGastosAdministracion || 0),
            paymentMethod: formData.method,
            paymentReference: formData.reference,
            paymentNotes: formData.notes,
            receiptUrl: uploadedFileUrls && uploadedFileUrls.length > 0 ? uploadedFileUrls[0] : null,
            receiptUrls: uploadedFileUrls || [],
            receiptMetadata: uploadedFileUrls ? uploadedFileUrls.map(url => ({
              url: url,
              uploadedAt: new Date(),
              type: url.includes('.pdf') ? 'pdf' : 'image'
            })) : [],
            updatedAt: Timestamp.now()
          });
          
          console.log('âœ… Compromiso actualizado como pagado completamente');
        }
      }
      
      // =====================================================
      // ðŸ’³ PROCESAMIENTO DE CUOTAS (SI APLICA)
      // =====================================================
      let installmentsCreated = [];
      let finalPaymentMessage;
      
      // ðŸŽ¯ MENSAJE FINAL SIMPLE
      let finalPaymentMessage = `ï¿½ Pago de $${formData.finalAmount.toLocaleString()} registrado para ${selectedCommitment.companyName}`;
      
      // Recargar la lista de compromisos para quitar el que acaba de ser pagado
      await loadPendingCommitments();
      
      addNotification({
        type: 'success',
        title: 'Pago registrado exitosamente',
        message: finalPaymentMessage,
        icon: 'success'
      });
        setSavingInstallments(true);
        
        try {
          console.log('ï¿½ INICIANDO CREACIÃ“N DE PLAN DE CUOTAS COMPLETO');
          console.log('ðŸ“Š Total de cuotas planificadas:', installmentPlan.installments.length);
          console.log('ðŸ’° Monto total a dividir:', formData.finalAmount);
          console.log('ðŸ“‹ Detalle del plan:', installmentPlan.installments.map(inst => ({
            cuota: inst.installmentNumber,
            monto: inst.amount,
            fecha: inst.dueDate
          })));
          
          // Crear todas las cuotas basadas en el pago principal
          installmentsCreated = await createInstallments(
            paymentRef.id, 
            installmentPlan.installments, 
            paymentData
          );
          
          console.log(`ðŸŽ‰ Ã‰XITO: ${installmentsCreated.length} cuotas creadas en Firebase`);
          console.log('ðŸ“‹ IDs de cuotas creadas:', installmentsCreated.map(inst => inst.id));
          
          // ðŸ”¥ ACTUALIZAR PAGO PRINCIPAL CON INFORMACIÃ“N COMPLETA DE CUOTAS
          const installmentSummary = {
            hasInstallments: true,
            totalInstallments: installmentPlan.installments.length,
            installmentIds: installmentsCreated.map(inst => inst.id),
            isParentPayment: true,
            installmentPlan: {
              planId: `${paymentRef.id}-PLAN`,
              total: formData.finalAmount,
              numberOfInstallments: installmentPlan.installments.length,
              firstInstallmentPaid: true,
              firstInstallmentAmount: installmentsCreated[0]?.amount || 0,
              remainingInstallments: installmentPlan.installments.length - 1,
              createdAt: Timestamp.now(),
              nextDueDate: installmentsCreated[1]?.dueDate || null
            },
            // ðŸ“Š RESUMEN PARA BÃšSQUEDAS Y REPORTES
            installmentMetadata: {
              paidInstallments: 1,
              pendingInstallments: installmentPlan.installments.length - 1,
              totalPaidAmount: installmentsCreated[0]?.amount || 0,
              totalPendingAmount: installmentsCreated.slice(1).reduce((sum, inst) => sum + inst.amount, 0)
            }
          };
          
          await updateDoc(paymentRef, installmentSummary);
          
          console.log('âœ… Pago principal actualizado con metadata de cuotas');
          
          // ï¿½ ESTABLECER EL RESUMEN INICIAL DE CUOTAS
          const initialSummary = await updateInstallmentSummary(paymentRef.id);
          console.log('ðŸ“‹ Resumen inicial establecido:', initialSummary);
          
          // ï¿½ðŸ” VERIFICAR QUE LAS CUOTAS SE GUARDARON CORRECTAMENTE
          setTimeout(async () => {
            const verifiedInstallments = await verifyInstallmentsInFirebase(paymentRef.id);
            if (verifiedInstallments.length === installmentPlan.installments.length) {
              console.log('ðŸŽ‰ VERIFICACIÃ“N EXITOSA: Todas las cuotas estÃ¡n en Firebase');
            } else {
              console.warn('âš ï¸ VERIFICACIÃ“N FALLIDA: Cuotas faltantes en Firebase');
            }
          }, 2000); // Esperar 2 segundos para que Firebase procese todo
          
          // Actualizar mensaje de Ã©xito mÃ¡s detallado
          const paidInstallments = installmentsCreated.filter(inst => inst.status === 'completed').length;
          const pendingInstallments = installmentsCreated.length - paidInstallments;
          const totalPending = installmentsCreated.slice(1).reduce((sum, inst) => sum + inst.amount, 0);
          
          finalPaymentMessage = `ðŸ’³ Plan de ${installmentsCreated.length} cuotas creado exitosamente.\n` +
            `ðŸ“Š ESTADO: Cuotas pagadas ${paidInstallments} de ${installmentsCreated.length}\n` +
            `âœ… PAGADO: ${formatCurrencyDisplay(installmentsCreated[0].amount)}\n` +
            `ðŸ’° SALDO PENDIENTE: ${formatCurrencyDisplay(totalPending)}\n` +
            `ðŸ“… PrÃ³ximo vencimiento: ${installmentsCreated[1]?.dueDate.toDate().toLocaleDateString()}`;
          
        } catch (installmentError) {
          console.error('ðŸš¨ ERROR CRÃTICO CREANDO CUOTAS:', installmentError);
          console.error('ðŸ“‹ Detalles completos:', {
            error: installmentError.message,
            stack: installmentError.stack,
            installmentPlan: installmentPlan.installments
          });
          
          // Notificar el error de cuotas pero continuar con el pago principal
          addNotification({
            type: 'error',
            title: 'âŒ Error creando plan de cuotas',
            message: `El pago principal se registrÃ³, pero fallÃ³ la creaciÃ³n de cuotas: ${installmentError.message}. Contacte al administrador.`,
            icon: 'error',
            duration: 8000
          });
        } finally {
          setSavingInstallments(false);
        }
      }
      
      // Recargar la lista de compromisos para quitar el que acaba de ser pagado
      await loadPendingCommitments();
      
      addNotification({
        type: 'success',
        title: 'Pago registrado exitosamente',
        message: finalPaymentMessage,
        icon: 'success'
      });
      
      // Limpiar el formulario para permitir otro pago
      setSelectedCommitment(null);
      setFormData({
        commitmentId: '',
        method: '',
        reference: '',
        date: new Date().toISOString().split('T')[0],
        notes: '',
        sourceAccount: '',
        sourceBank: '',
        tax4x1000: 0,
        originalAmount: 0,
        interests: 0,
        interesesDerechosExplotacion: 0,
        interesesGastosAdministracion: 0,
        finalAmount: 0
      });
      setFiles([]);
      
      // Limpiar tambiÃ©n la URL de la factura
      setInvoiceUrl(null);
      
    } catch (error) {
      console.error('Error guardando pago:', error);
      addNotification({
        type: 'error',
        title: 'Error al registrar pago',
        message: `No se pudo guardar el pago: ${error.message}`,
        icon: 'error'
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleCancel = () => {
    navigate('/payments');
  };

  // Funciones para manejo de archivos
  const handleDrag = (e) => {
    e.preventDefault();
    e.stopPropagation();
    if (e.type === 'dragenter' || e.type === 'dragover') {
      setDragActive(true);
    } else if (e.type === 'dragleave') {
      setDragActive(false);
    }
  };

  const handleDrop = (e) => {
    e.preventDefault();
    e.stopPropagation();
    setDragActive(false);
    
    const droppedFiles = Array.from(e.dataTransfer.files);
    handleFiles(droppedFiles);
  };

  const handleFileSelect = (e) => {
    const selectedFiles = Array.from(e.target.files);
    handleFiles(selectedFiles);
  };

  const handleFiles = (newFiles) => {
    // Filtrar archivos vÃ¡lidos
    const validFiles = newFiles.filter(file => {
      const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
      return validTypes.includes(file.type) && file.size <= 10 * 1024 * 1024; // 10MB max
    });

    if (validFiles.length !== newFiles.length) {
      addNotification({
        type: 'warning',
        title: 'Archivos filtrados',
        message: 'Solo se permiten imÃ¡genes (JPG, PNG) y PDFs menores a 10MB',
        icon: 'warning'
      });
    }

    // ðŸ—œï¸ PROCESAR CADA ARCHIVO (COMPRIMIR PDFs SI ES NECESARIO)
    validFiles.forEach(file => {
      if (file.type === 'application/pdf' && compressionEnabled && file.size > 100 * 1024) { // Solo comprimir PDFs > 100KB
        // Mostrar vista previa de compresiÃ³n para PDFs grandes
        setPendingPDFFile(file);
        setCompressionPreviewOpen(true);
      } else {
        // Agregar archivos no-PDF o PDFs pequeÃ±os directamente
        addFileToList(file);
      }
    });
  };

  // ðŸ—œï¸ MANEJAR RESULTADO DE COMPRESIÃ“N
  const handleCompressionAccept = (compressionResult) => {
    console.log('âœ… CompresiÃ³n aceptada:', compressionResult.stats);
    
    // Convertir el blob comprimido a File objeto
    const compressedFile = new File([compressionResult.compressed], pendingPDFFile.name, {
      type: 'application/pdf'
    });
    
    addFileToList(compressedFile, compressionResult.stats);
    setPendingPDFFile(null);
    
    addNotification({
      type: 'success',
      title: 'PDF Optimizado',
      message: `Archivo comprimido exitosamente (${compressionResult.stats.reductionPercent} reducido)`,
      icon: 'success'
    });
  };

  const handleCompressionReject = () => {
    console.log('âŒ CompresiÃ³n rechazada, usando original');
    addFileToList(pendingPDFFile);
    setPendingPDFFile(null);
    
    addNotification({
      type: 'info',
      title: 'Original Mantenido',
      message: 'Se usarÃ¡ el archivo original sin comprimir',
      icon: 'info'
    });
  };

  // FunciÃ³n auxiliar para agregar archivos a la lista
  const addFileToList = (file, compressionStats = null) => {
    setFiles(prev => [...prev, {
      file,
      id: Date.now() + Math.random(),
      name: file.name,
      size: file.size,
      type: file.type,
      uploaded: false,
      url: null,
      compressed: !!compressionStats,
      compressionStats: compressionStats
    }]);
  };

  const removeFile = (fileId) => {
    setFiles(prev => prev.filter(f => f.id !== fileId));
  };

  // FunciÃ³n para convertir imagen a PDF
  const imageToPdf = async (imageFile) => {
    const pdfDoc = await PDFDocument.create();
    const imageBytes = await imageFile.arrayBuffer();
    
    let image;
    if (imageFile.type === 'image/jpeg' || imageFile.type === 'image/jpg') {
      image = await pdfDoc.embedJpg(imageBytes);
    } else if (imageFile.type === 'image/png') {
      image = await pdfDoc.embedPng(imageBytes);
    } else {
      throw new Error('Tipo de imagen no soportado');
    }

    // Crear pÃ¡gina con el tamaÃ±o de la imagen
    const { width, height } = image.scale(1);
    const page = pdfDoc.addPage([width, height]);
    page.drawImage(image, {
      x: 0,
      y: 0,
      width,
      height,
    });

    return pdfDoc;
  };

  // FunciÃ³n para combinar todos los archivos en un solo PDF
  const combineFilesToPdf = async (files) => {
    try {
      const mainPdfDoc = await PDFDocument.create();

      for (const fileData of files) {
        const file = fileData.file;
        
        if (file.type === 'application/pdf') {
          // Si es PDF, copiarlo al documento principal
          const pdfBytes = await file.arrayBuffer();
          const pdf = await PDFDocument.load(pdfBytes);
          const copiedPages = await mainPdfDoc.copyPages(pdf, pdf.getPageIndices());
          copiedPages.forEach((page) => mainPdfDoc.addPage(page));
        } else if (file.type.startsWith('image/')) {
          // Si es imagen, convertirla a PDF primero
          const imagePdf = await imageToPdf(file);
          const copiedPages = await mainPdfDoc.copyPages(imagePdf, imagePdf.getPageIndices());
          copiedPages.forEach((page) => mainPdfDoc.addPage(page));
        }
      }

      // Generar el PDF combinado
      const pdfBytes = await mainPdfDoc.save();
      return new Blob([pdfBytes], { type: 'application/pdf' });
    } catch (error) {
      console.error('Error combining files:', error);
      throw error;
    }
  };

  const uploadFiles = async () => {
    if (files.length === 0) return [];

    setUploading(true);
    setUploadProgress(0);

    try {
      let fileToUpload;
      let fileName;

      if (files.length === 1) {
        // Si solo hay un archivo, subirlo directamente
        fileToUpload = files[0].file;
        fileName = files[0].name;
      } else {
        // Si hay mÃºltiples archivos, combinarlos en un PDF
        setUploadProgress(25); // Progreso durante la combinaciÃ³n
        
        addNotification({
          type: 'info',
          title: 'Combinando archivos',
          message: 'Creando PDF combinado con todos los comprobantes...',
          icon: 'info'
        });

        const combinedPdf = await combineFilesToPdf(files);
        fileToUpload = combinedPdf;
        fileName = `comprobantes_pago_${Date.now()}.pdf`;
        
        setUploadProgress(50); // Progreso despuÃ©s de combinar
      }

      // Crear referencia para el archivo
      const timestamp = Date.now();
      const finalFileName = `payments/${timestamp}_${fileName}`;
      const storageRef = ref(storage, finalFileName);

      setUploadProgress(75); // Progreso antes de subir

      // Subir archivo
      const snapshot = await uploadBytes(storageRef, fileToUpload);
      const downloadURL = await getDownloadURL(snapshot.ref);
      
      setUploadProgress(100); // Completado

      addNotification({
        type: 'success',
        title: 'Comprobante subido',
        message: files.length > 1 
          ? `${files.length} archivos combinados y subidos como PDF Ãºnico`
          : 'Comprobante subido exitosamente',
        icon: 'success'
      });

      // Marcar todos los archivos como subidos
      setFiles(prev => prev.map(f => ({ ...f, uploaded: true, url: downloadURL })));

      return [downloadURL];
    } catch (error) {
      console.error('Error uploading files:', error);
      addNotification({
        type: 'error',
        title: 'Error de carga',
        message: 'Hubo un error al procesar y subir los archivos',
        icon: 'error'
      });
      return [];
    } finally {
      setUploading(false);
      setUploadProgress(0);
    }
  };

  const steps = ['Seleccionar Compromiso', 'InformaciÃ³n del Pago', 'ConfirmaciÃ³n'];

  return (
    <Box sx={{ p: 3 }}>
      {/* HEADER GRADIENT SOBRIO */}
      <Paper 
        sx={{ 
          background: theme.palette.mode === 'dark' 
            ? `linear-gradient(135deg, ${theme.palette.primary.dark} 0%, ${theme.palette.secondary.dark} 100%)`
            : `linear-gradient(135deg, ${theme.palette.primary.main} 0%, ${theme.palette.secondary.main} 100%)`,
          borderRadius: 1,
          overflow: 'hidden',
          boxShadow: theme.palette.mode === 'dark'
            ? '0 4px 20px rgba(0, 0, 0, 0.3)'
            : '0 4px 20px rgba(0, 0, 0, 0.08)',
          mb: 3
        }}
      >
        <Box sx={{ 
          p: 3, 
          display: 'flex', 
          flexDirection: { xs: 'column', md: 'row' }, 
          justifyContent: 'space-between',
          alignItems: { xs: 'flex-start', md: 'center' },
          gap: 2,
          position: 'relative',
          zIndex: 1
        }}>
          {/* InformaciÃ³n principal */}
          <Box sx={{ flex: 1 }}>
            <Typography variant="overline" sx={{ 
              fontWeight: 600, 
              fontSize: '0.7rem', 
              color: 'rgba(255, 255, 255, 0.8)',
              letterSpacing: 1.2
            }}>
              FINANZAS â€¢ NUEVO PAGO
            </Typography>
            <Typography variant="h4" sx={{ 
              fontWeight: 700, 
              mt: 0.5, 
              mb: 0.5,
              color: 'white',
              display: 'flex',
              alignItems: 'center',
              gap: 1
            }}>
              ðŸ’³ Registrar Pago de Compromiso
            </Typography>
            <Typography variant="body1" sx={{ 
              color: 'rgba(255, 255, 255, 0.9)'
            }}>
              Seleccione un compromiso pendiente y registre su pago
            </Typography>
          </Box>

          {/* Acciones */}
          <Box sx={{ 
            display: 'flex', 
            gap: 1,
            alignItems: 'center'
          }}>
            {/* BotÃ³n de refresh */}
            <IconButton
              size="small"
              onClick={handleRefresh}
              disabled={refreshing}
              sx={{
                bgcolor: 'rgba(255, 255, 255, 0.15)',
                color: 'white',
                borderRadius: 1,
                p: 0.5,
                backdropFilter: 'blur(10px)',
                '&:hover': {
                  bgcolor: 'rgba(255, 255, 255, 0.25)'
                }
              }}
            >
              {refreshing ? (
                <CircularProgress size={16} sx={{ color: 'white' }} />
              ) : (
                <RefreshIcon fontSize="small" />
              )}
            </IconButton>

            {/* BotÃ³n de regresar */}
            <Button
              size="small"
              variant="outlined"
              startIcon={<ArrowBackIcon />}
              onClick={() => navigate('/payments')}
              sx={{
                textTransform: 'none',
                fontWeight: 600,
                borderRadius: 1,
                fontSize: '0.75rem',
                height: 32,
                px: 2,
                borderColor: 'rgba(255, 255, 255, 0.3)',
                color: 'white',
                backdropFilter: 'blur(10px)',
                '&:hover': {
                  borderColor: 'rgba(255, 255, 255, 0.5)',
                  bgcolor: 'rgba(255, 255, 255, 0.1)'
                }
              }}
            >
              Regresar
            </Button>
          </Box>
        </Box>
      </Paper>

      {/* Progress Stepper */}
      <Paper sx={{ 
        p: 3, 
        mb: 3,
        borderRadius: 2,
        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
        border: `1px solid ${alpha(theme.palette.primary.main, 0.6)}`
      }}>
        <Stepper activeStep={selectedCommitment ? 1 : 0} alternativeLabel>
          {steps.map((label) => (
            <Step key={label}>
              <StepLabel>{label}</StepLabel>
            </Step>
          ))}
        </Stepper>
      </Paper>

      <form onSubmit={handleSubmit}>
        <Grid container spacing={3}>
          {/* InformaciÃ³n Principal */}
          <Grid item xs={12} lg={8}>
            <Card sx={{
              borderRadius: 2,
              boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
              border: `1px solid ${alpha(theme.palette.primary.main, 0.6)}`
            }}>
              <CardContent>
                <Typography variant="h6" gutterBottom sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                  <ScheduleIcon color="primary" />
                  Seleccionar Compromiso Pendiente
                </Typography>
                
                <Grid container spacing={3}>
                  {/* Selector de Compromiso Pendiente */}
                  <Grid item xs={12}>
                    <Autocomplete
                      options={pendingCommitments}
                      getOptionLabel={(option) => option.displayName || ''}
                      loading={loadingCommitments}
                      value={selectedCommitment}
                      onChange={(event, newValue) => handleCommitmentSelect(newValue)}
                      noOptionsText={
                        loadingCommitments 
                          ? "Cargando compromisos..." 
                          : "No hay compromisos pendientes sin pago registrado"
                      }
                      renderInput={(params) => (
                        <TextField
                          {...params}
                          label="Compromiso a Pagar"
                          placeholder={
                            pendingCommitments.length === 0 && !loadingCommitments
                              ? "No hay compromisos disponibles para pagar..."
                              : "Seleccione un compromiso pendiente..."
                          }
                          fullWidth
                          required
                          helperText={
                            pendingCommitments.length === 0 && !loadingCommitments
                              ? "Solo se muestran compromisos pendientes que aÃºn no tienen pagos registrados"
                              : ""
                          }
                          InputProps={{
                            ...params.InputProps,
                            startAdornment: (
                              <InputAdornment position="start">
                                <CompanyIcon color="primary" />
                              </InputAdornment>
                            ),
                            endAdornment: (
                              <>
                                {loadingCommitments ? <CircularProgress color="inherit" size={20} /> : null}
                                {params.InputProps.endAdornment}
                              </>
                            ),
                          }}
                        />
                      )}
                      renderOption={(props, option) => {
                        const { key, ...otherProps } = props;
                        return (
                          <li key={key} {...otherProps}>
                            <Box sx={{ display: 'flex', flexDirection: 'column', width: '100%' }}>
                              <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <Typography variant="body1" fontWeight={600}>
                                  {/* ðŸŽ¯ MOSTRAR ICONO SEGÃšN TIPO */}
                                  {option.type === 'installment' ? 'ðŸ’³ ' : 'ðŸ“‹ '}
                                  {option.companyName}
                                </Typography>
                                <Chip 
                                  label={option.formattedAmount} 
                                  size="small" 
                                  color={option.type === 'installment' ? 'secondary' : 'primary'}
                                  variant="outlined"
                                />
                              </Box>
                              
                              <Typography variant="body2" color="text.secondary">
                                {option.concept}
                              </Typography>
                              
                              {/* ðŸ“Š INFORMACIÃ“N ESPECIAL PARA CUOTAS */}
                              {option.type === 'installment' && option.installmentInfo && (
                                <Typography variant="caption" sx={{ 
                                  color: 'secondary.main',
                                  fontWeight: 500,
                                  mt: 0.5,
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: 0.5
                                }}>
                                  ðŸ’³ {option.installmentInfo.planSummary}
                                  {option.installmentPlan && option.installmentPlan.paidCount > 0 && (
                                    ` â€¢ Pagadas: ${option.installmentPlan.paidCount}/${option.installmentPlan.totalInstallments}`
                                  )}
                                </Typography>
                              )}
                              
                              <Box sx={{ display: 'flex', justifyContent: 'space-between', mt: 0.5 }}>
                                <Typography variant="caption" color="warning.main">
                                  Vencimiento: {option.formattedDueDate}
                                </Typography>
                                
                                {/* ðŸ·ï¸ BADGE DE TIPO */}
                                <Chip
                                  label={option.type === 'installment' ? 'Cuota' : 'Compromiso'}
                                  size="small"
                                  variant="filled"
                                  color={option.type === 'installment' ? 'secondary' : 'default'}
                                  sx={{ 
                                    height: 16, 
                                    fontSize: '0.65rem',
                                    '& .MuiChip-label': { px: 0.8 }
                                  }}
                                />
                              </Box>
                            </Box>
                          </li>
                        );
                      }}
                    />
                  </Grid>

                  {/* InformaciÃ³n del Compromiso Seleccionado */}
                  {selectedCommitment && (
                    <>
                      <Grid item xs={12}>
                        <Card 
                          variant="outlined"
                          sx={{ 
                            mt: 2,
                            bgcolor: 'background.paper',
                            borderRadius: 2,
                            boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                            border: `1px solid ${alpha(theme.palette.success.main, 0.6)}`
                          }}
                        >
                          <CardContent sx={{ py: 2 }}>
                            <Typography variant="subtitle1" sx={{ 
                              fontWeight: 600,
                              color: 'text.primary',
                              mb: 1.5,
                              display: 'flex',
                              alignItems: 'center',
                              gap: 1
                            }}>
                              {/* ðŸŽ¯ ICONO DINÃMICO SEGÃšN TIPO */}
                              {selectedCommitment.type === 'installment' ? (
                                <CreditCardIcon color="secondary" fontSize="small" />
                              ) : (
                                <CompanyIcon color="action" fontSize="small" />
                              )}
                              {selectedCommitment.companyName}
                              
                              {/* ðŸ·ï¸ BADGE SEGÃšN TIPO */}
                              <Chip
                                label={selectedCommitment.type === 'installment' ? 'Cuota Pendiente' : 'Compromiso'}
                                size="small"
                                variant="filled"
                                color={selectedCommitment.type === 'installment' ? 'secondary' : 'primary'}
                                sx={{ 
                                  height: 20, 
                                  fontSize: '0.7rem',
                                  '& .MuiChip-label': { px: 1 }
                                }}
                              />
                            </Typography>
                            
                            <Grid container spacing={2}>
                              <Grid item xs={12} md={6}>
                                <Typography variant="body2" color="text.secondary">
                                  <strong>Concepto:</strong> {selectedCommitment.concept}
                                </Typography>
                              </Grid>
                              
                              {/* ðŸ“Š INFORMACIÃ“N ESPECÃFICA DE CUOTAS */}
                              {selectedCommitment.type === 'installment' && selectedCommitment.installmentInfo && (
                                <>
                                  <Grid item xs={12} md={6}>
                                    <Typography variant="body2" color="secondary.main" sx={{ fontWeight: 500 }}>
                                      <strong>Plan de Pagos:</strong> {selectedCommitment.installmentInfo.planSummary}
                                    </Typography>
                                  </Grid>
                                  
                                  {selectedCommitment.installmentPlan && (
                                    <>
                                      <Grid item xs={12} md={6}>
                                        <Typography variant="body2" color="success.main" sx={{ fontWeight: 500 }}>
                                          <strong>Cuotas Pagadas:</strong> {selectedCommitment.installmentPlan.paidCount || 0} de {selectedCommitment.installmentPlan.totalInstallments}
                                        </Typography>
                                      </Grid>
                                      
                                      <Grid item xs={12} md={6}>
                                        <Typography variant="body2" color="warning.main" sx={{ fontWeight: 500 }}>
                                          <strong>Saldo Pendiente:</strong> {new Intl.NumberFormat('es-CO', {
                                            style: 'currency',
                                            currency: 'COP',
                                            minimumFractionDigits: 0
                                          }).format(selectedCommitment.installmentPlan.remainingAmount || 0)}
                                        </Typography>
                                      </Grid>
                                    </>
                                  )}
                                  
                                  {selectedCommitment.parentPaymentId && (
                                    <Grid item xs={12}>
                                      <Typography variant="caption" color="text.secondary" sx={{ 
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: 0.5,
                                        fontStyle: 'italic'
                                      }}>
                                        ðŸ”— Pago relacionado: {selectedCommitment.parentPaymentId.slice(0, 8)}...
                                      </Typography>
                                    </Grid>
                                  )}
                                </>
                              )}
                              
                              {selectedCommitment.beneficiary && (
                                <Grid item xs={12} md={6}>
                                  <Typography variant="body2" color="primary.main" sx={{ 
                                    fontWeight: 500,
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: 0.5
                                  }}>
                                    <PersonIcon fontSize="small" />
                                    <strong>Proveedor:</strong> {selectedCommitment.beneficiary}
                                  </Typography>
                                </Grid>
                              )}
                              
                              <Grid item xs={12} md={6}>
                                <Typography variant="body2" color="text.secondary">
                                  <strong>Vencimiento:</strong> {selectedCommitment.formattedDueDate}
                                </Typography>
                              </Grid>
                            
                            {/* BotÃ³n para ver factura - Solo si existe */}
                            {invoiceUrl && (
                              <Grid item xs={12} sx={{ mt: 1 }}>
                                <Button
                                  variant="text"
                                  size="small"
                                  startIcon={<ViewIcon />}
                                  onClick={handleOpenPdfViewer}
                                  sx={{ 
                                    color: 'primary.main',
                                    textTransform: 'none',
                                    fontWeight: 500,
                                    fontSize: '0.875rem',
                                    '&:hover': {
                                      backgroundColor: 'action.hover'
                                    }
                                  }}
                                >
                                  Ver Factura Original
                                </Button>
                              </Grid>
                            )}
                          </Grid>
                          </CardContent>
                        </Card>
                      </Grid>

                      <Grid item xs={12} sm={4}>
                        <TextField
                          label="Valor Original"
                          value={new Intl.NumberFormat('es-CO', {
                            style: 'currency',
                            currency: 'COP',
                            minimumFractionDigits: 0
                          }).format(formData.originalAmount)}
                          fullWidth
                          disabled
                          InputProps={{
                            startAdornment: (
                              <InputAdornment position="start">
                                <MoneyIcon 
                                  sx={{ 
                                    color: 'success.main'
                                  }} 
                                />
                              </InputAdornment>
                            ),
                          }}
                        />
                      </Grid>

                      {/* Alerta de pago tardÃ­o al lado del valor original */}
                      {requiresInterests(selectedCommitment, formData.date) && (
                        <Grid item xs={12} sm={8}>
                          <Box sx={{ 
                            p: 1.5,
                            bgcolor: 'grey.50',
                            border: '1px solid',
                            borderColor: 'grey.300',
                            borderRadius: 1,
                            display: 'flex',
                            alignItems: 'center',
                            gap: 1.5,
                            height: '56px' // Mismo alto que el TextField
                          }}>
                            <InterestIcon color="action" fontSize="small" />
                            <Typography variant="body2" color="text.secondary" sx={{ fontSize: '0.875rem' }}>
                              {isColjuegosCommitment(selectedCommitment) 
                                ? "Pago posterior al vencimiento - Calcular intereses especÃ­ficos de Coljuegos"
                                : "Pago posterior al vencimiento - Calcular intereses por mora"
                              }
                            </Typography>
                          </Box>
                        </Grid>
                      )}

                      {/* Campos de Intereses - Solo cuando la fecha de pago es posterior al vencimiento */}
                      {requiresInterests(selectedCommitment, formData.date) ? (
                        <>
                          {(() => {
                            const isColj = isColjuegosCommitment(selectedCommitment);
                            console.log('Rendering interest fields - Is Coljuegos:', isColj);
                            return isColj;
                          })() ? (
                            <>
                              {/* Intereses especÃ­ficos para Coljuegos */}
                              <Grid item xs={12} sm={4}>
                                <TextField
                                  label="Intereses Derechos de ExplotaciÃ³n"
                                  value={formData.interesesDerechosExplotacion !== undefined ? formatCurrency(formData.interesesDerechosExplotacion) : ''}
                                  onChange={(e) => {
                                    const numericValue = parseCurrency(e.target.value);
                                    setFormData(prev => ({
                                      ...prev,
                                      interesesDerechosExplotacion: numericValue,
                                      finalAmount: prev.originalAmount + numericValue + prev.interesesGastosAdministracion
                                    }));
                                  }}
                                  fullWidth
                                  placeholder="0"
                                  error={errors.interests && formData.interesesDerechosExplotacion === 0 && formData.interesesGastosAdministracion === 0}
                                  InputProps={{
                                    startAdornment: (
                                      <InputAdornment position="start">
                                        <InterestIcon 
                                          sx={{ 
                                            color: 'warning.main',
                                            transition: 'color 0.2s ease'
                                          }} 
                                        />
                                        <Typography sx={{ ml: 0.5, color: 'text.secondary', fontWeight: 600 }}>
                                          $
                                        </Typography>
                                      </InputAdornment>
                                    ),
                                  }}
                                  sx={{
                                    '& .MuiOutlinedInput-root': {
                                      '&:hover': {
                                        '& .MuiOutlinedInput-notchedOutline': {
                                          borderColor: 'primary.main'
                                        },
                                        '& .MuiInputAdornment-root .MuiSvgIcon-root': {
                                          color: 'primary.main'
                                        }
                                      },
                                      '&.Mui-focused': {
                                        '& .MuiInputAdornment-root .MuiSvgIcon-root': {
                                          color: 'primary.main'
                                        }
                                      }
                                    }
                                  }}
                                  helperText="Para derechos de explotaciÃ³n"
                                />
                              </Grid>

                              <Grid item xs={12} sm={4}>
                                <TextField
                                  label="Intereses Gastos de AdministraciÃ³n"
                                  value={formData.interesesGastosAdministracion !== undefined ? formatCurrency(formData.interesesGastosAdministracion) : ''}
                                  onChange={(e) => {
                                    const numericValue = parseCurrency(e.target.value);
                                    setFormData(prev => ({
                                      ...prev,
                                      interesesGastosAdministracion: numericValue,
                                      finalAmount: prev.originalAmount + prev.interesesDerechosExplotacion + numericValue
                                    }));
                                  }}
                                  fullWidth
                                  placeholder="0"
                                  error={errors.interests && formData.interesesDerechosExplotacion === 0 && formData.interesesGastosAdministracion === 0}
                                  InputProps={{
                                    startAdornment: (
                                      <InputAdornment position="start">
                                        <InterestIcon 
                                          sx={{ 
                                            color: 'error.main',
                                            transition: 'color 0.2s ease'
                                          }} 
                                        />
                                        <Typography sx={{ ml: 0.5, color: 'text.secondary', fontWeight: 600 }}>
                                          $
                                        </Typography>
                                      </InputAdornment>
                                    ),
                                  }}
                                  sx={{
                                    '& .MuiOutlinedInput-root': {
                                      '&:hover': {
                                        '& .MuiOutlinedInput-notchedOutline': {
                                          borderColor: 'primary.main'
                                        },
                                        '& .MuiInputAdornment-root .MuiSvgIcon-root': {
                                          color: 'primary.main'
                                        }
                                      },
                                      '&.Mui-focused': {
                                        '& .MuiInputAdornment-root .MuiSvgIcon-root': {
                                          color: 'primary.main'
                                        }
                                      }
                                    }
                                  }}
                                  helperText="Para gastos de administraciÃ³n"
                                />
                              </Grid>

                              <Grid item xs={12} sm={4}>
                                <TextField
                                  label="Total Intereses"
                                  value={new Intl.NumberFormat('es-CO', {
                                    style: 'currency',
                                    currency: 'COP',
                                    minimumFractionDigits: 0
                                  }).format(formData.interesesDerechosExplotacion + formData.interesesGastosAdministracion)}
                                  fullWidth
                                  disabled
                                  InputProps={{
                                    startAdornment: (
                                      <InputAdornment position="start">
                                        <InterestIcon 
                                          sx={{ 
                                            color: 'secondary.main'
                                          }} 
                                        />
                                      </InputAdornment>
                                    ),
                                  }}
                                  helperText="Suma de ambos tipos de intereses"
                                />
                              </Grid>
                            </>
                          ) : (
                            <>
                              {/* Intereses regulares para otros compromisos */}
                              <Grid item xs={12} sm={6}>
                                <TextField
                                  label="Intereses por Mora"
                                  value={formData.interests !== undefined ? formatCurrency(formData.interests) : ''}
                                  onChange={(e) => {
                                    const numericValue = parseCurrency(e.target.value);
                                    setFormData(prev => ({
                                      ...prev,
                                      interests: numericValue,
                                      finalAmount: prev.originalAmount + numericValue
                                    }));
                                  }}
                                  fullWidth
                                  placeholder="0"
                                  error={errors.interests && formData.interests === 0}
                                  helperText={errors.interests && formData.interests === 0 ? "Requerido para pagos tardÃ­os" : "Monto de intereses por mora (puede ser $0)"}
                                  InputProps={{
                                    startAdornment: (
                                      <InputAdornment position="start">
                                        <InterestIcon 
                                          sx={{ 
                                            color: 'warning.main',
                                            transition: 'color 0.2s ease'
                                          }} 
                                        />
                                        <Typography sx={{ ml: 0.5, color: 'text.secondary', fontWeight: 600 }}>
                                          $
                                        </Typography>
                                      </InputAdornment>
                                    ),
                                  }}
                                  sx={{
                                    '& .MuiOutlinedInput-root': {
                                      '&:hover': {
                                        '& .MuiOutlinedInput-notchedOutline': {
                                          borderColor: 'primary.main'
                                        },
                                        '& .MuiInputAdornment-root .MuiSvgIcon-root': {
                                          color: 'primary.main'
                                        }
                                      },
                                      '&.Mui-focused': {
                                        '& .MuiInputAdornment-root .MuiSvgIcon-root': {
                                          color: 'primary.main'
                                        }
                                      }
                                    }
                                  }}
                                />
                              </Grid>

                              <Grid item xs={12} sm={6}>
                                {/* Espacio vacÃ­o para mantener layout */}
                              </Grid>
                            </>
                          )}
                        </>
                      ) : (
                        <>
                          {/* Mensaje cuando no se requieren intereses */}
                          <Grid item xs={12}>
                            <Typography variant="body2" color="success.main" sx={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: 1,
                              mt: 1,
                              fontWeight: 500
                            }}>
                              âœ… Pago a tiempo - Sin intereses adicionales
                            </Typography>
                          </Grid>
                        </>
                      )}

                      <Grid item xs={12} sm={4}>
                        <TextField
                          label="Total a Pagar"
                          value={new Intl.NumberFormat('es-CO', {
                            style: 'currency',
                            currency: 'COP',
                            minimumFractionDigits: 0
                          }).format(formData.finalAmount)}
                          fullWidth
                          disabled
                          InputProps={{
                            startAdornment: (
                              <InputAdornment position="start">
                                <MoneyIcon 
                                  sx={{ 
                                    color: 'primary.main'
                                  }} 
                                />
                              </InputAdornment>
                            ),
                          }}
                          sx={{
                            '& .MuiInputBase-input': {
                              fontWeight: 600,
                              color: 'primary.main',
                              fontSize: '1rem'
                            }
                          }}
                        />
                      </Grid>

                      {/* Campo visual del 4x1000 - Visible cuando hay monto vÃ¡lido */}
                      {formData.finalAmount > 0 && (
                        <Grid item xs={12} sm={4}>
                          <TextField
                            label="4x1000 (AutomÃ¡tico)"
                            value={new Intl.NumberFormat('es-CO', {
                              style: 'currency',
                              currency: 'COP',
                              minimumFractionDigits: 0
                            }).format(formData.tax4x1000)}
                            fullWidth
                            disabled
                            InputProps={{
                              startAdornment: (
                                <InputAdornment position="start">
                                  <ReceiptIcon 
                                    sx={{ 
                                      color: 'info.main'
                                    }} 
                                  />
                                </InputAdornment>
                              ),
                            }}
                            helperText="Se registra automÃ¡ticamente"
                          />
                        </Grid>
                      )}

                      <Grid item xs={12}>
                        {/* Espaciador visual */}
                        <Box sx={{ my: 1 }} />
                      </Grid>

                      {/* ðŸ’³ SECCIÃ“N DE CUOTAS */}
                      {formData.finalAmount > 0 && (
                        <>
                          <Grid item xs={12}>
                            <Box
                              sx={{
                                p: 2,
                                borderRadius: 2,
                                bgcolor: alpha(theme.palette.primary.main, 0.05),
                                border: `1px solid ${alpha(theme.palette.primary.main, 0.2)}`,
                                transition: 'all 0.3s ease'
                              }}
                            >
                              <FormControlLabel
                                control={
                                  <Checkbox
                                    checked={useInstallments}
                                    onChange={(e) => handleInstallmentToggle(e.target.checked)}
                                    color="primary"
                                    icon={<PendingIcon />}
                                    checkedIcon={<InstallmentIcon />}
                                  />
                                }
                                label={
                                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                    <Typography variant="subtitle1" fontWeight={600}>
                                      Dividir en cuotas mensuales
                                    </Typography>
                                    <Chip
                                      size="small"
                                      label="Nuevo"
                                      color="primary"
                                      variant="outlined"
                                    />
                                  </Box>
                                }
                              />
                              
                              <Typography variant="body2" color="text.secondary" sx={{ ml: 4 }}>
                                Divide el pago en 2-6 cuotas mensuales programadas
                              </Typography>

                              {useInstallments && (
                                <Collapse in={useInstallments}>
                                  <Box sx={{ mt: 2, ml: 4 }}>
                                    <Grid container spacing={2} alignItems="center">
                                      <Grid item xs={12} sm={4}>
                                        <FormControl fullWidth size="small">
                                          <InputLabel>NÃºmero de cuotas</InputLabel>
                                          <Select
                                            value={installmentPlan.numberOfInstallments}
                                            label="NÃºmero de cuotas"
                                            onChange={(e) => handleInstallmentNumberChange(e.target.value)}
                                          >
                                            {[2, 3, 4, 5, 6].map(num => (
                                              <MenuItem key={num} value={num}>
                                                {num} cuotas
                                              </MenuItem>
                                            ))}
                                          </Select>
                                        </FormControl>
                                      </Grid>
                                      
                                      <Grid item xs={12} sm={4}>
                                        <Button
                                          variant="outlined"
                                          startIcon={<TimelineIcon />}
                                          onClick={openInstallmentModal}
                                          size="small"
                                          fullWidth
                                        >
                                          Ver cronograma
                                        </Button>
                                      </Grid>

                                      {installmentPreview.length > 0 && (
                                        <Grid item xs={12}>
                                          <Box
                                            sx={{
                                              mt: 1,
                                              p: 2,
                                              bgcolor: alpha(theme.palette.success.main, 0.05),
                                              border: `1px solid ${alpha(theme.palette.success.main, 0.2)}`,
                                              borderRadius: 1
                                            }}
                                          >
                                            <Typography variant="body2" color="success.main" fontWeight={600}>
                                              âœ… Plan confirmado: {installmentPreview.length} cuotas de{' '}
                                              {formatCurrencyDisplay(installmentPreview[0]?.amount || 0)} aprox.
                                            </Typography>
                                            <Typography variant="caption" color="text.secondary" sx={{ mt: 0.5, display: 'block' }}>
                                              Primera cuota se paga inmediatamente, las demÃ¡s quedan programadas mensualmente
                                            </Typography>
                                          </Box>
                                        </Grid>
                                      )}
                                    </Grid>
                                  </Box>
                                </Collapse>
                              )}
                            </Box>
                          </Grid>
                        </>
                      )}

                      {/* Campo de cuenta de origen */}
                      <Grid item xs={12} sm={6}>
                        <FormControl fullWidth error={!!errors.sourceAccount}>
                          <InputLabel>Cuenta de Origen</InputLabel>
                          <Select
                            value={formData.sourceAccount}
                            label="Cuenta de Origen"
                            onChange={(e) => handleSourceAccountSelect(e.target.value)}
                            disabled={loadingCompanies}
                            startAdornment={
                              <InputAdornment position="start">
                                <CompanyIcon 
                                  sx={{ 
                                    color: 'success.main',
                                    transition: 'color 0.2s ease',
                                    '.MuiOutlinedInput-root:hover &': {
                                      color: 'primary.main'
                                    },
                                    '.MuiOutlinedInput-root.Mui-focused &': {
                                      color: 'primary.main'
                                    }
                                  }} 
                                />
                              </InputAdornment>
                            }
                            sx={{
                              '&:hover .MuiOutlinedInput-notchedOutline': {
                                borderColor: 'primary.main'
                              }
                            }}
                          >
                            <MenuItem value="">
                              <em>Seleccionar cuenta de origen</em>
                            </MenuItem>
                            {getBankAccounts().map((account) => (
                              <MenuItem 
                                key={`${account.id}-${account.bankAccount}`} 
                                value={account.bankAccount}
                              >
                                <Box sx={{ display: 'flex', alignItems: 'center', width: '100%' }}>
                                  <Box sx={{ mr: 1 }}>
                                    {account.type === 'personal' ? <PersonIcon fontSize="small" /> : <CompanyIcon fontSize="small" />}
                                  </Box>
                                  <Box>
                                    <Typography variant="body2" fontWeight="medium">
                                      {account.bankAccount}
                                    </Typography>
                                    <Typography variant="caption" color="text.secondary">
                                      {account.bankName} - {account.companyName} {account.type === 'personal' ? '(Personal)' : '(Empresarial)'}
                                    </Typography>
                                  </Box>
                                </Box>
                              </MenuItem>
                            ))}
                            {getBankAccounts().length === 0 && (
                              <MenuItem disabled>
                                <Typography variant="body2" color="text.secondary">
                                  {loadingCompanies ? 'Cargando...' : 'No hay cuentas bancarias registradas'}
                                </Typography>
                              </MenuItem>
                            )}
                          </Select>
                        </FormControl>
                      </Grid>

                      {/* Campo de banco (autocompletado) */}
                      <Grid item xs={12} sm={6}>
                        <TextField
                          label="Banco de Origen"
                          value={formData.sourceBank}
                          fullWidth
                          disabled={true}
                          placeholder="Se autocompleta al seleccionar cuenta"
                          helperText="Se completa automÃ¡ticamente al seleccionar una cuenta"
                          InputProps={{
                            startAdornment: (
                              <InputAdornment position="start">
                                <CompanyIcon 
                                  sx={{ 
                                    color: 'success.light'
                                  }} 
                                />
                              </InputAdornment>
                            ),
                          }}
                          sx={{
                            '& .MuiOutlinedInput-root': {
                              backgroundColor: theme.palette.action.hover,
                            },
                            '& .MuiInputLabel-root.Mui-disabled': {
                              color: theme.palette.text.secondary
                            }
                          }}
                        />
                      </Grid>

                      {/* Mensaje informativo sobre cuentas bancarias */}
                      {getBankAccounts().length === 0 && !loadingCompanies && (
                        <Grid item xs={12}>
                          <Alert 
                            severity="info" 
                            variant="outlined"
                            sx={{ mt: 1 }}
                          >
                            <Typography variant="body2">
                              <strong>ðŸ’¡ Tip:</strong> Para registrar cuentas de origen, agrega informaciÃ³n bancaria en la secciÃ³n de Empresas o en Cuentas Personales desde el menÃº principal.
                            </Typography>
                          </Alert>
                        </Grid>
                      )}

                      <Grid item xs={12} sm={6}>
                        <FormControl fullWidth error={!!errors.method}>
                          <InputLabel>MÃ©todo de Pago</InputLabel>
                          <Select
                            value={formData.method}
                            onChange={handleInputChange('method')}
                            label="MÃ©todo de Pago"
                            startAdornment={
                              <InputAdornment position="start">
                                <ReceiptIcon 
                                  sx={{ 
                                    color: 'secondary.main',
                                    transition: 'color 0.2s ease',
                                    '.MuiOutlinedInput-root:hover &': {
                                      color: 'primary.main'
                                    },
                                    '.MuiOutlinedInput-root.Mui-focused &': {
                                      color: 'primary.main'
                                    }
                                  }} 
                                />
                              </InputAdornment>
                            }
                            sx={{
                              '&:hover .MuiOutlinedInput-notchedOutline': {
                                borderColor: 'primary.main'
                              }
                            }}
                          >
                            {paymentMethods.map((method) => (
                              <MenuItem key={method} value={method}>
                                {method}
                              </MenuItem>
                            ))}
                          </Select>
                        </FormControl>
                      </Grid>

                      <Grid item xs={12} sm={6}>
                        <TextField
                          label="Referencia/ID del Pago"
                          value={formData.reference}
                          onChange={handleInputChange('reference')}
                          fullWidth
                          error={!!errors.reference}
                          helperText={errors.reference}
                          placeholder="Ej: TRF-2025-001, CHE-12345"
                          InputProps={{
                            startAdornment: (
                              <InputAdornment position="start">
                                <AttachIcon 
                                  sx={{ 
                                    color: 'info.main',
                                    transition: 'color 0.2s ease'
                                  }} 
                                />
                              </InputAdornment>
                            ),
                          }}
                          sx={{
                            '& .MuiOutlinedInput-root': {
                              '&:hover': {
                                '& .MuiOutlinedInput-notchedOutline': {
                                  borderColor: 'primary.main'
                                },
                                '& .MuiInputAdornment-root .MuiSvgIcon-root': {
                                  color: 'primary.main'
                                }
                              },
                              '&.Mui-focused': {
                                '& .MuiInputAdornment-root .MuiSvgIcon-root': {
                                  color: 'primary.main'
                                }
                              }
                            }
                          }}
                        />
                      </Grid>

                      <Grid item xs={12} sm={6}>
                        <TextField
                          label="Fecha del Pago"
                          type="date"
                          value={formData.date}
                          onChange={handleInputChange('date')}
                          fullWidth
                          error={!!errors.date}
                          helperText={errors.date}
                          InputLabelProps={{
                            shrink: true,
                          }}
                          InputProps={{
                            startAdornment: (
                              <InputAdornment position="start">
                                <ScheduleIcon 
                                  sx={{ 
                                    color: 'warning.main',
                                    transition: 'color 0.2s ease'
                                  }} 
                                />
                              </InputAdornment>
                            ),
                          }}
                          sx={{
                            '& .MuiOutlinedInput-root': {
                              '&:hover': {
                                '& .MuiOutlinedInput-notchedOutline': {
                                  borderColor: 'primary.main'
                                },
                                '& .MuiInputAdornment-root .MuiSvgIcon-root': {
                                  color: 'primary.main'
                                }
                              },
                              '&.Mui-focused': {
                                '& .MuiInputAdornment-root .MuiSvgIcon-root': {
                                  color: 'primary.main'
                                }
                              }
                            }
                          }}
                        />
                      </Grid>

                      <Grid item xs={12} sm={6}>
                        <TextField
                          label="Observaciones"
                          value={formData.notes}
                          onChange={handleInputChange('notes')}
                          fullWidth
                          multiline
                          rows={1}
                          placeholder="Notas adicionales sobre el pago..."
                          InputProps={{
                            startAdornment: (
                              <InputAdornment position="start">
                                <SaveIcon 
                                  sx={{ 
                                    color: 'grey.600',
                                    transition: 'color 0.2s ease'
                                  }} 
                                />
                              </InputAdornment>
                            ),
                          }}
                          sx={{
                            '& .MuiOutlinedInput-root': {
                              '&:hover': {
                                '& .MuiOutlinedInput-notchedOutline': {
                                  borderColor: 'primary.main'
                                },
                                '& .MuiInputAdornment-root .MuiSvgIcon-root': {
                                  color: 'primary.main'
                                }
                              },
                              '&.Mui-focused': {
                                '& .MuiInputAdornment-root .MuiSvgIcon-root': {
                                  color: 'primary.main'
                                }
                              }
                            }
                          }}
                        />
                      </Grid>

                      {/* SecciÃ³n de carga de archivos */}
                      <Grid item xs={12}>
                        <Typography variant="body1" gutterBottom sx={{ 
                          fontWeight: 600, 
                          color: 'text.primary',
                          mt: 2
                        }}>
                          Comprobantes de Pago
                        </Typography>
                      </Grid>

                      <Grid item xs={12}>
                        {/* Zona de drag & drop */}
                        <Card 
                          sx={{ 
                            border: dragActive ? `2px dashed ${theme.palette.primary.main}` : `2px dashed ${alpha(theme.palette.primary.main, 0.6)}`,
                            backgroundColor: dragActive ? 'action.hover' : 'background.paper',
                            cursor: 'pointer',
                            transition: 'all 0.3s ease',
                            borderRadius: 2,
                            boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                            '&:hover': {
                              backgroundColor: 'action.hover',
                              borderColor: alpha(theme.palette.primary.main, 0.8)
                            }
                          }}
                          onDragEnter={handleDrag}
                          onDragLeave={handleDrag}
                          onDragOver={handleDrag}
                          onDrop={handleDrop}
                        >
                          <CardContent sx={{ textAlign: 'center', py: 4 }}>
                            <input
                              type="file"
                              multiple
                              accept=".jpg,.jpeg,.png,.pdf"
                              onChange={handleFileSelect}
                              style={{ display: 'none' }}
                              id="file-upload"
                            />
                            <label htmlFor="file-upload" style={{ cursor: 'pointer', width: '100%', display: 'block' }}>
                              <UploadIcon sx={{ fontSize: 48, color: 'primary.main', mb: 2 }} />
                              <Typography variant="h6" gutterBottom>
                                Seleccionar Comprobantes
                              </Typography>
                              <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                                JPG, PNG, PDF (mÃ¡x. 10MB c/u) â€¢ MÃºltiples archivos se combinan en PDF
                              </Typography>
                              <Button
                                variant="outlined"
                                startIcon={<AttachIcon />}
                                component="span"
                              >
                                Examinar Archivos
                              </Button>
                            </label>
                          </CardContent>
                        </Card>
                      </Grid>

                      {/* Lista de archivos seleccionados */}
                      {files.length > 0 && (
                        <Grid item xs={12}>
                          <Typography variant="body2" gutterBottom sx={{ fontWeight: 500 }}>
                            Archivos Seleccionados ({files.length})
                          </Typography>
                          <List dense sx={{ 
                            bgcolor: 'background.paper', 
                            borderRadius: 2,
                            border: `1px solid ${alpha(theme.palette.primary.main, 0.6)}`,
                            boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                          }}>
                            {files.map((fileData) => (
                              <ListItem key={fileData.id} sx={{ py: 0.5 }}>
                                <ListItemIcon sx={{ minWidth: 36 }}>
                                  <FileIcon color={fileData.uploaded ? 'success' : 'default'} />
                                </ListItemIcon>
                                <ListItemText
                                  primary={
                                    <Typography variant="body2" noWrap>
                                      {fileData.name}
                                    </Typography>
                                  }
                                  secondary={`${Math.round(fileData.size / 1024)} KB`}
                                />
                                <ListItemSecondaryAction>
                                  <IconButton
                                    edge="end"
                                    onClick={() => removeFile(fileData.id)}
                                    size="small"
                                    disabled={uploading}
                                  >
                                    <DeleteIcon fontSize="small" />
                                  </IconButton>
                                </ListItemSecondaryAction>
                              </ListItem>
                            ))}
                          </List>
                        </Grid>
                      )}

                      {/* Barra de progreso durante la carga */}
                      {uploading && (
                        <Grid item xs={12}>
                          <Box sx={{ width: '100%', mb: 1 }}>
                            <Typography variant="body2" color="text.secondary">
                              Subiendo archivos... {uploadProgress}%
                            </Typography>
                            <LinearProgress variant="determinate" value={uploadProgress} />
                          </Box>
                        </Grid>
                      )}
                    </>
                  )}
                </Grid>
              </CardContent>
            </Card>
          </Grid>

          {/* Panel de Resumen */}
          <Grid item xs={12} lg={4}>
            <Card 
              sx={{ 
                position: 'sticky', 
                top: 20,
                bgcolor: 'background.paper',
                borderRadius: 2,
                boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                border: `1px solid ${alpha(theme.palette.secondary.main, 0.6)}`
              }}
            >
              <CardContent sx={{ pb: 2 }}>
                <Typography variant="h6" gutterBottom sx={{ 
                  display: 'flex', 
                  alignItems: 'center', 
                  gap: 1,
                  color: 'text.primary',
                  fontWeight: 600
                }}>
                  <ReceiptIcon color="primary" />
                  Resumen de Pago
                </Typography>
                
                {selectedCommitment ? (
                  <Box>
                    {/* Info del compromiso simplificada */}
                    <Box sx={{ 
                      mb: 2, 
                      p: 1.5, 
                      bgcolor: 'grey.50', 
                      borderRadius: 1,
                      border: '1px solid',
                      borderColor: 'grey.200'
                    }}>
                      <Typography variant="body2" sx={{ fontWeight: 600, color: 'text.primary' }}>
                        {selectedCommitment.companyName}
                      </Typography>
                      <Typography variant="caption" color="text.secondary">
                        {selectedCommitment.concept}
                      </Typography>
                    </Box>
                    
                    {/* Breakdown de costos */}
                    <Box sx={{ mb: 2 }}>
                      <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 1 }}>
                        <Typography variant="body2">Valor Base:</Typography>
                        <Typography variant="body2" fontWeight={500}>
                          {new Intl.NumberFormat('es-CO', {
                            style: 'currency',
                            currency: 'COP',
                            minimumFractionDigits: 0
                          }).format(formData.originalAmount)}
                        </Typography>
                      </Box>
                      
                      {/* Intereses - Simplificados */}
                      {(formData.interests > 0 || formData.interesesDerechosExplotacion > 0 || formData.interesesGastosAdministracion > 0) && (
                        <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 1 }}>
                          <Typography variant="body2">Intereses:</Typography>
                          <Typography variant="body2" color="warning.main" fontWeight={500}>
                            +{new Intl.NumberFormat('es-CO', {
                              style: 'currency',
                              currency: 'COP',
                              minimumFractionDigits: 0
                            }).format(
                              formData.interests + 
                              formData.interesesDerechosExplotacion + 
                              formData.interesesGastosAdministracion
                            )}
                          </Typography>
                        </Box>
                      )}
                      
                      <Divider sx={{ my: 1 }} />
                      
                      <Box sx={{ display: 'flex', justifyContent: 'space-between' }}>
                        <Typography variant="h6" color="primary">Total:</Typography>
                        <Typography variant="h6" color="primary" fontWeight={700}>
                          {new Intl.NumberFormat('es-CO', {
                            style: 'currency',
                            currency: 'COP',
                            minimumFractionDigits: 0
                          }).format(formData.finalAmount)}
                        </Typography>
                      </Box>
                    </Box>
                    
                    {/* Mostrar informaciÃ³n del 4x1000 si aplica */}
                    {(formData.method === 'Transferencia' || formData.method === 'PSE') && formData.sourceAccount && formData.tax4x1000 > 0 && (
                      <Typography variant="caption" color="text.secondary" sx={{ display: 'block', mb: 1 }}>
                        + 4x1000: {new Intl.NumberFormat('es-CO', {
                          style: 'currency',
                          currency: 'COP',
                          minimumFractionDigits: 0
                        }).format(formData.tax4x1000)} (registro separado)
                      </Typography>
                    )}

                    {files.length > 0 && (
                      <Typography variant="caption" color="success.main" sx={{ display: 'block', mb: 1 }}>
                        âœ“ {files.length === 1 ? '1 comprobante' : `${files.length} comprobantes`}
                      </Typography>
                    )}
                  </Box>
                ) : (
                  <Box sx={{ 
                    textAlign: 'center', 
                    py: 3,
                    color: 'text.secondary'
                  }}>
                    <ReceiptIcon sx={{ fontSize: 48, opacity: 0.3, mb: 1 }} />
                    <Typography variant="body2">
                      Seleccione un compromiso para ver el resumen
                    </Typography>
                  </Box>
                )}
              </CardContent>
            </Card>
          </Grid>
        </Grid>

        {/* Botones de AcciÃ³n */}
        <Box sx={{ display: 'flex', gap: 2, justifyContent: 'flex-end', mt: 3 }}>
          <Button
            variant="outlined"
            onClick={handleCancel}
            disabled={isSubmitting}
            sx={{ minWidth: 120 }}
          >
            <CancelIcon sx={{ mr: 1 }} />
            Cancelar
          </Button>
          
          <Box sx={{ position: 'relative' }}>
            <Button
              type="submit"
              variant="contained"
              disabled={isSubmitting || uploading}
              sx={{ minWidth: 120 }}
              onClick={() => {
                console.log('ðŸ”˜ BotÃ³n clicked - Estado del formulario:');
                console.log('- isSubmitting:', isSubmitting);
                console.log('- uploading:', uploading);
                console.log('- selectedCommitment:', !!selectedCommitment);
                console.log('- areInterestsComplete():', areInterestsComplete());
                console.log('- requiresInterests:', requiresInterests(selectedCommitment, formData.date));
                console.log('- formData:', formData);
              }}
            >
              {isSubmitting ? (
                <>
                  <CircularProgress size={20} />
                  {savingInstallments ? ' Creando cuotas...' : ''}
                </>
              ) : uploading ? (
                <>
                  <CircularProgress size={16} sx={{ mr: 1 }} />
                  Subiendo...
                </>
              ) : (
                <>
                  {useInstallments && installmentPreview.length > 0 ? (
                    <>
                      <InstallmentIcon sx={{ mr: 1 }} />
                      Crear {installmentPreview.length} Cuotas
                    </>
                  ) : (
                    <>
                      <SaveIcon sx={{ mr: 1 }} />
                      Registrar Pago
                    </>
                  )}
                </>
              )}
            </Button>
            
            {/* Mensaje de ayuda cuando el botÃ³n estÃ¡ deshabilitado por intereses */}
            {selectedCommitment && 
             requiresInterests(selectedCommitment, formData.date) && 
             !areInterestsComplete() && (
              <Typography 
                variant="caption" 
                color="warning.main" 
                sx={{ 
                  position: 'absolute', 
                  top: '100%', 
                  left: 0, 
                  mt: 0.5,
                  fontStyle: 'italic',
                  fontSize: '0.7rem'
                }}
              >
                âš ï¸ Ingrese los intereses para habilitar el pago
              </Typography>
            )}
          </Box>
        </Box>
      </form>

      {/* ðŸ“„ VISOR PDF DE FACTURA DEL COMPROMISO */}
      <Dialog
        open={pdfViewerOpen}
        onClose={handleClosePdfViewer}
        maxWidth={pdfViewerSize === 'large' ? 'xl' : pdfViewerSize === 'small' ? 'sm' : 'lg'}
        fullWidth
        PaperProps={{
          sx: {
            height: pdfViewerSize === 'large' ? '90vh' : pdfViewerSize === 'small' ? '60vh' : '80vh',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            border: '1px solid rgba(255,255,255,0.2)',
            backdropFilter: 'blur(10px)'
          }
        }}
      >
        <DialogTitle sx={{ 
          color: 'white', 
          background: 'rgba(0,0,0,0.2)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between'
        }}>
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
            <PdfIcon />
            <Typography variant="h6">
              ðŸ“„ Factura del Compromiso
            </Typography>
            {selectedCommitment && (
              <Chip 
                label={selectedCommitment.companyName}
                size="small"
                sx={{ 
                  backgroundColor: 'rgba(255,255,255,0.2)',
                  color: 'white'
                }}
              />
            )}
          </Box>
          
          <Box sx={{ display: 'flex', gap: 1 }}>
            <Tooltip title="Cambiar tamaÃ±o">
              <IconButton onClick={toggleViewerSize} sx={{ color: 'white' }}>
                {pdfViewerSize === 'large' ? <MinimizeIcon /> : <MaximizeIcon />}
              </IconButton>
            </Tooltip>
            
            <Tooltip title="Abrir en nueva pestaÃ±a">
              <IconButton onClick={handleOpenInNewTab} sx={{ color: 'white' }}>
                <ExternalLinkIcon />
              </IconButton>
            </Tooltip>
          </Box>
        </DialogTitle>

        <DialogContent sx={{ 
          p: 0, 
          backgroundColor: '#f5f5f5',
          display: 'flex',
          flexDirection: 'column',
          overflow: 'hidden'
        }}>
          {invoiceUrl ? (
            <Box sx={{ 
              flex: 1,
              width: '100%',
              height: '100%',
              display: 'flex',
              justifyContent: 'center',
              alignItems: 'center'
            }}>
              {invoiceUrl.includes('.pdf') ? (
                // Visor PDF
                <iframe
                  src={`${invoiceUrl}#toolbar=1&navpanes=1&scrollbar=1`}
                  style={{
                    width: '100%',
                    height: '100%',
                    border: 'none',
                    backgroundColor: 'white'
                  }}
                  title="Factura del Compromiso"
                />
              ) : (
                // Visor de imagen
                <Box sx={{ 
                  width: '100%', 
                  height: '100%',
                  display: 'flex',
                  justifyContent: 'center',
                  alignItems: 'center',
                  p: 2
                }}>
                  <img
                    src={invoiceUrl}
                    alt="Factura del Compromiso"
                    style={{
                      maxWidth: '100%',
                      maxHeight: '100%',
                      objectFit: 'contain',
                      borderRadius: '8px',
                      boxShadow: '0 4px 20px rgba(0,0,0,0.1)'
                    }}
                  />
                </Box>
              )}
            </Box>
          ) : (
            <Box sx={{ 
              display: 'flex', 
              justifyContent: 'center', 
              alignItems: 'center',
              height: '100%',
              flexDirection: 'column',
              gap: 2
            }}>
              <PdfIcon sx={{ fontSize: 64, color: 'text.secondary' }} />
              <Typography variant="h6" color="text.secondary">
                No hay factura disponible
              </Typography>
              <Typography variant="body2" color="text.secondary" textAlign="center">
                Este compromiso no tiene factura adjunta
              </Typography>
            </Box>
          )}
        </DialogContent>

        <DialogActions sx={{ 
          background: 'rgba(0,0,0,0.1)',
          justifyContent: 'space-between'
        }}>
          <Typography variant="body2" sx={{ color: 'white', ml: 1 }}>
            {selectedCommitment && (
              <>
                ðŸ’¼ {selectedCommitment.concept} â€¢ 
                ðŸ’° {new Intl.NumberFormat('es-CO', {
                  style: 'currency',
                  currency: 'COP',
                  minimumFractionDigits: 0
                }).format(selectedCommitment.amount || 0)}
              </>
            )}
          </Typography>
          
          <Button 
            onClick={handleClosePdfViewer}
            variant="outlined"
            sx={{ 
              color: 'white',
              borderColor: 'white',
              '&:hover': {
                backgroundColor: 'rgba(255,255,255,0.1)'
              }
            }}
          >
            Cerrar
          </Button>
        </DialogActions>
      </Dialog>

      {/* ðŸ—œï¸ DIÃLOGO DE VISTA PREVIA DE COMPRESIÃ“N */}
      <PDFCompressionPreview
        open={compressionPreviewOpen}
        onClose={() => setCompressionPreviewOpen(false)}
        file={pendingPDFFile}
        onAccept={handleCompressionAccept}
        onReject={handleCompressionReject}
      />

      {/* ðŸ’³ MODAL DE CRONOGRAMA DE CUOTAS */}
      <Dialog
        open={installmentModalOpen}
        onClose={() => setInstallmentModalOpen(false)}
        maxWidth="md"
        fullWidth
        PaperProps={{
          sx: {
            borderRadius: 2,
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            border: '1px solid rgba(255,255,255,0.2)',
            backdropFilter: 'blur(10px)'
          }
        }}
      >
        <DialogTitle sx={{ 
          color: 'white', 
          background: 'rgba(0,0,0,0.2)',
          display: 'flex',
          alignItems: 'center',
          gap: 2
        }}>
          <InstallmentIcon />
          <Typography variant="h6">
            Cronograma de Cuotas
          </Typography>
          <Chip 
            label={`${installmentPreview.length} cuotas`}
            size="small"
            sx={{ 
              backgroundColor: 'rgba(255,255,255,0.2)',
              color: 'white'
            }}
          />
        </DialogTitle>

        <DialogContent sx={{ 
          background: 'rgba(255,255,255,0.95)',
          p: 3
        }}>
          <Box sx={{ mb: 3 }}>
            <Typography variant="h6" gutterBottom>
              ðŸ“Š Resumen del Plan
            </Typography>
            <Grid container spacing={2}>
              <Grid item xs={6}>
                <Box sx={{ p: 2, bgcolor: 'primary.main', color: 'white', borderRadius: 1, textAlign: 'center' }}>
                  <Typography variant="body2">Total a dividir</Typography>
                  <Typography variant="h6" fontWeight="bold">
                    {formatCurrencyDisplay(formData.finalAmount)}
                  </Typography>
                </Box>
              </Grid>
              <Grid item xs={6}>
                <Box sx={{ p: 2, bgcolor: 'success.main', color: 'white', borderRadius: 1, textAlign: 'center' }}>
                  <Typography variant="body2">Pago inmediato</Typography>
                  <Typography variant="h6" fontWeight="bold">
                    {formatCurrencyDisplay(installmentPreview[0]?.amount || 0)}
                  </Typography>
                </Box>
              </Grid>
            </Grid>
          </Box>

          <Typography variant="h6" gutterBottom sx={{ mt: 3 }}>
            ðŸ“… Calendario de Pagos
          </Typography>
          
          <TableContainer component={Paper} sx={{ mt: 2, borderRadius: 2 }}>
            <Table size="small">
              <TableHead>
                <TableRow sx={{ bgcolor: 'grey.100' }}>
                  <TableCell><strong>Cuota</strong></TableCell>
                  <TableCell><strong>Monto</strong></TableCell>
                  <TableCell><strong>Fecha de vencimiento</strong></TableCell>
                  <TableCell><strong>Estado</strong></TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {installmentPreview.map((installment, index) => (
                  <TableRow key={index} sx={{ 
                    bgcolor: index === 0 ? alpha(theme.palette.success.main, 0.1) : 'inherit'
                  }}>
                    <TableCell>
                      <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                        {index === 0 ? <PaymentIcon color="success" /> : <DateRangeIcon />}
                        #{installment.installmentNumber}
                      </Box>
                    </TableCell>
                    <TableCell>
                      <Typography fontWeight={index === 0 ? 'bold' : 'normal'}>
                        {formatCurrencyDisplay(installment.amount)}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      {format(installment.dueDate, 'dd/MM/yyyy', { locale: es })}
                    </TableCell>
                    <TableCell>
                      <Chip
                        size="small"
                        icon={index === 0 ? <CheckCircleIcon /> : <PendingIcon />}
                        label={index === 0 ? 'Se paga ahora' : 'Programada'}
                        color={index === 0 ? 'success' : 'warning'}
                        variant={index === 0 ? 'filled' : 'outlined'}
                      />
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>

          <Alert 
            severity="info" 
            sx={{ mt: 3 }}
            icon={<InstallmentIcon />}
          >
            <Typography variant="body2">
              <strong>ðŸ’¡ Â¿CÃ³mo funciona?</strong><br/>
              â€¢ La primera cuota se paga inmediatamente al crear el registro<br/>
              â€¢ Las cuotas restantes quedan programadas para los siguientes meses<br/>
              â€¢ RecibirÃ¡s notificaciones cuando se acerque cada fecha de vencimiento<br/>
              â€¢ Cada cuota se maneja como un pago independiente
            </Typography>
          </Alert>
        </DialogContent>

        <DialogActions sx={{ 
          background: 'rgba(255,255,255,0.9)', 
          p: 2,
          gap: 1
        }}>
          <Button 
            onClick={() => setInstallmentModalOpen(false)}
            color="inherit"
            startIcon={<CancelIcon />}
          >
            Cancelar
          </Button>
          <Button 
            onClick={confirmInstallmentPlan}
            variant="contained"
            color="primary"
            startIcon={<CheckCircleIcon />}
          >
            Confirmar Plan
          </Button>
        </DialogActions>
      </Dialog>
    </Box>
  );
};

// ðŸ”„ FUNCIÃ“N EXPORTABLE PARA ACTUALIZAR CUOTAS DESDE OTRAS PÃGINAS
export const updateInstallmentWhenPaid = async (installmentId, parentPaymentId) => {
  try {
    console.log(`ðŸ’³ Marcando cuota ${installmentId} como pagada...`);
    
    // Actualizar la cuota individual
    await updateDoc(doc(db, 'payments', installmentId), {
      status: 'completed',
      installmentStatus: 'paid',
      paymentDate: Timestamp.now(),
      updatedAt: Timestamp.now()
    });
    
    // Recalcular el resumen del pago principal
    const installmentsQuery = query(
      collection(db, 'payments'),
      where('parentPaymentId', '==', parentPaymentId),
      where('isInstallment', '==', true),
      orderBy('installmentNumber', 'asc')
    );
    
    const installmentsSnapshot = await getDocs(installmentsQuery);
    const installments = [];
    
    installmentsSnapshot.forEach((doc) => {
      installments.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    // Calcular totales
    const totalInstallments = installments.length;
    const paidInstallments = installments.filter(inst => inst.status === 'completed').length;
    const pendingInstallments = totalInstallments - paidInstallments;
    
    const totalPaidAmount = installments
      .filter(inst => inst.status === 'completed')
      .reduce((sum, inst) => sum + inst.amount, 0);
    
    const totalPendingAmount = installments
      .filter(inst => inst.status === 'pending')
      .reduce((sum, inst) => sum + inst.amount, 0);
    
    // Encontrar prÃ³xima cuota pendiente
    const nextPendingInstallment = installments.find(inst => inst.status === 'pending');
    
    // Actualizar el pago principal
    const updateData = {
      installmentMetadata: {
        paidInstallments,
        pendingInstallments,
        totalPaidAmount,
        totalPendingAmount,
        lastUpdated: Timestamp.now(),
        displaySummary: {
          text: `Cuotas pagadas: ${paidInstallments} de ${totalInstallments}`,
          paidText: `Pagado: $${totalPaidAmount.toLocaleString()}`,
          pendingText: `Saldo pendiente: $${totalPendingAmount.toLocaleString()}`,
          nextDueText: nextPendingInstallment ? 
            `PrÃ³ximo vencimiento: ${nextPendingInstallment.dueDate?.toDate?.()?.toLocaleDateString() || 'No definido'}` : 
            'Plan de cuotas completado'
        }
      },
      installmentPlan: {
        ...installments[0]?.installmentPlan || {},
        paidInstallments,
        remainingInstallments: pendingInstallments,
        nextDueDate: nextPendingInstallment?.dueDate || null,
        isCompleted: pendingInstallments === 0,
        lastPaymentDate: Timestamp.now()
      }
    };
    
    await updateDoc(doc(db, 'payments', parentPaymentId), updateData);
    
    console.log('âœ… Cuota marcada como pagada y resumen actualizado:', {
      cuotasPagadas: paidInstallments,
      cuotasPendientes: pendingInstallments,
      montoPagado: totalPaidAmount,
      saldoPendiente: totalPendingAmount
    });
    
    return updateData.installmentMetadata.displaySummary;
    
  } catch (error) {
    console.error('âŒ Error actualizando cuota pagada:', error);
    throw error;
  }
};

export default NewPaymentPage;

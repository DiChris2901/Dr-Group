import React, { useState, useCallback, useMemo } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Button,
  Grid,
  Alert,
  Chip,
  LinearProgress,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  TablePagination,
  Paper,
  TextField,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  IconButton,
  Tooltip,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Divider,
  Stack,
  useTheme,
  alpha
} from '@mui/material';
import {
  CloudUpload,
  Description,
  Search,
  FilterList,
  GetApp,
  Refresh,
  Visibility,
  Analytics,
  Assignment,
  TableView,
  FileDownload,
  CheckCircle,
  Warning,
  Info,
  Error as ErrorIcon,
  Clear,
  PlayArrow,
  Stop,
  Settings,
  DeleteSweep,
  Save,
  RestartAlt,
  FirstPage,
  LastPage,
  KeyboardArrowLeft,
  KeyboardArrowRight,
  Business,
  CalendarToday,
  AttachMoney,
  AccountBalance,
  TrendingUp,
  TrendingDown,
  Casino,
  Factory,
  Receipt,
  MonetizationOn,
  PrecisionManufacturing,
  ExpandMore,
  ExpandLess,
  Store,
  DateRange
} from '@mui/icons-material';
import { motion, AnimatePresence } from 'framer-motion';
import { styled } from '@mui/material/styles';
import useCompanies from '../hooks/useCompanies';

// Utilities para archivos
import * as XLSX from 'xlsx';
import Papa from 'papaparse';
import { saveAs } from 'file-saver';
import ExcelJS from 'exceljs';

// Hooks y Context - AGREGADO useSettings
import { useSettings } from '../context/SettingsContext';

// Design System v2.1 utilities
import {
  animationVariants,
  useThemeGradients,
  shimmerEffect
} from '../utils/designSystem.js';

// Funci√≥n utilitaria para formatear valores como pesos colombianos
const formatCOP = (value) => {
  if (value == null || value === '' || isNaN(value)) return '$0';
  return new Intl.NumberFormat('es-CO', {
    style: 'currency',
    currency: 'COP',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(Number(value));
};

// Styled components con Design System Spectacular v2.1
const StyledContainer = styled(Box)(({ theme }) => ({
  position: 'relative',
  minHeight: '100vh',
  '@keyframes shimmer': {
    '0%': { 
      transform: 'translateX(-100%)',
      opacity: 0.6
    },
    '50%': {
      opacity: 1
    },
    '100%': { 
      transform: 'translateX(100%)',
      opacity: 0.6
    }
  },
  '@keyframes pulse': {
    '0%, 100%': { 
      boxShadow: `0 0 0 0 ${alpha(theme.palette.primary.main, 0.7)}`
    },
    '50%': { 
      boxShadow: `0 0 0 15px ${alpha(theme.palette.primary.main, 0)}`
    }
  },
  '@keyframes glow': {
    '0%': { 
      boxShadow: `0 4px 20px ${alpha(theme.palette.primary.main, 0.3)}`
    },
    '50%': { 
      boxShadow: `0 8px 40px ${alpha(theme.palette.primary.main, 0.6)}`
    },
    '100%': { 
      boxShadow: `0 4px 20px ${alpha(theme.palette.primary.main, 0.3)}`
    }
  },
  '@keyframes float': {
    '0%, 100%': { 
      transform: 'translateY(0px) rotate(0deg)' 
    },
    '33%': { 
      transform: 'translateY(-10px) rotate(1deg)' 
    },
    '66%': { 
      transform: 'translateY(-5px) rotate(-1deg)' 
    }
  }
}));

const UploadZone = styled(Box, {
  shouldForwardProp: (prop) => prop !== 'isDragOver' && prop !== 'hasFile' && prop !== 'borderRadius',
})(({ theme, isDragOver, hasFile, borderRadius }) => ({
  position: 'relative',
  border: `2px dashed ${hasFile ? theme.palette.success.main : isDragOver ? theme.palette.secondary.main : theme.palette.primary.main}`,
  borderRadius: borderRadius || theme.shape.borderRadius,
  padding: theme.spacing(3),
  textAlign: 'center',
  cursor: 'pointer',
  overflow: 'hidden',
  transition: 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
  background: hasFile 
    ? `linear-gradient(135deg, ${alpha(theme.palette.success.main, 0.08)}, ${alpha(theme.palette.success.light, 0.04)})`
    : isDragOver 
      ? `linear-gradient(135deg, ${alpha(theme.palette.secondary.main, 0.15)}, ${alpha(theme.palette.secondary.light, 0.08)})`
      : `linear-gradient(135deg, ${alpha(theme.palette.primary.main, 0.06)}, ${alpha(theme.palette.primary.light, 0.03)})`,
  backdropFilter: 'blur(10px)',
  '&:before': {
    content: '""',
    position: 'absolute',
    top: 0,
    left: '-100%',
    width: '100%',
    height: '100%',
    background: `linear-gradient(90deg, transparent, ${alpha(theme.palette.primary.main, 0.1)}, transparent)`,
    transition: 'left 0.6s ease-in-out',
    pointerEvents: 'none'
  },
  '&:hover': {
    borderColor: hasFile ? theme.palette.success.dark : theme.palette.primary.dark,
    background: hasFile
      ? `linear-gradient(135deg, ${alpha(theme.palette.success.main, 0.12)}, ${alpha(theme.palette.success.light, 0.06)})`
      : `linear-gradient(135deg, ${alpha(theme.palette.primary.main, 0.12)}, ${alpha(theme.palette.primary.light, 0.06)})`,
    transform: 'translateY(-4px) scale(1.02)',
    boxShadow: hasFile
      ? `0 12px 30px ${alpha(theme.palette.success.main, 0.25)}`
      : `0 12px 30px ${alpha(theme.palette.primary.main, 0.25)}`,
    '&:before': {
      left: '100%'
    }
  },
  '&:active': {
    transform: 'translateY(-2px) scale(1.01)'
  },
  ...(hasFile && {
    animation: 'pulse 2s infinite'
  })
}));

const ProcessButton = styled(Button)(({ theme }) => ({
  position: 'relative',
  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
  border: 'none',
  borderRadius: theme.shape.borderRadius * 3,
  color: 'white',
  padding: theme.spacing(1.5, 4),
  fontSize: '1rem',
  fontWeight: 600,
  textTransform: 'none',
  letterSpacing: '0.5px',
  overflow: 'hidden',
  boxShadow: `0 8px 25px ${alpha('#667eea', 0.4)}`,
  transition: 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
  '&:before': {
    content: '""',
    position: 'absolute',
    top: 0,
    left: '-100%',
    width: '100%',
    height: '100%',
    background: 'linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent)',
    transition: 'left 0.8s ease-in-out'
  },
  '&:hover': {
    background: 'linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%)',
    transform: 'translateY(-3px) scale(1.05)',
    boxShadow: `0 15px 35px ${alpha('#667eea', 0.5)}`,
    '&:before': {
      left: '100%'
    }
  },
  '&:active': {
    transform: 'translateY(-1px) scale(1.02)'
  },
  '&:disabled': {
    background: 'linear-gradient(135deg, #bbb 0%, #999 100%)',
    color: 'rgba(255,255,255,0.6)',
    cursor: 'not-allowed',
    transform: 'none',
    boxShadow: 'none'
  }
}));

const SpectacularCard = styled(Card, {
  shouldForwardProp: (prop) => prop !== 'borderRadius',
})(({ theme, borderRadius }) => ({
  position: 'relative',
  background: `linear-gradient(135deg, ${alpha(theme.palette.background.paper, 0.95)}, ${alpha(theme.palette.background.default, 0.98)})`,
  backdropFilter: 'blur(20px)',
  borderRadius: borderRadius || theme.shape.borderRadius,
  border: `1px solid ${alpha(theme.palette.primary.main, 0.1)}`,
  boxShadow: `0 8px 32px ${alpha(theme.palette.common.black, 0.1)}`,
  transition: 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
  overflow: 'hidden',
  '&:before': {
    content: '""',
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    height: '3px',
    background: 'linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c)',
    opacity: 0,
    transition: 'opacity 0.3s ease'
  },
  '&:hover': {
    transform: 'translateY(-8px)',
    boxShadow: `0 20px 40px ${alpha(theme.palette.common.black, 0.15)}`,
    '&:before': {
      opacity: 1
    }
  }
}));

const StatsCard = styled(Box, {
  shouldForwardProp: (prop) => prop !== 'gradient',
})(({ theme, gradient }) => ({
  position: 'relative',
  background: gradient || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
  borderRadius: theme.shape.borderRadius * 2.5,
  padding: theme.spacing(3),
  color: 'white',
  textAlign: 'center',
  overflow: 'hidden',
  boxShadow: `0 8px 25px ${alpha(theme.palette.primary.main, 0.3)}`,
  transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
  '&:before': {
    content: '""',
    position: 'absolute',
    top: '-50%',
    right: '-50%',
    width: '200%',
    height: '200%',
    background: `radial-gradient(circle, ${alpha('#ffffff', 0.1)} 0%, transparent 70%)`,
    opacity: 0,
    transition: 'opacity 0.3s ease',
    pointerEvents: 'none'
  },
  '&:hover': {
    transform: 'translateY(-5px) scale(1.03)',
    boxShadow: `0 15px 35px ${alpha(theme.palette.primary.main, 0.4)}`,
    '&:before': {
      opacity: 1
    }
  }
}));

// Styled components adicionales para Design System Spectacular v2.1
const SpectacularTextField = styled(TextField)(({ theme }) => ({
  '& .MuiOutlinedInput-root': {
    background: `linear-gradient(135deg, ${alpha(theme.palette.background.paper, 0.8)}, ${alpha(theme.palette.background.default, 0.9)})`,
    backdropFilter: 'blur(10px)',
    borderRadius: theme.shape.borderRadius * 2,
    transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
    '&:hover': {
      transform: 'translateY(-2px)',
      boxShadow: `0 8px 25px ${alpha(theme.palette.primary.main, 0.15)}`,
      '& .MuiOutlinedInput-notchedOutline': {
        borderColor: theme.palette.primary.main,
        borderWidth: '2px'
      }
    },
    '&.Mui-focused': {
      transform: 'translateY(-2px)',
      boxShadow: `0 8px 25px ${alpha(theme.palette.primary.main, 0.25)}`,
      '& .MuiOutlinedInput-notchedOutline': {
        borderColor: theme.palette.primary.main,
        borderWidth: '2px'
      }
    }
  },
  '& .MuiInputLabel-root': {
    color: theme.palette.text.secondary,
    fontWeight: 500,
    '&.Mui-focused': {
      color: theme.palette.primary.main,
      fontWeight: 600
    }
  }
}));

const SpectacularAlert = styled(Alert)(({ theme }) => ({
  background: `linear-gradient(135deg, ${alpha(theme.palette.info.main, 0.1)}, ${alpha(theme.palette.info.light, 0.05)})`,
  backdropFilter: 'blur(10px)',
  borderRadius: theme.shape.borderRadius * 2,
  border: `1px solid ${alpha(theme.palette.info.main, 0.2)}`,
  boxShadow: `0 4px 20px ${alpha(theme.palette.info.main, 0.1)}`,
  '& .MuiAlert-icon': {
    color: theme.palette.info.main
  },
  '& .MuiAlert-message': {
    fontWeight: 500
  }
}));

const SpectacularChip = styled(Chip)(({ theme }) => ({
  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
  color: 'white',
  fontWeight: 600,
  borderRadius: theme.shape.borderRadius * 3,
  transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
  '&:hover': {
    transform: 'translateY(-2px) scale(1.05)',
    boxShadow: `0 8px 20px ${alpha('#667eea', 0.4)}`
  }
}));

const SpectacularButton = styled(Button)(({ theme, variant = 'contained', color = 'primary' }) => ({
  borderRadius: theme.shape.borderRadius * 2,
  textTransform: 'none',
  fontWeight: 600,
  padding: theme.spacing(1.5, 3),
  transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
  position: 'relative',
  overflow: 'hidden',
  ...(variant === 'contained' && {
    background: color === 'primary' 
      ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
      : color === 'secondary'
      ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'
      : 'linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%)',
    color: 'white',
    boxShadow: `0 4px 15px ${alpha(theme.palette[color].main, 0.3)}`,
    '&:hover': {
      transform: 'translateY(-2px)',
      boxShadow: `0 8px 25px ${alpha(theme.palette[color].main, 0.4)}`
    }
  }),
  ...(variant === 'outlined' && {
    border: `2px solid ${theme.palette[color].main}`,
    background: `linear-gradient(135deg, ${alpha(theme.palette[color].main, 0.05)}, ${alpha(theme.palette[color].light, 0.02)})`,
    color: theme.palette[color].main,
    backdropFilter: 'blur(10px)',
    '&:hover': {
      background: `linear-gradient(135deg, ${alpha(theme.palette[color].main, 0.1)}, ${alpha(theme.palette[color].light, 0.05)})`,
      transform: 'translateY(-2px)',
      boxShadow: `0 8px 20px ${alpha(theme.palette[color].main, 0.2)}`
    }
  }),
  '&:active': {
    transform: 'translateY(0px)'
  }
}));

const SpectacularPaper = styled(Paper, {
  shouldForwardProp: (prop) => prop !== 'borderRadius',
})(({ theme, borderRadius }) => ({
  background: `linear-gradient(135deg, ${alpha(theme.palette.background.paper, 0.9)}, ${alpha(theme.palette.background.default, 0.95)})`,
  backdropFilter: 'blur(20px)',
  borderRadius: borderRadius || theme.shape.borderRadius,
  border: `1px solid ${alpha(theme.palette.primary.main, 0.1)}`,
  boxShadow: `0 8px 32px ${alpha(theme.palette.common.black, 0.08)}`,
  overflow: 'hidden',
  '& .MuiTableHead-root': {
    background: `linear-gradient(135deg, ${alpha(theme.palette.primary.main, 0.1)}, ${alpha(theme.palette.primary.light, 0.05)})`,
    '& .MuiTableCell-head': {
      fontWeight: 700,
      color: theme.palette.primary.main,
      borderBottom: `2px solid ${alpha(theme.palette.primary.main, 0.2)}`
    }
  },
  '& .MuiTableBody-root .MuiTableRow-root': {
    transition: 'all 0.2s ease',
    '&:hover': {
      background: `linear-gradient(135deg, ${alpha(theme.palette.primary.main, 0.05)}, ${alpha(theme.palette.primary.light, 0.02)})`,
      transform: 'scale(1.005)'
    }
  }
}));

const SpectacularTablePagination = styled(TablePagination)(({ theme }) => ({
  background: `linear-gradient(135deg, ${alpha(theme.palette.background.paper, 0.95)}, ${alpha(theme.palette.background.default, 0.98)})`,
  backdropFilter: 'blur(10px)',
  borderTop: `1px solid ${alpha(theme.palette.primary.main, 0.1)}`,
  '& .MuiTablePagination-toolbar': {
    padding: theme.spacing(2),
    minHeight: '60px',
  },
  '& .MuiTablePagination-selectLabel, & .MuiTablePagination-displayedRows': {
    color: theme.palette.text.primary,
    fontWeight: 500,
    fontSize: '0.9rem',
  },
  '& .MuiTablePagination-select': {
    background: `linear-gradient(135deg, ${alpha(theme.palette.primary.main, 0.08)}, ${alpha(theme.palette.primary.light, 0.04)})`,
    borderRadius: theme.shape.borderRadius,
    border: `1px solid ${alpha(theme.palette.primary.main, 0.2)}`,
    color: theme.palette.text.primary,
    fontSize: '0.9rem',
    fontWeight: 600,
    padding: theme.spacing(1),
    minWidth: '60px',
    '&:focus': {
      background: `linear-gradient(135deg, ${alpha(theme.palette.primary.main, 0.12)}, ${alpha(theme.palette.primary.light, 0.06)})`,
    },
    '&:hover': {
      background: `linear-gradient(135deg, ${alpha(theme.palette.primary.main, 0.15)}, ${alpha(theme.palette.primary.light, 0.08)})`,
    }
  },
  '& .MuiSelect-icon': {
    color: theme.palette.primary.main,
  },
  '& .MuiTablePagination-actions': {
    marginLeft: theme.spacing(2),
    '& .MuiIconButton-root': {
      background: `linear-gradient(135deg, ${alpha(theme.palette.primary.main, 0.08)}, ${alpha(theme.palette.primary.light, 0.04)})`,
      borderRadius: theme.shape.borderRadius,
      margin: theme.spacing(0, 0.5),
      width: '40px',
      height: '40px',
      transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
      '&:hover': {
        background: `linear-gradient(135deg, ${alpha(theme.palette.primary.main, 0.15)}, ${alpha(theme.palette.primary.light, 0.08)})`,
        transform: 'translateY(-2px)',
        boxShadow: `0 4px 12px ${alpha(theme.palette.primary.main, 0.25)}`,
      },
      '&:disabled': {
        background: alpha(theme.palette.action.disabled, 0.1),
        color: theme.palette.action.disabled,
        transform: 'none',
      }
    }
  }
}));

// Funci√≥n para convertir per√≠odo a texto legible
const convertPeriodToText = (period) => {
  if (!period || period.length !== 6) return period;
  
  const year = period.substring(0, 4);
  const month = period.substring(4, 6);
  
  const months = {
    '01': 'Enero', '02': 'Febrero', '03': 'Marzo', '04': 'Abril',
    '05': 'Mayo', '06': 'Junio', '07': 'Julio', '08': 'Agosto',
    '09': 'Septiembre', '10': 'Octubre', '11': 'Noviembre', '12': 'Diciembre'
  };
  
  return `${months[month]} ${year}`;
};

// Funci√≥n para encontrar establecimiento y c√≥digo de local por separado
const findEstablishment = (row, inventoryData) => {
  if (!inventoryData.length) return 'No encontrado';
  
  const nuc = row.NUC?.toString().trim();
  const nuid = row.NUID?.toString().trim();
  const serial = row.Serial?.toString().trim();
  
  // Buscar por Serial primero (m√°s espec√≠fico)
  let match = inventoryData.find(inv => {
    const invSerial = inv.Serial?.toString().trim();
    return serial && invSerial === serial;
  });
  
  // Si no encuentra por Serial, buscar por NUC
  if (!match && nuc) {
    match = inventoryData.find(inv => {
      const invNUC = inv.NUC?.toString().trim();
      return invNUC === nuc;
    });
  }
  
  // Si no encuentra por NUC, buscar por NUID
  if (!match && nuid) {
    match = inventoryData.find(inv => {
      const invNUID = inv.NUID?.toString().trim();
      return invNUID === nuid;
    });
  }
  
  if (match) {
    const establishment = match['Nombre Establecimiento'] || match.Establecimiento || match.Nombre || match['Nombre de Establecimiento'] || match.establecimiento || 'No encontrado';
    return establishment;
  }
  
  return 'No encontrado';
};

const findLocalCode = (row, inventoryData) => {
  if (!inventoryData.length) return 'No encontrado';
  
  const nuc = row.NUC?.toString().trim();
  const nuid = row.NUID?.toString().trim();
  const serial = row.Serial?.toString().trim();
  
  console.log('üîç Buscando c√≥digo de local para:', { nuc, nuid, serial });
  
  // Buscar por Serial primero (m√°s espec√≠fico)
  let match = inventoryData.find(inv => {
    const invSerial = inv.Serial?.toString().trim();
    return serial && invSerial === serial;
  });
  
  if (match) {
    console.log('‚úÖ Encontrado match por Serial:', serial);
  }
  
  // Si no encuentra por Serial, buscar por NUC
  if (!match && nuc) {
    match = inventoryData.find(inv => {
      const invNUC = inv.NUC?.toString().trim();
      return invNUC === nuc;
    });
    if (match) {
      console.log('‚úÖ Encontrado match por NUC:', nuc);
    }
  }
  
  // Si no encuentra por NUC, buscar por NUID
  if (!match && nuid) {
    match = inventoryData.find(inv => {
      const invNUID = inv.NUID?.toString().trim();
      return invNUID === nuid;
    });
    if (match) {
      console.log('‚úÖ Encontrado match por NUID:', nuid);
    }
  }
  
  if (match) {
    console.log('üìã Columnas disponibles en match:', Object.keys(match));
    
    // Buscar por nombres exactos PRIMERO (incluyendo "C√≥digo Local")
    const possibleKeys = [
      'C√≥digo Local',        // ‚úÖ Tu columna exacta
      'C√≥digo de Local',     // ‚úÖ Variante con may√∫scula
      'Codigo Local',        // ‚úÖ Variante sin tilde
      'Codigo de Local',     // ‚úÖ Variante sin tilde con may√∫scula
      'C√≥digo local',        // ‚úÖ Variante min√∫scula
      'Codigo local',        // ‚úÖ Variante sin tilde min√∫scula
      'C√ìDIGO LOCAL',        // ‚úÖ May√∫sculas
      'CODIGO LOCAL',        // ‚úÖ May√∫sculas sin tilde
      'C√ìDIGO DE LOCAL', 
      'CODIGO DE LOCAL', 
      'CodigoLocal', 
      'codigoLocal',
      'Codigo_Local',
      'codigo_local',
      'Local',               // ‚úÖ Solo "Local"
      'LOCAL',               // ‚úÖ Solo "LOCAL"
      'Codigo', 
      'C√≥digo', 
      'codigo',
      'CODIGO',
      'Code',
      'code'
    ];
    
    for (const key of possibleKeys) {
      if (match[key] !== undefined && match[key] !== null && match[key] !== '') {
        console.log(`‚úÖ ENCONTRADO c√≥digo de local en "${key}":`, match[key]);
        return match[key].toString();
      }
    }
    
    // Si no encuentra por nombres exactos, buscar con l√≥gica inteligente
    for (const key of Object.keys(match)) {
      const lowerKey = key.toLowerCase();
      // Buscar claves que contengan "codigo" o "local" o "code"
      if ((lowerKey.includes('codigo') || lowerKey.includes('code')) && 
          (lowerKey.includes('local') || lowerKey.includes('establecimiento'))) {
        if (match[key] !== undefined && match[key] !== null && match[key] !== '') {
          console.log(`‚úÖ ENCONTRADO por b√∫squeda inteligente en "${key}":`, match[key]);
          return match[key].toString();
        }
      }
    }
    
    // Buscar solo por "local" o "code" como √∫ltimo recurso
    for (const key of Object.keys(match)) {
      const lowerKey = key.toLowerCase();
      if ((lowerKey === 'local' || lowerKey === 'code' || lowerKey === 'codigo') && 
          match[key] !== undefined && match[key] !== null && match[key] !== '') {
        console.log(`‚úÖ ENCONTRADO por b√∫squeda de √∫ltimo recurso en "${key}":`, match[key]);
        return match[key].toString();
      }
    }
    
    console.log('‚ùå NO ENCONTRADO c√≥digo de local. Columnas disponibles:', Object.keys(match));
    return 'No encontrado';
  }
  
  console.log('‚ùå NO ENCONTRADO match para NUC/NUID/Serial');
  return 'No encontrado';
};

const findInventoryNIT = (row, inventoryData) => {
  if (!inventoryData.length) return null;
  
  const nuc = row.NUC?.toString().trim();
  const nuid = row.NUID?.toString().trim();
  const serial = row.Serial?.toString().trim();
  
  // Buscar por Serial primero (m√°s espec√≠fico)
  let match = inventoryData.find(inv => {
    const invSerial = inv.Serial?.toString().trim();
    return serial && invSerial === serial;
  });
  
  // Si no encuentra por Serial, buscar por NUC
  if (!match && nuc) {
    match = inventoryData.find(inv => {
      const invNUC = inv.NUC?.toString().trim();
      return invNUC === nuc;
    });
  }
  
  // Si no encuentra por NUC, buscar por NUID
  if (!match && nuid) {
    match = inventoryData.find(inv => {
      const invNUID = inv.NUID?.toString().trim();
      return invNUID === nuid;
    });
  }
  
  if (match) {
    return match.NIT || match.nit || match.Nit || null;
  }
  
  return null;
};

// Funci√≥n para encontrar columna por varios nombres posibles (insensible a may√∫sculas)
const findColumn = (data, possibleNames) => {
  if (!data.length) return null;
  
  const columns = Object.keys(data[0]).map(col => col.toLowerCase().trim());
  
  for (const possibleName of possibleNames) {
    const nameLower = possibleName.toLowerCase().trim();
    for (let i = 0; i < columns.length; i++) {
      if (columns[i] === nameLower || columns[i].includes(nameLower)) {
        return Object.keys(data[0])[i];
      }
    }
  }
  
  return null;
};

// Funci√≥n principal para procesar archivo √∫nico de liquidaci√≥n
const processLiquidationFile = (liquidationData, selectedCompany) => {
  console.log('üöÄ Iniciando procesamiento de liquidaci√≥n');
  console.log('üìä Datos de liquidaci√≥n:', liquidationData.length, 'filas');
  console.log('üè¢ Empresa seleccionada:', selectedCompany);
  
  if (liquidationData.length === 0) {
    throw new Error('No hay datos para procesar');
  }

  // Debug: Mostrar estructura de datos
  console.log('üîç Estructura (primera fila):', Object.keys(liquidationData[0]));
  console.log('üîç Primera fila:', liquidationData[0]);

  // Detectar columnas autom√°ticamente
  console.log('üîç Detectando columnas en el archivo...');
  
  const columnMapping = {};
  
  // Serial (puede ser Serial, Nro Serial, N√∫mero Serial, etc.)
  const serialCol = findColumn(liquidationData, ['serial', 'nro serial', 'numero serial', 'num serial']);
  if (serialCol) {
    columnMapping['Serial'] = serialCol;
    console.log(`‚úÖ Columna Serial encontrada: ${serialCol}`);
  } else {
    throw new Error('‚ùå No se encontr√≥ columna de Serial en el archivo');
  }

  // NUC
  const nucCol = findColumn(liquidationData, ['nuc']);
  if (nucCol) {
    columnMapping['NUC'] = nucCol;
    console.log(`‚úÖ Columna NUC encontrada: ${nucCol}`);
  } else {
    // Intentar usar NUID si no hay NUC
    const nuidCol = findColumn(liquidationData, ['nuid']);
    if (nuidCol) {
      columnMapping['NUC'] = nuidCol;
      console.log(`‚úÖ Columna NUID encontrada (usando como NUC): ${nuidCol}`);
    } else {
      console.log('‚ö†Ô∏è No se encontr√≥ columna NUC o NUID');
    }
  }

  // Establecimiento
  const establishmentCol = findColumn(liquidationData, ['establecimiento', 'sala', 'casino']);
  if (establishmentCol) {
    columnMapping['Establecimiento'] = establishmentCol;
    console.log(`‚úÖ Columna Establecimiento encontrada: ${establishmentCol}`);
  } else {
    throw new Error('‚ùå No se encontr√≥ columna de Establecimiento en el archivo');
  }

  // Tipo apuesta
  const typeCol = findColumn(liquidationData, ['tipo apuesta', 'tipo', 'categoria']);
  if (typeCol) {
    columnMapping['Tipo apuesta'] = typeCol;
    console.log(`‚úÖ Columna Tipo apuesta encontrada: ${typeCol}`);
  } else {
    console.log('‚ö†Ô∏è No se encontr√≥ columna Tipo apuesta, usando valor por defecto');
  }

  // Base liquidaci√≥n
  const baseCol = findColumn(liquidationData, ['base liquidacion diaria', 'base liquidacion', 'base', 'produccion', 'ingresos']);
  if (baseCol) {
    columnMapping['Base liquidaci√≥n diaria'] = baseCol;
    console.log(`‚úÖ Columna Base liquidaci√≥n encontrada: ${baseCol}`);
  } else {
    throw new Error('‚ùå No se encontr√≥ columna de Base liquidaci√≥n en el archivo');
  }

  // Fecha reporte
  const dateCol = findColumn(liquidationData, ['fecha reporte', 'fecha', 'periodo']);
  if (dateCol) {
    columnMapping['Fecha reporte'] = dateCol;
    console.log(`‚úÖ Columna Fecha reporte encontrada: ${dateCol}`);
  } else {
    console.log('‚ö†Ô∏è No se encontr√≥ columna Fecha reporte');
  }

  console.log('üîß Consolidando datos por Serial...');

  // Agrupar y consolidar por Serial
  const groupedData = {};
  
  liquidationData.forEach((row, index) => {
    const serial = row[columnMapping['Serial']]?.toString().trim();
    if (!serial) {
      console.log(`‚ö†Ô∏è Fila ${index + 1} sin Serial, omitiendo`);
      return;
    }

    if (!groupedData[serial]) {
      groupedData[serial] = {
        serial,
        nuc: row[columnMapping['NUC']]?.toString().trim() || '',
        establecimiento: row[columnMapping['Establecimiento']]?.toString().trim() || '',
        tipo: row[columnMapping['Tipo apuesta']]?.toString().trim() || 'General',
        fechas: [],
        totalBase: 0
      };
    }

    // Agregar fecha y base
    const fecha = row[columnMapping['Fecha reporte']];
    const base = Number(row[columnMapping['Base liquidaci√≥n diaria']]) || 0;
    
    if (fecha) {
      groupedData[serial].fechas.push(fecha);
    }
    
    groupedData[serial].totalBase += base;
  });

  console.log(`üìä Consolidaci√≥n completada: ${Object.keys(groupedData).length} m√°quinas √∫nicas`);

  // Convertir a array y calcular campos derivados
  const consolidatedData = Object.values(groupedData).map(group => {
    // Calcular fechas
    const fechasValidas = group.fechas.filter(f => f);
    const primerDia = fechasValidas.length > 0 ? new Date(Math.min(...fechasValidas.map(f => new Date(f)))) : null;
    const ultimoDia = fechasValidas.length > 0 ? new Date(Math.max(...fechasValidas.map(f => new Date(f)))) : null;
    const diasTransmitidos = fechasValidas.length;

    // Calcular d√≠as del mes
    let diasDelMes = 31;
    if (ultimoDia) {
      const year = ultimoDia.getFullYear();
      const month = ultimoDia.getMonth();
      diasDelMes = new Date(year, month + 1, 0).getDate();
    }

    // Determinar novedad
    let novedad = 'Sin informaci√≥n';
    if (diasTransmitidos === diasDelMes) {
      novedad = 'Sin cambios';
    } else if (diasTransmitidos < diasDelMes) {
      novedad = 'Retiro / Adici√≥n';
    } else {
      novedad = 'D√≠as excedentes';
    }

    // Crear per√≠odo texto
    const periodoTexto = ultimoDia ? convertDateToPeriod(ultimoDia) : '';

    // Calcular impuestos seg√∫n f√≥rmulas correctas del Python
    const produccion = group.totalBase;
    const derechosExplotacion = produccion * 0.12; // 12%
    const gastosAdministracion = derechosExplotacion * 0.01; // 1% de los derechos
    const totalImpuestos = derechosExplotacion + gastosAdministracion;

    return {
      'Empresa': selectedCompany || 'No especificada',
      'Serial': group.serial,
      'NUC': group.nuc,
      'Establecimiento': group.establecimiento,
      'D√≠as transmitidos': diasTransmitidos,
      'D√≠as del mes': diasDelMes,
      'Primer d√≠a transmitido': primerDia ? primerDia.toLocaleDateString('es-ES') : '',
      '√öltimo d√≠a transmitido': ultimoDia ? ultimoDia.toLocaleDateString('es-ES') : '',
      'Per√≠odo Texto': periodoTexto,
      'Tipo apuesta': group.tipo,
      'Producci√≥n': produccion,
      'Derechos de Explotaci√≥n': derechosExplotacion,
      'Gastos de Administraci√≥n': gastosAdministracion,
      'Total Impuestos': totalImpuestos,
      'Novedad': novedad
    };
  });

  return consolidatedData;
};

// Funci√≥n para generar reporte por sala/establecimiento
const generateRoomReport = (consolidatedData) => {
  console.log('üè¢ Generando reporte por establecimiento...');
  
  if (!consolidatedData.length) {
    console.log('‚ùå No hay datos consolidados para generar reporte por sala');
    return [];
  }

  // Agrupar por establecimiento
  const roomData = {};

  consolidatedData.forEach(row => {
    const establishment = row.Establecimiento;
    if (!establishment || establishment === 'No encontrado') return;

    if (!roomData[establishment]) {
      roomData[establishment] = {
        establecimiento: establishment,
        empresa: row.Empresa,
        totalMaquinas: 0,
        produccionTotal: 0,
        derechosTotal: 0,
        gastosTotal: 0,
        impuestosTotal: 0
      };
    }

    roomData[establishment].totalMaquinas += 1;
    roomData[establishment].produccionTotal += row['Producci√≥n'] || 0;
    roomData[establishment].derechosTotal += row['Derechos de Explotaci√≥n'] || 0;
    roomData[establishment].gastosTotal += row['Gastos de Administraci√≥n'] || 0;
    roomData[establishment].impuestosTotal += row['Total Impuestos'] || 0;
  });

  // Convertir a array y calcular promedios
  const roomReport = Object.values(roomData).map(room => ({
    'Empresa': room.empresa,
    'Establecimiento': room.establecimiento,
    'Total M√°quinas': room.totalMaquinas,
    'Producci√≥n': room.produccionTotal,
    'Derechos de Explotaci√≥n': room.derechosTotal,
    'Gastos de Administraci√≥n': room.gastosTotal,
    'Total Impuestos': room.impuestosTotal,
    'Promedio/Establecimiento': room.totalMaquinas > 0 ? room.produccionTotal / room.totalMaquinas : 0
  }));

  // Ordenar por producci√≥n total descendente
  roomReport.sort((a, b) => b['Producci√≥n'] - a['Producci√≥n']);

  console.log(`‚úÖ Reporte por establecimiento completado: ${roomReport.length} establecimientos`);
  return roomReport;
};

// Funci√≥n para convertir fecha a per√≠odo texto
const convertDateToPeriod = (date) => {
  try {
    const d = new Date(date);
    const month = (d.getMonth() + 1).toString().padStart(2, '0');
    const year = d.getFullYear();
    
    const months = {
      '01': 'Enero', '02': 'Febrero', '03': 'Marzo', '04': 'Abril',
      '05': 'Mayo', '06': 'Junio', '07': 'Julio', '08': 'Agosto',
      '09': 'Septiembre', '10': 'Octubre', '11': 'Noviembre', '12': 'Diciembre'
    };
    
    return `${months[month]} ${year}`;
  } catch (error) {
    console.log('‚ö†Ô∏è Error convirtiendo fecha a per√≠odo:', error);
    return '';
  }
};

// Funci√≥n para detectar fila de encabezados autom√°ticamente
const detectHeaderRow = (data) => {
  if (!data || data.length === 0) return 0;

  const keyColumns = ['serial', 'nuc', 'nuid', 'establecimiento'];
  
  for (let rowIndex = 0; rowIndex < Math.min(data.length, 10); rowIndex++) {
    const row = data[rowIndex];
    const rowValues = Object.values(row).map(val => 
      val?.toString().toLowerCase().trim() || ''
    );
    
    let matches = 0;
    keyColumns.forEach(key => {
      if (rowValues.some(val => val.includes(key))) {
        matches++;
      }
    });
    
    if (matches >= 2) {
      console.log(`üîç Encabezados detectados en fila ${rowIndex + 1} con ${matches} coincidencias`);
      return rowIndex;
    }
  }

  console.log('‚ö†Ô∏è No se detectaron encabezados autom√°ticamente, usando fila 1');
  return 0;
};

// Funci√≥n para extraer n√∫mero de contrato del archivo de liquidaci√≥n
const extractContractNumber = (liquidationData) => {
  console.log('üîç Extrayendo n√∫mero de contrato del archivo...');
  
  if (!liquidationData || liquidationData.length === 0) {
    console.log('‚ùå No hay datos para extraer n√∫mero de contrato');
    return null;
  }

  // Buscar en las primeras filas (pueden estar en metadata al inicio)
  for (let i = 0; i < Math.min(10, liquidationData.length); i++) {
    const row = liquidationData[i];
    
    // Buscar en todas las columnas de la fila
    for (const [key, value] of Object.entries(row)) {
      if (value && typeof value === 'string') {
        // Buscar patrones de n√∫mero de contrato (t√≠picamente alfanum√©rico)
        // Ejemplo: "Contrato: ABC123", "Contract: 123456", o simplemente "CJ0R06"
        const contractPatterns = [
          /contrato[:\s]*([A-Z0-9]+)/i,
          /contract[:\s]*([A-Z0-9]+)/i,
          /^[A-Z]{1,3}\d{3,6}$/,  // Patr√≥n com√∫n: CJ0R06, ABC123, etc.
          /^[A-Z0-9]{4,10}$/      // C√≥digo alfanum√©rico de 4-10 caracteres
        ];
        
        for (const pattern of contractPatterns) {
          const match = value.match(pattern);
          if (match) {
            const contractNumber = match[1] || match[0];
            console.log(`‚úÖ N√∫mero de contrato encontrado: ${contractNumber} (en columna: ${key})`);
            return contractNumber;
          }
        }
      }
    }
  }
  
  // Si no se encuentra en metadata, buscar en datos (primera columna que parezca n√∫mero de contrato)
  if (liquidationData.length > 0) {
    const firstDataRow = liquidationData[0];
    for (const [key, value] of Object.entries(firstDataRow)) {
      if (value && typeof value === 'string' && /^[A-Z0-9]{4,10}$/i.test(value)) {
        console.log(`‚úÖ Posible n√∫mero de contrato encontrado en datos: ${value} (columna: ${key})`);
        return value;
      }
    }
  }
  
  console.log('‚ö†Ô∏è No se pudo extraer n√∫mero de contrato autom√°ticamente');
  return null;
};

// Funci√≥n para buscar empresa por n√∫mero de contrato
const findCompanyByContractNumber = (companies, contractNumber) => {
  console.log(`üîç Buscando empresa con n√∫mero de contrato: ${contractNumber}`);
  
  if (!contractNumber || !companies || companies.length === 0) {
    console.log('‚ùå No hay n√∫mero de contrato o empresas para buscar');
    return null;
  }
  
  const foundCompany = companies.find(company => 
    company.contractNumber && 
    company.contractNumber.toLowerCase() === contractNumber.toLowerCase()
  );
  
  if (foundCompany) {
    console.log(`‚úÖ Empresa encontrada: ${foundCompany.name} (NIT: ${foundCompany.nit})`);
    return foundCompany;
  }
  
  console.log('‚ùå No se encontr√≥ empresa con ese n√∫mero de contrato');
  return null;
};

const LiquidationProcessorPage = () => {
  const theme = useTheme();
  const gradients = useThemeGradients();

  // Hook para configuraci√≥n de temas - AGREGADO
  const { settings } = useSettings();

  // Hook para obtener empresas de la base de datos
  const { companies, loading: companiesLoading } = useCompanies();

  // Estados principales - CORREGIDOS para UN SOLO ARCHIVO
  const [liquidationFile, setLiquidationFile] = useState(null);
  const [selectedCompany, setSelectedCompany] = useState(''); // Empresa asignada autom√°ticamente
  const [detectedContractNumber, setDetectedContractNumber] = useState(''); // N√∫mero de contrato detectado
  const [liquidationData, setLiquidationData] = useState([]);
  const [consolidatedData, setConsolidatedData] = useState([]); // Datos consolidados por Serial
  const [roomReportData, setRoomReportData] = useState([]); // Reporte por sala
  const [processing, setProcessing] = useState(false);
  const [error, setError] = useState(null);

  // Estados para filtros y b√∫squeda
  const [searchTerm, setSearchTerm] = useState('');
  const [establishmentFilter, setEstablishmentFilter] = useState('all');
  const [periodFilter, setPeriodFilter] = useState('all');
  const [showResults, setShowResults] = useState(false);

  // Estados para paginaci√≥n
  const [page, setPage] = useState(0);
  const [rowsPerPage, setRowsPerPage] = useState(25);

  // Estados para drag and drop - SOLO LIQUIDACI√ìN
  const [dragOverLiquidation, setDragOverLiquidation] = useState(false);

  // Estado para expansi√≥n del an√°lisis por salas
  const [expandRoomAnalysis, setExpandRoomAnalysis] = useState(false);

  // Modal para selecci√≥n de empresa
  const [showCompanyDialog, setShowCompanyDialog] = useState(false);

  // Estados para modal de exportaci√≥n por sala
  const [showRoomExportDialog, setShowRoomExportDialog] = useState(false);
  const [selectedRoomForExport, setSelectedRoomForExport] = useState('');
  const [exportFormat, setExportFormat] = useState('xlsx');
  const [availableRooms, setAvailableRooms] = useState([]);

  // Funci√≥n para leer archivos
  const readFile = useCallback((file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet);
          resolve(jsonData);
        } catch (error) {
          reject(error);
        }
      };
      
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }, []);

  // Handlers para drag and drop - CORREGIDO para un archivo
  const handleDragOver = useCallback((e) => {
    e.preventDefault();
    setDragOverLiquidation(true);
  }, []);

  const handleDragLeave = useCallback((e) => {
    e.preventDefault();
    setDragOverLiquidation(false);
  }, []);

  const handleDrop = useCallback(async (e) => {
    e.preventDefault();
    setDragOverLiquidation(false);
    
    const files = Array.from(e.dataTransfer.files);
    const file = files[0];
    
    if (file && (file.type.includes('sheet') || file.name.endsWith('.xlsx') || file.name.endsWith('.csv'))) {
      try {
        setProcessing(true);
        setError(null);
        
        // Leer el archivo
        const data = await readFile(file);
        console.log(`üìÅ Archivo cargado: ${file.name}`);
        
        // Extraer n√∫mero de contrato autom√°ticamente
        const contractNumber = extractContractNumber(data);
        
        if (contractNumber) {
          setDetectedContractNumber(contractNumber);
          
          // Buscar empresa por n√∫mero de contrato
          const company = findCompanyByContractNumber(companies, contractNumber);
          
          if (company) {
            // Empresa encontrada autom√°ticamente
            setLiquidationFile(file);
            setLiquidationData(data);
            setSelectedCompany(company.name);
            console.log(`‚úÖ Archivo vinculado autom√°ticamente a empresa: ${company.name}`);
          } else {
            // N√∫mero de contrato detectado pero empresa no encontrada en DB
            setError(`Se detect√≥ el n√∫mero de contrato "${contractNumber}" pero no se encontr√≥ la empresa correspondiente en la base de datos. Aseg√∫rate de que la empresa est√© registrada con ese n√∫mero de contrato.`);
          }
        } else {
          // No se pudo detectar n√∫mero de contrato
          setError('No se pudo detectar autom√°ticamente el n√∫mero de contrato en el archivo. Verifica que el archivo contenga esta informaci√≥n en las primeras filas o columnas.');
        }
        
      } catch (err) {
        setError(`Error leyendo archivo ${file.name}: ${err.message}`);
      } finally {
        setProcessing(false);
      }
    } else {
      setError('Por favor, sube un archivo Excel (.xlsx) o CSV v√°lido');
    }
  }, [readFile, companies]);

  // Handler para seleccionar archivos - CORREGIDO
  const handleFileSelect = useCallback(async (e) => {
    const file = e.target.files[0];
    if (file) {
      try {
        setProcessing(true);
        setError(null);

        // Leer el archivo
        const data = await readFile(file);
        console.log(`üìÅ Archivo seleccionado: ${file.name}`);

        // Extraer n√∫mero de contrato autom√°ticamente
        const contractNumber = extractContractNumber(data);
        
        if (contractNumber) {
          setDetectedContractNumber(contractNumber);
          
          // Buscar empresa por n√∫mero de contrato
          const company = findCompanyByContractNumber(companies, contractNumber);
          
          if (company) {
            // Empresa encontrada autom√°ticamente
            setLiquidationFile(file);
            setLiquidationData(data);
            setSelectedCompany(company.name);
            console.log(`‚úÖ Archivo vinculado autom√°ticamente a empresa: ${company.name}`);
          } else {
            // N√∫mero de contrato detectado pero empresa no encontrada en DB
            setError(`Se detect√≥ el n√∫mero de contrato "${contractNumber}" pero no se encontr√≥ la empresa correspondiente en la base de datos. Aseg√∫rate de que la empresa est√© registrada con ese n√∫mero de contrato.`);
          }
        } else {
          // No se pudo detectar n√∫mero de contrato
          setError('No se pudo detectar autom√°ticamente el n√∫mero de contrato en el archivo. Verifica que el archivo contenga esta informaci√≥n en las primeras filas o columnas.');
        }

      } catch (err) {
        setError(`Error leyendo archivo ${file.name}: ${err.message}`);
      } finally {
        setProcessing(false);
      }
    }
    
    // Limpiar el input para permitir seleccionar el mismo archivo nuevamente
    e.target.value = '';
  }, [readFile, companies]);

  // Funci√≥n para procesar archivo - CORREGIDA seg√∫n l√≥gica Python
  const handleProcessFiles = useCallback(async () => {
    if (!liquidationData.length) {
      setError('Por favor, carga el archivo de liquidaci√≥n antes de procesar');
      return;
    }

    if (!selectedCompany || selectedCompany.trim() === '') {
      setError('Debe especificar el nombre de la empresa');
      return;
    }

    setProcessing(true);
    setError(null);

    try {
      console.log('üîç Detectando fila de encabezados...');
      const headerRow = detectHeaderRow(liquidationData);
      console.log(`üìã Usando fila ${headerRow + 1} como encabezados`);

      // Si los encabezados no est√°n en la primera fila, ajustar datos
      const dataToProcess = headerRow > 0 ? liquidationData.slice(headerRow) : liquidationData;

      console.log(`üìä Procesando ${dataToProcess.length} filas de datos`);

      // Simular delay de procesamiento
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // Procesar consolidaci√≥n por Serial
      const consolidated = processLiquidationFile(dataToProcess, selectedCompany);
      setConsolidatedData(consolidated);
      console.log(`‚úÖ Consolidaci√≥n completada: ${consolidated.length} m√°quinas`);
      
      // Generar reporte por sala
      const roomReport = generateRoomReport(consolidated);
      setRoomReportData(roomReport);
      console.log(`‚úÖ Reporte por sala generado: ${roomReport.length} establecimientos`);
      
      setShowResults(true);
      console.log('üéâ Procesamiento completado exitosamente');
      
    } catch (err) {
      console.error('‚ùå Error en procesamiento:', err);
      setError(`Error procesando archivo: ${err.message}`);
    } finally {
      setProcessing(false);
    }
  }, [liquidationData, selectedCompany]);

  // Funci√≥n para obtener salas/establecimientos √∫nicos
  const getAvailableRooms = useCallback(() => {
    if (!consolidatedData.length) return [];
    
    const rooms = [...new Set(consolidatedData.map(row => row.Establecimiento).filter(Boolean))];
    return rooms.sort();
  }, [consolidatedData]);

  // Actualizar salas disponibles cuando cambien los datos consolidados
  React.useEffect(() => {
    if (consolidatedData.length > 0) {
      const rooms = getAvailableRooms();
      setAvailableRooms(rooms);
      console.log('üè¢ Salas disponibles:', rooms);
    }
  }, [consolidatedData, getAvailableRooms]);

  // Funci√≥n para crear Excel formateado para consolidado con ExcelJS (replica Python exacto)
  const createFormattedConsolidatedExcel = useCallback(async (data, fileName) => {
    try {
      console.log('üìä Creando Excel formateado para consolidado con ExcelJS...');
      
      if (!data || data.length === 0) {
        throw new Error('No hay datos para exportar');
      }
      
      // Crear workbook con ExcelJS
      const workbook = new ExcelJS.Workbook();
      workbook.creator = 'DR Group Dashboard';
      workbook.lastModifiedBy = 'Sistema de Liquidaciones';
      workbook.created = new Date();
      
      // Crear worksheet
      const worksheet = workbook.addWorksheet('Datos Consolidados', {
        pageSetup: { 
          paperSize: 9, 
          orientation: 'landscape',
          fitToPage: true,
          fitToWidth: 1,
          fitToHeight: 0
        }
      });
      
      // Definir columnas con formato espec√≠fico
      const columns = [
        { header: 'Empresa', key: 'Empresa', width: 18 },
        { header: 'Serial', key: 'Serial', width: 15 },
        { header: 'NUC', key: 'NUC', width: 15 },
        { header: 'Establecimiento', key: 'Establecimiento', width: 25 },
        { header: 'D√≠as transmitidos', key: 'D√≠as transmitidos', width: 12 },
        { header: 'D√≠as del mes', key: 'D√≠as del mes', width: 12 },
        { header: 'Primer d√≠a transmitido', key: 'Primer d√≠a transmitido', width: 18 },
        { header: '√öltimo d√≠a transmitido', key: '√öltimo d√≠a transmitido', width: 18 },
        { header: 'Per√≠odo Texto', key: 'Per√≠odo Texto', width: 18 },
        { header: 'Tipo apuesta', key: 'Tipo apuesta', width: 15 },
        { header: 'Producci√≥n', key: 'Producci√≥n', width: 18 },
        { header: 'Derechos de Explotaci√≥n', key: 'Derechos de Explotaci√≥n', width: 22 },
        { header: 'Gastos de Administraci√≥n', key: 'Gastos de Administraci√≥n', width: 22 },
        { header: 'Total Impuestos', key: 'Total Impuestos', width: 18 },
        { header: 'Novedad', key: 'Novedad', width: 18 }
      ];
      
      worksheet.columns = columns;
      
      // Estilo de encabezado (replica Python exacto)
      const headerRow = worksheet.getRow(1);
      headerRow.height = 25;
      
      headerRow.eachCell((cell, colNumber) => {
        cell.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FF0B3040' } // Color corporativo exacto
        };
        cell.font = {
          name: 'Segoe UI',
          size: 11,
          bold: true,
          color: { argb: 'FFFFFFFF' }
        };
        cell.alignment = {
          vertical: 'middle',
          horizontal: 'center',
          wrapText: true
        };
        cell.border = {
          top: { style: 'thin', color: { argb: 'FF000000' } },
          left: { style: 'thin', color: { argb: 'FF000000' } },
          bottom: { style: 'thin', color: { argb: 'FF000000' } },
          right: { style: 'thin', color: { argb: 'FF000000' } }
        };
      });
      
      // Agregar datos
      data.forEach((rowData, index) => {
        const row = worksheet.addRow(rowData);
        row.height = 20;
        
        // Formatear cada celda
        row.eachCell((cell, colNumber) => {
          const column = columns[colNumber - 1];
          
          // Formato base
          cell.alignment = {
            vertical: 'middle',
            horizontal: 'left'
          };
          
          cell.border = {
            top: { style: 'thin', color: { argb: 'FFE0E0E0' } },
            left: { style: 'thin', color: { argb: 'FFE0E0E0' } },
            bottom: { style: 'thin', color: { argb: 'FFE0E0E0' } },
            right: { style: 'thin', color: { argb: 'FFE0E0E0' } }
          };
          
          // Formato espec√≠fico por tipo de columna
          if (column.key.includes('Producci√≥n') || 
              column.key.includes('Derechos') || 
              column.key.includes('Gastos') || 
              column.key.includes('Impuestos')) {
            // Formato monetario colombiano
            cell.numFmt = '"$"#,##0_);[Red]("$"#,##0)';
            cell.alignment.horizontal = 'right';
            cell.font = { name: 'Segoe UI', size: 10, color: { argb: 'FF0B3040' } };
          } else if (column.key.includes('D√≠as')) {
            // Centrar d√≠as
            cell.alignment.horizontal = 'center';
            cell.font = { name: 'Segoe UI', size: 10, bold: true };
          } else if (column.key === 'Establecimiento') {
            // Negrita para establecimiento
            cell.font = { name: 'Segoe UI', size: 10, bold: true, color: { argb: 'FF1A5F7A' } };
          } else if (column.key === 'Novedad') {
            // Color seg√∫n novedad
            cell.font = { 
              name: 'Segoe UI', 
              size: 10, 
              bold: true,
              color: cell.value === 'Sin cambios' ? { argb: 'FF28A745' } : { argb: 'FFDC3545' }
            };
            cell.alignment.horizontal = 'center';
          } else {
            cell.font = { name: 'Segoe UI', size: 10 };
          }
          
          // Filas alternas
          if ((index + 1) % 2 === 0) {
            cell.fill = {
              type: 'pattern',
              pattern: 'solid',
              fgColor: { argb: 'FFF8F9FA' }
            };
          }
        });
      });
      
      // Agregar filtros autom√°ticos
      worksheet.autoFilter = {
        from: 'A1',
        to: `${String.fromCharCode(65 + columns.length - 1)}1`
      };
      
      // Congelar paneles (primera fila)
      worksheet.views = [
        { state: 'frozen', xSplit: 0, ySplit: 1 }
      ];
      
      // Generar archivo
      const buffer = await workbook.xlsx.writeBuffer();
      const blob = new Blob([buffer], { 
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
      });
      saveAs(blob, fileName);
      
      console.log('‚úÖ Excel consolidado con formato Python creado exitosamente');
      return true;
      
    } catch (error) {
      console.error('‚ùå Error creando Excel consolidado:', error);
      return false;
    }
  }, []);

  // Funci√≥n para crear Excel formateado para reporte por sala con ExcelJS (replica Python)
  const createFormattedRoomExcel = useCallback(async (data, fileName, roomName = null) => {
    try {
      console.log(`üìä Creando Excel formateado para ${roomName ? `sala: ${roomName}` : 'reporte por sala'} con ExcelJS...`);
      
      if (!data || data.length === 0) {
        throw new Error('No hay datos para exportar');
      }
      
      // Crear workbook con ExcelJS
      const workbook = new ExcelJS.Workbook();
      workbook.creator = 'DR Group Dashboard';
      workbook.lastModifiedBy = 'Sistema de Liquidaciones';
      workbook.created = new Date();
      
      // Crear worksheet
      const sheetName = roomName ? roomName.substring(0, 31) : 'Reporte por Sala';
      const worksheet = workbook.addWorksheet(sheetName, {
        pageSetup: { 
          paperSize: 9, 
          orientation: 'landscape',
          fitToPage: true,
          fitToWidth: 1,
          fitToHeight: 0
        }
      });
      
      // Definir columnas para reporte por sala
      const columns = [
        { header: 'Empresa', key: 'Empresa', width: 18 },
        { header: 'Establecimiento', key: 'Establecimiento', width: 30 },
        { header: 'Total M√°quinas', key: 'Total M√°quinas', width: 15 },
        { header: 'Producci√≥n', key: 'Producci√≥n', width: 20 },
        { header: 'Derechos de Explotaci√≥n', key: 'Derechos de Explotaci√≥n', width: 25 },
        { header: 'Gastos de Administraci√≥n', key: 'Gastos de Administraci√≥n', width: 25 },
        { header: 'Total Impuestos', key: 'Total Impuestos', width: 20 },
        { header: 'Promedio/Establecimiento', key: 'Promedio/Establecimiento', width: 25 }
      ];
      
      worksheet.columns = columns;
      
      // Estilo de encabezado (azul medio como en Python)
      const headerRow = worksheet.getRow(1);
      headerRow.height = 25;
      
      headerRow.eachCell((cell, colNumber) => {
        cell.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FF1A5F7A' } // Azul medio corporativo
        };
        cell.font = {
          name: 'Segoe UI',
          size: 11,
          bold: true,
          color: { argb: 'FFFFFFFF' }
        };
        cell.alignment = {
          vertical: 'middle',
          horizontal: 'center',
          wrapText: true
        };
        cell.border = {
          top: { style: 'medium', color: { argb: 'FF0B3040' } },
          left: { style: 'thin', color: { argb: 'FF0B3040' } },
          bottom: { style: 'medium', color: { argb: 'FF0B3040' } },
          right: { style: 'thin', color: { argb: 'FF0B3040' } }
        };
      });
      
      // Agregar datos
      data.forEach((rowData, index) => {
        const row = worksheet.addRow(rowData);
        row.height = 22;
        
        // Formatear cada celda
        row.eachCell((cell, colNumber) => {
          const column = columns[colNumber - 1];
          
          // Formato base
          cell.alignment = {
            vertical: 'middle',
            horizontal: 'left'
          };
          
          cell.border = {
            top: { style: 'thin', color: { argb: 'FFD0D0D0' } },
            left: { style: 'thin', color: { argb: 'FFD0D0D0' } },
            bottom: { style: 'thin', color: { argb: 'FFD0D0D0' } },
            right: { style: 'thin', color: { argb: 'FFD0D0D0' } }
          };
          
          // Formato espec√≠fico por columna
          if (column.key.includes('Producci√≥n') || 
              column.key.includes('Derechos') || 
              column.key.includes('Gastos') || 
              column.key.includes('Impuestos') ||
              column.key.includes('Promedio')) {
            // Formato monetario
            cell.numFmt = '"$"#,##0_);[Red]("$"#,##0)';
            cell.alignment.horizontal = 'right';
            cell.font = { name: 'Segoe UI', size: 10, color: { argb: 'FF0B3040' } };
          } else if (column.key.includes('M√°quinas')) {
            // Centrar y resaltar m√°quinas
            cell.alignment.horizontal = 'center';
            cell.font = { name: 'Segoe UI', size: 10, bold: true, color: { argb: 'FF1A5F7A' } };
          } else if (column.key === 'Establecimiento') {
            // Negrita para establecimiento
            cell.font = { name: 'Segoe UI', size: 10, bold: true, color: { argb: 'FF0B3040' } };
          } else {
            cell.font = { name: 'Segoe UI', size: 10 };
          }
          
          // Filas alternas (azul claro/blanco)
          if ((index + 1) % 2 === 0) {
            cell.fill = {
              type: 'pattern',
              pattern: 'solid',
              fgColor: { argb: 'FFF0F8FF' } // Azul muy claro
            };
          } else {
            cell.fill = {
              type: 'pattern',
              pattern: 'solid',
              fgColor: { argb: 'FFFFFFFF' } // Blanco
            };
          }
        });
      });
      
      // Agregar fila de totales si hay m√∫ltiples salas
      if (data.length > 1) {
        // Fila vac√≠a
        worksheet.addRow({});
        
        // Calcular totales
        const totalMaquinas = data.reduce((sum, row) => sum + (row['Total M√°quinas'] || 0), 0);
        const totalProduccion = data.reduce((sum, row) => sum + (row['Producci√≥n'] || 0), 0);
        const totalDerechos = data.reduce((sum, row) => sum + (row['Derechos de Explotaci√≥n'] || 0), 0);
        const totalGastos = data.reduce((sum, row) => sum + (row['Gastos de Administraci√≥n'] || 0), 0);
        const totalImpuestos = data.reduce((sum, row) => sum + (row['Total Impuestos'] || 0), 0);
        const promedioGeneral = totalProduccion / totalMaquinas;
        
        // Fila de totales
        const totalRow = worksheet.addRow({
          'Empresa': '',
          'Establecimiento': 'TOTALES GENERALES',
          'Total M√°quinas': totalMaquinas,
          'Producci√≥n': totalProduccion,
          'Derechos de Explotaci√≥n': totalDerechos,
          'Gastos de Administraci√≥n': totalGastos,
          'Total Impuestos': totalImpuestos,
          'Promedio/Establecimiento': promedioGeneral
        });
        
        totalRow.height = 25;
        
        // Formatear fila de totales (verde como Python)
        totalRow.eachCell((cell, colNumber) => {
          cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FF28A745' } // Verde totales
          };
          cell.font = {
            name: 'Segoe UI',
            size: 11,
            bold: true,
            color: { argb: 'FFFFFFFF' }
          };
          cell.alignment = {
            vertical: 'middle',
            horizontal: colNumber === 2 ? 'left' : 'right'
          };
          cell.border = {
            top: { style: 'medium', color: { argb: 'FF000000' } },
            left: { style: 'thin', color: { argb: 'FF000000' } },
            bottom: { style: 'medium', color: { argb: 'FF000000' } },
            right: { style: 'thin', color: { argb: 'FF000000' } }
          };
          
          // Formato monetario para columnas num√©ricas
          if (colNumber >= 4 && colNumber !== 3) {
            cell.numFmt = '"$"#,##0_);[Red]("$"#,##0)';
          }
        });
      }
      
      // Agregar filtros autom√°ticos
      worksheet.autoFilter = {
        from: 'A1',
        to: `${String.fromCharCode(65 + columns.length - 1)}1`
      };
      
      // Congelar paneles (primera fila)
      worksheet.views = [
        { state: 'frozen', xSplit: 0, ySplit: 1 }
      ];
      
      // Generar archivo
      const buffer = await workbook.xlsx.writeBuffer();
      const blob = new Blob([buffer], { 
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
      });
      saveAs(blob, fileName);
      
      console.log(`‚úÖ Excel ${roomName ? 'por sala espec√≠fica' : 'por salas'} con formato Python creado exitosamente`);
      return true;
      
    } catch (error) {
      console.error('‚ùå Error creando Excel por sala:', error);
      return false;
    }
  }, []);

  // Funci√≥n para manejar exportaci√≥n por sala espec√≠fica - ACTUALIZADA con ExcelJS
  const handleRoomExport = useCallback(async () => {
    if (!selectedRoomForExport || !consolidatedData.length) {
      setError('Debe seleccionar una sala para exportar');
      return;
    }

    // Filtrar datos por sala seleccionada
    const roomData = consolidatedData.filter(row => row.Establecimiento === selectedRoomForExport);
    
    if (!roomData.length) {
      setError('No hay datos para la sala seleccionada');
      return;
    }

    console.log(`üìä Exportando ${roomData.length} registros de sala: ${selectedRoomForExport}`);

    const fileName = `Liquidacion_${selectedRoomForExport.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.${exportFormat}`;
    
    try {
      if (exportFormat === 'xlsx') {
        // Usar funci√≥n de formato profesional con ExcelJS
        const success = await createFormattedConsolidatedExcel(roomData, fileName);
        if (!success) {
          throw new Error('Error al crear archivo Excel formateado');
        }
      } else {
        // CSV simple
        const csv = Papa.unparse(roomData);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        saveAs(blob, fileName);
      }
      
      console.log(`‚úÖ Archivo exportado: ${fileName}`);
      
      // Cerrar modal y limpiar selecci√≥n
      setShowRoomExportDialog(false);
      setSelectedRoomForExport('');
      
    } catch (err) {
      console.error('‚ùå Error exportando:', err);
      setError(`Error al exportar: ${err.message}`);
    }
  }, [selectedRoomForExport, consolidatedData, exportFormat, createFormattedConsolidatedExcel]);

  // Funci√≥n para abrir modal de exportaci√≥n por sala
  const openRoomExportDialog = useCallback((format = 'xlsx') => {
    const rooms = getAvailableRooms();
    
    if (!rooms.length) {
      setError('No hay salas disponibles para exportar. Procesa primero un archivo de liquidaci√≥n.');
      return;
    }
    
    setAvailableRooms(rooms);
    setExportFormat(format);
    setSelectedRoomForExport('');
    setShowRoomExportDialog(true);
  }, [getAvailableRooms]);

  // Funci√≥n para exportar resultados - CORREGIDA
  const handleExport = useCallback((format = 'xlsx', type = 'consolidated') => {
    if (type === 'rooms') {
      // Abrir modal para seleccionar sala
      openRoomExportDialog(format);
      return;
    }

    const dataToExport = type === 'consolidated' ? consolidatedData : roomReportData;
    
    if (!dataToExport.length) {
      setError('No hay datos para exportar');
      return;
    }

    // Aplicar filtros si es datos consolidados
    let filteredData = dataToExport;
    if (type === 'consolidated') {
      filteredData = dataToExport.filter(row => {
        const matchesSearch = !searchTerm || 
          Object.values(row).some(value => 
            value?.toString().toLowerCase().includes(searchTerm.toLowerCase())
          );
        
        const matchesEstablishment = establishmentFilter === 'all' || 
          row.Establecimiento === establishmentFilter;
        
        const matchesPeriod = periodFilter === 'all' || 
          row['Per√≠odo Texto'] === periodFilter;

        return matchesSearch && matchesEstablishment && matchesPeriod;
      });
    }

    // Formatear datos para exportaci√≥n
    const exportData = filteredData.map(row => {
      const formattedRow = { ...row };
      // Formatear campos monetarios para exportaci√≥n
      if (typeof formattedRow['Producci√≥n'] === 'number') {
        formattedRow['Producci√≥n'] = formattedRow['Producci√≥n'];
      }
      if (typeof formattedRow['Derechos de Explotaci√≥n'] === 'number') {
        formattedRow['Derechos de Explotaci√≥n'] = formattedRow['Derechos de Explotaci√≥n'];
      }
      if (typeof formattedRow['Gastos de Administraci√≥n'] === 'number') {
        formattedRow['Gastos de Administraci√≥n'] = formattedRow['Gastos de Administraci√≥n'];
      }
      if (typeof formattedRow['Total Impuestos'] === 'number') {
        formattedRow['Total Impuestos'] = formattedRow['Total Impuestos'];
      }
      return formattedRow;
    });

  // Funci√≥n para exportar resultados - ACTUALIZADA con ExcelJS
  const handleExport = useCallback(async (format = 'xlsx', type = 'consolidated') => {
    if (type === 'rooms') {
      // Abrir modal para seleccionar sala
      openRoomExportDialog(format);
      return;
    }

    const dataToExport = type === 'consolidated' ? consolidatedData : roomReportData;
    
    if (!dataToExport.length) {
      setError('No hay datos para exportar');
      return;
    }

    // Aplicar filtros si es datos consolidados
    let filteredData = dataToExport;
    if (type === 'consolidated') {
      filteredData = dataToExport.filter(row => {
        const matchesSearch = !searchTerm || 
          Object.values(row).some(value => 
            value?.toString().toLowerCase().includes(searchTerm.toLowerCase())
          );
        
        const matchesEstablishment = establishmentFilter === 'all' || 
          row.Establecimiento === establishmentFilter;
        
        const matchesPeriod = periodFilter === 'all' || 
          row['Per√≠odo Texto'] === periodFilter;

        return matchesSearch && matchesEstablishment && matchesPeriod;
      });
    }

    // Formatear datos para exportaci√≥n
    const exportData = filteredData.map(row => {
      const formattedRow = { ...row };
      // Formatear campos monetarios para exportaci√≥n
      if (typeof formattedRow['Producci√≥n'] === 'number') {
        formattedRow['Producci√≥n'] = formattedRow['Producci√≥n'];
      }
      if (typeof formattedRow['Derechos de Explotaci√≥n'] === 'number') {
        formattedRow['Derechos de Explotaci√≥n'] = formattedRow['Derechos de Explotaci√≥n'];
      }
      if (typeof formattedRow['Gastos de Administraci√≥n'] === 'number') {
        formattedRow['Gastos de Administraci√≥n'] = formattedRow['Gastos de Administraci√≥n'];
      }
      if (typeof formattedRow['Total Impuestos'] === 'number') {
        formattedRow['Total Impuestos'] = formattedRow['Total Impuestos'];
      }
      return formattedRow;
    });

    const fileName = type === 'consolidated' 
      ? `Liquidacion_Consolidada_${selectedCompany.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}`
      : `Reporte_por_Sala_${selectedCompany.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}`;

    try {
      if (format === 'xlsx') {
        let success = false;
        
        if (type === 'consolidated') {
          // Usar formato profesional para consolidado con ExcelJS
          success = await createFormattedConsolidatedExcel(exportData, `${fileName}.xlsx`);
        } else {
          // Usar formato profesional para sala con ExcelJS
          success = await createFormattedRoomExcel(exportData, `${fileName}.xlsx`);
        }
        
        if (!success) {
          throw new Error('Error al crear archivo Excel con formato profesional');
        }
      } else {
        // CSV simple
        const csv = Papa.unparse(exportData);
        const data = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        saveAs(data, `${fileName}.csv`);
      }

      console.log(`üì• Exportaci√≥n completada con formato Python exacto: ${fileName}.${format}`);
      
    } catch (err) {
      console.error('‚ùå Error en exportaci√≥n:', err);
      setError(`Error al exportar: ${err.message}`);
    }
  }, [consolidatedData, roomReportData, searchTerm, establishmentFilter, periodFilter, selectedCompany, openRoomExportDialog, createFormattedConsolidatedExcel, createFormattedRoomExcel]);

  // Funci√≥n para limpiar todo - CORREGIDA
  const handleClearAll = useCallback(() => {
    setLiquidationFile(null);
    setSelectedCompany('');
    setLiquidationData([]);
    setConsolidatedData([]);
    setRoomReportData([]);
    setSearchTerm('');
    setEstablishmentFilter('all');
    setPeriodFilter('all');
    setShowResults(false);
    setError(null);
    setProcessing(false);
    setPage(0); // Reset pagination
    console.log('üßπ Aplicaci√≥n reiniciada');
  }, []);

  // Funci√≥n para guardar - CORREGIDA
  const handleSave = useCallback(() => {
    if (!consolidatedData.length) {
      setError('No hay datos consolidados para guardar');
      return;
    }

    // TODO: Implementar funcionalidad de guardado en Firebase
    console.log('üíæ Guardando datos...', {
      empresa: selectedCompany,
      maquinasConsolidadas: consolidatedData.length,
      establecimientos: roomReportData.length,
      filtros: { searchTerm, establishmentFilter, periodFilter }
    });
    
    // Simulamos guardado exitoso
    console.log('‚úÖ Datos guardados correctamente');
  }, [consolidatedData, roomReportData, selectedCompany, searchTerm, establishmentFilter, periodFilter]);

  // Handlers de paginaci√≥n
  const handleChangePage = useCallback((event, newPage) => {
    setPage(newPage);
  }, []);

  const handleChangeRowsPerPage = useCallback((event) => {
    const newRowsPerPage = parseInt(event.target.value, 10);
    setRowsPerPage(newRowsPerPage);
    setPage(0);
  }, []);

  // Handler para resetear paginaci√≥n cuando cambien los filtros
  const resetPagination = useCallback(() => {
    setPage(0);
  }, []);

  // Reset paginaci√≥n cuando cambien los filtros
  React.useEffect(() => {
    resetPagination();
  }, [searchTerm, establishmentFilter, periodFilter, resetPagination]);

  // Datos filtrados para mostrar - CORREGIDOS
  const filteredResults = useMemo(() => {
    if (!consolidatedData.length) return [];

    return consolidatedData.filter(row => {
      const matchesSearch = !searchTerm || 
        Object.values(row).some(value => 
          value?.toString().toLowerCase().includes(searchTerm.toLowerCase())
        );
      
      const matchesEstablishment = establishmentFilter === 'all' || 
        row.Establecimiento === establishmentFilter;
      
      const matchesPeriod = periodFilter === 'all' || 
        row['Per√≠odo Texto'] === periodFilter;

      return matchesSearch && matchesEstablishment && matchesPeriod;
    });
  }, [consolidatedData, searchTerm, establishmentFilter, periodFilter]);

  // Datos paginados para mostrar en la tabla
  const paginatedResults = useMemo(() => {
    const startIndex = page * rowsPerPage;
    const endIndex = startIndex + rowsPerPage;
    return filteredResults.slice(startIndex, endIndex);
  }, [filteredResults, page, rowsPerPage]);

  // Obtener valores √∫nicos para filtros - CORREGIDOS
  const uniqueEstablishments = useMemo(() => {
    const establishments = consolidatedData.map(row => row.Establecimiento);
    return [...new Set(establishments)].filter(Boolean).sort();
  }, [consolidatedData]);

  const uniquePeriods = useMemo(() => {
    const periods = consolidatedData.map(row => row['Per√≠odo Texto']);
    return [...new Set(periods)].filter(Boolean).sort();
  }, [consolidatedData]);

  // Stats financieros y por salas - CORREGIDOS
  const financialStats = useMemo(() => {
    if (!consolidatedData.length) {
      return {
        totalProduccion: 0,
        totalDerechos: 0,
        totalGastos: 0,
        totalImpuestos: 0,
        totalGeneral: 0
      };
    }

    const totalProduccion = consolidatedData.reduce((sum, row) => {
      return sum + (Number(row['Producci√≥n']) || 0);
    }, 0);

    const totalDerechos = consolidatedData.reduce((sum, row) => {
      return sum + (Number(row['Derechos de Explotaci√≥n']) || 0);
    }, 0);

    const totalGastos = consolidatedData.reduce((sum, row) => {
      return sum + (Number(row['Gastos de Administraci√≥n']) || 0);
    }, 0);

    const totalImpuestos = consolidatedData.reduce((sum, row) => {
      return sum + (Number(row['Total Impuestos']) || 0);
    }, 0);

    return {
      totalProduccion,
      totalDerechos,
      totalGastos,
      totalImpuestos,
      totalGeneral: totalDerechos + totalGastos  // Para compatibilidad
    };
  }, [consolidatedData]);

  // Stats por salas - CORREGIDOS
  const roomStats = useMemo(() => {
    if (!roomReportData.length) return [];

    return roomReportData.map(room => ({
      name: room.Establecimiento,
      empresa: room.Empresa,
      machinesCount: room['Total M√°quinas'],
      derechos: room['Derechos de Explotaci√≥n'],
      gastos: room['Gastos de Administraci√≥n'],
      total: room['Total Impuestos'],
      produccion: room['Producci√≥n']
    })).sort((a, b) => b.total - a.total);
  }, [roomReportData]);

  // Stats para mostrar - CORREGIDOS
  const stats = useMemo(() => ({
    totalRecords: consolidatedData.length,
    filteredRecords: filteredResults.length,
    establishments: uniqueEstablishments.length,
    periods: uniquePeriods.length,
    companiesFound: consolidatedData.filter(row => row.Empresa && row.Empresa !== 'No especificada').length,
    establishmentsNotFound: consolidatedData.filter(row => row.Establecimiento === 'No encontrado').length,
    // Estad√≠sticas financieras
    totalProduccion: financialStats.totalProduccion,
    totalDerechos: financialStats.totalDerechos,
    totalGastos: financialStats.totalGastos,
    totalImpuestos: financialStats.totalImpuestos,
    totalGeneral: financialStats.totalGeneral,
    totalMachines: consolidatedData.length,
    // Estad√≠sticas de novedades
    sinCambios: consolidatedData.filter(row => row.Novedad === 'Sin cambios').length,
    conNovedades: consolidatedData.filter(row => row.Novedad === 'Retiro / Adici√≥n').length
  }), [consolidatedData, filteredResults, uniqueEstablishments, uniquePeriods, financialStats]);

  return (
    <StyledContainer>
      {/* Header Premium con Gradiente Din√°mico - EXACTO a Due Commitments */}
      <motion.div
        initial={settings.theme?.animations ? { opacity: 0, y: -20 } : {}}
        animate={settings.theme?.animations ? { opacity: 1, y: 0 } : { opacity: 1, y: 0 }}
        transition={settings.theme?.animations ? { duration: 0.6, type: "spring" } : { duration: 0 }}
      >
        <Box
          sx={{
            background: `linear-gradient(135deg, ${settings.theme?.primaryColor || '#667eea'} 0%, ${settings.theme?.secondaryColor || '#764ba2'} 100%)`,
            borderRadius: `${settings.theme?.borderRadius || 16}px`,
            p: settings.theme?.compactMode ? 3 : 4,
            mb: 3,
            color: 'white',
            position: 'relative',
            overflow: 'hidden',
            '&::before': {
              content: '""',
              position: 'absolute',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(255, 255, 255, 0.1)',
              borderRadius: `${settings.theme?.borderRadius || 16}px`,
              zIndex: 0,
            }
          }}
        >
          <Box sx={{ position: 'relative', zIndex: 1 }}>
            <Box display="flex" alignItems="center" justifyContent="space-between">
              <Box display="flex" alignItems="center" gap={2}>
                <Box
                  sx={{
                    p: 1.5,
                    bgcolor: 'rgba(255, 255, 255, 0.2)',
                    borderRadius: `${(settings.theme?.borderRadius || 16) / 2}px`,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}
                >
                  <Analytics sx={{ fontSize: (settings.theme?.fontSize || 16) * 2.3, color: 'white' }} />
                </Box>
                <Box>
                  <Typography 
                    variant="h4" 
                    fontWeight="700" 
                    sx={{ 
                      color: 'white', 
                      mb: 0.5,
                      fontSize: settings.theme?.fontSize ? `${settings.theme.fontSize + 8}px` : '2rem',
                      fontFamily: settings.theme?.fontFamily || 'inherit'
                    }}
                  >
                    Procesador de Liquidaciones
                  </Typography>
                  <Typography 
                    variant="subtitle1" 
                    sx={{ 
                      color: 'rgba(255, 255, 255, 0.9)',
                      fontSize: settings.theme?.fontSize ? `${settings.theme.fontSize + 2}px` : '1.125rem',
                      fontFamily: settings.theme?.fontFamily || 'inherit'
                    }}
                  >
                    Herramienta para cruzar datos entre Base de Liquidaci√≥n e Inventario, generando la "Liquidaci√≥n Final" con informaci√≥n completa
                  </Typography>
                </Box>
              </Box>
              
              {/* Botones de Acci√≥n */}
              <Box display="flex" gap={2}>
                {/* Bot√≥n Limpiar */}
                <motion.div
                  initial={settings.theme?.animations ? { x: 20, opacity: 0 } : {}}
                  animate={settings.theme?.animations ? { x: 0, opacity: 1 } : { x: 0, opacity: 1 }}
                  transition={settings.theme?.animations ? { delay: 0.1, duration: 0.5 } : { duration: 0 }}
                  whileHover={settings.theme?.animations ? { scale: 1.05 } : {}}
                  whileTap={settings.theme?.animations ? { scale: 0.95 } : {}}
                >
                  <Button
                    variant="outlined"
                    startIcon={<DeleteSweep />}
                    onClick={handleClearAll}
                    disabled={!liquidationFile && !consolidatedData.length}
                    size={settings.theme?.compactMode ? "medium" : "large"}
                    sx={{
                      py: settings.theme?.compactMode ? 1 : 1.5,
                      px: settings.theme?.compactMode ? 2.5 : 3.5,
                      fontSize: settings.theme?.fontSize ? `${settings.theme.fontSize * 1}px` : '1rem',
                      fontWeight: 600,
                      fontFamily: settings.theme?.fontFamily || 'inherit',
                      borderRadius: `${settings.theme?.borderRadius || 16}px`,
                      border: '2px solid rgba(255, 255, 255, 0.5)',
                      color: 'white',
                      textTransform: 'none',
                      backdropFilter: 'blur(10px)',
                      transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                      '&:hover': {
                        background: 'rgba(255, 152, 0, 0.15)', // Naranja suave para indicar limpieza
                        borderColor: 'rgba(255, 193, 7, 0.8)',
                        transform: 'translateY(-2px)',
                        boxShadow: '0 6px 20px rgba(255, 152, 0, 0.3)'
                      },
                      '&:disabled': {
                        opacity: 0.6,
                        cursor: 'not-allowed'
                      }
                    }}
                  >
                    Limpiar Todo
                  </Button>
                </motion.div>

                {/* Bot√≥n Guardar */}
                <motion.div
                  initial={settings.theme?.animations ? { x: 20, opacity: 0 } : {}}
                  animate={settings.theme?.animations ? { x: 0, opacity: 1 } : { x: 0, opacity: 1 }}
                  transition={settings.theme?.animations ? { delay: 0.2, duration: 0.5 } : { duration: 0 }}
                  whileHover={settings.theme?.animations ? { scale: 1.05 } : {}}
                  whileTap={settings.theme?.animations ? { scale: 0.95 } : {}}
                >
                  <Button
                    variant="outlined"
                    startIcon={<Save />}
                    onClick={handleSave}
                    disabled={!consolidatedData.length}
                    size={settings.theme?.compactMode ? "medium" : "large"}
                    sx={{
                      py: settings.theme?.compactMode ? 1 : 1.5,
                      px: settings.theme?.compactMode ? 2.5 : 3.5,
                      fontSize: settings.theme?.fontSize ? `${settings.theme.fontSize * 1}px` : '1rem',
                      fontWeight: 600,
                      fontFamily: settings.theme?.fontFamily || 'inherit',
                      borderRadius: `${settings.theme?.borderRadius || 16}px`,
                      border: '2px solid rgba(255, 255, 255, 0.5)',
                      color: 'white',
                      textTransform: 'none',
                      backdropFilter: 'blur(10px)',
                      transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                      '&:hover': {
                        background: 'rgba(255, 255, 255, 0.15)',
                        borderColor: 'rgba(255, 255, 255, 0.8)',
                        transform: 'translateY(-2px)',
                        boxShadow: '0 6px 20px rgba(0, 0, 0, 0.3)'
                      },
                      '&:disabled': {
                        opacity: 0.6,
                        cursor: 'not-allowed'
                      }
                    }}
                  >
                    {!consolidatedData.length ? 'Guardar' : 'Guardar Consolidado'}
                  </Button>
                </motion.div>
              </Box>
            </Box>
          </Box>
        </Box>
      </motion.div>

      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.6, ease: 'easeOut' }}
      >
        {/* Error Alert */}
        <AnimatePresence>
          {error && (
            <motion.div
              initial={{ opacity: 0, y: -20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -20 }}
              transition={{ duration: 0.3 }}
            >
              <SpectacularAlert 
                severity="error" 
                sx={{ mb: 3 }}
                action={
                  <IconButton
                    aria-label="close"
                    color="inherit"
                    size="small"
                    onClick={() => setError(null)}
                  >
                    <Clear fontSize="inherit" />
                  </IconButton>
                }
              >
                {error}
              </SpectacularAlert>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Upload Section - CORREGIDA para un solo archivo */}
        <Grid container spacing={3} sx={{ mb: 4 }}>
          {/* Archivo de Liquidaci√≥n */}
          <Grid item xs={12}>
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.6, delay: 0.2 }}
            >
              <SpectacularCard sx={{ height: '100%' }} borderRadius={settings.theme?.borderRadius}>
                <CardContent sx={{ padding: theme.spacing(3) }}>
                  <Typography variant="h6" sx={{ mb: 2, display: 'flex', alignItems: 'center', gap: 1 }}>
                    <Assignment color="primary" />
                    Archivo de Liquidaci√≥n Diaria
                  </Typography>
                  
                  <Typography variant="body2" color="text.secondary" sx={{ mb: 3 }}>
                    {selectedCompany ? (
                      <>
                        <Box component="span" sx={{ display: 'block' }}>
                          üìã <strong>Empresa detectada:</strong> {selectedCompany}
                        </Box>
                        {detectedContractNumber && (
                          <Box component="span" sx={{ display: 'block', mt: 0.5 }}>
                            üìÑ <strong>N√∫mero de contrato:</strong> {detectedContractNumber}
                          </Box>
                        )}
                      </>
                    ) : (
                      'üìã Sube un archivo para detectar autom√°ticamente la empresa'
                    )}
                  </Typography>
                  
                  <UploadZone
                    hasFile={liquidationFile !== null}
                    isDragOver={dragOverLiquidation}
                    borderRadius={settings.theme?.borderRadius}
                    onDragOver={handleDragOver}
                    onDragLeave={handleDragLeave}
                    onDrop={handleDrop}
                    onClick={() => document.getElementById('liquidation-file').click()}
                  >
                    <input
                      id="liquidation-file"
                      type="file"
                      accept=".xlsx,.xls,.csv"
                      style={{ display: 'none' }}
                      onChange={handleFileSelect}
                    />
                    
                    {liquidationFile ? (
                      <Box>
                        <CheckCircle sx={{ fontSize: 36, color: theme.palette.success.main, mb: 1.5 }} />
                        <Typography variant="h6" color="success.main">
                          {liquidationFile.name}
                        </Typography>
                        <Typography variant="body2" color="success.dark">
                          {liquidationData.length} registros cargados
                          {selectedCompany && (
                            <Box component="span" sx={{ display: 'block', mt: 0.5 }}>
                              üè¢ Empresa: {selectedCompany}
                              {detectedContractNumber && ` ‚Ä¢ Contrato: ${detectedContractNumber}`}
                            </Box>
                          )}
                        </Typography>
                      </Box>
                    ) : (
                      <Box>
                        <CloudUpload sx={{ fontSize: 36, color: theme.palette.primary.main, mb: 1.5 }} />
                        <Typography variant="h6" color="primary">
                          Arrastra o selecciona archivo de liquidaci√≥n
                        </Typography>
                        <Typography variant="body2" color="text.secondary" sx={{ textAlign: 'center', maxWidth: 600, mx: 'auto' }}>
                          üìä Archivo Excel (.xlsx) o CSV con datos de liquidaci√≥n diaria.<br/>
                          <strong>Columnas requeridas:</strong> Serial, NUC/NUID, Establecimiento, Base Liquidaci√≥n Diaria, Fecha Reporte<br/>
                          <strong>Columnas opcionales:</strong> Tipo Apuesta<br/><br/>
                          ‚ö° <em>Al seleccionar el archivo se te pedir√° el nombre de la empresa</em>
                        </Typography>
                      </Box>
                    )}
                  </UploadZone>
                </CardContent>
              </SpectacularCard>
            </motion.div>
          </Grid>
        </Grid>

        {/* Process Button - CORREGIDO */}
        <Box sx={{ textAlign: 'center', mb: 4 }}>
          <motion.div
            initial={{ opacity: 0, scale: 0.8 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ duration: 0.6, delay: 0.4 }}
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
          >
            <ProcessButton
              size="medium"
              startIcon={processing ? <Stop /> : <PlayArrow />}
              disabled={!liquidationFile || !selectedCompany || processing}
              onClick={handleProcessFiles}
              sx={{ px: 3, py: 1.2 }}
            >
              {processing ? 'Procesando Liquidaci√≥n...' : 'Procesar Liquidaci√≥n'}
            </ProcessButton>
          </motion.div>
          
          {processing && (
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ duration: 0.3, delay: 0.2 }}
            >
              <LinearProgress sx={{ mt: 2, borderRadius: 2 }} />
              <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
                Consolidando datos por Serial y calculando impuestos...
              </Typography>
            </motion.div>
          )}
        </Box>

        <AnimatePresence>
          {showResults && consolidatedData.length > 0 && (
            <motion.div
              initial={{ opacity: 0, y: 30 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -30 }}
              transition={{ duration: 0.6 }}
            >
              {/* Stats Cards - Actualizadas con datos consolidados */}
              <Grid container spacing={2} mb={4} justifyContent="center">
                {[
                  {
                    title: 'Total Producci√≥n',
                    value: formatCOP(stats.totalProduccion),
                    icon: AttachMoney,
                    iconBg: '#e8f5e8',
                    iconColor: '#4caf50'
                  },
                  {
                    title: 'Derechos Explotaci√≥n',
                    value: formatCOP(stats.totalDerechos),
                    icon: MonetizationOn,
                    iconBg: '#fff8e1',
                    iconColor: '#ffa000'
                  },
                  {
                    title: 'Gastos Administraci√≥n',
                    value: formatCOP(stats.totalGastos),
                    icon: TrendingUp,
                    iconBg: '#e3f2fd',
                    iconColor: '#2196f3'
                  },
                  {
                    title: 'TOTAL IMPUESTOS',
                    value: formatCOP(stats.totalImpuestos),
                    icon: PrecisionManufacturing,
                    iconBg: '#f3e5f5',
                    iconColor: '#9c27b0'
                  },
                  {
                    title: 'Total M√°quinas',
                    value: stats.totalMachines,
                    icon: Business,
                    iconBg: '#fff3e0',
                    iconColor: '#ff9800'
                  }
                ].map((stat, index) => (
                  <Grid item xs={12} sm={6} md={2.4} lg={2.4} xl={2.4} key={index}>
                    <motion.div
                      initial={{ opacity: 0, y: 20 }}
                      animate={{ opacity: 1, y: 0 }}
                      transition={{ 
                        duration: 0.4, 
                        delay: index * 0.1,
                        ease: "easeOut"
                      }}
                    >
                      <Card
                        sx={{
                          p: 2,
                          height: 120,
                          background: 'white',
                          borderRadius: 1,
                          border: '1px solid #f0f0f0',
                          boxShadow: '0 2px 8px rgba(0,0,0,0.04)',
                          transition: 'all 0.3s ease',
                          '&:hover': {
                            boxShadow: '0 8px 24px rgba(0,0,0,0.12)',
                            transform: 'translateY(-2px)',
                          }
                        }}
                      >
                        <Box sx={{ 
                          display: 'flex', 
                          justifyContent: 'space-between', 
                          alignItems: 'flex-start',
                          height: '100%'
                        }}>
                          <Box sx={{ flex: 1 }}>
                            <Typography 
                              variant="h3" 
                              sx={{ 
                                fontWeight: 600,
                                color: '#1a1a1a',
                                mb: 0.5,
                                fontSize: stat.title.includes('$') || stat.title.includes('Total') ? '1.4rem' : '1.75rem',
                                lineHeight: 1.2
                              }}
                            >
                              {stat.value}
                            </Typography>
                            <Typography 
                              variant="body2" 
                              sx={{ 
                                color: '#666',
                                fontWeight: 500,
                                mb: 1.5,
                                lineHeight: 1.3
                              }}
                            >
                              {stat.title}
                            </Typography>
                          </Box>
                          <Box
                            sx={{
                              width: 44,
                              height: 44,
                              borderRadius: 1,
                              backgroundColor: stat.iconBg,
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center'
                            }}
                          >
                            <stat.icon sx={{ fontSize: 22, color: stat.iconColor }} />
                          </Box>
                        </Box>
                      </Card>
                    </motion.div>
                  </Grid>
                ))}
              </Grid>

              {/* Segunda fila de estad√≠sticas - Novedades y an√°lisis */}
              <Grid container spacing={2} mb={4} justifyContent="center">
                {[
                  {
                    title: 'Sin Cambios',
                    value: `${stats.sinCambios} (${stats.totalMachines > 0 ? ((stats.sinCambios / stats.totalMachines) * 100).toFixed(1) : 0}%)`,
                    icon: CheckCircle,
                    iconBg: '#e8f5e8',
                    iconColor: '#4caf50'
                  },
                  {
                    title: 'Con Novedades',
                    value: `${stats.conNovedades} (${stats.totalMachines > 0 ? ((stats.conNovedades / stats.totalMachines) * 100).toFixed(1) : 0}%)`,
                    icon: Warning,
                    iconBg: '#fff8e1',
                    iconColor: '#ff9800'
                  },
                  {
                    title: 'Establecimientos',
                    value: stats.establishments,
                    icon: Store,
                    iconBg: '#e3f2fd',
                    iconColor: '#2196f3'
                  },
                  {
                    title: 'Per√≠odos',
                    value: stats.periods,
                    icon: DateRange,
                    iconBg: '#f3e5f5',
                    iconColor: '#9c27b0'
                  },
                  {
                    title: 'Promedio/Establecimiento',
                    value: formatCOP(stats.establishments > 0 ? stats.totalProduccion / stats.establishments : 0),
                    icon: Analytics,
                    iconBg: '#fff3e0',
                    iconColor: '#ff9800'
                  }
                ].map((stat, index) => (
                  <Grid item xs={12} sm={6} md={2.4} lg={2.4} xl={2.4} key={`stat2-${index}`}>
                    <motion.div
                      initial={{ opacity: 0, y: 20 }}
                      animate={{ opacity: 1, y: 0 }}
                      transition={{ 
                        duration: 0.4, 
                        delay: 0.5 + (index * 0.1),
                        ease: "easeOut"
                      }}
                    >
                      <Card
                        sx={{
                          p: 2,
                          height: 120,
                          background: 'white',
                          borderRadius: 1,
                          border: '1px solid #f0f0f0',
                          boxShadow: '0 2px 8px rgba(0,0,0,0.04)',
                          transition: 'all 0.3s ease',
                          '&:hover': {
                            boxShadow: '0 8px 24px rgba(0,0,0,0.12)',
                            transform: 'translateY(-2px)',
                          }
                        }}
                      >
                        <Box sx={{ 
                          display: 'flex', 
                          justifyContent: 'space-between', 
                          alignItems: 'flex-start',
                          height: '100%'
                        }}>
                          <Box sx={{ flex: 1 }}>
                            <Typography 
                              variant="h3" 
                              sx={{ 
                                fontWeight: 600,
                                color: '#1a1a1a',
                                mb: 0.5,
                                fontSize: stat.title.includes('%') ? '1.2rem' : '1.6rem',
                                lineHeight: 1.2
                              }}
                            >
                              {stat.value}
                            </Typography>
                            <Typography 
                              variant="body2" 
                              sx={{ 
                                color: '#666',
                                fontWeight: 500,
                                mb: 1.5,
                                lineHeight: 1.3
                              }}
                            >
                              {stat.title}
                            </Typography>
                          </Box>
                          <Box
                            sx={{
                              width: 44,
                              height: 44,
                              borderRadius: 1,
                              backgroundColor: stat.iconBg,
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center'
                            }}
                          >
                            <stat.icon sx={{ fontSize: 22, color: stat.iconColor }} />
                          </Box>
                        </Box>
                      </Card>
                    </motion.div>
                  </Grid>
                ))}
              </Grid>

              {/* Secci√≥n de An√°lisis por Salas */}
              {roomStats.length > 0 && (
                <motion.div
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ duration: 0.5, delay: 0.6 }}
                >
                  <SpectacularCard sx={{ mb: 3 }}>
                    <CardContent sx={{ padding: theme.spacing(3) }}>
                      <Box 
                        sx={{ 
                          display: 'flex', 
                          alignItems: 'center', 
                          justifyContent: 'space-between',
                          cursor: 'pointer',
                          mb: expandRoomAnalysis ? 3 : 0
                        }}
                        onClick={() => setExpandRoomAnalysis(!expandRoomAnalysis)}
                      >
                        <Box sx={{ display: 'flex', alignItems: 'center' }}>
                          <Analytics sx={{ 
                            fontSize: 28, 
                            color: theme.palette.primary.main, 
                            mr: 2 
                          }} />
                          <Box>
                            <Typography 
                              variant="h5" 
                              sx={{ 
                                fontWeight: 700,
                                color: theme.palette.primary.main,
                                mb: 0.5
                              }}
                            >
                              An√°lisis por Salas
                            </Typography>
                            <Typography 
                              variant="body2" 
                              color="text.secondary"
                            >
                              Desglose detallado de ingresos y m√°quinas por establecimiento
                            </Typography>
                          </Box>
                        </Box>
                        <Box sx={{ display: 'flex', alignItems: 'center' }}>
                          <Chip 
                            label={`${roomStats.length} salas`}
                            size="small"
                            color="primary"
                            variant="outlined"
                            sx={{ mr: 1 }}
                          />
                          {expandRoomAnalysis ? 
                            <ExpandLess sx={{ fontSize: 28, color: theme.palette.primary.main }} /> : 
                            <ExpandMore sx={{ fontSize: 28, color: theme.palette.primary.main }} />
                          }
                        </Box>
                      </Box>

                      <AnimatePresence>
                        {expandRoomAnalysis && (
                          <motion.div
                            initial={{ opacity: 0, height: 0 }}
                            animate={{ opacity: 1, height: 'auto' }}
                            exit={{ opacity: 0, height: 0 }}
                            transition={{ duration: 0.4, ease: "easeInOut" }}
                            style={{ overflow: 'hidden' }}
                          >
                            <Divider sx={{ mb: 3 }} />
                            
                            {/* Resumen r√°pido */}
                            <Grid container spacing={2} sx={{ mb: 4 }}>
                              <Grid item xs={12} sm={3}>
                                <Box sx={{ 
                                  p: 2, 
                                  background: 'linear-gradient(135deg, #e8f5e8, #f0f8f0)',
                                  borderRadius: 2,
                                  textAlign: 'center'
                                }}>
                                  <Typography variant="h6" color="success.main" sx={{ fontWeight: 600 }}>
                                    {financialStats.totalDerechos.toLocaleString('es-CO', { 
                                      style: 'currency', 
                                      currency: 'COP',
                                      minimumFractionDigits: 0
                                    })}
                                  </Typography>
                                  <Typography variant="body2" color="text.secondary">
                                    Total Derechos
                                  </Typography>
                                </Box>
                              </Grid>
                              <Grid item xs={12} sm={3}>
                                <Box sx={{ 
                                  p: 2, 
                                  background: 'linear-gradient(135deg, #fff3e0, #fff8f0)',
                                  borderRadius: 2,
                                  textAlign: 'center'
                                }}>
                                  <Typography variant="h6" color="warning.main" sx={{ fontWeight: 600 }}>
                                    {financialStats.totalGastos.toLocaleString('es-CO', { 
                                      style: 'currency', 
                                      currency: 'COP',
                                      minimumFractionDigits: 0
                                    })}
                                  </Typography>
                                  <Typography variant="body2" color="text.secondary">
                                    Total Gastos
                                  </Typography>
                                </Box>
                              </Grid>
                              <Grid item xs={12} sm={3}>
                                <Box sx={{ 
                                  p: 2, 
                                  background: 'linear-gradient(135deg, #e3f2fd, #f0f8ff)',
                                  borderRadius: 2,
                                  textAlign: 'center'
                                }}>
                                  <Typography variant="h6" color="primary.main" sx={{ fontWeight: 600 }}>
                                    {financialStats.totalGeneral.toLocaleString('es-CO', { 
                                      style: 'currency', 
                                      currency: 'COP',
                                      minimumFractionDigits: 0
                                    })}
                                  </Typography>
                                  <Typography variant="body2" color="text.secondary">
                                    Total General
                                  </Typography>
                                </Box>
                              </Grid>
                              <Grid item xs={12} sm={3}>
                                <Box sx={{ 
                                  p: 2, 
                                  background: 'linear-gradient(135deg, #f3e5f5, #f8f0f8)',
                                  borderRadius: 2,
                                  textAlign: 'center'
                                }}>
                                  <Typography variant="h6" color="secondary.main" sx={{ fontWeight: 600 }}>
                                    {stats.totalMachines}
                                  </Typography>
                                  <Typography variant="body2" color="text.secondary">
                                    Total M√°quinas
                                  </Typography>
                                </Box>
                              </Grid>
                            </Grid>

                            {/* Tabla detallada por salas */}
                            <Typography variant="h6" sx={{ mb: 2, fontWeight: 600 }}>
                              Detalle por Establecimiento
                            </Typography>
                            
                            <SpectacularPaper>
                              <TableContainer>
                                <Table>
                                  <TableHead>
                                    <TableRow>
                                      <TableCell sx={{ fontWeight: 700 }}>Establecimiento</TableCell>
                                      <TableCell sx={{ fontWeight: 700 }}>Empresa</TableCell>
                                      <TableCell align="right" sx={{ fontWeight: 700 }}>M√°quinas</TableCell>
                                      <TableCell align="right" sx={{ fontWeight: 700 }}>Derechos</TableCell>
                                      <TableCell align="right" sx={{ fontWeight: 700 }}>Gastos</TableCell>
                                      <TableCell align="right" sx={{ fontWeight: 700 }}>Total</TableCell>
                                      <TableCell align="right" sx={{ fontWeight: 700 }}>% del Total</TableCell>
                                    </TableRow>
                                  </TableHead>
                                  <TableBody>
                                    {roomStats.slice(0, 10).map((room, index) => (
                                      <TableRow key={index}>
                                        <TableCell>
                                          <Typography variant="body2" sx={{ fontWeight: 500 }}>
                                            {room.name}
                                          </Typography>
                                        </TableCell>
                                        <TableCell>
                                          <Chip 
                                            label={room.empresa}
                                            size="small"
                                            variant="outlined"
                                            color={room.empresa === 'No encontrado' ? 'error' : 'primary'}
                                          />
                                        </TableCell>
                                        <TableCell align="right">
                                          <Typography variant="body2" sx={{ fontWeight: 600 }}>
                                            {room.machinesCount}
                                          </Typography>
                                        </TableCell>
                                        <TableCell align="right">
                                          <Typography variant="body2" color="success.main" sx={{ fontWeight: 500 }}>
                                            {room.derechos.toLocaleString('es-CO', { 
                                              style: 'currency', 
                                              currency: 'COP',
                                              minimumFractionDigits: 0
                                            })}
                                          </Typography>
                                        </TableCell>
                                        <TableCell align="right">
                                          <Typography variant="body2" color="warning.main" sx={{ fontWeight: 500 }}>
                                            {room.gastos.toLocaleString('es-CO', { 
                                              style: 'currency', 
                                              currency: 'COP',
                                              minimumFractionDigits: 0
                                            })}
                                          </Typography>
                                        </TableCell>
                                        <TableCell align="right">
                                          <Typography variant="body2" color="primary.main" sx={{ fontWeight: 600 }}>
                                            {room.total.toLocaleString('es-CO', { 
                                              style: 'currency', 
                                              currency: 'COP',
                                              minimumFractionDigits: 0
                                            })}
                                          </Typography>
                                        </TableCell>
                                        <TableCell align="right">
                                          <Typography variant="body2" sx={{ fontWeight: 500 }}>
                                            {((room.total / financialStats.totalGeneral) * 100).toFixed(1)}%
                                          </Typography>
                                        </TableCell>
                                      </TableRow>
                                    ))}
                                  </TableBody>
                                </Table>
                              </TableContainer>
                              {roomStats.length > 10 && (
                                <Box sx={{ p: 2, textAlign: 'center' }}>
                                  <Typography variant="body2" color="text.secondary">
                                    Mostrando las 10 salas principales de {roomStats.length} total
                                  </Typography>
                                </Box>
                              )}
                            </SpectacularPaper>
                          </motion.div>
                        )}
                      </AnimatePresence>
                    </CardContent>
                  </SpectacularCard>
                </motion.div>
              )}

              <SpectacularCard sx={{ mb: 3 }}>
                <CardContent sx={{ padding: theme.spacing(3) }}>
                  {/* Filters */}
                  <Grid container spacing={2} sx={{ mb: 3 }}>
                    <Grid item xs={12} sm={6} md={4}>
                      <SpectacularTextField
                        fullWidth
                        label="Buscar"
                        variant="outlined"
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        InputProps={{
                          startAdornment: <Search sx={{ color: 'text.secondary', mr: 1 }} />
                        }}
                      />
                    </Grid>
                    
                    <Grid item xs={12} sm={6} md={4}>
                      <FormControl fullWidth>
                        <InputLabel>Establecimiento</InputLabel>
                        <Select
                          value={establishmentFilter}
                          label="Establecimiento"
                          onChange={(e) => setEstablishmentFilter(e.target.value)}
                        >
                          <MenuItem value="all">Todos</MenuItem>
                          {uniqueEstablishments.map(est => (
                            <MenuItem key={est} value={est}>{est}</MenuItem>
                          ))}
                        </Select>
                      </FormControl>
                    </Grid>
                    
                    <Grid item xs={12} sm={6} md={4}>
                      <FormControl fullWidth>
                        <InputLabel>Per√≠odo</InputLabel>
                        <Select
                          value={periodFilter}
                          label="Per√≠odo"
                          onChange={(e) => setPeriodFilter(e.target.value)}
                        >
                          <MenuItem value="all">Todos</MenuItem>
                          {uniquePeriods.map(period => (
                            <MenuItem key={period} value={period}>{period}</MenuItem>
                          ))}
                        </Select>
                      </FormControl>
                    </Grid>
                  </Grid>

                  {/* Export Buttons - CORREGIDOS */}
                  <Stack direction="row" spacing={2} sx={{ mb: 3 }} flexWrap="wrap">
                    <Button
                      variant="contained"
                      startIcon={<GetApp />}
                      onClick={() => handleExport('xlsx', 'consolidated')}
                      sx={{
                        background: 'linear-gradient(135deg, #4caf50 0%, #8bc34a 100%)',
                        '&:hover': {
                          background: 'linear-gradient(135deg, #43a047 0%, #7cb342 100%)'
                        }
                      }}
                    >
                      Exportar Consolidado Excel
                    </Button>
                    
                    <Button
                      variant="contained"
                      startIcon={<GetApp />}
                      onClick={() => handleExport('xlsx', 'rooms')}
                      sx={{
                        background: 'linear-gradient(135deg, #2196f3 0%, #21cbf3 100%)',
                        '&:hover': {
                          background: 'linear-gradient(135deg, #1976d2 0%, #0288d1 100%)'
                        }
                      }}
                    >
                      Exportar por Sala Excel
                    </Button>
                    
                    <SpectacularButton
                      variant="outlined"
                      startIcon={<FileDownload />}
                      onClick={() => handleExport('csv', 'consolidated')}
                      color="primary"
                    >
                      CSV Consolidado
                    </SpectacularButton>
                    
                    <SpectacularButton
                      variant="outlined"
                      startIcon={<FileDownload />}
                      onClick={() => handleExport('csv', 'rooms')}
                      color="secondary"
                    >
                      CSV por Sala
                    </SpectacularButton>
                    
                    <SpectacularButton
                      variant="outlined"
                      startIcon={<Refresh />}
                      color="info"
                      onClick={() => {
                        setSearchTerm('');
                        setEstablishmentFilter('all');
                        setPeriodFilter('all');
                      }}
                    >
                      Limpiar Filtros
                    </SpectacularButton>
                  </Stack>

                  {/* Results Table */}
                  <TableContainer 
                    component={(props) => 
                      <SpectacularPaper 
                        {...props} 
                        borderRadius={settings.theme?.borderRadius}
                      />
                    } 
                    sx={{ maxHeight: 600 }}
                  >
                    <Table stickyHeader>
                      <TableHead>
                        <TableRow>
                          {[
                            'Empresa', 'Serial', 'NUC', 'Establecimiento', 'D√≠as Transmitidos', 
                            'D√≠as del Mes', 'Primer D√≠a', '√öltimo D√≠a', 'Per√≠odo',
                            'Tipo Apuesta', 'Producci√≥n', 'Derechos Explotaci√≥n', 'Gastos Admin', 'Total Impuestos', 'Novedad'
                          ].map((header) => (
                            <TableCell 
                              key={header}
                              sx={{ 
                                fontWeight: 600,
                                backgroundColor: alpha(theme.palette.primary.main, 0.1),
                                minWidth: header === 'Establecimiento' ? 150 : 
                                         header === 'Producci√≥n' || header.includes('Derechos') || header.includes('Gastos') || header.includes('Total') ? 120 : 100
                              }}
                            >
                              {header}
                            </TableCell>
                          ))}
                        </TableRow>
                      </TableHead>
                      <TableBody>
                        {paginatedResults.map((row, index) => (
                          <TableRow 
                            key={`consolidated-${page}-${index}`}
                            sx={{
                              '&:nth-of-type(odd)': {
                                backgroundColor: alpha(theme.palette.primary.main, 0.02)
                              },
                              '&:hover': {
                                backgroundColor: alpha(theme.palette.primary.main, 0.05)
                              }
                            }}
                          >
                            <TableCell>{row.Empresa}</TableCell>
                            <TableCell sx={{ fontWeight: 600 }}>{row.Serial}</TableCell>
                            <TableCell>{row.NUC}</TableCell>
                            <TableCell sx={{ fontWeight: 500 }}>{row.Establecimiento}</TableCell>
                            <TableCell align="center">{row['D√≠as transmitidos']}</TableCell>
                            <TableCell align="center">{row['D√≠as del mes']}</TableCell>
                            <TableCell>{row['Primer d√≠a transmitido']}</TableCell>
                            <TableCell>{row['√öltimo d√≠a transmitido']}</TableCell>
                            <TableCell>{row['Per√≠odo Texto']}</TableCell>
                            <TableCell>{row['Tipo apuesta']}</TableCell>
                            <TableCell align="right" sx={{ fontWeight: 600, color: theme.palette.success.main }}>
                              {formatCOP(row['Producci√≥n'])}
                            </TableCell>
                            <TableCell align="right" sx={{ fontWeight: 500 }}>
                              {formatCOP(row['Derechos de Explotaci√≥n'])}
                            </TableCell>
                            <TableCell align="right" sx={{ fontWeight: 500 }}>
                              {formatCOP(row['Gastos de Administraci√≥n'])}
                            </TableCell>
                            <TableCell align="right" sx={{ fontWeight: 600, color: theme.palette.info.main }}>
                              {formatCOP(row['Total Impuestos'])}
                            </TableCell>
                            <TableCell>
                              <Chip 
                                label={row.Novedad}
                                size="small"
                                color={row.Novedad === 'Sin cambios' ? 'success' : 'warning'}
                                variant="outlined"
                              />
                            </TableCell>
                          </TableRow>
                        ))}
                        {paginatedResults.length === 0 && (
                          <TableRow>
                            <TableCell colSpan={15} align="center">
                              <Box sx={{ py: 4 }}>
                                <Typography variant="h6" color="text.secondary">
                                  No se encontraron registros que coincidan con los filtros
                                </Typography>
                              </Box>
                            </TableCell>
                          </TableRow>
                        )}
                      </TableBody>
                    </Table>
                    
                    {/* Spectacular Pagination */}
                    <SpectacularTablePagination
                      component="div"
                      count={filteredResults.length}
                      page={page}
                      onPageChange={handleChangePage}
                      rowsPerPage={rowsPerPage}
                      onRowsPerPageChange={handleChangeRowsPerPage}
                      rowsPerPageOptions={[10, 25, 50, 100]}
                      labelRowsPerPage="Registros por p√°gina:"
                      labelDisplayedRows={({ from, to, count }) => 
                        `${from}-${to} de ${count !== -1 ? count : `m√°s de ${to}`}`
                      }
                      showFirstButton
                      showLastButton
                    />
                  </TableContainer>

                  {/* Controles de Navegaci√≥n Adicionales - M√°s Visibles */}
                  {filteredResults.length > rowsPerPage && (
                    <Box sx={{ 
                      mt: 3, 
                      mb: 2, 
                      display: 'flex', 
                      justifyContent: 'center', 
                      alignItems: 'center',
                      gap: 2,
                      flexWrap: 'wrap'
                    }}>
                      {/* Bot√≥n Primera P√°gina */}
                      <SpectacularButton
                        variant="outlined"
                        size="small"
                        startIcon={<FirstPage />}
                        onClick={() => handleChangePage(null, 0)}
                        disabled={page === 0}
                        color="primary"
                      >
                        Primera
                      </SpectacularButton>

                      {/* Bot√≥n P√°gina Anterior */}
                      <SpectacularButton
                        variant="outlined"
                        size="small"
                        startIcon={<KeyboardArrowLeft />}
                        onClick={() => handleChangePage(null, page - 1)}
                        disabled={page === 0}
                        color="primary"
                      >
                        Anterior
                      </SpectacularButton>

                      {/* Indicador de P√°gina Actual */}
                      <Box sx={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: 1,
                        background: `linear-gradient(135deg, ${alpha(theme.palette.primary.main, 0.1)}, ${alpha(theme.palette.primary.light, 0.05)})`,
                        backdropFilter: 'blur(10px)',
                        borderRadius: theme.shape.borderRadius * 2,
                        padding: theme.spacing(1, 2),
                        border: `1px solid ${alpha(theme.palette.primary.main, 0.2)}`
                      }}>
                        <Typography variant="body2" fontWeight={600} color="primary">
                          P√°gina {page + 1} de {Math.ceil(filteredResults.length / rowsPerPage)}
                        </Typography>
                      </Box>

                      {/* Bot√≥n P√°gina Siguiente */}
                      <SpectacularButton
                        variant="outlined"
                        size="small"
                        endIcon={<KeyboardArrowRight />}
                        onClick={() => handleChangePage(null, page + 1)}
                        disabled={page >= Math.ceil(filteredResults.length / rowsPerPage) - 1}
                        color="primary"
                      >
                        Siguiente
                      </SpectacularButton>

                      {/* Bot√≥n √öltima P√°gina */}
                      <SpectacularButton
                        variant="outlined"
                        size="small"
                        endIcon={<LastPage />}
                        onClick={() => handleChangePage(null, Math.max(0, Math.ceil(filteredResults.length / rowsPerPage) - 1))}
                        disabled={page >= Math.ceil(filteredResults.length / rowsPerPage) - 1}
                        color="primary"
                      >
                        √öltima
                      </SpectacularButton>
                    </Box>
                  )}

                  {/* Info sobre paginaci√≥n */}
                  {filteredResults.length > 0 && (
                    <Box sx={{ mt: 2 }}>
                      <SpectacularAlert severity="info" sx={{ textAlign: 'center' }}>
                        <Stack direction="row" spacing={2} justifyContent="center" alignItems="center" flexWrap="wrap">
                          <Typography variant="body2">
                            üìä <strong>{filteredResults.length}</strong> registros encontrados
                          </Typography>
                          <Typography variant="body2">
                            üìÑ P√°gina <strong>{page + 1}</strong> de <strong>{Math.ceil(filteredResults.length / rowsPerPage)}</strong>
                          </Typography>
                          <Typography variant="body2">
                            üëÅÔ∏è Mostrando <strong>{Math.min(rowsPerPage, filteredResults.length - page * rowsPerPage)}</strong> registros
                          </Typography>
                        </Stack>
                      </SpectacularAlert>
                    </Box>
                  )}
                </CardContent>
              </SpectacularCard>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Modal para seleccionar sala a exportar */}
        <Dialog
          open={showRoomExportDialog}
          onClose={() => setShowRoomExportDialog(false)}
          maxWidth="sm"
          fullWidth
          PaperProps={{
            sx: {
              borderRadius: 3,
              background: `linear-gradient(135deg, ${theme.palette.background.paper} 0%, ${alpha(theme.palette.primary.main, 0.02)} 100%)`,
            }
          }}
        >
          <DialogTitle sx={{ 
            pb: 1,
            background: `linear-gradient(135deg, ${theme.palette.primary.main} 0%, ${theme.palette.secondary.main} 100%)`,
            color: 'white',
            display: 'flex',
            alignItems: 'center',
            gap: 1
          }}>
            <Store />
            Seleccionar Sala para Exportar
          </DialogTitle>
          
          <DialogContent sx={{ pt: 3 }}>
            <Typography variant="body2" color="text.secondary" sx={{ mb: 3 }}>
              Selecciona la sala/establecimiento que deseas exportar como archivo {exportFormat.toUpperCase()}.
            </Typography>
            
            <FormControl fullWidth sx={{ mb: 2 }}>
              <InputLabel>Sala / Establecimiento</InputLabel>
              <Select
                value={selectedRoomForExport}
                label="Sala / Establecimiento"
                onChange={(e) => setSelectedRoomForExport(e.target.value)}
                disabled={!availableRooms.length}
              >
                {availableRooms.map((room, index) => (
                  <MenuItem key={index} value={room}>
                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                      <Casino sx={{ fontSize: 18, color: 'primary.main' }} />
                      {room}
                      <Chip 
                        size="small" 
                        label={consolidatedData.filter(row => row.Establecimiento === room).length + ' m√°quinas'}
                        variant="outlined"
                        sx={{ ml: 'auto' }}
                      />
                    </Box>
                  </MenuItem>
                ))}
              </Select>
            </FormControl>

            {selectedRoomForExport && (
              <Alert severity="info" sx={{ mt: 2 }}>
                <Typography variant="body2">
                  <strong>Sala seleccionada:</strong> {selectedRoomForExport}
                  <br />
                  <strong>Registros a exportar:</strong> {consolidatedData.filter(row => row.Establecimiento === selectedRoomForExport).length} m√°quinas
                  <br />
                  <strong>Formato:</strong> {exportFormat.toUpperCase()}
                </Typography>
              </Alert>
            )}

            {!availableRooms.length && (
              <Alert severity="warning" sx={{ mt: 2 }}>
                No hay salas disponibles para exportar. Aseg√∫rate de haber procesado un archivo de liquidaci√≥n primero.
              </Alert>
            )}
          </DialogContent>

          <DialogActions sx={{ p: 3, pt: 1 }}>
            <Button 
              onClick={() => setShowRoomExportDialog(false)}
              variant="outlined"
              startIcon={<Clear />}
            >
              Cancelar
            </Button>
            <Button 
              onClick={handleRoomExport}
              variant="contained"
              startIcon={<FileDownload />}
              disabled={!selectedRoomForExport}
              sx={{
                background: `linear-gradient(135deg, ${theme.palette.primary.main} 0%, ${theme.palette.secondary.main} 100%)`,
                '&:hover': {
                  background: `linear-gradient(135deg, ${theme.palette.primary.dark} 0%, ${theme.palette.secondary.dark} 100%)`,
                }
              }}
            >
              Exportar {exportFormat.toUpperCase()}
            </Button>
          </DialogActions>
        </Dialog>
      </motion.div>
    </StyledContainer>
  );
};

export default LiquidationProcessorPage;

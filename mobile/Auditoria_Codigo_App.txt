--- INICIO DE AUDITORIA ---


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\components\shared\EmptyState.js
========================================
import React from 'react';
import { View, Text, StyleSheet } from 'react-native';
import { MaterialIcons } from '@expo/vector-icons';

/**
 * EmptyState - Estado vacÃ­o elegante con Material 3 Expressive Design
 * 
 * @param {string} icon - Nombre del Ã­cono de MaterialIcons
 * @param {string} message - Mensaje a mostrar
 * @param {string} iconColor - Color del Ã­cono (opcional)
 */
export default function EmptyState({ icon, message, iconColor = '#ccc' }) {
  return (
    <View style={styles.container}>
      <View style={styles.iconContainer}>
        <MaterialIcons name={icon || 'inbox'} size={64} color={iconColor} />
      </View>
      <Text style={styles.message}>{message || 'No hay datos para mostrar'}</Text>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 24,
    backgroundColor: '#f5f5f5'
  },
  iconContainer: {
    width: 96,
    height: 96,
    borderRadius: 28, // ðŸŽ¨ Material 3 Extra Large
    backgroundColor: '#fff',
    justifyContent: 'center',
    alignItems: 'center',
    marginBottom: 20,
    // Material 3 Elevation Level 1
    shadowColor: '#000',
    shadowOffset: {
      width: 0,
      height: 4,
    },
    shadowOpacity: 0.08,
    shadowRadius: 12,
    elevation: 3,
  },
  message: {
    fontSize: 16, // ðŸŽ¨ Material 3 Body Large
    fontWeight: '500',
    color: '#64748b', // text.secondary
    textAlign: 'center',
    lineHeight: 24, // ðŸŽ¨ Material 3 line-height
    letterSpacing: 0.2,
    maxWidth: 280
  }
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\components\shared\ErrorState.js
========================================
import React from 'react';
import { View, Text, TouchableOpacity, StyleSheet } from 'react-native';
import { MaterialIcons } from '@expo/vector-icons';

/**
 * ErrorState - Estado de error elegante con Material 3 Expressive Design
 * 
 * @param {string} message - Mensaje de error
 * @param {function} onRetry - Callback para reintentar
 * @param {string} errorColor - Color del error (opcional)
 */
export default function ErrorState({ message, onRetry, errorColor = '#f44336' }) {
  return (
    <View style={styles.container}>
      <View style={[styles.iconContainer, { backgroundColor: errorColor + '14' }]}>
        <MaterialIcons name="error-outline" size={64} color={errorColor} />
      </View>
      <Text style={styles.title}>Algo saliÃ³ mal</Text>
      <Text style={styles.message}>{message || 'Error al cargar los datos'}</Text>
      {onRetry && (
        <TouchableOpacity 
          style={[styles.button, { backgroundColor: errorColor }]} 
          onPress={onRetry}
          activeOpacity={0.8}
        >
          <MaterialIcons name="refresh" size={20} color="#fff" />
          <Text style={styles.buttonText}>Reintentar</Text>
        </TouchableOpacity>
      )}
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 24,
    backgroundColor: '#f5f5f5'
  },
  iconContainer: {
    width: 96,
    height: 96,
    borderRadius: 28, // ðŸŽ¨ Material 3 Extra Large
    justifyContent: 'center',
    alignItems: 'center',
    marginBottom: 20,
    // Material 3 Elevation Level 1
    shadowColor: '#000',
    shadowOffset: {
      width: 0,
      height: 4,
    },
    shadowOpacity: 0.08,
    shadowRadius: 12,
    elevation: 3,
  },
  title: {
    fontSize: 20, // ðŸŽ¨ Material 3 Title Medium
    fontWeight: '600',
    color: '#1e293b', // text.primary
    marginBottom: 8,
    letterSpacing: 0.2,
  },
  message: {
    fontSize: 15, // ðŸŽ¨ Material 3 Body Medium
    fontWeight: '400',
    color: '#64748b', // text.secondary
    textAlign: 'center',
    lineHeight: 22,
    letterSpacing: 0.2,
    marginBottom: 24,
    maxWidth: 280
  },
  button: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
    paddingHorizontal: 24,
    paddingVertical: 14,
    borderRadius: 28, // ðŸŽ¨ Material 3 Extra Large
    // Material 3 Elevation Level 2
    shadowColor: '#000',
    shadowOffset: {
      width: 0,
      height: 4,
    },
    shadowOpacity: 0.14,
    shadowRadius: 16,
    elevation: 5,
  },
  buttonText: {
    color: '#fff',
    fontSize: 15, // ðŸŽ¨ Material 3 Label Large
    fontWeight: '600',
    letterSpacing: 0.5,
  }
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\components\shared\LoadingState.js
========================================
import React from 'react';
import { View, ActivityIndicator, Text, StyleSheet } from 'react-native';
import { useTheme } from '../../contexts/ThemeContext'; // âœ… FIX: Usar custom hook

/**
 * LoadingState - Estado de carga elegante con Material 3 Expressive Design
 * 
 * @param {string} message - Mensaje de carga (opcional)
 */
export default function LoadingState({ message }) {
  const { getPrimaryColor } = useTheme(); // âœ… FIX: Usar custom hook

  return (
    <View style={styles.container}>
      <View style={styles.loadingContainer}>
        <ActivityIndicator size="large" color={getPrimaryColor()} />
      </View>
      {message && <Text style={styles.message}>{message}</Text>}
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 24,
    backgroundColor: '#f5f5f5'
  },
  loadingContainer: {
    width: 96,
    height: 96,
    borderRadius: 28, // ðŸŽ¨ Material 3 Extra Large
    backgroundColor: '#fff',
    justifyContent: 'center',
    alignItems: 'center',
    marginBottom: 20,
    // Material 3 Elevation Level 1
    shadowColor: '#000',
    shadowOffset: {
      width: 0,
      height: 4,
    },
    shadowOpacity: 0.08,
    shadowRadius: 12,
    elevation: 3,
  },
  message: {
    fontSize: 15, // ðŸŽ¨ Material 3 Body Medium
    fontWeight: '500',
    color: '#64748b', // text.secondary
    textAlign: 'center',
    lineHeight: 22,
    letterSpacing: 0.2,
    maxWidth: 280
  }
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\components\DetailRow.js
========================================
import React from 'react';
import { View, Text, StyleSheet } from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { useTheme } from 'react-native-paper';

/**
 * DetailRow - Componente para mostrar informaciÃ³n con Material 3 Expressive Design
 * 
 * Material 3 Mejoras:
 * - Spacing generoso: 16px padding (antes 12px)
 * - Icon sizing estÃ¡ndar: 24px (Material 3)
 * - Typography scale: Material 3 standards
 * - Border radius: 12px (Medium)
 * - Gap entre elementos: 16px consistente
 */
export default function DetailRow({ 
  icon, 
  label, 
  value, 
  highlight = false,
  iconColor = '#667eea',
  highlightColor = '#4ade80'
}) {
  const theme = useTheme();
  
  const bgColor = highlight 
    ? highlightColor + '14' // alpha 0.08
    : iconColor + '0A'; // alpha 0.04
    
  const borderColor = highlight
    ? highlightColor + '4D' // alpha 0.3
    : iconColor + '33'; // alpha 0.2

  return (
    <View style={[
      styles.container,
      { backgroundColor: bgColor, borderColor: borderColor }
    ]}>
      {icon && (
        <View style={styles.iconContainer}>
          <Ionicons name={icon} size={24} color={highlight ? highlightColor : iconColor} />
        </View>
      )}
      <View style={styles.content}>
        <Text style={[styles.label, { color: theme.colors.onSurfaceVariant }]}>{label}</Text>
        {typeof value === 'string' || typeof value === 'number' ? (
          <Text style={[
            styles.value,
            { color: theme.colors.onSurface },
            highlight && { color: highlightColor, fontWeight: '600' }
          ]}>
            {value}
          </Text>
        ) : (
          value
        )}
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 16, // ðŸŽ¨ Material 3 spacing (mantiene 16px, ya era correcto)
    padding: 16, // ðŸŽ¨ Material 3 generous spacing (â†‘ de 12px)
    borderRadius: 12, // ðŸŽ¨ Material 3 Medium (â†‘ de 8px)
    borderWidth: 1,
  },
  iconContainer: {
    justifyContent: 'center',
    alignItems: 'center',
    width: 24, // ðŸŽ¨ Material 3 icon grid (nuevo)
    height: 24, // ðŸŽ¨ Material 3 icon grid (nuevo)
  },
  icon: {
    fontSize: 24, // ðŸŽ¨ Material 3 standard icon size (â†‘ de 20px)
  },
  content: {
    flex: 1,
  },
  label: {
    fontSize: 12, // ðŸŽ¨ Material 3 label size (â†‘ de 11px)
    fontWeight: '600',
    textTransform: 'uppercase',
    letterSpacing: 1.0, // ðŸŽ¨ Material 3 letter-spacing (â†‘ de 0.8)
    marginBottom: 6, // ðŸŽ¨ Material 3 spacing (â†‘ de 4px)
  },
  value: {
    fontSize: 15, // ðŸŽ¨ Material 3 body size (â†‘ de 14px)
    fontWeight: '500',
    lineHeight: 22, // ðŸŽ¨ Material 3 line-height (nuevo)
  },
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\components\EmployeeDetailSheet.js
========================================
import React from 'react';
import { View, StyleSheet, Linking, ScrollView } from 'react-native';
import { Text, Button, Avatar, useTheme, IconButton, Divider, Surface, Chip } from 'react-native-paper';
import { Ionicons } from '@expo/vector-icons';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';

export default function EmployeeDetailSheet({ employee, onClose, onStatusChange }) {
  const theme = useTheme();

  if (!employee) return null;

  const isNovedad = !!employee.type && !!employee.status;

  const handleCall = () => {
    if (employee.phone) Linking.openURL(`tel:${employee.phone}`);
  };

  const handleWhatsApp = () => {
    if (employee.phone) {
      const phone = employee.phone.replace('+', '');
      const url = `whatsapp://send?phone=${phone}`;
      Linking.openURL(url).catch(() => {
        Linking.openURL(`https://wa.me/${phone}`);
      });
    }
  };

  const handleEmail = () => {
    if (employee.email || employee.empleadoEmail) {
      Linking.openURL(`mailto:${employee.email || employee.empleadoEmail}`);
    }
  };

  return (
    <View style={[styles.container, { backgroundColor: theme.colors.surface }]}>
      <View style={styles.header}>
        <Text variant="titleMedium" style={{ fontWeight: 'bold', opacity: 0.5 }}>
          {isNovedad ? 'Detalle de Solicitud' : 'Ficha de Empleado'}
        </Text>
        <IconButton icon="close" onPress={onClose} />
      </View>

      <ScrollView showsVerticalScrollIndicator={false} contentContainerStyle={{ paddingBottom: 20 }}>
        {/* Profile Section */}
        <View style={styles.profileHeader}>
          <Avatar.Text 
            size={64} 
            label={(employee.userName || employee.empleadoNombre || 'NN').substring(0, 2).toUpperCase()} 
            style={{ backgroundColor: theme.colors.primaryContainer }}
            color={theme.colors.onPrimaryContainer}
          />
          <View style={{ marginLeft: 16, flex: 1 }}>
            <Text variant="headlineSmall" style={{ fontWeight: 'bold' }}>
              {employee.userName || employee.empleadoNombre}
            </Text>
            <Text variant="bodyMedium" style={{ color: theme.colors.secondary }}>
              {employee.position || 'Empleado'}
            </Text>
          </View>
        </View>

        {/* Novedad Details */}
        {isNovedad && (
          <Surface style={[styles.novedadCard, { backgroundColor: theme.colors.surfaceVariant }]} elevation={0}>
            <View style={{ flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 }}>
              <Chip icon="clock" compact>{employee.status?.toUpperCase()}</Chip>
              <Text variant="labelSmall" style={{ color: theme.colors.onSurfaceVariant }}>
                {employee.date?.toDate ? format(employee.date.toDate(), 'dd MMM yyyy, h:mm a', { locale: es }) : ''}
              </Text>
            </View>
            
            <Text variant="titleLarge" style={{ fontWeight: 'bold', color: theme.colors.primary, marginBottom: 8 }}>
              {employee.type?.replace('_', ' ').toUpperCase()}
            </Text>
            
            <Divider style={{ marginBottom: 12 }} />
            
            <Text variant="bodyLarge" style={{ lineHeight: 24 }}>
              {employee.description || 'Sin descripciÃ³n proporcionada.'}
            </Text>
          </Surface>
        )}

        {/* Decision Buttons */}
        {isNovedad && employee.status === 'pending' && onStatusChange && (
          <View style={styles.decisionButtons}>
            <Button 
              mode="outlined" 
              textColor={theme.colors.error} 
              style={{ flex: 1, borderColor: theme.colors.error }}
              icon="close"
              onPress={() => { onStatusChange(employee.id, 'rejected'); onClose(); }}
            >
              Rechazar
            </Button>
            <Button 
              mode="contained" 
              buttonColor={theme.colors.primary} 
              style={{ flex: 1 }}
              icon="check"
              onPress={() => { onStatusChange(employee.id, 'approved'); onClose(); }}
            >
              Aprobar
            </Button>
          </View>
        )}

        <Divider style={{ marginVertical: 24 }} />

        {/* Contact Actions */}
        <Text variant="titleSmall" style={{ fontWeight: 'bold', marginBottom: 16, textAlign: 'center' }}>
          Contactar Empleado
        </Text>
        <View style={styles.actionsContainer}>
          <View style={styles.actionItem}>
            <IconButton 
              icon="phone" 
              mode="contained" 
              containerColor={theme.colors.secondaryContainer} 
              iconColor={theme.colors.onSecondaryContainer}
              size={28}
              onPress={handleCall}
            />
            <Text variant="labelSmall">Llamar</Text>
          </View>

          <View style={styles.actionItem}>
            <IconButton 
              icon="whatsapp" 
              mode="contained" 
              containerColor="#25D366" 
              iconColor="white"
              size={28}
              onPress={handleWhatsApp}
            />
            <Text variant="labelSmall">WhatsApp</Text>
          </View>

          <View style={styles.actionItem}>
            <IconButton 
              icon="email" 
              mode="contained" 
              containerColor={theme.colors.tertiaryContainer} 
              iconColor={theme.colors.onTertiaryContainer}
              size={28}
              onPress={handleEmail}
            />
            <Text variant="labelSmall">Email</Text>
          </View>
        </View>
      </ScrollView>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    borderTopLeftRadius: 28,
    borderTopRightRadius: 28,
    padding: 20,
    height: '85%', // Increased height for more content
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 16,
  },
  profileHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 24,
  },
  novedadCard: {
    padding: 20,
    borderRadius: 16,
    marginBottom: 24,
  },
  decisionButtons: {
    flexDirection: 'row',
    gap: 12,
    marginBottom: 8,
  },
  actionsContainer: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    marginBottom: 24,
  },
  actionItem: {
    alignItems: 'center',
    gap: 8,
  },
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\components\FloatingActionBar.js
========================================
import React from 'react';
import { View, StyleSheet, TouchableOpacity } from 'react-native';
import { Text, Surface, useTheme, Icon } from 'react-native-paper';

export default function FloatingActionBar({ 
  status = 'off', // off, working, break, lunch
  onPressStart,
  onPressBreak,
  onPressLunch,
  onPressEnd,
  onPressResume,
  breaksCount = 0
}) {
  const theme = useTheme();

  if (status === 'off' || status === 'finalizado' || !status) {
    return (
      <View style={styles.container}>
        <TouchableOpacity 
          style={[styles.largeButton, { backgroundColor: theme.colors.primary }]}
          onPress={onPressStart}
          activeOpacity={0.9}
        >
          <Icon source="hand-wave" size={24} color={theme.colors.onPrimary} />
          <Text variant="titleMedium" style={{ color: theme.colors.onPrimary, fontWeight: 'bold', marginLeft: 8 }}>
            Iniciar Jornada
          </Text>
        </TouchableOpacity>
      </View>
    );
  }

  if (status === 'break' || status === 'almuerzo') {
    const isLunch = status === 'almuerzo';
    return (
      <View style={styles.container}>
        <TouchableOpacity 
          style={[styles.largeButton, { backgroundColor: theme.colors.tertiary }]}
          onPress={onPressResume}
          activeOpacity={0.9}
        >
          <Icon source="play" size={24} color={theme.colors.onTertiary} />
          <Text variant="titleMedium" style={{ color: theme.colors.onTertiary, fontWeight: 'bold', marginLeft: 8 }}>
            {isLunch ? 'Volver del Almuerzo' : 'Volver del Break'}
          </Text>
        </TouchableOpacity>
      </View>
    );
  }

  // Status: working
  return (
    <View style={styles.container}>
      <Surface style={[styles.bar, { backgroundColor: theme.colors.elevation.level3 }]} elevation={4}>
        
        {/* Break Button */}
        <TouchableOpacity 
          style={[styles.actionButton, { backgroundColor: theme.colors.secondaryContainer }]}
          onPress={onPressBreak}
          disabled={breaksCount >= 2}
        >
          <Icon 
            source={breaksCount >= 2 ? "coffee-off" : "coffee"} 
            size={24} 
            color={breaksCount >= 2 ? theme.colors.onSurfaceDisabled : theme.colors.onSecondaryContainer} 
          />
          <Text 
            variant="labelSmall" 
            style={{ 
              color: breaksCount >= 2 ? theme.colors.onSurfaceDisabled : theme.colors.onSecondaryContainer, 
              marginTop: 4,
              fontWeight: 'bold'
            }}
          >
            Break
          </Text>
        </TouchableOpacity>

        {/* Lunch Button */}
        <TouchableOpacity 
          style={[styles.actionButton, { backgroundColor: theme.colors.tertiaryContainer }]}
          onPress={onPressLunch}
        >
          <Icon source="food" size={24} color={theme.colors.onTertiaryContainer} />
          <Text variant="labelSmall" style={{ color: theme.colors.onTertiaryContainer, marginTop: 4, fontWeight: 'bold' }}>
            Almuerzo
          </Text>
        </TouchableOpacity>

        {/* End Button */}
        <TouchableOpacity 
          style={[styles.actionButton, { backgroundColor: theme.colors.errorContainer }]}
          onPress={onPressEnd}
        >
          <Icon source="home-export-outline" size={24} color={theme.colors.onErrorContainer} />
          <Text variant="labelSmall" style={{ color: theme.colors.onErrorContainer, marginTop: 4, fontWeight: 'bold' }}>
            Finalizar
          </Text>
        </TouchableOpacity>

      </Surface>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    position: 'absolute',
    bottom: 16,
    left: 16,
    right: 16,
    alignItems: 'center',
  },
  largeButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    width: '100%',
    height: 64,
    borderRadius: 32,
    elevation: 4,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.25,
    shadowRadius: 3.84,
  },
  bar: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    padding: 8,
    borderRadius: 32,
    width: '100%',
    height: 80,
  },
  actionButton: {
    flex: 1,
    height: '100%',
    justifyContent: 'center',
    alignItems: 'center',
    borderRadius: 24,
    marginHorizontal: 4,
  }
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\components\index.js
========================================
// ðŸ“¦ Componentes de DiseÃ±o Sobrio para React Native
// Siguiendo DISENO_SOBRIO_NOTAS.md y MODAL_DESIGN_SYSTEM.md

// Componentes base
export { default as SobrioCard } from './SobrioCard';
export { default as DetailRow } from './DetailRow';
export { default as OverlineText } from './OverlineText';

// Estados compartidos (Material 3 Expressive)
export { default as EmptyState } from './shared/EmptyState';
export { default as ErrorState } from './shared/ErrorState';
export { default as LoadingState } from './shared/LoadingState';


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\components\NovedadesSheet.js
========================================
import React, { useState } from 'react';
import { View, StyleSheet, ScrollView, Alert } from 'react-native';
import { Text, Button, TextInput, Chip, useTheme, IconButton, ActivityIndicator } from 'react-native-paper';
import * as DocumentPicker from 'expo-document-picker';
import { collection, addDoc, Timestamp } from 'firebase/firestore';
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage';
import { db, storage } from '../services/firebase';
import { useAuth } from '../contexts/AuthContext';
import NotificationService from '../services/NotificationService';

export default function NovedadesSheet({ onClose, onSuccess }) {
  const { user, userProfile } = useAuth();
  const theme = useTheme();
  
  const [type, setType] = useState('llegada_tarde');
  const [description, setDescription] = useState('');
  const [attachment, setAttachment] = useState(null);
  const [loading, setLoading] = useState(false);

  const tiposNovedad = [
    { id: 'llegada_tarde', label: 'Llegada Tarde', icon: 'clock-alert-outline' },
    { id: 'olvido_salida', label: 'Olvido de Salida', icon: 'exit-run' },
    { id: 'urgencia_medica', label: 'Urgencia MÃ©dica', icon: 'hospital-box-outline' },
    { id: 'calamidad', label: 'Calamidad', icon: 'alert-circle-outline' },
    { id: 'otro', label: 'Otro', icon: 'pencil-outline' },
  ];

  const pickDocument = async () => {
    try {
      const result = await DocumentPicker.getDocumentAsync({
        type: ['image/*', 'application/pdf'],
        copyToCacheDirectory: true,
      });

      if (result.assets && result.assets.length > 0) {
        setAttachment(result.assets[0]);
      }
    } catch (err) {
      console.error('Error picking document:', err);
    }
  };

  const handleSubmit = async () => {
    if (!description.trim()) {
      Alert.alert('Error', 'Por favor describe la novedad');
      return;
    }

    setLoading(true);
    try {
      let attachmentUrl = null;
      if (attachment) {
        const response = await fetch(attachment.uri);
        const blob = await response.blob();
        const filename = `novedades/${user.uid}/${Date.now()}_${attachment.name}`;
        const storageRef = ref(storage, filename);
        await uploadBytes(storageRef, blob);
        attachmentUrl = await getDownloadURL(storageRef);
      }

      await addDoc(collection(db, 'novedades'), {
        uid: user.uid,
        userName: userProfile?.displayName || user.email,
        type,
        description,
        attachmentUrl,
        date: Timestamp.now(),
        status: 'pending', // pending, approved, rejected
        createdAt: Timestamp.now()
      });

      // âœ… Notificar al admin sobre nueva novedad
      const nombreEmpleado = userProfile?.name || userProfile?.displayName || user.email.split('@')[0];
      await NotificationService.notifyAdminNewNovedad(nombreEmpleado, type);

      Alert.alert('Ã‰xito', 'Novedad reportada correctamente');
      if (onSuccess) onSuccess();
      if (onClose) onClose();
    } catch (error) {
      console.error('Error reporting novedad:', error);
      Alert.alert('Error', 'No se pudo reportar la novedad');
    } finally {
      setLoading(false);
    }
  };

  return (
    <View style={[styles.container, { backgroundColor: theme.colors.surface }]}>
      <View style={styles.header}>
        <Text variant="titleLarge" style={{ fontWeight: 'bold' }}>Reportar Novedad</Text>
        <IconButton icon="close" onPress={onClose} />
      </View>

      <ScrollView contentContainerStyle={styles.content}>
        <Text variant="titleMedium" style={{ marginBottom: 12 }}>Tipo de Novedad</Text>
        <View style={styles.chipContainer}>
          {tiposNovedad.map((t) => (
            <Chip
              key={t.id}
              selected={type === t.id}
              onPress={() => setType(t.id)}
              showSelectedOverlay
              style={styles.chip}
              icon={t.icon}
            >
              {t.label}
            </Chip>
          ))}
        </View>

        <TextInput
          label="DescripciÃ³n detallada"
          value={description}
          onChangeText={setDescription}
          mode="outlined"
          multiline
          numberOfLines={4}
          style={styles.input}
        />

        <Button 
          mode="outlined" 
          onPress={pickDocument} 
          icon={attachment ? "check" : "paperclip"}
          style={styles.button}
        >
          {attachment ? `Adjunto: ${attachment.name}` : 'Adjuntar Soporte (Opcional)'}
        </Button>

        <Button 
          mode="contained" 
          onPress={handleSubmit} 
          loading={loading}
          disabled={loading}
          style={[styles.button, { marginTop: 24 }]}
        >
          Enviar Reporte
        </Button>
      </ScrollView>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    borderTopLeftRadius: 28,
    borderTopRightRadius: 28,
    padding: 20,
    height: '85%', // Bottom sheet height
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 16,
  },
  content: {
    paddingBottom: 40,
  },
  chipContainer: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: 8,
    marginBottom: 24,
  },
  chip: {
    marginBottom: 8,
  },
  input: {
    marginBottom: 16,
    backgroundColor: 'transparent',
  },
  button: {
    marginBottom: 12,
  }
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\components\OverlineText.js
========================================
import React from 'react';
import { Text, StyleSheet } from 'react-native';

/**
 * OverlineText - Typography overline con Material 3 Expressive Design
 * 
 * Material 3 Mejoras:
 * - Font size: 13px (Material 3 Label Large)
 * - Letter-spacing: 1.2 (mÃ¡s expresivo)
 * - Font weight: 700 (mÃ¡s bold)
 * - Margin bottom: 12px (spacing generoso)
 * - Color dinÃ¡mico del tema (preservado 100%)
 */
export default function OverlineText({ 
  children, 
  style, 
  color = '#667eea', // Color del tema por defecto
  variant = 'primary' // 'primary' | 'secondary'
}) {
  const variantColor = variant === 'primary' ? color : color;
  
  return (
    <Text style={[
      styles.overline, 
      { color: variantColor },
      style
    ]}>
      {children}
    </Text>
  );
}

const styles = StyleSheet.create({
  overline: {
    fontSize: 13, // ðŸŽ¨ Material 3 Label Large (â†‘ de 12px)
    fontWeight: '700', // ðŸŽ¨ Material 3 bold emphasis (â†‘ de 600)
    letterSpacing: 1.2, // ðŸŽ¨ Material 3 expressive spacing (â†‘ de 0.8)
    textTransform: 'uppercase',
    marginBottom: 12, // ðŸŽ¨ Material 3 generous spacing (â†‘ de 8px)
  },
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\components\RingChart.js
========================================
import React, { useEffect, useRef } from 'react';
import { View, StyleSheet, Animated, Easing } from 'react-native';
import Svg, { Circle, G } from 'react-native-svg';
import { Text, useTheme } from 'react-native-paper';

const AnimatedCircle = Animated.createAnimatedComponent(Circle);

export default function RingChart({ 
  progress = 0, // 0 to 1
  size = 280, 
  strokeWidth = 20, 
  color,
  label = "00:00:00",
  subLabel = "Tiempo Trabajado",
  status = 'idle'
}) {
  const theme = useTheme();
  const animatedValue = useRef(new Animated.Value(0)).current;
  const pulseAnim = useRef(new Animated.Value(1)).current;
  const radius = (size - strokeWidth) / 2;
  const circumference = radius * 2 * Math.PI;
  
  // Color fallback
  const activeColor = color || theme.colors.primary;
  const inactiveColor = theme.colors.surfaceVariant;

  useEffect(() => {
    Animated.timing(animatedValue, {
      toValue: progress,
      duration: 1000,
      easing: Easing.out(Easing.cubic),
      useNativeDriver: true,
    }).start();
  }, [progress]);

  // Breathing Animation for Break/Lunch
  useEffect(() => {
    let animation;
    if (status === 'break' || status === 'almuerzo') {
      animation = Animated.loop(
        Animated.sequence([
          Animated.timing(pulseAnim, {
            toValue: 1.05,
            duration: 1500,
            easing: Easing.inOut(Easing.ease),
            useNativeDriver: true,
          }),
          Animated.timing(pulseAnim, {
            toValue: 1,
            duration: 1500,
            easing: Easing.inOut(Easing.ease),
            useNativeDriver: true,
          }),
        ])
      );
      animation.start();
    } else {
      pulseAnim.setValue(1);
    }
    return () => {
      if (animation) animation.stop();
    };
  }, [status]);

  const strokeDashoffset = animatedValue.interpolate({
    inputRange: [0, 1],
    outputRange: [circumference, 0],
  });

  return (
    <Animated.View style={[styles.container, { width: size, height: size, transform: [{ scale: pulseAnim }] }]}>
      <Svg width={size} height={size} style={styles.svg}>
        <G rotation="-90" origin={`${size / 2}, ${size / 2}`}>
          {/* Background Circle */}
          <Circle
            cx={size / 2}
            cy={size / 2}
            r={radius}
            stroke={inactiveColor}
            strokeWidth={strokeWidth}
            fill="transparent"
          />
          {/* Progress Circle */}
          <AnimatedCircle
            cx={size / 2}
            cy={size / 2}
            r={radius}
            stroke={activeColor}
            strokeWidth={strokeWidth}
            strokeDasharray={circumference}
            strokeDashoffset={strokeDashoffset}
            strokeLinecap="round"
            fill="transparent"
          />
        </G>
      </Svg>
      
      {/* Center Text */}
      <View style={styles.textContainer}>
        <Text variant="displayMedium" style={[styles.timeText, { color: theme.colors.onSurface }]}>
          {label}
        </Text>
        <Text variant="labelLarge" style={{ color: theme.colors.secondary }}>
          {subLabel}
        </Text>
      </View>
    </Animated.View>
  );
}

const styles = StyleSheet.create({
  container: {
    justifyContent: 'center',
    alignItems: 'center',
  },
  svg: {
    position: 'absolute',
  },
  textContainer: {
    alignItems: 'center',
    justifyContent: 'center',
  },
  timeText: {
    fontWeight: 'bold',
    fontVariant: ['tabular-nums'], // Monospaced numbers for timer
  }
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\components\SobrioCard.js
========================================
import React from 'react';
import { View, StyleSheet, TouchableOpacity } from 'react-native';
import { useTheme } from 'react-native-paper';

/**
 * SobrioCard - Card component con Material 3 Expressive Design
 * 
 * Material 3 CaracterÃ­sticas:
 * - borderRadius: 28 (Extra Large - Material 3)
 * - Sombras definidas: Elevation Level 1 (0 4px 16px rgba(0,0,0,0.12))
 * - Bordes con alpha(theme, 0.15)
 * - Padding generoso: 24px (Material 3 spacing)
 * - Colores dinÃ¡micos preservados desde ThemeContext
 */
export default function SobrioCard({ 
  children, 
  style, 
  variant = 'primary', // 'primary' | 'secondary'
  borderColor = '#667eea', // Color del tema (dinÃ¡mico desde ThemeContext)
  onPress
}) {
  const theme = useTheme();
  
  const variantStyles = variant === 'primary' 
    ? styles.cardPrimary 
    : styles.cardSecondary;

  const cardStyle = [
    styles.card, 
    variantStyles, 
    { 
      backgroundColor: theme.colors.surface,
      borderColor: borderColor + '26',
      shadowColor: theme.dark ? '#000' : '#000',
      shadowOpacity: theme.dark ? 0.3 : 0.12,
    }, 
    style
  ];

  if (onPress) {
    return (
      <TouchableOpacity onPress={onPress} style={cardStyle} activeOpacity={0.7}>
        {children}
      </TouchableOpacity>
    );
  }

  return (
    <View style={cardStyle}>
      {children}
    </View>
  );
}

const styles = StyleSheet.create({
  card: {
    borderRadius: 28, // ðŸŽ¨ Material 3 Extra Large (antes 16)
    padding: 24, // âœ… Material 3 spacing (mantiene 24px)
    borderWidth: 1,
    // ðŸŽ¨ Material 3 Elevation Level 1 (mÃ¡s definida)
    shadowOffset: {
      width: 0,
      height: 4, // â†‘ ElevaciÃ³n mejorada (antes 2)
    },
    shadowRadius: 16, // â†‘ Radio expandido (antes 8)
    elevation: 4, // â†‘ Android elevation (antes 2)
  },
  cardPrimary: {
    // Borde con alpha(primary, 0.15) - Material 3 (antes 0.2)
    // Se aplica dinÃ¡micamente desde borderColor prop
  },
  cardSecondary: {
    padding: 28, // âœ… Padding secundario (mantiene diferencia)
  },
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\contexts\AuthContext.js
========================================
import React, { createContext, useState, useContext, useEffect } from 'react';
import { 
  signInWithEmailAndPassword, 
  signOut as firebaseSignOut,
  onAuthStateChanged 
} from 'firebase/auth';
import { doc, getDoc, setDoc, updateDoc, collection, addDoc, Timestamp, query, where, getDocs } from 'firebase/firestore';
import { auth, db } from '../services/firebase';
import * as Location from 'expo-location';
import { Platform, Alert } from 'react-native';
import NetInfo from '@react-native-community/netinfo';
import AsyncStorage from '@react-native-async-storage/async-storage';
import NotificationService from '../services/NotificationService';

const AuthContext = createContext({});

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [userProfile, setUserProfile] = useState(null);
  const [loading, setLoading] = useState(true);
  const [activeSession, setActiveSession] = useState(null);
  const [isConnected, setIsConnected] = useState(true);

  // âœ… Monitorear conexiÃ³n y sincronizar
  useEffect(() => {
    const unsubscribe = NetInfo.addEventListener(state => {
      setIsConnected(state.isConnected);
      if (state.isConnected) {
        syncPendingActions();
      }
    });
    return unsubscribe;
  }, []);

  const syncPendingActions = async () => {
    try {
      const pending = await AsyncStorage.getItem('pending_actions');
      if (!pending) return;

      const actions = JSON.parse(pending);
      if (actions.length === 0) return;

      console.log('ðŸ”„ Sincronizando acciones pendientes:', actions.length);
      
      for (const action of actions) {
        // Procesar cada acciÃ³n segÃºn su tipo
        // Nota: Esto es simplificado. En producciÃ³n idealmente se re-ejecuta la lÃ³gica completa
        // o se usa un endpoint de API que acepte timestamps pasados.
        // AquÃ­ solo actualizamos Firestore con los datos guardados.
        
        if (action.type === 'update_session') {
          await updateDoc(doc(db, 'asistencias', action.sessionId), action.data);
        } else if (action.type === 'create_session') {
          // Crear sesiÃ³n pendiente
          await addDoc(collection(db, 'asistencias'), action.data);
        }
      }

      await AsyncStorage.removeItem('pending_actions');
      Alert.alert('SincronizaciÃ³n', 'Tus registros offline se han subido correctamente.');
    } catch (error) {
      console.error('Error sincronizando:', error);
    }
  };

  const queueAction = async (action) => {
    try {
      const pending = await AsyncStorage.getItem('pending_actions');
      const actions = pending ? JSON.parse(pending) : [];
      actions.push(action);
      await AsyncStorage.setItem('pending_actions', JSON.stringify(actions));
      Alert.alert('Modo Offline', 'Registro guardado localmente. Se subirÃ¡ cuando tengas internet.');
    } catch (error) {
      console.error('Error encolando acciÃ³n:', error);
    }
  };

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (firebaseUser) => {
      if (firebaseUser) {
        setUser(firebaseUser);
        // Cargar perfil completo del usuario desde Firestore
        try {
          const userDoc = await getDoc(doc(db, 'users', firebaseUser.uid));
          if (userDoc.exists()) {
            // âœ… Incluir UID en el perfil para evitar errores
            setUserProfile({ ...userDoc.data(), uid: firebaseUser.uid });
          }
          
          // âœ… Cargar sesiÃ³n activa si existe (Persistencia)
          const q = query(
            collection(db, 'asistencias'), 
            where('uid', '==', firebaseUser.uid),
            where('estadoActual', '!=', 'finalizado')
          );
          const querySnapshot = await getDocs(q);
          if (!querySnapshot.empty) {
            const sessionDoc = querySnapshot.docs[0];
            setActiveSession({ ...sessionDoc.data(), id: sessionDoc.id });
          }
        } catch (e) {
          console.log('Error cargando datos iniciales (posible offline):', e);
          // Intentar cargar de AsyncStorage si falla Firestore
        }
      } else {
        setUser(null);
        setUserProfile(null);
        setActiveSession(null);
      }
      setLoading(false);
    });

    return unsubscribe;
  }, []);

  const signIn = async (email, password) => {
    try {
      // 1. Autenticar con Firebase
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      // 2. âœ… Cargar perfil del usuario PRIMERO (para obtener nombre correcto y rol)
      let nombreEmpleado = user.email; // Fallback por defecto
      let userRole = 'USER'; // âœ… Por defecto USER
      try {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists()) {
          const profileData = userDoc.data();
          // âœ… Usar 'name' como campo principal (segÃºn instrucciones), fallback a displayName â†’ email
          nombreEmpleado = profileData.name || profileData.displayName || user.email;
          userRole = profileData.role || 'USER'; // âœ… Obtener rol del usuario
          setUserProfile(profileData);
        }
      } catch (profileError) {
        console.warn('No se pudo cargar perfil del usuario:', profileError);
      }

      // âœ… Ya no auto-registramos entrada al login
      // El usuario debe presionar "Iniciar Jornada" manualmente
      console.log('Login exitoso - Usuario debe iniciar jornada manualmente');
      return { success: true, user };
    } catch (error) {
      console.error('Error en signIn:', error);
      throw error;
    }
  };

  const signOut = async () => {
    try {
      // âœ… Ya NO finalizamos automÃ¡ticamente la jornada al cerrar sesiÃ³n
      // El usuario debe finalizar jornada manualmente antes de salir
      await firebaseSignOut(auth);
      setActiveSession(null);
    } catch (error) {
      console.error('Error en signOut:', error);
      throw error;
    }
  };

  // âœ… NUEVA FUNCIÃ“N: Iniciar jornada laboral manualmente
  const iniciarJornada = async () => {
    try {
      if (!user) {
        throw new Error('No hay usuario autenticado');
      }

      // âœ… Verificar que no haya sesiÃ³n activa
      if (activeSession && !activeSession.salida) {
        throw new Error('Ya tienes una jornada activa');
      }

      // 1. Obtener ubicaciÃ³n con TIMEOUT de 5 segundos
      let location = null;
      try {
        const { status } = await Location.requestForegroundPermissionsAsync();
        if (status === 'granted') {
          // âœ… Promise.race para timeout
          const locationPromise = Location.getCurrentPositionAsync({
            accuracy: Location.Accuracy.Balanced, // MÃ¡s rÃ¡pido que High
          });
          const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Timeout')), 5000)
          );
          
          const loc = await Promise.race([locationPromise, timeoutPromise]);
          location = {
            lat: loc.coords.latitude,
            lon: loc.coords.longitude
          };

          // âœ… Verificar si estÃ¡ en oficina
          try {
            const settingsDoc = await getDoc(doc(db, 'settings', 'location'));
            if (settingsDoc.exists()) {
              const officeLoc = settingsDoc.data();
              const R = 6371e3; // metros
              const Ï†1 = location.lat * Math.PI/180;
              const Ï†2 = officeLoc.lat * Math.PI/180;
              const Î”Ï† = (officeLoc.lat - location.lat) * Math.PI/180;
              const Î”Î» = (officeLoc.lon - location.lon) * Math.PI/180;

              const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
              const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
              const d = R * c;

              location.tipo = d <= (officeLoc.radius || 100) ? 'Oficina' : 'Remoto';
              location.distanciaOficina = Math.round(d);
            } else {
              location.tipo = 'Remoto (Sin Config)';
            }
          } catch (e) {
            console.log('Error verificando oficina:', e);
            location.tipo = 'Remoto (Error)';
          }
        }
      } catch (locError) {
        console.warn('No se pudo obtener ubicaciÃ³n (timeout o error):', locError.message);
        // âœ… Continuar sin ubicaciÃ³n
      }

      // 2. Obtener informaciÃ³n del dispositivo
      const deviceInfo = {
        brand: 'Android',
        manufacturer: 'Unknown',
        modelName: Platform.constants?.Model || 'Unknown',
        osName: Platform.OS,
        osVersion: Platform.Version?.toString() || 'Unknown'
      };

      // 3. Obtener nombre del empleado desde userProfile
      const nombreEmpleado = userProfile?.name || userProfile?.displayName || user.email.split('@')[0];

      // 4. Registrar entrada en asistencias
      // âœ… Usar fecha LOCAL del dispositivo (lo que el usuario ve)
      const now = new Date();
      const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
      const asistenciaData = {
        uid: user.uid,
        empleadoEmail: user.email,
        empleadoNombre: nombreEmpleado,
        fecha: today,
        entrada: {
          hora: Timestamp.now(),
          ubicacion: location,
          dispositivo: `${deviceInfo.brand} ${deviceInfo.modelName}`
        },
        breaks: [],
        almuerzo: null,
        salida: null,
        estadoActual: 'trabajando',
        createdAt: Timestamp.now(),
        updatedAt: Timestamp.now()
      };

      const asistenciaRef = await addDoc(collection(db, 'asistencias'), asistenciaData);
      setActiveSession({
        ...asistenciaData,
        id: asistenciaRef.id
      });

      // âœ… Programar notificaciÃ³n cuando complete 9 horas
      await NotificationService.notifyWorkDayComplete(9);

      return { success: true, sessionId: asistenciaRef.id };
    } catch (error) {
      console.error('Error iniciando jornada:', error);
      throw error;
    }
  };

  const registrarBreak = async () => {
    if (!activeSession) return;
    
    // âœ… Validar mÃ¡ximo 2 breaks
    if (activeSession.breaks && activeSession.breaks.length >= 2) {
      throw new Error('Has alcanzado el lÃ­mite mÃ¡ximo de 2 breaks por dÃ­a.');
    }

    try {
      const breakInicio = Timestamp.now(); // âœ… Usar Timestamp de Firestore
      const updatedBreaks = [
        ...activeSession.breaks,
        {
          inicio: breakInicio,
          fin: null,
          duracion: null
        }
      ];

      const updateData = {
        breaks: updatedBreaks,
        estadoActual: 'break',
        updatedAt: Timestamp.now()
      };

      if (isConnected) {
        await updateDoc(doc(db, 'asistencias', activeSession.id), updateData);
      } else {
        await queueAction({
          type: 'update_session',
          sessionId: activeSession.id,
          data: updateData
        });
      }

      setActiveSession({
        ...activeSession,
        breaks: updatedBreaks,
        estadoActual: 'break'
      });

      // âœ… Programar notificaciÃ³n si el break es muy largo (15 min)
      await NotificationService.notifyLongBreak(15);
    } catch (error) {
      console.error('Error registrando break:', error);
      throw error;
    }
  };

  const finalizarBreak = async () => {
    if (!activeSession || activeSession.breaks.length === 0) return;

    try {
      const breakActual = activeSession.breaks[activeSession.breaks.length - 1];
      if (breakActual.fin) return; // Ya estÃ¡ finalizado

      const fin = Timestamp.now(); // âœ… Usar Timestamp de Firestore
      // âœ… El inicio ya es Timestamp, convertir a Date para cÃ¡lculos
      const inicioDate = breakActual.inicio.toDate ? breakActual.inicio.toDate() : new Date(breakActual.inicio);
      const finDate = fin.toDate();
      const diffMs = finDate - inicioDate;
      
      // Calcular HH:MM:SS
      const horas = Math.floor(diffMs / 1000 / 60 / 60);
      const minutos = Math.floor((diffMs / 1000 / 60) % 60);
      const segundos = Math.floor((diffMs / 1000) % 60);
      const duracionHMS = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;

      const updatedBreaks = [...activeSession.breaks];
      updatedBreaks[updatedBreaks.length - 1] = {
        ...breakActual,
        fin: fin,
        duracion: duracionHMS
      };

      const updateData = {
        breaks: updatedBreaks,
        estadoActual: 'trabajando',
        updatedAt: Timestamp.now()
      };

      if (isConnected) {
        await updateDoc(doc(db, 'asistencias', activeSession.id), updateData);
      } else {
        await queueAction({
          type: 'update_session',
          sessionId: activeSession.id,
          data: updateData
        });
      }

      setActiveSession({
        ...activeSession,
        breaks: updatedBreaks,
        estadoActual: 'trabajando'
      });
    } catch (error) {
      console.error('Error finalizando break:', error);
      throw error;
    }
  };

  const registrarAlmuerzo = async () => {
    if (!activeSession) return;

    // âœ… Validar mÃ¡ximo 1 almuerzo
    if (activeSession.almuerzo) {
      throw new Error('Ya has registrado tu hora de almuerzo hoy.');
    }

    try {
      const almuerzoInicio = Timestamp.now(); // âœ… Usar Timestamp de Firestore

      const updateData = {
        almuerzo: {
          inicio: almuerzoInicio,
          fin: null,
          duracion: null
        },
        estadoActual: 'almuerzo',
        updatedAt: Timestamp.now()
      };

      if (isConnected) {
        await updateDoc(doc(db, 'asistencias', activeSession.id), updateData);
      } else {
        await queueAction({
          type: 'update_session',
          sessionId: activeSession.id,
          data: updateData
        });
      }

      setActiveSession({
        ...activeSession,
        almuerzo: {
          inicio: almuerzoInicio,
          fin: null,
          duracion: null
        },
        estadoActual: 'almuerzo'
      });
    } catch (error) {
      console.error('Error registrando almuerzo:', error);
      throw error;
    }
  };

  const finalizarAlmuerzo = async () => {
    if (!activeSession || !activeSession.almuerzo) return;

    try {
      const fin = Timestamp.now(); // âœ… Usar Timestamp de Firestore
      // âœ… El inicio ya es Timestamp, convertir a Date para cÃ¡lculos
      const inicioDate = activeSession.almuerzo.inicio.toDate ? activeSession.almuerzo.inicio.toDate() : new Date(activeSession.almuerzo.inicio);
      const finDate = fin.toDate();
      const diffMs = finDate - inicioDate;
      
      // Calcular HH:MM:SS
      const horas = Math.floor(diffMs / 1000 / 60 / 60);
      const minutos = Math.floor((diffMs / 1000 / 60) % 60);
      const segundos = Math.floor((diffMs / 1000) % 60);
      const duracionHMS = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;

      const updateData = {
        almuerzo: {
          ...activeSession.almuerzo,
          fin: fin,
          duracion: duracionHMS
        },
        estadoActual: 'trabajando',
        updatedAt: Timestamp.now()
      };

      if (isConnected) {
        await updateDoc(doc(db, 'asistencias', activeSession.id), updateData);
      } else {
        await queueAction({
          type: 'update_session',
          sessionId: activeSession.id,
          data: updateData
        });
      }

      setActiveSession({
        ...activeSession,
        almuerzo: {
          ...activeSession.almuerzo,
          fin: fin,
          duracion: duracionHMS
        },
        estadoActual: 'trabajando'
      });
    } catch (error) {
      console.error('Error finalizando almuerzo:', error);
      throw error;
    }
  };

  const finalizarJornada = async () => {
    if (!activeSession) return;

    try {
      // âœ… Obtener ubicaciÃ³n con TIMEOUT de 5 segundos
      let location = null;
      try {
        const { status } = await Location.requestForegroundPermissionsAsync();
        if (status === 'granted') {
          // âœ… Promise.race para timeout
          const locationPromise = Location.getCurrentPositionAsync({
            accuracy: Location.Accuracy.Balanced, // MÃ¡s rÃ¡pido que High
          });
          const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Timeout')), 5000)
          );
          
          const loc = await Promise.race([locationPromise, timeoutPromise]);
          location = {
            lat: loc.coords.latitude,
            lon: loc.coords.longitude
          };
        }
      } catch (locError) {
        console.warn('No se pudo obtener ubicaciÃ³n (timeout o error):', locError.message);
        // âœ… Continuar sin ubicaciÃ³n
      }

      // Calcular horas trabajadas en formato HH:MM:SS
      // âœ… Convertir Timestamp a Date para cÃ¡lculos
      const entradaDate = activeSession.entrada.hora.toDate ? activeSession.entrada.hora.toDate() : new Date(activeSession.entrada.hora);
      const salidaTimestamp = Timestamp.now();
      const salidaDate = salidaTimestamp.toDate();
      
      // Calcular tiempo total trabajado (sin descansos aÃºn)
      const diffMs = salidaDate - entradaDate;
      
      // Convertir duraciones HH:MM:SS a milisegundos y sumar
      let tiempoDescansoMs = 0;
      
      activeSession.breaks.forEach(b => {
        if (b.duracion && typeof b.duracion === 'string' && b.duracion.includes(':')) {
          const [h, m, s] = b.duracion.split(':').map(Number);
          tiempoDescansoMs += (h * 60 * 60 + m * 60 + s) * 1000;
        }
      });
      
      if (activeSession.almuerzo?.duracion && typeof activeSession.almuerzo.duracion === 'string' && activeSession.almuerzo.duracion.includes(':')) {
        const [h, m, s] = activeSession.almuerzo.duracion.split(':').map(Number);
        tiempoDescansoMs += (h * 60 * 60 + m * 60 + s) * 1000;
      }

      // Tiempo trabajado efectivo = tiempo total - descansos
      const tiempoTrabajadoMs = diffMs - tiempoDescansoMs;
      
      // Convertir a HH:MM:SS
      const horas = Math.floor(tiempoTrabajadoMs / 1000 / 60 / 60);
      const minutos = Math.floor((tiempoTrabajadoMs / 1000 / 60) % 60);
      const segundos = Math.floor((tiempoTrabajadoMs / 1000) % 60);
      const horasTrabajadas = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;

      const updateData = {
        salida: {
          hora: salidaTimestamp, // âœ… Usar Timestamp de Firestore
          ubicacion: location
        },
        horasTrabajadas: horasTrabajadas,
        estadoActual: 'finalizado',
        updatedAt: Timestamp.now()
      };

      if (isConnected) {
        await updateDoc(doc(db, 'asistencias', activeSession.id), updateData);
      } else {
        await queueAction({
          type: 'update_session',
          sessionId: activeSession.id,
          data: updateData
        });
      }

      // âœ… Solo actualizar el estado de la sesiÃ³n a finalizado
      // NO cerrar sesiÃ³n automÃ¡ticamente
      setActiveSession({
        ...activeSession,
        ...updateData,
        estadoActual: 'finalizado'
      });
    } catch (error) {
      console.error('Error finalizando jornada:', error);
      throw error;
    }
  };

  // âœ… PASO 1.1: Sistema de permisos basado en roles
  const hasPermission = (permission) => {
    if (!userProfile) return false;
    
    // SUPER_ADMIN tiene todos los permisos
    if (userProfile.role === 'SUPER_ADMIN') return true;
    
    // ADMIN tiene permisos especÃ­ficos
    if (userProfile.role === 'ADMIN') {
      const adminPermissions = [
        'asistencias.ver_todos',
        'reportes.generar',
        'usuarios.ver',
        'chat'
      ];
      return adminPermissions.includes(permission);
    }
    
    // USER solo tiene permisos bÃ¡sicos
    if (userProfile.role === 'USER') {
      const userPermissions = ['chat', 'asistencia.propia'];
      return userPermissions.includes(permission);
    }
    
    return false;
  };

  const value = {
    user,
    userProfile,
    loading,
    activeSession,
    signIn,
    signOut,
    iniciarJornada, // âœ… Nueva funciÃ³n
    registrarBreak,
    finalizarBreak,
    registrarAlmuerzo,
    finalizarAlmuerzo,
    finalizarJornada,
    hasPermission
  };

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
};

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth debe ser usado dentro de un AuthProvider');
  }
  return context;
};


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\contexts\NotificationsContext.js
========================================
import React, { createContext, useContext, useState, useEffect, useRef } from 'react';
import * as Notifications from 'expo-notifications';
import { Platform } from 'react-native';

const NotificationsContext = createContext();

export const useNotifications = () => {
  const context = useContext(NotificationsContext);
  if (!context) {
    throw new Error('useNotifications debe ser usado dentro de NotificationsProvider');
  }
  return context;
};

// âœ… Configurar cÃ³mo se manejan las notificaciones locales cuando la app estÃ¡ en foreground
Notifications.setNotificationHandler({
  handleNotification: async () => ({
    shouldShowAlert: true, // Deprecated pero aÃºn funciona
    shouldPlaySound: true,
    shouldSetBadge: true,
    // âœ… Nueva API recomendada:
    shouldShowBanner: true,
    shouldShowList: true,
  }),
});

export const NotificationsProvider = ({ children }) => {
  const [notification, setNotification] = useState(false);
  const notificationListener = useRef();
  const responseListener = useRef();

  useEffect(() => {
    // âœ… Pedir permisos para notificaciones locales
    requestNotificationPermissions();

    // âœ… Configurar canales de notificaciÃ³n para Android
    if (Platform.OS === 'android') {
      setupNotificationChannels();
    }

    // âœ… Listener para notificaciones recibidas mientras la app estÃ¡ en foreground
    notificationListener.current = Notifications.addNotificationReceivedListener(notification => {
      console.log('ðŸ”” NotificaciÃ³n recibida:', notification);
      setNotification(notification);
    });

    // âœ… Listener para cuando el usuario toca una notificaciÃ³n
    responseListener.current = Notifications.addNotificationResponseReceivedListener(response => {
      console.log('ðŸ‘† NotificaciÃ³n tocada:', response);
      // La navegaciÃ³n se manejarÃ¡ en App.js
    });

    return () => {
      // âœ… Usar .remove() en lugar de removeNotificationSubscription
      if (notificationListener.current) {
        notificationListener.current.remove();
      }
      if (responseListener.current) {
        responseListener.current.remove();
      }
    };
  }, []);

  // âœ… FunciÃ³n para pedir permisos de notificaciones locales
  async function requestNotificationPermissions() {
    try {
      const { status: existingStatus } = await Notifications.getPermissionsAsync();
      let finalStatus = existingStatus;
      
      if (existingStatus !== 'granted') {
        const { status } = await Notifications.requestPermissionsAsync();
        finalStatus = status;
      }
      
      if (finalStatus !== 'granted') {
        console.warn('âš ï¸ Permiso de notificaciones denegado');
        return false;
      }
      
      console.log('âœ… Permisos de notificaciones concedidos');
      return true;
    } catch (error) {
      console.error('âŒ Error pidiendo permisos:', error);
      return false;
    }
  }

  // Configurar canales de notificaciÃ³n para Android
  async function setupNotificationChannels() {
    try {
      // Canal para jornada laboral (prioridad alta)
      await Notifications.setNotificationChannelAsync('work-session', {
        name: 'Jornada Laboral',
        importance: Notifications.AndroidImportance.HIGH,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: '#667eea',
        lockscreenVisibility: Notifications.AndroidNotificationVisibility.PUBLIC,
        sound: 'default',
      });

      // Canal para recordatorios (prioridad media)
      await Notifications.setNotificationChannelAsync('reminders', {
        name: 'Recordatorios',
        importance: Notifications.AndroidImportance.DEFAULT,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: '#ffa502',
        sound: 'default',
      });

      console.log('âœ… Canales de notificaciÃ³n configurados');
    } catch (error) {
      console.error('âŒ Error configurando canales:', error);
    }
  }

  // âœ… FunciÃ³n para programar notificaciÃ³n local
  async function scheduleNotification(title, body, data = {}, channelId = 'default') {
    try {
      await Notifications.scheduleNotificationAsync({
        content: {
          title,
          body,
          data,
          sound: true,
          priority: Notifications.AndroidNotificationPriority.HIGH,
        },
        trigger: null, // Inmediato
      });
      console.log('âœ… NotificaciÃ³n programada');
    } catch (error) {
      console.error('âŒ Error programando notificaciÃ³n:', error);
    }
  }

  // âœ… FunciÃ³n para cancelar notificaciÃ³n por ID
  async function cancelNotification(notificationId) {
    try {
      await Notifications.dismissNotificationAsync(notificationId);
      console.log('âœ… NotificaciÃ³n cancelada:', notificationId);
    } catch (error) {
      console.error('âŒ Error cancelando notificaciÃ³n:', error);
    }
  }

  // âœ… FunciÃ³n para cancelar todas las notificaciones
  async function cancelAllNotifications() {
    try {
      await Notifications.dismissAllNotificationsAsync();
      console.log('âœ… Todas las notificaciones canceladas');
    } catch (error) {
      console.error('âŒ Error cancelando notificaciones:', error);
    }
  }

  const value = {
    notification,
    scheduleNotification,
    cancelNotification,
    cancelAllNotifications
  };

  return (
    <NotificationsContext.Provider value={value}>
      {children}
    </NotificationsContext.Provider>
  );
};


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\contexts\ThemeContext.js
========================================
import React, { createContext, useState, useContext, useEffect } from 'react';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { doc, getDoc } from 'firebase/firestore';
import { useAuth } from './AuthContext';
import { db } from '../services/firebase';

const ThemeContext = createContext({});

// âœ… Colores por defecto spectacular
const DEFAULT_COLORS = {
  primary: '#667eea',
  secondary: '#764ba2',
  accent: '#f093fb',
  error: '#f5576c'
};

const STORAGE_KEY = '@theme_colors';
const PHOTO_STORAGE_KEY = '@last_user_photo';
const DARK_MODE_KEY = '@theme_dark_mode';

export const ThemeProvider = ({ children }) => {
  const { user } = useAuth();
  const [colors, setColors] = useState(DEFAULT_COLORS);
  const [lastUserPhoto, setLastUserPhoto] = useState(null);
  const [isDarkMode, setIsDarkMode] = useState(false);

  // âœ… Cargar colores y foto guardados al iniciar la app
  useEffect(() => {
    const loadSavedData = async () => {
      try {
        const savedColors = await AsyncStorage.getItem(STORAGE_KEY);
        if (savedColors) {
          setColors(JSON.parse(savedColors));
        }
        
        const savedPhoto = await AsyncStorage.getItem(PHOTO_STORAGE_KEY);
        if (savedPhoto) {
          setLastUserPhoto(savedPhoto);
        }

        const savedDarkMode = await AsyncStorage.getItem(DARK_MODE_KEY);
        if (savedDarkMode !== null) {
          setIsDarkMode(savedDarkMode === 'true');
        }
      } catch (error) {
        // Si hay error, usar defaults
      }
    };

    loadSavedData();
  }, []);

  // âœ… Cargar colores y foto del usuario cuando inicia sesiÃ³n
  useEffect(() => {
    const loadUserSettings = async () => {
      if (!user?.uid) {
        return;
      }

      try {
        // âœ… Leer desde userSettings collection (estructura real de Firestore)
        const userSettingsRef = doc(db, 'userSettings', user.uid);
        const userSettingsSnap = await getDoc(userSettingsRef);

        if (userSettingsSnap.exists()) {
          const settings = userSettingsSnap.data();
          if (settings?.theme) {
            const newColors = {
              primary: settings.theme.primaryColor || DEFAULT_COLORS.primary,
              secondary: settings.theme.secondaryColor || DEFAULT_COLORS.secondary,
              accent: settings.theme.accent || DEFAULT_COLORS.accent,
              error: settings.theme.error || DEFAULT_COLORS.error
            };
            setColors(newColors);
            // âœ… Guardar en AsyncStorage para la prÃ³xima vez
            await AsyncStorage.setItem(STORAGE_KEY, JSON.stringify(newColors));
          }
        }

        // âœ… TambiÃ©n cargar la foto de perfil del usuario
        const userRef = doc(db, 'users', user.uid);
        const userSnap = await getDoc(userRef);
        
        if (userSnap.exists() && userSnap.data()?.photoURL) {
          const photoURL = userSnap.data().photoURL;
          setLastUserPhoto(photoURL);
          // âœ… Guardar foto en AsyncStorage
          await AsyncStorage.setItem(PHOTO_STORAGE_KEY, photoURL);
        }
      } catch (error) {
        // Si hay error, mantener colores actuales
      }
    };

    loadUserSettings();
  }, [user]);

  const toggleDarkMode = async () => {
    try {
      const newMode = !isDarkMode;
      setIsDarkMode(newMode);
      await AsyncStorage.setItem(DARK_MODE_KEY, String(newMode));
    } catch (error) {
      console.error('Error al cambiar modo oscuro:', error);
    }
  };

  const value = {
    colors,
    isDarkMode,
    lastUserPhoto, // âœ… Exponer la foto del Ãºltimo usuario
    toggleDarkMode,
    // Helper para obtener array de gradiente
    getGradient: () => [colors.primary, colors.secondary],
    // Helper para obtener color Ãºnico
    getPrimaryColor: () => colors.primary,
    getSecondaryColor: () => colors.secondary,
    getAccentColor: () => colors.accent,
    getErrorColor: () => colors.error
  };

  return <ThemeContext.Provider value={value}>{children}</ThemeContext.Provider>;
};

export const useTheme = () => {
  const context = useContext(ThemeContext);
  if (!context) {
    throw new Error('useTheme debe ser usado dentro de un ThemeProvider');
  }
  return context;
};


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\hooks\useColombianHolidays.js
========================================
import { useMemo } from 'react';
import festivosColombianos from 'festivos-colombianos';
import { parseISO, getDay, addDays } from 'date-fns';

// Hook para obtener dÃ­as festivos de Colombia aplicando manualmente la Ley Emiliani
export const useColombianHolidays = (year = new Date().getFullYear()) => {
  const holidays = useMemo(() => {
    try {
      // Obtener festivos usando el paquete oficial
      const festivosOficiales = festivosColombianos(year);
      
      if (!Array.isArray(festivosOficiales)) return [];

      // Festivos que deben regirse por la Ley Emiliani (traslado al lunes)
      const festivosEmiliani = [
        "San JosÃ©",
        "San Pedro y San Pablo", 
        "AsunciÃ³n de la Virgen",
        "DÃ­a de la Raza",
        "Todos los Santos",
        "Independencia de Cartagena",
        "Sagrado CorazÃ³n",
        "AscensiÃ³n del SeÃ±or",
        "Corpus Christi"
      ];

      // FunciÃ³n para aplicar la Ley Emiliani
      const aplicarLeyEmiliani = (fechaISO) => {
        const fecha = parseISO(fechaISO);
        const diaSemana = getDay(fecha); // 0 = domingo, 1 = lunes, etc.
        
        if (diaSemana === 0) { // Si cae domingo
          return addDays(fecha, 1); // Mover al lunes (dÃ­a siguiente)
        } else if (diaSemana > 1) { // Si cae martes a sÃ¡bado
          return addDays(fecha, 8 - diaSemana); // Mover al lunes siguiente
        } else {
          return fecha; // Si ya es lunes, no se mueve
        }
      };

      // Convertir y aplicar Ley Emiliani donde corresponda
      const formattedHolidays = festivosOficiales.map(festivo => {
        const aplicaEmiliani = festivosEmiliani.some(nombre => 
          festivo.celebration.includes(nombre)
        );

        if (aplicaEmiliani) {
          const fechaCorregida = aplicarLeyEmiliani(festivo.holiday);
          return {
            date: fechaCorregida.toISOString().split('T')[0],
            name: festivo.celebration,
            type: 'religious',
            originalDate: festivo.holiday // Guardar fecha original para referencia
          };
        } else {
          return {
            date: festivo.holiday,
            name: festivo.celebration,
            type: 'civil'
          };
        }
      });

      return formattedHolidays;
    } catch (error) {
      console.error("Error calculating holidays:", error);
      return [];
    }
  }, [year]);

  return holidays;
};


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\navigation\AppNavigator.js
========================================
import React from 'react';
import { NavigationContainer } from '@react-navigation/native';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { useAuth } from '../contexts/AuthContext';
import { ActivityIndicator, View } from 'react-native';

// Screens
import LoginScreen from '../screens/auth/LoginScreen';
import BottomTabNavigator from './BottomTabNavigator'; // âœ… FASE 0.3: Bottom Tab Navigator
import AsistenciaDetailScreen from '../screens/asistencias/AsistenciaDetailScreen'; // âœ… FASE 0.5: Detalle de asistencia
import DashboardScreen from '../screens/dashboard/DashboardScreen';
import NovedadesScreen from '../screens/novedades/NovedadesScreen';
import AdminNovedadesScreen from '../screens/admin/AdminNovedadesScreen';
import AdminSettingsScreen from '../screens/admin/AdminSettingsScreen';
import NotificationsScreen from '../screens/notifications/NotificationsScreen';
import AsistenciasScreen from '../screens/asistencias/AsistenciasScreen';
import ReportesScreen from '../screens/reportes/ReportesScreen';

const Stack = createNativeStackNavigator();

function AppNavigator({ navigation }, ref) {
  const { user, userProfile, loading } = useAuth();

  if (loading) {
    return (
      <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>
        <ActivityIndicator size="large" color="#667eea" />
      </View>
    );
  }

  // âœ… PASO 1.3: Determinar rol del usuario
  const userRole = userProfile?.role || 'USER';
  const isAdmin = userRole === 'ADMIN' || userRole === 'SUPER_ADMIN';

  return (
    <NavigationContainer ref={ref}>
      <Stack.Navigator screenOptions={{ headerShown: false }}>
        {user ? (
          <>
            {/* âœ… TODOS: Acceso con Bottom Tab Navigator (Tabs dinÃ¡micos por rol) */}
            <Stack.Screen name="Main" component={BottomTabNavigator} />
            
            {/* âœ… Pantallas Comunes (Accesibles por Stack) */}
            <Stack.Screen name="AsistenciaDetail" component={AsistenciaDetailScreen} />
            <Stack.Screen name="Novedades" component={NovedadesScreen} />
            <Stack.Screen name="AdminNovedades" component={AdminNovedadesScreen} />
            <Stack.Screen name="AdminSettings" component={AdminSettingsScreen} />
            <Stack.Screen name="Notifications" component={NotificationsScreen} />
          </>
        ) : (
          // Usuario no autenticado
          <Stack.Screen name="Login" component={LoginScreen} />
        )}
      </Stack.Navigator>
    </NavigationContainer>
  );
}

export default React.forwardRef(AppNavigator);


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\navigation\BottomTabNavigator.js
========================================
import React, { useEffect, useRef } from 'react';
import { Animated, View, Platform } from 'react-native';
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import { Ionicons } from '@expo/vector-icons';
import { useSafeAreaInsets } from 'react-native-safe-area-context';
import { useTheme as usePaperTheme } from 'react-native-paper';
import { useTheme } from '../contexts/ThemeContext';
import { useAuth } from '../contexts/AuthContext';

// Screens
import DashboardScreen from '../screens/dashboard/DashboardScreen';
// import AdminDashboardScreen from '../screens/admin/AdminDashboardScreen'; // Removed as per user request
import AdminNovedadesScreen from '../screens/admin/AdminNovedadesScreen';
import CalendarioScreen from '../screens/calendario/CalendarioScreen';
import AsistenciasScreen from '../screens/asistencias/AsistenciasScreen';
import ReportesScreen from '../screens/reportes/ReportesScreen';
import NovedadesScreen from '../screens/novedades/NovedadesScreen';

const Tab = createBottomTabNavigator();

/**
 * BottomTabNavigator - NavegaciÃ³n principal con tabs dinÃ¡micos por rol
 * 
 * Tabs Comunes:
 * 1. Jornada (DashboardScreen)
 * 3. Reportes (ReportesScreen)
 * 4. Historial (AsistenciasScreen)
 * 
 * Tabs Admin:
 * 2. Calendario (CalendarioScreen)
 * 
 * Tabs User:
 * 2. Novedades (NovedadesScreen)
 */
export default function BottomTabNavigator() {
  const paperTheme = usePaperTheme();
  const { getPrimaryColor } = useTheme();
  const { userProfile } = useAuth();
  const insets = useSafeAreaInsets();
  
  const userRole = userProfile?.role || 'USER';
  const isAdmin = userRole === 'ADMIN' || userRole === 'SUPER_ADMIN';

  // Color de Ã­conos inactivos con mejor contraste en modo oscuro
  const inactiveColor = paperTheme.dark ? '#94a3b8' : paperTheme.colors.onSurfaceVariant;

  return (
    <Tab.Navigator
      screenOptions={{
        headerShown: false,
        tabBarActiveTintColor: getPrimaryColor(),
        tabBarInactiveTintColor: inactiveColor,
        tabBarStyle: {
          height: 80 + (Platform.OS === 'ios' ? insets.bottom : 10),
          backgroundColor: paperTheme.colors.surface,
          borderTopWidth: 1,
          borderTopColor: paperTheme.colors.surfaceVariant,
          elevation: 0,
          paddingTop: 12,
          paddingBottom: 12 + (Platform.OS === 'ios' ? insets.bottom : 10),
        },
        tabBarLabelStyle: {
          fontSize: 12,
          fontWeight: '600',
          marginTop: 4,
        },
        tabBarIconStyle: {
          marginBottom: 0,
        },
        tabBarItemStyle: {
          paddingVertical: 8,
        }
      }}
    >
      {/* 1. INICIO (Jornada) - Para TODOS (Incluido Admin) */}
      <Tab.Screen 
        name="Dashboard" 
        component={DashboardScreen}
        options={{
          tabBarIcon: ({ color, focused }) => (
            <Ionicons name={focused ? "timer" : "timer-outline"} size={24} color={color} />
          ),
          tabBarLabel: 'Mi Jornada'
        }}
      />

      {isAdmin ? (
        <>
          <Tab.Screen 
            name="Calendario" 
            component={CalendarioScreen}
            options={{
              tabBarIcon: ({ color, focused }) => (
                <Ionicons name={focused ? "calendar" : "calendar-outline"} size={24} color={color} />
              ),
              tabBarLabel: 'Calendario'
            }}
          />
          <Tab.Screen 
            name="AdminNovedades" 
            component={AdminNovedadesScreen}
            options={{
              tabBarIcon: ({ color, focused }) => (
                <Ionicons name={focused ? "file-tray-full" : "file-tray-full-outline"} size={24} color={color} />
              ),
              tabBarLabel: 'Novedades'
            }}
          />
        </>
      ) : (
        <Tab.Screen 
          name="Novedades" 
          component={NovedadesScreen}
          options={{
            tabBarIcon: ({ color, focused }) => (
              <Ionicons name={focused ? "notifications" : "notifications-outline"} size={24} color={color} />
            ),
            tabBarLabel: 'Novedades'
          }}
        />
      )}
      
      {/* COMMON TABS */}
      <Tab.Screen 
        name="Reportes" 
        component={ReportesScreen}
        options={{
          tabBarIcon: ({ color, focused }) => (
            <Ionicons name={focused ? "bar-chart" : "bar-chart-outline"} size={24} color={color} />
          ),
          tabBarLabel: isAdmin ? 'Reportes' : 'EstadÃ­sticas'
        }}
      />
      
      <Tab.Screen 
        name="Asistencias" 
        component={AsistenciasScreen}
        options={{
          tabBarIcon: ({ color, focused }) => (
            <Ionicons name={focused ? "time" : "time-outline"} size={24} color={color} />
          ),
          tabBarLabel: 'Historial'
        }}
      />
    </Tab.Navigator>
  );
}


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\screens\admin\AdminNovedadesScreen.js
========================================
import React, { useState, useEffect } from 'react';
import {
  View,
  StyleSheet,
  FlatList,
  Alert,
  RefreshControl,
  Animated,
  Linking,
  Dimensions
} from 'react-native';
import { 
  Text, 
  useTheme as usePaperTheme, 
  Avatar, 
  IconButton, 
  Chip,
  Searchbar,
  Portal,
  Modal,
  Button
} from 'react-native-paper';
import { Swipeable, GestureHandlerRootView } from 'react-native-gesture-handler';
import { collection, query, orderBy, getDocs, updateDoc, doc } from 'firebase/firestore';
import { db } from '../../services/firebase';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { SafeAreaView } from 'react-native-safe-area-context';

// Custom Hooks & Components
import { useTheme } from '../../contexts/ThemeContext';
import SobrioCard from '../../components/SobrioCard';
import DetailRow from '../../components/DetailRow';
import OverlineText from '../../components/OverlineText';

const { width } = Dimensions.get('window');

export default function AdminNovedadesScreen({ navigation }) {
  const paperTheme = usePaperTheme();
  const { getPrimaryColor } = useTheme();
  const primaryColor = getPrimaryColor();

  const [novedades, setNovedades] = useState([]);
  const [filteredNovedades, setFilteredNovedades] = useState([]);
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [filterStatus, setFilterStatus] = useState('pending'); // 'pending' | 'all'
  const [selectedNovedad, setSelectedNovedad] = useState(null);
  const [modalVisible, setModalVisible] = useState(false);

  const fetchNovedades = async () => {
    try {
      const q = query(collection(db, 'novedades'), orderBy('date', 'desc'));
      const snapshot = await getDocs(q);
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setNovedades(data);
      filterData(data, searchQuery, filterStatus);
    } catch (error) {
      console.error(error);
      Alert.alert('Error', 'No se pudieron cargar las novedades');
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  };

  useEffect(() => {
    fetchNovedades();
  }, []);

  useEffect(() => {
    filterData(novedades, searchQuery, filterStatus);
  }, [searchQuery, filterStatus, novedades]);

  const filterData = (data, query, status) => {
    let filtered = data;
    
    // Filter by Status
    if (status === 'pending') {
      filtered = filtered.filter(item => item.status === 'pending');
    }

    // Filter by Search
    if (query) {
      const lowerQuery = query.toLowerCase();
      filtered = filtered.filter(item => 
        item.userName?.toLowerCase().includes(lowerQuery) ||
        item.type?.toLowerCase().includes(lowerQuery)
      );
    }

    setFilteredNovedades(filtered);
  };

  const handleStatusChange = async (id, newStatus) => {
    try {
      // Optimistic Update
      setNovedades(prev => prev.map(item => 
        item.id === id ? { ...item, status: newStatus } : item
      ));

      await updateDoc(doc(db, 'novedades', id), { status: newStatus });
      
      if (selectedNovedad?.id === id) {
        setSelectedNovedad(prev => ({ ...prev, status: newStatus }));
      }
    } catch (error) {
      Alert.alert('Error', 'No se pudo actualizar el estado');
      fetchNovedades(); // Revert on error
    }
  };

  const renderRightActions = (progress, dragX, item) => {
    const trans = dragX.interpolate({
      inputRange: [-100, 0],
      outputRange: [0, 100],
      extrapolate: 'clamp',
    });

    return (
      <View style={styles.rightActionContainer}>
        <Animated.View style={[styles.actionButton, { backgroundColor: paperTheme.colors.error, transform: [{ translateX: trans }] }]}>
          <IconButton icon="close" iconColor="white" onPress={() => handleStatusChange(item.id, 'rejected')} />
          <Text style={{ color: 'white', fontWeight: 'bold' }}>Rechazar</Text>
        </Animated.View>
      </View>
    );
  };

  const renderLeftActions = (progress, dragX, item) => {
    const trans = dragX.interpolate({
      inputRange: [0, 100],
      outputRange: [-100, 0],
      extrapolate: 'clamp',
    });

    return (
      <View style={styles.leftActionContainer}>
        <Animated.View style={[styles.actionButton, { backgroundColor: primaryColor, transform: [{ translateX: trans }] }]}>
          <IconButton icon="check" iconColor="white" onPress={() => handleStatusChange(item.id, 'approved')} />
          <Text style={{ color: 'white', fontWeight: 'bold' }}>Aprobar</Text>
        </Animated.View>
      </View>
    );
  };

  const renderItem = ({ item }) => (
    <Swipeable
      renderRightActions={(p, d) => renderRightActions(p, d, item)}
      renderLeftActions={(p, d) => renderLeftActions(p, d, item)}
    >
      <SobrioCard 
        onPress={() => { setSelectedNovedad(item); setModalVisible(true); }}
        borderColor={primaryColor}
        style={{ marginBottom: 12 }}
      >
        <View style={styles.cardHeader}>
          <Avatar.Text 
            size={40} 
            label={item.userName ? item.userName.substring(0, 2).toUpperCase() : 'NA'} 
            style={{ backgroundColor: primaryColor + '20' }}
            color={primaryColor}
          />
          <View style={styles.headerText}>
            <Text variant="titleMedium" style={{ fontWeight: 'bold' }}>{item.userName || 'Usuario'}</Text>
            <Text variant="bodySmall" style={{ color: paperTheme.colors.secondary }}>
              {item.date?.toDate ? format(item.date.toDate(), "d MMM, h:mm a", { locale: es }) : 'Fecha invÃ¡lida'}
            </Text>
          </View>
          <Chip 
            icon={item.status === 'pending' ? 'clock' : item.status === 'approved' ? 'check' : 'close'} 
            style={{ backgroundColor: item.status === 'pending' ? paperTheme.colors.tertiaryContainer : item.status === 'approved' ? '#E8F5E9' : '#FFEBEE' }}
            textStyle={{ color: item.status === 'pending' ? paperTheme.colors.onTertiaryContainer : item.status === 'approved' ? '#2E7D32' : '#C62828', fontSize: 10 }}
            compact
          >
            {item.status === 'pending' ? 'Pendiente' : item.status === 'approved' ? 'Aprobado' : 'Rechazado'}
          </Chip>
        </View>
        
        <View style={{ marginTop: 12 }}>
            <OverlineText color={paperTheme.colors.secondary} style={{ marginBottom: 4 }}>
                {item.type?.replace('_', ' ')}
            </OverlineText>
            {item.description ? (
                <Text numberOfLines={2} style={{ color: paperTheme.colors.onSurfaceVariant }}>
                    {item.description}
                </Text>
            ) : null}
        </View>
      </SobrioCard>
    </Swipeable>
  );

  return (
    <GestureHandlerRootView style={{ flex: 1 }}>
      <SafeAreaView style={[styles.container, { backgroundColor: paperTheme.colors.background }]}>
        
        {/* Header */}
        <View style={styles.header}>
          <Text variant="headlineMedium" style={{ fontWeight: 'bold', color: primaryColor }}>
            Novedades
          </Text>
        </View>

        {/* Filter Chips */}
        <View style={styles.filterChips}>
          <Chip 
            selected={filterStatus === 'pending'} 
            onPress={() => setFilterStatus('pending')}
            style={{ marginRight: 8 }}
            showSelectedOverlay
          >
            Pendientes
          </Chip>
          <Chip 
            selected={filterStatus === 'all'} 
            onPress={() => setFilterStatus('all')}
            showSelectedOverlay
          >
            Historial
          </Chip>
        </View>

        <Searchbar
          placeholder="Buscar empleado..."
          onChangeText={setSearchQuery}
          value={searchQuery}
          style={styles.searchBar}
          elevation={0}
        />

        {filteredNovedades.length === 0 && !loading ? (
          <View style={styles.emptyState}>
            <Avatar.Icon size={80} icon="check-all" style={{ backgroundColor: primaryColor + '20' }} color={primaryColor} />
            <Text variant="headlineSmall" style={{ marginTop: 16, fontWeight: 'bold' }}>Â¡Todo al dÃ­a!</Text>
            <Text variant="bodyMedium" style={{ color: paperTheme.colors.secondary }}>No hay novedades pendientes.</Text>
          </View>
        ) : (
          <FlatList
            data={filteredNovedades}
            renderItem={renderItem}
            keyExtractor={item => item.id}
            contentContainerStyle={styles.listContent}
            refreshControl={<RefreshControl refreshing={refreshing} onRefresh={() => { setRefreshing(true); fetchNovedades(); }} />}
          />
        )}

        {/* Detail Modal */}
        <Portal>
          <Modal visible={modalVisible} onDismiss={() => setModalVisible(false)} contentContainerStyle={[styles.modal, { backgroundColor: paperTheme.colors.background }]}>
            {selectedNovedad && (
              <View>
                <OverlineText color={primaryColor} style={{ marginBottom: 16, fontSize: 16 }}>
                  Detalle de Novedad
                </OverlineText>
                
                <DetailRow 
                  icon="person"
                  label="Empleado"
                  value={selectedNovedad.userName}
                  iconColor={primaryColor}
                />
                
                <View style={{ height: 12 }} />

                <DetailRow 
                  icon="alert-circle"
                  label="Tipo"
                  value={selectedNovedad.type?.replace('_', ' ').toUpperCase()}
                  iconColor={paperTheme.colors.secondary}
                />

                <View style={{ height: 12 }} />

                <DetailRow 
                  icon="document-text"
                  label="DescripciÃ³n"
                  value={selectedNovedad.description || 'Sin descripciÃ³n'}
                  iconColor={paperTheme.colors.tertiary}
                />

                {selectedNovedad.attachmentUrl && (
                  <Button 
                    mode="outlined" 
                    icon="paperclip" 
                    onPress={() => Linking.openURL(selectedNovedad.attachmentUrl)}
                    style={{ marginTop: 24, borderColor: primaryColor }}
                    textColor={primaryColor}
                  >
                    Ver Adjunto
                  </Button>
                )}

                <View style={styles.modalActions}>
                  <Button 
                    mode="contained" 
                    buttonColor={paperTheme.colors.error} 
                    onPress={() => { handleStatusChange(selectedNovedad.id, 'rejected'); setModalVisible(false); }}
                    style={{ flex: 1, marginRight: 8 }}
                  >
                    Rechazar
                  </Button>
                  <Button 
                    mode="contained" 
                    buttonColor={primaryColor} 
                    onPress={() => { handleStatusChange(selectedNovedad.id, 'approved'); setModalVisible(false); }}
                    style={{ flex: 1, marginLeft: 8 }}
                  >
                    Aprobar
                  </Button>
                </View>
              </View>
            )}
          </Modal>
        </Portal>

      </SafeAreaView>
    </GestureHandlerRootView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  header: {
    padding: 24,
    paddingBottom: 16,
  },
  filterChips: {
    flexDirection: 'row',
    marginTop: 16,
  },
  searchBar: {
    marginHorizontal: 24,
    marginBottom: 16,
    backgroundColor: '#F3F4F6',
    borderRadius: 16,
  },
  listContent: {
    paddingHorizontal: 24,
    paddingBottom: 100,
  },
  cardHeader: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  headerText: {
    flex: 1,
    marginLeft: 12,
  },
  rightActionContainer: {
    width: 100,
    marginBottom: 12,
    justifyContent: 'center',
    alignItems: 'flex-end',
  },
  leftActionContainer: {
    width: 100,
    marginBottom: 12,
    justifyContent: 'center',
    alignItems: 'flex-start',
  },
  actionButton: {
    width: 100,
    height: '100%',
    justifyContent: 'center',
    alignItems: 'center',
    borderRadius: 28, // Match SobrioCard radius
  },
  emptyState: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    marginTop: 40,
  },
  modal: {
    margin: 20,
    padding: 24,
    borderRadius: 28,
  },
  modalActions: {
    flexDirection: 'row',
    marginTop: 24,
  }
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\screens\admin\AdminSettingsScreen.js
========================================
import React, { useState, useEffect } from 'react';
import {
  View,
  StyleSheet,
  ScrollView,
  Alert,
  Platform
} from 'react-native';
import { 
  Text, 
  useTheme as usePaperTheme, 
  IconButton, 
  Button, 
  ActivityIndicator,
  Surface,
  TextInput as PaperInput,
  Chip,
  Portal,
  Modal
} from 'react-native-paper';
import { SobrioCard, DetailRow, OverlineText } from '../../components';
import { SafeAreaView } from 'react-native-safe-area-context';
import { doc, getDoc, setDoc } from 'firebase/firestore';
import { db } from '../../services/firebase';
import { useTheme } from '../../contexts/ThemeContext';
import * as Location from 'expo-location';
import MapView, { Marker } from 'react-native-maps';
import { Ionicons } from '@expo/vector-icons';

export default function AdminSettingsScreen({ navigation }) {
  const theme = usePaperTheme();
  const { getPrimaryColor, getSecondaryColor } = useTheme();

  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  
  // Work Schedule State
  const [workStartTime, setWorkStartTime] = useState('08:00');
  const [workEndTime, setWorkEndTime] = useState('18:00');
  const [gracePeriod, setGracePeriod] = useState('15');
  const [workDays, setWorkDays] = useState([1, 2, 3, 4, 5]); // Mon-Fri default

  // Location State
  const [officeLocation, setOfficeLocation] = useState(null);
  const [locationRadius, setLocationRadius] = useState('100');
  const [mapVisible, setMapVisible] = useState(false);
  const [tempLocation, setTempLocation] = useState(null);
  const [searchAddress, setSearchAddress] = useState('');

  const daysOfWeek = [
    { id: 1, label: 'L', full: 'Lunes' },
    { id: 2, label: 'M', full: 'Martes' },
    { id: 3, label: 'M', full: 'MiÃ©rcoles' },
    { id: 4, label: 'J', full: 'Jueves' },
    { id: 5, label: 'V', full: 'Viernes' },
    { id: 6, label: 'S', full: 'SÃ¡bado' },
    { id: 0, label: 'D', full: 'Domingo' },
  ];

  useEffect(() => {
    loadSettings();
  }, []);

  const loadSettings = async () => {
    try {
      const scheduleDoc = await getDoc(doc(db, 'settings', 'work_schedule'));
      if (scheduleDoc.exists()) {
        const data = scheduleDoc.data();
        setWorkStartTime(data.startTime || '08:00');
        setWorkEndTime(data.endTime || '18:00');
        setGracePeriod(data.gracePeriod?.toString() || '15');
        setWorkDays(data.workDays || [1, 2, 3, 4, 5]);
      }

      const locationDoc = await getDoc(doc(db, 'settings', 'location'));
      if (locationDoc.exists()) {
        const data = locationDoc.data();
        setOfficeLocation({ lat: data.lat, lon: data.lon });
        setLocationRadius(data.radius?.toString() || '100');
      }
    } catch (error) {
      console.error('Error loading settings:', error);
      Alert.alert('Error', 'No se pudo cargar la configuraciÃ³n.');
    } finally {
      setLoading(false);
    }
  };

  const toggleDay = (dayId) => {
    if (workDays.includes(dayId)) {
      setWorkDays(workDays.filter(id => id !== dayId));
    } else {
      setWorkDays([...workDays, dayId]);
    }
  };

  const openMapPicker = async () => {
    try {
      let initialRegion = {
        latitude: 4.6097, // BogotÃ¡ default
        longitude: -74.0817,
        latitudeDelta: 0.01,
        longitudeDelta: 0.01,
      };

      if (officeLocation) {
        initialRegion = {
          latitude: officeLocation.lat,
          longitude: officeLocation.lon,
          latitudeDelta: 0.005,
          longitudeDelta: 0.005,
        };
        setTempLocation({
          latitude: officeLocation.lat,
          longitude: officeLocation.lon
        });
      } else {
        const { status } = await Location.requestForegroundPermissionsAsync();
        if (status === 'granted') {
           const location = await Location.getCurrentPositionAsync({ accuracy: Location.Accuracy.Balanced });
           initialRegion = {
              latitude: location.coords.latitude,
              longitude: location.coords.longitude,
              latitudeDelta: 0.005,
              longitudeDelta: 0.005,
           };
           setTempLocation({
              latitude: location.coords.latitude,
              longitude: location.coords.longitude
           });
        }
      }
      
      setMapVisible(true);
    } catch (error) {
      console.error('Error opening map:', error);
      Alert.alert('Error', 'No se pudo abrir el mapa.');
    }
  };

  const handleSearchAddress = async () => {
    if (!searchAddress.trim()) return;
    
    try {
      const result = await Location.geocodeAsync(searchAddress);
      if (result.length > 0) {
        const { latitude, longitude } = result[0];
        setTempLocation({ latitude, longitude });
      } else {
        Alert.alert('No encontrado', 'No se encontraron coordenadas para esa direcciÃ³n.');
      }
    } catch (error) {
      console.error('Geocoding error:', error);
      Alert.alert('Error', 'FallÃ³ la bÃºsqueda de direcciÃ³n.');
    }
  };

  const confirmMapLocation = () => {
    if (tempLocation) {
      setOfficeLocation({
        lat: tempLocation.latitude,
        lon: tempLocation.longitude
      });
      setMapVisible(false);
    }
  };

  const captureLocation = async () => {
    try {
      setLoading(true);
      const { status } = await Location.requestForegroundPermissionsAsync();
      if (status !== 'granted') {
        Alert.alert('Permiso denegado', 'Se necesita acceso a la ubicaciÃ³n para registrar la oficina.');
        return;
      }

      const location = await Location.getCurrentPositionAsync({
        accuracy: Location.Accuracy.High
      });

      setOfficeLocation({
        lat: location.coords.latitude,
        lon: location.coords.longitude
      });
      
      Alert.alert('ðŸ“ UbicaciÃ³n Capturada', 'Coordenadas actuales registradas. No olvides guardar los cambios.');
    } catch (error) {
      console.error('Error capturing location:', error);
      Alert.alert('Error', 'No se pudo obtener la ubicaciÃ³n.');
    } finally {
      setLoading(false);
    }
  };

  const handleSave = async () => {
    const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
    if (!timeRegex.test(workStartTime) || !timeRegex.test(workEndTime)) {
      Alert.alert('Formato InvÃ¡lido', 'Las horas deben estar en formato HH:MM (ej: 08:00)');
      return;
    }

    const grace = parseInt(gracePeriod);
    if (isNaN(grace) || grace < 0 || grace > 60) {
      Alert.alert('Valor InvÃ¡lido', 'El tiempo de gracia debe ser entre 0 y 60 minutos.');
      return;
    }

    if (workDays.length === 0) {
      Alert.alert('AtenciÃ³n', 'Debes seleccionar al menos un dÃ­a laboral.');
      return;
    }

    try {
      setSaving(true);
      await setDoc(doc(db, 'settings', 'work_schedule'), {
        startTime: workStartTime,
        endTime: workEndTime,
        gracePeriod: grace,
        workDays: workDays,
        updatedAt: new Date()
      });

      if (officeLocation) {
        await setDoc(doc(db, 'settings', 'location'), {
          lat: officeLocation.lat,
          lon: officeLocation.lon,
          radius: parseInt(locationRadius) || 100,
          updatedAt: new Date()
        });
      }

      Alert.alert('âœ… Guardado', 'La configuraciÃ³n se ha actualizado correctamente.');
      navigation.goBack();
    } catch (error) {
      console.error('Error saving settings:', error);
      Alert.alert('Error', 'No se pudo guardar la configuraciÃ³n.');
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: theme.colors.background }}>
        <ActivityIndicator size="large" color={theme.colors.primary} />
      </View>
    );
  }

  return (
    <SafeAreaView style={[styles.container, { backgroundColor: theme.colors.background }]}>
      {/* Header */}
      <View style={styles.header}>
        <IconButton icon="arrow-left" onPress={() => navigation.goBack()} />
        <Text variant="headlineLarge" style={{ color: getPrimaryColor(), flex: 1 }}>ConfiguraciÃ³n</Text>
      </View>

      <ScrollView contentContainerStyle={styles.content}>
        
        {/* Work Schedule Section */}
        <OverlineText color={getPrimaryColor()}>
          JORNADA LABORAL
        </OverlineText>
        
        <SobrioCard style={{ marginBottom: 24 }} borderColor={getPrimaryColor()}>
            <Text variant="titleMedium" style={{ fontWeight: 'bold', marginBottom: 4 }}>DÃ­as Laborales</Text>
            <Text variant="bodySmall" style={{ color: theme.colors.secondary, marginBottom: 16 }}>
              Selecciona los dÃ­as de operaciÃ³n de la empresa.
            </Text>
            
            <View style={styles.daysContainer}>
              {daysOfWeek.map((day) => {
                const isSelected = workDays.includes(day.id);
                return (
                  <Chip
                    key={day.id}
                    selected={isSelected}
                    onPress={() => toggleDay(day.id)}
                    mode={isSelected ? 'flat' : 'outlined'}
                    style={{ marginRight: 8, marginBottom: 8 }}
                  >
                    {day.label}
                  </Chip>
                );
              })}
            </View>

            <View style={styles.row}>
              <View style={{ flex: 1, marginRight: 8 }}>
                <PaperInput
                  label="Hora Entrada"
                  value={workStartTime}
                  onChangeText={setWorkStartTime}
                  placeholder="08:00"
                  maxLength={5}
                  mode="outlined"
                  left={<PaperInput.Icon icon="clock-start" />}
                />
              </View>
              <View style={{ flex: 1, marginLeft: 8 }}>
                <PaperInput
                  label="Hora Salida"
                  value={workEndTime}
                  onChangeText={setWorkEndTime}
                  placeholder="18:00"
                  maxLength={5}
                  mode="outlined"
                  left={<PaperInput.Icon icon="clock-end" />}
                />
              </View>
            </View>

            <PaperInput
              label="Tiempo de Gracia (minutos)"
              value={gracePeriod}
              onChangeText={setGracePeriod}
              placeholder="15"
              keyboardType="numeric"
              maxLength={2}
              mode="outlined"
              left={<PaperInput.Icon icon="timer-sand" />}
              style={{ marginTop: 16 }}
            />
        </SobrioCard>

        {/* Location Section */}
        <OverlineText color={getPrimaryColor()}>
          GEOLOCALIZACIÃ“N
        </OverlineText>

        <SobrioCard style={{ marginBottom: 24 }} borderColor={getPrimaryColor()}>
            <Text variant="titleMedium" style={{ fontWeight: 'bold', marginBottom: 4 }}>UbicaciÃ³n Oficina</Text>
            <Text variant="bodySmall" style={{ color: theme.colors.secondary, marginBottom: 16 }}>
              Control de asistencia por GPS
            </Text>

            <PaperInput
              label="Radio Permitido (metros)"
              value={locationRadius}
              onChangeText={setLocationRadius}
              placeholder="100"
                keyboardType="numeric"
              maxLength={4}
              mode="outlined"
              left={<PaperInput.Icon icon="ruler" />}
              style={{ marginBottom: 16 }}
            />

            {officeLocation ? (
              <View style={{ marginBottom: 16 }}>
                <DetailRow
                  icon="location-outline"
                  label="COORDENADAS GPS"
                  value={`${officeLocation.lat.toFixed(6)}, ${officeLocation.lon.toFixed(6)}`}
                  iconColor={getPrimaryColor()}
                />
              </View>
            ) : (
              <Surface style={{ padding: 16, borderRadius: 12, backgroundColor: theme.colors.errorContainer, marginBottom: 16 }} elevation={0}>
                <Text variant="bodyMedium" style={{ textAlign: 'center', color: theme.colors.onErrorContainer }}>
                  âš ï¸ No hay ubicaciÃ³n registrada
                </Text>
              </Surface>
            )}

            <Button 
              mode="outlined" 
              onPress={captureLocation} 
              style={{ marginBottom: 12 }}
              icon="crosshairs-gps"
            >
              Capturar UbicaciÃ³n Actual
            </Button>

            <Button 
              mode="contained" 
              onPress={openMapPicker} 
              icon="map-marker"
            >
              Buscar en Mapa
            </Button>
        </SobrioCard>

        <Button 
          mode="contained" 
          onPress={handleSave} 
          loading={saving}
          disabled={saving}
          icon="content-save"
          style={{ marginBottom: 32 }}
        >
          Guardar Cambios
        </Button>

      </ScrollView>

      {/* Map Modal */}
      <Portal>
        <Modal
          visible={mapVisible}
          onDismiss={() => setMapVisible(false)}
          contentContainerStyle={{ flex: 1, backgroundColor: theme.colors.background }}
        >
          <SafeAreaView style={{ flex: 1 }}>
            <View style={styles.mapHeader}>
              <IconButton icon="close" onPress={() => setMapVisible(false)} />
              <Text variant="titleLarge" style={{ fontWeight: 'bold', flex: 1 }}>Seleccionar UbicaciÃ³n</Text>
            </View>
            
            <View style={styles.searchContainer}>
              <PaperInput
                placeholder="Buscar direcciÃ³n..."
                value={searchAddress}
                onChangeText={setSearchAddress}
                onSubmitEditing={handleSearchAddress}
                mode="outlined"
                style={{ flex: 1, marginRight: 8 }}
                left={<PaperInput.Icon icon="magnify" />}
              />
              <IconButton 
                icon="arrow-right" 
                mode="contained" 
                containerColor={theme.colors.primary} 
                iconColor="white" 
                onPress={handleSearchAddress} 
              />
            </View>

            {tempLocation && (
              <MapView
                style={{ flex: 1 }}
                region={{
                  latitude: tempLocation.latitude,
                  longitude: tempLocation.longitude,
                  latitudeDelta: 0.005,
                  longitudeDelta: 0.005,
                }}
                onPress={(e) => setTempLocation(e.nativeEvent.coordinate)}
              >
                <Marker
                  coordinate={tempLocation}
                  draggable
                  onDragEnd={(e) => setTempLocation(e.nativeEvent.coordinate)}
                />
              </MapView>
            )}

            <View style={{ padding: 20, backgroundColor: theme.colors.surface }}>
              <Button 
                mode="contained" 
                onPress={confirmMapLocation}
                icon="check"
              >
                Confirmar UbicaciÃ³n
              </Button>
            </View>
          </SafeAreaView>
        </Modal>
      </Portal>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 4,
    paddingVertical: 8,
  },
  content: {
    padding: 20,
    paddingBottom: 40,
  },
  daysContainer: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    marginBottom: 16,
  },
  row: {
    flexDirection: 'row',
    marginTop: 16,
  },
  locationInfo: {
    padding: 16,
    borderRadius: 12,
    marginBottom: 16,
    alignItems: 'center',
  },
  mapHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 4,
    paddingVertical: 8,
  },
  searchContainer: {
    flexDirection: 'row',
    padding: 16,
    alignItems: 'center',
  },
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\screens\asistencias\AsistenciaDetailScreen.js
========================================
import React from 'react';
import { View, Text, StyleSheet, ScrollView, TouchableOpacity } from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { LinearGradient } from 'expo-linear-gradient';
import { useTheme } from '../../contexts/ThemeContext';
import { SobrioCard, DetailRow, OverlineText } from '../../components';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';

/**
 * AsistenciaDetailScreen - Detalle completo de una jornada laboral
 * 
 * Material 3 Expressive Design aplicado
 */
export default function AsistenciaDetailScreen({ route, navigation }) {
  const { asistencia } = route.params;
  const { getGradient, getPrimaryColor, getSecondaryColor } = useTheme();

  const formatearHora = (timestamp) => {
    if (!timestamp) return '--:--';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return format(date, "HH:mm:ss", { locale: es });
  };

  const formatearFechaCompleta = (timestamp) => {
    if (!timestamp) return '--';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return format(date, "EEEE, d 'de' MMMM 'de' yyyy 'a las' HH:mm", { locale: es });
  };

  const getEstadoColor = () => {
    switch (asistencia.estadoActual) {
      case 'trabajando': return '#4caf50';
      case 'break': return '#ff9800';
      case 'almuerzo': return '#2196f3';
      case 'finalizado': return '#9e9e9e';
      default: return '#9e9e9e';
    }
  };

  const getEstadoLabel = () => {
    switch (asistencia.estadoActual) {
      case 'trabajando': return 'Trabajando';
      case 'break': return 'En Break';
      case 'almuerzo': return 'Almorzando';
      case 'finalizado': return 'Finalizado';
      default: return 'Desconocido';
    }
  };

  const getEstadoIcon = () => {
    switch (asistencia.estadoActual) {
      case 'trabajando': return 'ðŸ’¼';
      case 'break': return 'â˜•';
      case 'almuerzo': return 'ðŸ½ï¸';
      case 'finalizado': return 'âœ…';
      default: return 'â“';
    }
  };

  return (
    <View style={styles.container}>
      {/* Header con gradiente */}
      <LinearGradient
        colors={getGradient()}
        start={{ x: 0, y: 0 }}
        end={{ x: 1, y: 1 }}
        style={styles.header}
      >
        <TouchableOpacity style={styles.backButton} onPress={() => navigation.goBack()}>
          <Ionicons name="arrow-back" size={24} color="#fff" />
        </TouchableOpacity>
        
        <View style={styles.headerContent}>
          <OverlineText style={styles.headerOverline}>DETALLE DE ASISTENCIA</OverlineText>
          <Text style={styles.headerTitle}>{asistencia.userName || 'Usuario'}</Text>
          <Text style={styles.headerSubtitle}>{asistencia.fecha}</Text>
        </View>

        {/* Estado badge */}
        <View style={[styles.estadoBadge, { backgroundColor: getEstadoColor() + '26' }]}>
          <Text style={styles.estadoEmoji}>{getEstadoIcon()}</Text>
          <Text style={[styles.estadoText, { color: getEstadoColor() }]}>
            {getEstadoLabel()}
          </Text>
        </View>
      </LinearGradient>

      <ScrollView style={styles.content} showsVerticalScrollIndicator={false}>
        {/* Entrada */}
        <View style={styles.section}>
          <OverlineText style={styles.sectionTitle}>ENTRADA</OverlineText>
          <SobrioCard>
            <DetailRow
              icon="log-in"
              label="Hora de Entrada"
              value={formatearHora(asistencia.entrada?.hora)}
              iconColor={getPrimaryColor()}
              highlight
            />
            {asistencia.entrada?.ubicacion && (
              <DetailRow
                icon="location"
                label="UbicaciÃ³n"
                value={`${asistencia.entrada.ubicacion.lat.toFixed(6)}, ${asistencia.entrada.ubicacion.lon.toFixed(6)}`}
                iconColor="#4caf50"
              />
            )}
            {asistencia.entrada?.dispositivo && (
              <DetailRow
                icon="phone-portrait"
                label="Dispositivo"
                value={asistencia.entrada.dispositivo}
                iconColor="#2196f3"
              />
            )}
          </SobrioCard>
        </View>

        {/* Breaks */}
        {asistencia.breaks && asistencia.breaks.length > 0 && (
          <View style={styles.section}>
            <OverlineText style={styles.sectionTitle}>
              BREAKS ({asistencia.breaks.length})
            </OverlineText>
            {asistencia.breaks.map((breakItem, index) => (
              <SobrioCard key={index} style={styles.breakCard}>
                <View style={styles.breakHeader}>
                  <Text style={styles.breakTitle}>â˜• Break #{index + 1}</Text>
                  {breakItem.duracion && (
                    <Text style={styles.breakDuration}>{breakItem.duracion}</Text>
                  )}
                </View>
                <DetailRow
                  icon="play"
                  label="Inicio"
                  value={formatearHora(breakItem.inicio)}
                  iconColor="#ff9800"
                />
                {breakItem.fin && (
                  <DetailRow
                    icon="square"
                    label="Fin"
                    value={formatearHora(breakItem.fin)}
                    iconColor="#ff9800"
                  />
                )}
                {!breakItem.fin && (
                  <Text style={styles.breakActive}>ðŸ”´ Break activo</Text>
                )}
              </SobrioCard>
            ))}
          </View>
        )}

        {/* Almuerzo */}
        {asistencia.almuerzo && asistencia.almuerzo.inicio && (
          <View style={styles.section}>
            <OverlineText style={styles.sectionTitle}>ALMUERZO</OverlineText>
            <SobrioCard>
              <DetailRow
                icon="play"
                label="Inicio"
                value={formatearHora(asistencia.almuerzo.inicio)}
                iconColor="#2196f3"
              />
              {asistencia.almuerzo.fin && (
                <>
                  <DetailRow
                    icon="square"
                    label="Fin"
                    value={formatearHora(asistencia.almuerzo.fin)}
                    iconColor="#2196f3"
                  />
                  {asistencia.almuerzo.duracion && (
                    <DetailRow
                      icon="timer"
                      label="DuraciÃ³n"
                      value={asistencia.almuerzo.duracion}
                      iconColor="#4caf50"
                      highlight
                    />
                  )}
                </>
              )}
              {!asistencia.almuerzo.fin && (
                <Text style={styles.almuerzoPending}>â³ Almuerzo en curso</Text>
              )}
            </SobrioCard>
          </View>
        )}

        {/* Salida */}
        {asistencia.salida && (
          <View style={styles.section}>
            <OverlineText style={styles.sectionTitle}>SALIDA</OverlineText>
            <SobrioCard>
              <DetailRow
                icon="log-out"
                label="Hora de Salida"
                value={formatearHora(asistencia.salida.hora)}
                iconColor={getSecondaryColor()}
                highlight
              />
            </SobrioCard>
          </View>
        )}

        {/* Resumen */}
        <View style={styles.section}>
          <OverlineText style={styles.sectionTitle}>RESUMEN DE JORNADA</OverlineText>
          <SobrioCard>
            <DetailRow
              icon="access-time"
              label="Horas Trabajadas"
              value={asistencia.horasTrabajadas || '00:00:00'}
              iconColor="#4caf50"
              highlight
            />
            <DetailRow
              icon="event"
              label="Fecha Completa"
              value={formatearFechaCompleta(asistencia.entrada?.hora)}
              iconColor="#9e9e9e"
            />
          </SobrioCard>
        </View>

        <View style={styles.bottomSpacer} />
      </ScrollView>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: 'transparent'
  },
  header: {
    paddingTop: 48,
    paddingBottom: 28,
    paddingHorizontal: 24,
    borderBottomLeftRadius: 32,
    borderBottomRightRadius: 32,
    shadowColor: '#000',
    shadowOffset: {
      width: 0,
      height: 4,
    },
    shadowOpacity: 0.12,
    shadowRadius: 16,
    elevation: 5,
  },
  backButton: {
    width: 40,
    height: 40,
    borderRadius: 20,
    backgroundColor: 'rgba(255,255,255,0.2)',
    justifyContent: 'center',
    alignItems: 'center',
    marginBottom: 16
  },
  headerContent: {
    marginBottom: 16
  },
  headerOverline: {
    color: 'rgba(255,255,255,0.8)',
    marginBottom: 6
  },
  headerTitle: {
    fontSize: 30,
    fontWeight: '700',
    color: '#fff',
    marginBottom: 4,
    letterSpacing: 0.3,
  },
  headerSubtitle: {
    fontSize: 15,
    color: 'rgba(255,255,255,0.9)',
    lineHeight: 22,
  },
  estadoBadge: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
    paddingHorizontal: 16,
    paddingVertical: 10,
    borderRadius: 20,
  },
  estadoEmoji: {
    fontSize: 18
  },
  estadoText: {
    fontSize: 13,
    fontWeight: '700',
    letterSpacing: 0.5,
    textTransform: 'uppercase'
  },
  content: {
    flex: 1
  },
  section: {
    paddingHorizontal: 16,
    paddingTop: 20
  },
  sectionTitle: {
    marginBottom: 12,
    color: '#64748b'
  },
  breakCard: {
    marginBottom: 12
  },
  breakHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 12,
    paddingBottom: 12,
    borderBottomWidth: 1,
    borderBottomColor: 'rgba(0,0,0,0.06)'
  },
  breakTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: '#333'
  },
  breakDuration: {
    fontSize: 15,
    fontWeight: '700',
    color: '#4caf50'
  },
  breakActive: {
    marginTop: 12,
    paddingTop: 12,
    borderTopWidth: 1,
    borderTopColor: 'rgba(0,0,0,0.06)',
    fontSize: 13,
    fontWeight: '600',
    color: '#ff9800',
    textAlign: 'center'
  },
  almuerzoPending: {
    marginTop: 12,
    paddingTop: 12,
    borderTopWidth: 1,
    borderTopColor: 'rgba(0,0,0,0.06)',
    fontSize: 13,
    fontWeight: '600',
    color: '#2196f3',
    textAlign: 'center'
  },
  bottomSpacer: {
    height: 40
  }
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\screens\asistencias\AsistenciasScreen.js
========================================
import React, { useState, useEffect, useRef } from 'react';
import {
  View,
  StyleSheet,
  FlatList,
  RefreshControl,
  Modal,
  Pressable,
  Platform,
  Dimensions,
  Animated,
  ScrollView,
  Linking
} from 'react-native';
import { 
  Text, 
  useTheme, 
  ActivityIndicator, 
  IconButton,
  Surface,
  Chip,
  Avatar,
  Divider
} from 'react-native-paper';
import { SafeAreaView } from 'react-native-safe-area-context';
import { collection, query, where, getDocs, orderBy } from 'firebase/firestore';
import { db } from '../../services/firebase';
import { useAuth } from '../../contexts/AuthContext';
import { format, startOfMonth, parseISO } from 'date-fns';
import { es } from 'date-fns/locale';
import { SobrioCard, DetailRow, OverlineText } from '../../components';
import { MaterialCommunityIcons } from '@expo/vector-icons';
import * as Haptics from 'expo-haptics';
import materialTheme from '../../../material-theme.json';

const { width, height } = Dimensions.get('window');

export default function AsistenciasScreen({ navigation }) {
  const { userProfile, user } = useAuth();
  const theme = useTheme();
  
  // ðŸŽ¨ Material You Expressive: Surface colors para profundidad (no sombras)
  const surfaceColors = theme.dark 
    ? materialTheme.schemes.dark 
    : materialTheme.schemes.light;
    
  const dynamicStyles = {
    container: { backgroundColor: surfaceColors.background },
    surfaceContainerLow: { backgroundColor: surfaceColors.surfaceContainerLow },
    surfaceContainer: { backgroundColor: surfaceColors.surfaceContainer },
    text: { color: surfaceColors.onSurface },
    textSecondary: { color: surfaceColors.onSurfaceVariant },
    primary: { color: surfaceColors.primary },
    modalOverlay: { backgroundColor: theme.dark ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.5)' },
    modalSurface: { backgroundColor: surfaceColors.surface }
  };
  
  const [asistencias, setAsistencias] = useState([]);
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [usersMap, setUsersMap] = useState({});
  
  // Modal State
  const [selectedAsistencia, setSelectedAsistencia] = useState(null);
  const [modalVisible, setModalVisible] = useState(false);

  // Animations
  const slideAnim = useRef(new Animated.Value(height * 0.3)).current;
  const fadeAnim = useRef(new Animated.Value(0)).current;

  useEffect(() => {
    Animated.parallel([
      Animated.timing(slideAnim, {
        toValue: 0,
        duration: 800,
        useNativeDriver: true,
      }),
      Animated.timing(fadeAnim, {
        toValue: 1,
        duration: 800,
        useNativeDriver: true,
      }),
    ]).start();
  }, []);

  useEffect(() => {
    cargarUsuarios();
  }, []);

  useEffect(() => {
    if (userProfile) {
      cargarAsistencias();
    }
  }, [userProfile]);

  const cargarUsuarios = async () => {
    try {
      const usersSnapshot = await getDocs(collection(db, 'users'));
      const userMap = {};
      usersSnapshot.forEach(doc => {
        const userData = doc.data();
        userMap[doc.id] = {
          uid: doc.id,
          name: userData.name || userData.displayName || userData.email,
          photoURL: userData.photoURL
        };
      });
      setUsersMap(userMap);
    } catch (error) {
      console.error('Error cargando usuarios:', error);
    }
  };

  const cargarAsistencias = async () => {
    try {
      setLoading(true);
      
      let q;
      
      if (userProfile?.role !== 'ADMIN' && userProfile?.role !== 'SUPER_ADMIN') {
        const targetUid = userProfile?.uid || user?.uid;
        if (!targetUid) {
          setLoading(false);
          return;
        }
        q = query(
          collection(db, 'asistencias'),
          where('uid', '==', targetUid)
        );
      } else {
        q = query(
          collection(db, 'asistencias'),
          orderBy('fecha', 'desc')
        );
      }

      const querySnapshot = await getDocs(q);
      
      let asistenciasData = querySnapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      
      // âœ… Ordenar SIEMPRE por createdAt (fuente de verdad mÃ¡s precisa)
      asistenciasData = asistenciasData.sort((a, b) => {
        // 1. Obtener timestamp de creaciÃ³n o entrada
        const timeA = a.createdAt?.toMillis?.() || a.entrada?.hora?.toMillis?.() || 0;
        const timeB = b.createdAt?.toMillis?.() || b.entrada?.hora?.toMillis?.() || 0;
        
        // 2. Ordenar descendente (mÃ¡s reciente primero)
        return timeB - timeA;
      });
      
      setAsistencias(asistenciasData);
    } catch (error) {
      console.error('Error cargando asistencias:', error);
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  };

  const onRefresh = () => {
    setRefreshing(true);
    cargarAsistencias();
  };

  const handleItemPress = (item) => {
    setSelectedAsistencia(item);
    setModalVisible(true);
  };

  const formatTime = (timestamp) => {
    if (!timestamp) return '--:--';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return format(date, 'h:mm a');
  };

  const AsistenciaItem = ({ item, index }) => {
    const user = usersMap[item.uid] || {};
    const isCompleted = !!item.salida;
    const isWorking = item.estadoActual === 'trabajando' || item.estadoActual === 'break' || item.estadoActual === 'almuerzo';
    
    let statusColor = surfaceColors.error;
    let statusLabel = 'INCOMPLETO';
    let statusIcon = 'alert-circle';

    if (isCompleted) {
      statusColor = surfaceColors.primary;
      statusLabel = 'COMPLETADO';
      statusIcon = 'check-circle';
    } else if (isWorking) {
      statusColor = surfaceColors.tertiary;
      statusLabel = 'EN CURSO';
      statusIcon = 'clock';
    }

    const handlePress = () => {
      Haptics.selectionAsync(); // âœ… Feedback tÃ¡ctil
      handleItemPress(item);
    };

    return (
      <Pressable
        onPress={handlePress}
        android_ripple={{ 
          color: surfaceColors.primary + '1F'  // âœ… Ripple tintado (12% opacidad)
        }}
        style={({ pressed }) => [
          styles.expressiveCard,
          {
            backgroundColor: pressed 
              ? surfaceColors.surfaceContainer  // âœ… Pressed state con surface color
              : surfaceColors.surfaceContainerLow,
            marginBottom: 20,  // âœ… Espaciado generoso (12â†’20)
          }
        ]}
      >
        <View style={styles.cardHeader}>
          <View style={styles.userInfo}>
            {user.photoURL ? (
              <Avatar.Image size={40} source={{ uri: user.photoURL }} style={{ marginRight: 12 }} />
            ) : (
              <Avatar.Text 
                size={40} 
                label={(user.name || 'U').charAt(0)} 
                style={{ 
                  marginRight: 12, 
                  backgroundColor: surfaceColors.primaryContainer 
                }} 
              />
            )}
            <View>
              <Text 
                variant="titleMedium" 
                style={{ 
                  fontWeight: '600',
                  color: surfaceColors.onSurface,
                  letterSpacing: -0.25  // âœ… Tight letter spacing
                }}
              >
                {format(parseISO(item.fecha + 'T12:00:00'), "EEEE d 'de' MMMM", { locale: es })}
              </Text>
              <Text variant="bodySmall" style={{ color: surfaceColors.secondary }}>
                {user.name || 'Usuario'}
              </Text>
            </View>
          </View>
          <View 
            style={[
              styles.statusChip,
              { backgroundColor: statusColor + '20' }
            ]}
          >
            <MaterialCommunityIcons name={statusIcon} size={14} color={statusColor} />
            <Text style={{ color: statusColor, fontSize: 10, fontWeight: '700', marginLeft: 4 }}>
              {statusLabel}
            </Text>
          </View>
        </View>

        <View style={styles.statsRow}>
          <View style={styles.statItem}>
            <Text variant="labelSmall" style={{ color: surfaceColors.onSurfaceVariant, textTransform: 'uppercase', letterSpacing: 0.8 }}>
              Entrada
            </Text>
            <Text variant="titleMedium" style={{ fontWeight: '600', color: surfaceColors.onSurface, marginTop: 4 }}>
              {formatTime(item.entrada?.hora)}
            </Text>
          </View>
          <View style={styles.statItem}>
            <Text variant="labelSmall" style={{ color: surfaceColors.onSurfaceVariant, textTransform: 'uppercase', letterSpacing: 0.8 }}>
              Salida
            </Text>
            <Text variant="titleMedium" style={{ fontWeight: '600', color: surfaceColors.onSurface, marginTop: 4 }}>
              {formatTime(item.salida?.hora)}
            </Text>
          </View>
          <View style={styles.statItem}>
            <Text variant="labelSmall" style={{ color: surfaceColors.onSurfaceVariant, textTransform: 'uppercase', letterSpacing: 0.8 }}>
              Total
            </Text>
            <Text variant="titleMedium" style={{ fontWeight: '700', color: surfaceColors.primary, marginTop: 4 }}>
              {item.horasTrabajadas || '--:--'}
            </Text>
          </View>
        </View>
      </Pressable>
    );
  };

  return (
    <SafeAreaView style={[styles.container, dynamicStyles.container]} edges={['top', 'left', 'right']}>
      <View style={styles.header}>
        <Text 
          variant="headlineMedium" 
          style={{ 
            fontWeight: '500', 
            color: surfaceColors.onSurface,
            letterSpacing: -0.25,  // âœ… Tight spacing
            // âœ… Width Axis 110% se aplicarÃ¡ con Roboto Flex
          }}
        >
          Historial
        </Text>
        <Text variant="titleMedium" style={{ color: surfaceColors.onSurfaceVariant, marginTop: 4 }}>
          Registro de Asistencias
        </Text>
      </View>

      <Animated.View style={[
        styles.sheetContainer,
        {
          backgroundColor: theme.colors.background,
          opacity: fadeAnim,
          transform: [{ translateY: slideAnim }]
        }
      ]}>
        <FlatList
          data={asistencias}
          renderItem={({ item, index }) => <AsistenciaItem item={item} index={index} />}
          keyExtractor={item => item.id}
          contentContainerStyle={styles.listContent}
          showsVerticalScrollIndicator={false}
          refreshControl={
            <RefreshControl
              refreshing={refreshing}
              onRefresh={onRefresh}
              colors={[theme.colors.primary]}
              tintColor={theme.colors.primary}
            />
          }
          ListEmptyComponent={
            !loading && (
              <View style={styles.emptyState}>
                <MaterialCommunityIcons name="clock-outline" size={64} color={surfaceColors.outline} />
                <Text variant="titleMedium" style={{ color: surfaceColors.onSurfaceVariant, marginTop: 20, textAlign: 'center' }}>
                  No hay registros disponibles
                </Text>
              </View>
            )
          }
        />
      </Animated.View>

      {/* Detail Modal */}
      <Modal
        animationType="slide"
        transparent={true}
        visible={modalVisible}
        onRequestClose={() => setModalVisible(false)}
      >
        <View style={[styles.modalOverlay, dynamicStyles.modalOverlay]}>
          <Surface style={[styles.modalContent, dynamicStyles.modalSurface]} elevation={0}>
            <View style={[styles.modalHeader, { borderBottomColor: theme.colors.surfaceVariant }]}>
              <Text variant="titleLarge" style={{ fontWeight: 'bold', letterSpacing: -0.25 }}>Detalle de Asistencia</Text>
              <IconButton icon="close" onPress={() => setModalVisible(false)} />
            </View>
            
            {selectedAsistencia && (
              <ScrollView contentContainerStyle={styles.modalBody}>
                {/* Usuario Card */}
                <View 
                  style={[
                    styles.expressiveDetailCard, 
                    { 
                      backgroundColor: surfaceColors.surfaceContainerLow,
                      borderRadius: 20,
                      padding: 16,
                      borderWidth: 1,
                      borderColor: surfaceColors.primary + '20',
                      marginBottom: 12
                    }
                  ]}
                >
                  <View style={{ flexDirection: 'row', alignItems: 'center' }}>
                    {usersMap[selectedAsistencia.uid]?.photoURL ? (
                      <Avatar.Image 
                        size={48} 
                        source={{ uri: usersMap[selectedAsistencia.uid].photoURL }} 
                        style={{ marginRight: 16 }} 
                      />
                    ) : (
                      <Avatar.Text 
                        size={48} 
                        label={(usersMap[selectedAsistencia.uid]?.name || 'U').charAt(0)} 
                        style={{ 
                          marginRight: 16, 
                          backgroundColor: surfaceColors.primaryContainer 
                        }} 
                      />
                    )}
                    <View style={{ flex: 1 }}>
                      <Text variant="labelSmall" style={{ color: surfaceColors.onSurfaceVariant, textTransform: 'uppercase', letterSpacing: 0.8, fontWeight: '600', marginBottom: 4 }}>
                        USUARIO
                      </Text>
                      <Text variant="titleLarge" style={{ color: surfaceColors.onSurface, fontWeight: '600', letterSpacing: -0.25 }}>
                        {usersMap[selectedAsistencia.uid]?.name || 'Usuario'}
                      </Text>
                    </View>
                  </View>
                </View>

                {/* Fecha Card */}
                <View 
                  style={[
                    styles.expressiveDetailCard, 
                    { 
                      backgroundColor: surfaceColors.surfaceContainerLow,
                      borderRadius: 20,
                      padding: 16,
                      borderWidth: 1,
                      borderColor: surfaceColors.primary + '20'
                    }
                  ]}
                >
                  <View style={{ flexDirection: 'row', alignItems: 'center' }}>
                    <View style={{ 
                      width: 48, 
                      height: 48, 
                      borderRadius: 24, 
                      backgroundColor: surfaceColors.primaryContainer, 
                      alignItems: 'center', 
                      justifyContent: 'center',
                      marginRight: 16
                    }}>
                      <MaterialCommunityIcons name="calendar" size={24} color={surfaceColors.primary} />
                    </View>
                    <View style={{ flex: 1 }}>
                      <Text variant="labelSmall" style={{ color: surfaceColors.onSurfaceVariant, textTransform: 'uppercase', letterSpacing: 0.8, fontWeight: '600', marginBottom: 4 }}>
                        FECHA
                      </Text>
                      <Text variant="titleMedium" style={{ color: surfaceColors.onSurface, fontWeight: '600', letterSpacing: -0.25 }}>
                        {format(parseISO(selectedAsistencia.fecha + 'T12:00:00'), "EEEE d 'de' MMMM, yyyy", { locale: es })}
                      </Text>
                    </View>
                  </View>
                </View>

                {/* UbicaciÃ³n y Modalidad - SOLO ADMIN */}
                {(userProfile?.role === 'ADMIN' || userProfile?.role === 'SUPER_ADMIN') && selectedAsistencia.entrada?.ubicacion && (
                  <View style={{ marginTop: 20 }}>
                    <Text variant="labelMedium" style={{ color: surfaceColors.onSurfaceVariant, letterSpacing: 0.8, textTransform: 'uppercase', fontWeight: '600', marginBottom: 16 }}>
                      INFORMACIÃ“N DE CONEXIÃ“N
                    </Text>
                    
                    {/* Modalidad */}
                    <View 
                      style={[
                        styles.expressiveDetailCard, 
                        { 
                          backgroundColor: surfaceColors.surfaceContainerLow,
                          borderRadius: 20,
                          padding: 16,
                          borderWidth: 1,
                          borderColor: (selectedAsistencia.entrada.ubicacion.tipo === 'Oficina' ? surfaceColors.primary : surfaceColors.tertiary) + '30',
                          marginBottom: 12
                        }
                      ]}
                    >
                      <View style={{ flexDirection: 'row', alignItems: 'center' }}>
                        <View style={{ 
                          width: 48, 
                          height: 48, 
                          borderRadius: 24, 
                          backgroundColor: selectedAsistencia.entrada.ubicacion.tipo === 'Oficina' ? surfaceColors.primaryContainer : surfaceColors.tertiaryContainer, 
                          alignItems: 'center', 
                          justifyContent: 'center',
                          marginRight: 16
                        }}>
                          <MaterialCommunityIcons 
                            name="wifi" 
                            size={24} 
                            color={selectedAsistencia.entrada.ubicacion.tipo === 'Oficina' ? surfaceColors.primary : surfaceColors.tertiary} 
                          />
                        </View>
                        <View style={{ flex: 1 }}>
                          <Text variant="labelSmall" style={{ color: surfaceColors.onSurfaceVariant, textTransform: 'uppercase', letterSpacing: 0.8, fontWeight: '600', marginBottom: 4 }}>
                            MODALIDAD
                          </Text>
                          <Text variant="titleMedium" style={{ color: surfaceColors.onSurface, fontWeight: '600', letterSpacing: -0.25 }}>
                            {selectedAsistencia.entrada.ubicacion.tipo || 'Remoto'}
                          </Text>
                        </View>
                      </View>
                    </View>

                    {/* UbicaciÃ³n GPS */}
                    {selectedAsistencia.entrada.ubicacion.lat && selectedAsistencia.entrada.ubicacion.lon && (
                      <Pressable
                        onPress={() => {
                          Haptics.selectionAsync();
                          const lat = selectedAsistencia.entrada.ubicacion.lat;
                          const lon = selectedAsistencia.entrada.ubicacion.lon;
                          const url = `https://www.google.com/maps?q=${lat},${lon}`;
                          Linking.openURL(url);
                        }}
                        android_ripple={{ color: surfaceColors.primary + '1F' }}
                        style={[
                          styles.expressiveDetailCard, 
                          { 
                            backgroundColor: surfaceColors.surfaceContainerLow,
                            borderRadius: 20,
                            padding: 16,
                            borderWidth: 1,
                            borderColor: surfaceColors.tertiary + '30',
                            marginBottom: 12
                          }
                        ]}
                      >
                        <View style={{ flexDirection: 'row', alignItems: 'center' }}>
                          <View style={{ 
                            width: 48, 
                            height: 48, 
                            borderRadius: 24, 
                            backgroundColor: surfaceColors.tertiaryContainer, 
                            alignItems: 'center', 
                            justifyContent: 'center',
                            marginRight: 16
                          }}>
                            <MaterialCommunityIcons name="map-marker" size={24} color={surfaceColors.tertiary} />
                          </View>
                          <View style={{ flex: 1 }}>
                            <Text variant="labelSmall" style={{ color: surfaceColors.onSurfaceVariant, textTransform: 'uppercase', letterSpacing: 0.8, fontWeight: '600', marginBottom: 4 }}>
                              VER UBICACIÃ“N
                            </Text>
                            <Text variant="bodyMedium" style={{ color: surfaceColors.onSurface, fontWeight: '500' }} numberOfLines={1}>
                              {`${selectedAsistencia.entrada.ubicacion.lat.toFixed(6)}, ${selectedAsistencia.entrada.ubicacion.lon.toFixed(6)}`}
                            </Text>
                          </View>
                          <MaterialCommunityIcons name="chevron-right" size={24} color={surfaceColors.onSurfaceVariant} />
                        </View>
                      </Pressable>
                    )}

                    {/* Dispositivo */}
                    {selectedAsistencia.entrada.dispositivo && (
                      <View 
                        style={[
                          styles.expressiveDetailCard, 
                          { 
                            backgroundColor: surfaceColors.surfaceContainerLow,
                            borderRadius: 20,
                            padding: 16,
                            borderWidth: 1,
                            borderColor: surfaceColors.secondary + '30'
                          }
                        ]}
                      >
                        <View style={{ flexDirection: 'row', alignItems: 'center' }}>
                          <View style={{ 
                            width: 48, 
                            height: 48, 
                            borderRadius: 24, 
                            backgroundColor: surfaceColors.secondaryContainer, 
                            alignItems: 'center', 
                            justifyContent: 'center',
                            marginRight: 16
                          }}>
                            <MaterialCommunityIcons name="cellphone" size={24} color={surfaceColors.secondary} />
                          </View>
                          <View style={{ flex: 1 }}>
                            <Text variant="labelSmall" style={{ color: surfaceColors.onSurfaceVariant, textTransform: 'uppercase', letterSpacing: 0.8, fontWeight: '600', marginBottom: 4 }}>
                              DISPOSITIVO
                            </Text>
                            <Text variant="titleMedium" style={{ color: surfaceColors.onSurface, fontWeight: '600', letterSpacing: -0.25 }}>
                              {selectedAsistencia.entrada.dispositivo}
                            </Text>
                          </View>
                        </View>
                      </View>
                    )}
                  </View>
                )}

                <View style={styles.rowContainer}>
                  {/* Entry */}
                  <View style={[styles.timeCard, { backgroundColor: surfaceColors.surfaceContainerLow, marginRight: 8, borderWidth: 1, borderColor: surfaceColors.secondary + '30' }]}>
                    <View style={styles.timeCardHeader}>
                      <MaterialCommunityIcons name="login" size={24} color={surfaceColors.secondary} />
                      <Text variant="labelMedium" style={{ color: surfaceColors.onSurfaceVariant, marginLeft: 8, fontWeight: '600', letterSpacing: 0.8, textTransform: 'uppercase' }}>ENTRADA</Text>
                    </View>
                    <Text variant="headlineSmall" style={{ fontWeight: '600', marginTop: 8, color: surfaceColors.onSurface, letterSpacing: -0.25 }}>
                      {selectedAsistencia.entrada?.hora ? format(selectedAsistencia.entrada.hora.toDate(), 'h:mm a') : '--:--'}
                    </Text>
                  </View>

                  {/* Exit */}
                  <View style={[styles.timeCard, { backgroundColor: surfaceColors.surfaceContainerLow, marginLeft: 8, borderWidth: 1, borderColor: surfaceColors.tertiary + '30' }]}>
                    <View style={styles.timeCardHeader}>
                      <MaterialCommunityIcons name="logout" size={24} color={surfaceColors.tertiary} />
                      <Text variant="labelMedium" style={{ color: surfaceColors.onSurfaceVariant, marginLeft: 8, fontWeight: '600', letterSpacing: 0.8, textTransform: 'uppercase' }}>SALIDA</Text>
                    </View>
                    <Text variant="headlineSmall" style={{ fontWeight: '600', marginTop: 8, color: surfaceColors.onSurface, letterSpacing: -0.25 }}>
                      {selectedAsistencia.salida?.hora ? format(selectedAsistencia.salida.hora.toDate(), 'h:mm a') : '--:--'}
                    </Text>
                  </View>
                </View>

                {/* Breaks */}
                {selectedAsistencia.breaks && selectedAsistencia.breaks.length > 0 && (
                  <View style={{ marginTop: 20 }}>
                    <Text variant="labelMedium" style={{ color: surfaceColors.onSurfaceVariant, letterSpacing: 0.8, textTransform: 'uppercase', fontWeight: '600', marginBottom: 16 }}>Breaks</Text>
                    {selectedAsistencia.breaks.map((b, i) => (
                      <View 
                        key={i} 
                        style={[
                          styles.expressiveDetailCard, 
                          { 
                            backgroundColor: surfaceColors.surfaceContainerLow,
                            padding: 16,
                            marginBottom: 12,
                            borderRadius: 20,
                            borderWidth: 1,
                            borderColor: surfaceColors.tertiary + '20'
                          }
                        ]}
                      >
                        <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>
                          <View style={{ flexDirection: 'row', alignItems: 'center' }}>
                            <MaterialCommunityIcons name="coffee" size={20} color={surfaceColors.tertiary} />
                            <Text variant="labelMedium" style={{ color: surfaceColors.onSurfaceVariant, marginLeft: 8, fontWeight: '600' }}>Break {i + 1}</Text>
                          </View>
                          <Text variant="bodyMedium" style={{ color: surfaceColors.onSurface, fontWeight: '600' }}>
                            {`${b.inicio ? format(b.inicio.toDate(), 'h:mm a') : '--'} - ${b.fin ? format(b.fin.toDate(), 'h:mm a') : 'En curso'}`}
                          </Text>
                        </View>
                      </View>
                    ))}
                  </View>
                )}

                {/* Lunch */}
                {selectedAsistencia.almuerzo && (
                  <View style={{ marginTop: 20 }}>
                    <Text variant="labelMedium" style={{ color: surfaceColors.onSurfaceVariant, letterSpacing: 0.8, textTransform: 'uppercase', fontWeight: '600', marginBottom: 16 }}>Almuerzo</Text>
                    <View 
                      style={[
                        styles.expressiveDetailCard, 
                        { 
                          backgroundColor: surfaceColors.surfaceContainerLow,
                          padding: 16,
                          borderRadius: 20,
                          borderWidth: 1,
                          borderColor: surfaceColors.tertiary + '20'
                        }
                      ]}
                    >
                      <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>
                        <View style={{ flexDirection: 'row', alignItems: 'center' }}>
                          <MaterialCommunityIcons name="food" size={20} color={surfaceColors.tertiary} />
                          <Text variant="labelMedium" style={{ color: surfaceColors.onSurfaceVariant, marginLeft: 8, fontWeight: '600' }}>Hora de Almuerzo</Text>
                        </View>
                        <Text variant="bodyMedium" style={{ color: surfaceColors.onSurface, fontWeight: '600' }}>
                          {`${selectedAsistencia.almuerzo.inicio ? format(selectedAsistencia.almuerzo.inicio.toDate(), 'h:mm a') : '--'} - ${selectedAsistencia.almuerzo.fin ? format(selectedAsistencia.almuerzo.fin.toDate(), 'h:mm a') : 'En curso'}`}
                        </Text>
                      </View>
                    </View>
                  </View>
                )}

                <Divider style={{ marginVertical: 20, backgroundColor: surfaceColors.surfaceVariant }} />

                <View style={[styles.totalRow, { backgroundColor: surfaceColors.primaryContainer, borderRadius: 24, padding: 20, borderWidth: 1, borderColor: surfaceColors.primary + '30' }]}>
                  <MaterialCommunityIcons name="timer" size={40} color={surfaceColors.primary} />
                  <View style={styles.detailTextContainer}>
                    <Text variant="labelLarge" style={{ color: surfaceColors.onSurfaceVariant, letterSpacing: 0.8, fontWeight: '600', textTransform: 'uppercase' }}>TIEMPO TOTAL</Text>
                    <Text variant="headlineLarge" style={{ fontWeight: '600', color: surfaceColors.primary, marginTop: 4, letterSpacing: -0.5 }}>
                      {selectedAsistencia.horasTrabajadas || '--:--:--'}
                    </Text>
                  </View>
                </View>

              </ScrollView>
            )}
          </Surface>
        </View>
      </Modal>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  header: {
    paddingHorizontal: 20,  // âœ… Espaciado generoso (24â†’20)
    paddingTop: 24,
    paddingBottom: 16,
  },
  sheetContainer: {
    flex: 1,
    marginTop: 10,
    overflow: 'hidden',
  },
  listContent: {
    padding: 20,  // âœ… Espaciado generoso (16â†’20)
    paddingBottom: 100,
  },
  // âœ… Expressive Card (border radius 24px, elevation 0)
  expressiveCard: {
    borderRadius: 24,  // âœ… OrgÃ¡nico (16â†’24)
    padding: 20,  // âœ… Generoso (16â†’20)
    elevation: 0,  // âœ… Tonal elevation
  },
  cardHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 20,  // âœ… Espaciado generoso
  },
  userInfo: {
    flexDirection: 'row',
    alignItems: 'center',
    flex: 1,
  },
  statusChip: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 10,
    paddingVertical: 6,
    borderRadius: 16,  // âœ… OrgÃ¡nico
  },
  statsRow: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    alignItems: 'center',
    paddingTop: 12,
    borderTopWidth: 1,
    borderTopColor: 'rgba(0,0,0,0.06)',
  },
  statItem: {
    alignItems: 'center',
  },
  emptyState: {
    alignItems: 'center',
    justifyContent: 'center',
    marginTop: 80,
    paddingHorizontal: 40,
  },
  // Modal Styles (Expressive)
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.5)',
    justifyContent: 'flex-end',
  },
  modalContent: {
    borderTopLeftRadius: 32,  // âœ… OrgÃ¡nico (24â†’32)
    borderTopRightRadius: 32,
    maxHeight: '85%',
    paddingBottom: 30,
    elevation: 0,  // âœ… Tonal elevation
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 20,
    borderBottomWidth: 1,
  },
  modalBody: {
    padding: 20,
  },
  rowContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 16,
  },
  totalRow: {
    flexDirection: 'row',
    alignItems: 'center',
    elevation: 0,
  },
  detailTextContainer: {
    marginLeft: 16,
    flex: 1,
  },
  timeCard: {
    flex: 1,
    padding: 16,
    borderRadius: 20,  // âœ… OrgÃ¡nico (16â†’20)
    justifyContent: 'center',
    elevation: 0,
  },
  timeCardHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 4,
  },
  // âœ… Expressive Detail Card (border radius 24px, padding 20px)
  expressiveDetailCard: {
    borderRadius: 24,
    padding: 20,
    marginBottom: 20,
    elevation: 0,
  },
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\screens\auth\LoginScreen.js
========================================
import React, { useState, useEffect, useRef } from 'react';
import {
  View,
  StyleSheet,
  KeyboardAvoidingView,
  Platform,
  Alert,
  Animated,
  Dimensions
} from 'react-native';
import { Text, TextInput, Button, Surface, useTheme, Avatar } from 'react-native-paper';
import { useAuth } from '../../contexts/AuthContext';
import * as LocalAuthentication from 'expo-local-authentication';
import * as SecureStore from 'expo-secure-store';
import * as Haptics from 'expo-haptics';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useTheme as useAppTheme } from '../../contexts/ThemeContext'; // Renamed to avoid conflict

const { height } = Dimensions.get('window');

export default function LoginScreen() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [isBiometricSupported, setIsBiometricSupported] = useState(false);
  const [hasStoredCredentials, setHasStoredCredentials] = useState(false);
  const [secureTextEntry, setSecureTextEntry] = useState(true);

  const { signIn } = useAuth();
  const theme = useTheme(); // Material 3 Theme
  const { lastUserPhoto } = useAppTheme(); // Legacy context for photo
  
  // Animaciones
  const slideAnim = useRef(new Animated.Value(50)).current;
  const fadeAnim = useRef(new Animated.Value(0)).current;

  // âœ… Verificar soporte biomÃ©trico y credenciales guardadas
  useEffect(() => {
    (async () => {
      const compatible = await LocalAuthentication.hasHardwareAsync();
      const enrolled = await LocalAuthentication.isEnrolledAsync();
      setIsBiometricSupported(compatible && enrolled);

      const credentials = await SecureStore.getItemAsync('user_credentials');
      setHasStoredCredentials(!!credentials);
    })();

    // Iniciar animaciÃ³n de entrada
    Animated.parallel([
      Animated.spring(slideAnim, {
        toValue: 0,
        tension: 20,
        friction: 7,
        useNativeDriver: true,
      }),
      Animated.timing(fadeAnim, {
        toValue: 1,
        duration: 800,
        useNativeDriver: true,
      }),
    ]).start();
  }, []);

  const handleBiometricLogin = async () => {
    try {
      const result = await LocalAuthentication.authenticateAsync({
        promptMessage: 'AutenticaciÃ³n BiomÃ©trica',
        fallbackLabel: 'Usar contraseÃ±a',
      });

      if (result.success) {
        await Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
        setLoading(true);
        const credentialsJson = await SecureStore.getItemAsync('user_credentials');
        if (credentialsJson) {
          const { email: storedEmail, password: storedPassword } = JSON.parse(credentialsJson);
          await signIn(storedEmail, storedPassword);
        }
      } else {
        await Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error);
      }
    } catch (error) {
      console.error('Error biomÃ©trico:', error);
      Alert.alert('Error', 'FallÃ³ la autenticaciÃ³n biomÃ©trica');
    } finally {
      setLoading(false);
    }
  };

  const handleLogin = async () => {
    if (!email || !password) {
      await Haptics.notificationAsync(Haptics.NotificationFeedbackType.Warning);
      Alert.alert('Error', 'Por favor ingresa email y contraseÃ±a');
      return;
    }

    setLoading(true);
    try {
      await signIn(email, password);
      await Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
      
      // âœ… Preguntar si desea guardar credenciales para biometrÃ­a
      if (isBiometricSupported) {
        Alert.alert(
          'Habilitar BiometrÃ­a',
          'Â¿Deseas usar tu huella/rostro para iniciar sesiÃ³n la prÃ³xima vez?',
          [
            { text: 'No', style: 'cancel' },
            { 
              text: 'SÃ­', 
              onPress: async () => {
                await SecureStore.setItemAsync('user_credentials', JSON.stringify({ email, password }));
                Alert.alert('Ã‰xito', 'BiometrÃ­a habilitada');
              }
            }
          ]
        );
      }
    } catch (error) {
      await Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error);
      console.error('Error en login:', error);
      let errorMessage = 'Error al iniciar sesiÃ³n';
      
      if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
        errorMessage = 'Email o contraseÃ±a incorrectos';
      } else if (error.code === 'auth/invalid-email') {
        errorMessage = 'Email invÃ¡lido';
      } else if (error.code === 'auth/user-disabled') {
        errorMessage = 'Usuario deshabilitado';
      }
      
      Alert.alert('Error', errorMessage);
    } finally {
      setLoading(false);
    }
  };

  return (
    <SafeAreaView style={[styles.container, { backgroundColor: theme.colors.background }]}>
      <KeyboardAvoidingView
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        style={styles.keyboardView}
      >
        <View style={styles.content}>
          
          {/* Header Section */}
          <Animated.View style={[styles.headerContainer, { opacity: fadeAnim, transform: [{ translateY: slideAnim }] }]}>
            <View style={styles.logoWrapper}>
              {lastUserPhoto ? (
                <Avatar.Image 
                  size={100} 
                  source={{ uri: lastUserPhoto }} 
                  style={{ backgroundColor: theme.colors.primaryContainer }}
                />
              ) : (
                <Avatar.Text 
                  size={100} 
                  label="DR" 
                  style={{ backgroundColor: theme.colors.primary }}
                  color={theme.colors.onPrimary}
                  labelStyle={{ fontSize: 40, fontWeight: 'bold' }}
                />
              )}
            </View>
            
            <Text variant="displaySmall" style={[styles.title, { color: theme.colors.primary }]}>
              Bienvenido
            </Text>
            <Text variant="bodyLarge" style={[styles.subtitle, { color: theme.colors.secondary }]}>
              Dr Group Mobile
            </Text>
          </Animated.View>

          {/* Form Section */}
          <Animated.View 
            style={[
              styles.formContainer, 
              { 
                opacity: fadeAnim,
                transform: [{ translateY: slideAnim }] 
              }
            ]}
          >
            <TextInput
              label="Correo ElectrÃ³nico"
              value={email}
              onChangeText={setEmail}
              mode="outlined"
              keyboardType="email-address"
              autoCapitalize="none"
              style={styles.input}
              left={<TextInput.Icon icon="email" />}
              outlineStyle={{ borderRadius: 16 }}
            />

            <TextInput
              label="ContraseÃ±a"
              value={password}
              onChangeText={setPassword}
              mode="outlined"
              secureTextEntry={secureTextEntry}
              style={styles.input}
              left={<TextInput.Icon icon="lock" />}
              right={
                <TextInput.Icon 
                  icon={secureTextEntry ? "eye" : "eye-off"} 
                  onPress={() => setSecureTextEntry(!secureTextEntry)} 
                />
              }
              outlineStyle={{ borderRadius: 16 }}
            />

            <Button
              mode="contained"
              onPress={handleLogin}
              loading={loading}
              disabled={loading}
              style={styles.button}
              contentStyle={styles.buttonContent}
              labelStyle={styles.buttonLabel}
            >
              INICIAR JORNADA
            </Button>

            {/* Biometric Button */}
            {isBiometricSupported && hasStoredCredentials && (
              <Button
                mode="outlined"
                onPress={handleBiometricLogin}
                disabled={loading}
                style={styles.biometricButton}
                icon="fingerprint"
              >
                Ingresar con BiometrÃ­a
              </Button>
            )}

            <Surface style={[styles.infoBox, { backgroundColor: theme.colors.secondaryContainer }]} elevation={0}>
              <Text variant="bodySmall" style={{ color: theme.colors.onSecondaryContainer }}>
                â±ï¸ Al iniciar sesiÃ³n se registrarÃ¡ tu hora de entrada automÃ¡ticamente.
              </Text>
            </Surface>

          </Animated.View>
        </View>
      </KeyboardAvoidingView>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  keyboardView: {
    flex: 1,
  },
  content: {
    flex: 1,
    paddingHorizontal: 24,
    justifyContent: 'center',
  },
  headerContainer: {
    alignItems: 'center',
    marginBottom: 48,
  },
  logoWrapper: {
    marginBottom: 24,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.1,
    shadowRadius: 12,
    elevation: 8,
  },
  title: {
    fontWeight: 'bold',
    marginBottom: 8,
  },
  subtitle: {
    fontWeight: '500',
  },
  formContainer: {
    width: '100%',
  },
  input: {
    marginBottom: 16,
    backgroundColor: '#fff',
  },
  button: {
    marginTop: 8,
    borderRadius: 100, // Pill shape
    elevation: 4,
  },
  buttonContent: {
    height: 56,
  },
  buttonLabel: {
    fontSize: 16,
    fontWeight: 'bold',
    letterSpacing: 1,
  },
  biometricButton: {
    marginTop: 16,
    borderRadius: 100,
    borderColor: 'transparent',
  },
  infoBox: {
    marginTop: 32,
    padding: 16,
    borderRadius: 16,
    alignItems: 'center',
  },
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\screens\calendario\CalendarioScreen.js
========================================
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { 
  View, 
  FlatList, 
  StyleSheet, 
  RefreshControl, 
  TouchableOpacity, 
  Dimensions,
  Animated,
  Easing,
  Platform
} from 'react-native';
import { 
  Text, 
  useTheme as usePaperTheme, 
  Surface, 
  IconButton, 
  Chip 
} from 'react-native-paper';
import { MaterialIcons } from '@expo/vector-icons';
import { onSnapshot, query, collection } from 'firebase/firestore';
import { db } from '../../services/firebase';
import { useTheme } from '../../contexts/ThemeContext';
import { useColombianHolidays } from '../../hooks/useColombianHolidays';
import { SafeAreaView } from 'react-native-safe-area-context';
import { 
  esHabil, 
  calculateTenthBusinessDay, 
  calculateThirdBusinessDay 
} from '../../utils/dateUtils';
import { 
  format, 
  isSameDay, 
  isSameWeek, 
  isSameMonth, 
  addDays, 
  addWeeks, 
  addMonths, 
  subDays, 
  subWeeks, 
  subMonths,
  startOfWeek,
  endOfWeek,
  startOfMonth,
  endOfMonth,
  parseISO,
  isValid
} from 'date-fns';
import { es } from 'date-fns/locale';

const { width, height } = Dimensions.get('window');

// Componente renderizado fuera para evitar "Invalid hook call"
const EventoItem = ({ item, index, styles, theme }) => {
  const scaleAnim = useRef(new Animated.Value(0.9)).current;
  
  useEffect(() => {
    Animated.spring(scaleAnim, {
      toValue: 1,
      friction: 8,
      tension: 40,
      delay: index * 50,
      useNativeDriver: true,
    }).start();
  }, []);

  const getPriorityColor = (priority, type) => {
    if (type === 'holiday') return '#9c27b0'; // Morado para festivos
    if (type === 'system') return '#2196f3'; // Azul para sistema
    if (type === 'commitment') {
      if (priority === 'paid') return '#4caf50';
      if (priority === 'overdue') return '#f44336';
      return '#ff9800';
    }
    
    switch (priority) {
      case 'urgent': return '#ff4757';
      case 'high': return '#ffa502';
      case 'medium': return '#eccc68';
      case 'low': return '#2ed573';
      default: return '#a4b0be';
    }
  };

  const isValidDate = (d) => d instanceof Date && !isNaN(d);
  const safeDate = isValidDate(item.date) ? item.date : new Date();
  const priorityColor = getPriorityColor(item.priority, item.type);

  return (
    <Animated.View style={{ transform: [{ scale: scaleAnim }] }}>
      <Surface style={styles.card} elevation={1}>
        <View style={[styles.priorityStrip, { backgroundColor: priorityColor }]} />
        <View style={styles.cardContent}>
          <View style={styles.dateBox}>
            <Text variant="headlineMedium" style={{ fontWeight: 'bold', color: theme.colors.onSurface }}>
              {format(safeDate, 'dd')}
            </Text>
            <Text variant="labelSmall" style={{ color: theme.colors.onSurfaceVariant, textTransform: 'uppercase' }}>
              {format(safeDate, 'MMM', { locale: es })}
            </Text>
          </View>
          <View style={styles.eventInfo}>
            <Text variant="titleMedium" style={{ fontWeight: 'bold', marginBottom: 4 }}>
              {item.title}
            </Text>
            <Text variant="bodySmall" style={{ color: theme.colors.onSurfaceVariant, marginBottom: 4 }}>
              {item.allDay ? 'Todo el dÃ­a' : format(safeDate, 'h:mm a', { locale: es })} 
              {item.location ? ` â€¢ ${item.location}` : ''}
            </Text>
            
            {item.type === 'commitment' ? (
              <View style={{ marginTop: 4 }}>
                <Text variant="bodySmall" style={{ color: theme.colors.onSurfaceVariant }}>
                  ðŸ¢ {item.companyName || 'Sin empresa'}
                </Text>
                <Text variant="labelLarge" style={{ color: priorityColor, fontWeight: 'bold' }}>
                  {new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(item.amount || 0)}
                </Text>
              </View>
            ) : (
              item.description && (
                <Text variant="bodySmall" numberOfLines={2} style={{ color: theme.colors.outline }}>
                  {item.description}
                </Text>
              )
            )}
          </View>
        </View>
      </Surface>
    </Animated.View>
  );
};

export default function CalendarioScreen({ navigation }) {
  const paperTheme = usePaperTheme();
  const { getGradient, getPrimaryColor } = useTheme();
  const [allEventos, setAllEventos] = useState([]);
  const [filteredEventos, setFilteredEventos] = useState([]);
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  
  // Data Sources
  const [customEvents, setCustomEvents] = useState([]);
  const [commitments, setCommitments] = useState([]);
  const [companies, setCompanies] = useState([]);
  
  // View State
  const [viewMode, setViewMode] = useState('month'); // 'day', 'week', 'month'
  const [selectedDate, setSelectedDate] = useState(new Date());
  
  const holidays = useColombianHolidays(selectedDate.getFullYear());

  // Animations
  const slideAnim = useRef(new Animated.Value(height * 0.3)).current;
  const fadeAnim = useRef(new Animated.Value(0)).current;

  useEffect(() => {
    Animated.parallel([
      Animated.timing(slideAnim, {
        toValue: 0,
        duration: 800,
        useNativeDriver: true,
        easing: Easing.out(Easing.exp),
      }),
      Animated.timing(fadeAnim, {
        toValue: 1,
        duration: 800,
        useNativeDriver: true,
      }),
    ]).start();
  }, []);

  // 1. Fetch Custom Events
  useEffect(() => {
    const q = query(collection(db, 'calendar_events'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const events = snapshot.docs.map(doc => {
        const data = doc.data();
        let eventDate = new Date();
        if (data.date?.toDate) eventDate = data.date.toDate();
        else if (data.date instanceof Date) eventDate = data.date;
        else if (typeof data.date === 'string') eventDate = new Date(data.date);
        else if (data.date?.seconds) eventDate = new Date(data.date.seconds * 1000);

        return { id: doc.id, ...data, date: eventDate, type: 'custom' };
      });
      setCustomEvents(events);
    });
    return () => unsubscribe();
  }, []);

  // 2. Fetch Commitments
  useEffect(() => {
    const q = query(collection(db, 'commitments'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const comms = snapshot.docs.map(doc => {
        const data = doc.data();
        let dueDate = new Date();
        if (data.dueDate?.toDate) dueDate = data.dueDate.toDate();
        else if (typeof data.dueDate === 'string') dueDate = new Date(data.dueDate);
        
        return { id: doc.id, ...data, dueDate };
      });
      setCommitments(comms);
    });
    return () => unsubscribe();
  }, []);

  // 3. Fetch Companies (Contracts)
  useEffect(() => {
    const q = query(collection(db, 'companies'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const comps = snapshot.docs.map(doc => {
        const data = doc.data();
        return { id: doc.id, ...data };
      });
      setCompanies(comps);
    });
    return () => unsubscribe();
  }, []);

  // 4. Combine and Generate Events
  useEffect(() => {
    if (!holidays || !Array.isArray(holidays) || !holidays.length) return;

    const generatedEvents = [];
    const year = selectedDate.getFullYear();

    // --- A. Festivos ---
    holidays.forEach(h => {
      generatedEvents.push({
        id: `holiday-${h.date}`,
        title: `ðŸ‡¨ðŸ‡´ ${h.name}`,
        date: parseISO(h.date),
        allDay: true,
        type: 'holiday',
        priority: 'low',
        description: 'Festivo Nacional'
      });
    });

    // --- B. Eventos del Sistema (Coljuegos, UIAF, Parafiscales) ---
    // Generamos para todos los meses del aÃ±o actual para permitir navegaciÃ³n fluida
    for (let month = 0; month < 12; month++) {
      // 1. Coljuegos (10mo dÃ­a hÃ¡bil)
      const coljuegosDate = calculateTenthBusinessDay(year, month + 1, holidays);
      generatedEvents.push({
        id: `coljuegos-${year}-${month}`,
        title: 'ðŸŽ° Pago Coljuegos',
        date: coljuegosDate,
        allDay: true,
        type: 'system',
        priority: 'high',
        description: 'Vencimiento pago Derechos de ExplotaciÃ³n y Gastos de AdministraciÃ³n'
      });

      // 2. Parafiscales (3er dÃ­a hÃ¡bil)
      const parafiscalesDate = calculateThirdBusinessDay(year, month + 1, holidays);
      generatedEvents.push({
        id: `parafiscales-${year}-${month}`,
        title: 'ðŸ‘¥ Parafiscales',
        date: parafiscalesDate,
        allDay: true,
        type: 'system',
        priority: 'high',
        description: 'Pago seguridad social y parafiscales'
      });

      // 3. UIAF (DÃ­a 10 del mes)
      const uiafDate = new Date(year, month, 10);
      generatedEvents.push({
        id: `uiaf-${year}-${month}`,
        title: 'ðŸ‘® Reporte UIAF',
        date: uiafDate,
        allDay: true,
        type: 'system',
        priority: 'medium',
        description: 'Reporte SIREL'
      });
    }

    // --- C. Compromisos ---
    const commitmentEvents = commitments.map(comm => {
      const isPaid = comm.status === 'paid';
      const isOverdue = !isPaid && new Date(comm.dueDate) < new Date();
      
      // Formatear monto
      const formattedAmount = new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 0
      }).format(comm.amount || 0);

      return {
        id: `comm-${comm.id}`,
        title: comm.concept || 'Compromiso',
        date: comm.dueDate,
        allDay: true,
        type: 'commitment',
        priority: isPaid ? 'paid' : (isOverdue ? 'overdue' : 'pending'),
        description: `${comm.companyName || 'Sin empresa'}\n${formattedAmount}`,
        location: 'Finanzas',
        amount: comm.amount,
        companyName: comm.companyName
      };
    });

    // --- D. Contratos ---
    const contractEvents = companies
      .filter(c => c.contractExpirationDate)
      .map(comp => {
        let expDate;
        if (comp.contractExpirationDate?.toDate) expDate = comp.contractExpirationDate.toDate();
        else if (typeof comp.contractExpirationDate === 'string') expDate = new Date(comp.contractExpirationDate);
        
        if (!isValid(expDate)) return null;

        return {
          id: `contract-${comp.id}`,
          title: `ðŸ“„ Contrato ${comp.name}`,
          date: expDate,
          allDay: true,
          type: 'system',
          priority: 'urgent',
          description: 'Vencimiento de contrato'
        };
      })
      .filter(Boolean);

    // --- Merge All ---
    const finalEvents = [
      ...customEvents,
      ...generatedEvents,
      ...commitmentEvents,
      ...contractEvents
    ];

    // Sort by date
    finalEvents.sort((a, b) => a.date - b.date);

    setAllEventos(finalEvents);
    setLoading(false);

  }, [customEvents, commitments, companies, holidays, selectedDate]);

  // Filter events
  useEffect(() => {
    const filtered = allEventos.filter(event => {
      const eventDate = event.date;
      if (!isValid(eventDate)) return false;

      switch (viewMode) {
        case 'day':
          return isSameDay(eventDate, selectedDate);
        case 'week':
          return isSameWeek(eventDate, selectedDate, { weekStartsOn: 1 });
        case 'month':
          return isSameMonth(eventDate, selectedDate);
        default:
          return true;
      }
    });
    setFilteredEventos(filtered);
  }, [allEventos, viewMode, selectedDate]);

  const onRefresh = () => {
    setRefreshing(true);
    // Re-fetch logic is handled by onSnapshot automatically, just fake delay
    setTimeout(() => setRefreshing(false), 1000);
  };

  const handlePrev = () => {
    switch (viewMode) {
      case 'day': setSelectedDate(subDays(selectedDate, 1)); break;
      case 'week': setSelectedDate(subWeeks(selectedDate, 1)); break;
      case 'month': setSelectedDate(subMonths(selectedDate, 1)); break;
    }
  };

  const handleNext = () => {
    switch (viewMode) {
      case 'day': setSelectedDate(addDays(selectedDate, 1)); break;
      case 'week': setSelectedDate(addWeeks(selectedDate, 1)); break;
      case 'month': setSelectedDate(addMonths(selectedDate, 1)); break;
    }
  };

  const getDateLabel = () => {
    switch (viewMode) {
      case 'day':
        return format(selectedDate, "EEEE d 'de' MMMM", { locale: es });
      case 'week':
        const start = startOfWeek(selectedDate, { weekStartsOn: 1 });
        const end = endOfWeek(selectedDate, { weekStartsOn: 1 });
        return `${format(start, 'd MMM')} - ${format(end, 'd MMM', { locale: es })}`;
      case 'month':
        return format(selectedDate, 'MMMM yyyy', { locale: es });
      default:
        return '';
    }
  };

  const styles = createStyles(paperTheme);

  return (
    <SafeAreaView style={styles.container}>
      <View style={styles.header}>
        <Text variant="headlineMedium" style={{ fontWeight: 'bold', color: paperTheme.colors.primary }}>
          Calendario
        </Text>
        <IconButton icon="calendar-today" onPress={() => setSelectedDate(new Date())} />
      </View>

      {/* View Selector */}
      <View style={styles.viewSelectorContainer}>
        <View style={styles.viewSelector}>
          {['day', 'week', 'month'].map((mode) => (
            <TouchableOpacity
              key={mode}
              style={[
                styles.viewOption,
                viewMode === mode && { backgroundColor: paperTheme.colors.primaryContainer }
              ]}
              onPress={() => setViewMode(mode)}
            >
              <Text 
                style={[
                  styles.viewOptionText,
                  viewMode === mode && { color: paperTheme.colors.onPrimaryContainer, fontWeight: 'bold' }
                ]}
              >
                {mode === 'day' ? 'DÃ­a' : mode === 'week' ? 'Semana' : 'Mes'}
              </Text>
            </TouchableOpacity>
          ))}
        </View>
      </View>

      {/* Date Navigator */}
      <View style={styles.dateNavigator}>
        <IconButton icon="chevron-left" onPress={handlePrev} />
        <Text variant="titleLarge" style={{ fontWeight: 'bold', textTransform: 'capitalize' }}>
          {getDateLabel()}
        </Text>
        <IconButton icon="chevron-right" onPress={handleNext} />
      </View>

      <Animated.View style={[
        styles.sheetContainer,
        {
          transform: [{ translateY: slideAnim }],
          opacity: fadeAnim
        }
      ]}>
        <FlatList
          data={filteredEventos}
          renderItem={({ item, index }) => <EventoItem item={item} index={index} styles={styles} theme={paperTheme} />}
          keyExtractor={item => item.id}
          contentContainerStyle={styles.listContent}
          showsVerticalScrollIndicator={false}
          refreshControl={
            <RefreshControl
              refreshing={refreshing}
              onRefresh={onRefresh}
              colors={[getPrimaryColor()]}
              tintColor={getPrimaryColor()}
            />
          }
          ListEmptyComponent={
            !loading && (
              <View style={styles.emptyState}>
                <MaterialIcons name="event-busy" size={64} color={paperTheme.colors.outline} />
                <Text variant="bodyLarge" style={styles.emptyText}>No hay eventos para esta fecha</Text>
                <TouchableOpacity 
                  style={[styles.resetButton, { borderColor: getPrimaryColor() }]}
                  onPress={() => {
                    setViewMode('month');
                    setSelectedDate(new Date());
                  }}
                >
                  <Text style={[styles.resetText, { color: getPrimaryColor() }]}>
                    Ir a Hoy
                  </Text>
                </TouchableOpacity>
              </View>
            )
          }
        />
      </Animated.View>
    </SafeAreaView>
  );
}

const createStyles = (theme) => StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: theme.colors.background,
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingHorizontal: 20,
    paddingVertical: 16,
  },
  viewSelectorContainer: {
    paddingHorizontal: 20,
    marginBottom: 16,
  },
  viewSelector: {
    flexDirection: 'row',
    backgroundColor: theme.colors.surfaceVariant,
    borderRadius: 24,
    padding: 4,
  },
  viewOption: {
    flex: 1,
    paddingVertical: 8,
    alignItems: 'center',
    borderRadius: 20,
  },
  viewOptionText: {
    color: theme.colors.onSurfaceVariant,
    fontSize: 14,
  },
  dateNavigator: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingHorizontal: 10,
    marginBottom: 10,
  },
  sheetContainer: {
    flex: 1,
    backgroundColor: theme.colors.background,
  },
  listContent: {
    padding: 20,
    paddingBottom: 100,
  },
  card: {
    backgroundColor: theme.colors.surface,
    borderRadius: 16,
    marginBottom: 16,
    flexDirection: 'row',
    overflow: 'hidden',
  },
  priorityStrip: {
    width: 6,
    height: '100%',
  },
  cardContent: {
    flex: 1,
    padding: 16,
    flexDirection: 'row',
  },
  dateBox: {
    alignItems: 'center',
    justifyContent: 'center',
    paddingRight: 16,
    borderRightWidth: 1,
    borderRightColor: theme.colors.outlineVariant,
    marginRight: 16,
    minWidth: 60,
  },
  eventInfo: {
    flex: 1,
    justifyContent: 'center',
  },
  emptyState: {
    alignItems: 'center',
    justifyContent: 'center',
    paddingTop: 60,
  },
  emptyText: {
    color: theme.colors.outline,
    marginTop: 16,
    marginBottom: 24,
  },
  resetButton: {
    paddingHorizontal: 24,
    paddingVertical: 12,
    borderRadius: 24,
    borderWidth: 1,
  },
  resetText: {
    fontWeight: '600',
  },
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\screens\dashboard\DashboardScreen.js
========================================
import React, { useState, useEffect, useRef, useMemo } from 'react';
import {
  View,
  StyleSheet,
  ScrollView,
  Alert,
  RefreshControl,
  AppState,
  Dimensions
} from 'react-native';
import { 
  Text as PaperText, 
  Surface, 
  FAB, 
  Portal, 
  Modal, 
  useTheme as usePaperTheme, 
  Avatar, 
  Chip,
  Button,
  IconButton
} from 'react-native-paper';
import { useNavigation } from '@react-navigation/native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useAuth } from '../../contexts/AuthContext';
import { useNotifications } from '../../contexts/NotificationsContext';
import { useTheme } from '../../contexts/ThemeContext';
import RingChart from '../../components/RingChart';
import FloatingActionBar from '../../components/FloatingActionBar';
import NovedadesSheet from '../../components/NovedadesSheet';
import NovedadesScreen from '../novedades/NovedadesScreen'; // We will reuse logic but adapt UI later if needed

const { width } = Dimensions.get('window');

export default function DashboardScreen() {
  const navigation = useNavigation();
  const theme = usePaperTheme();
  const { isDarkMode, toggleDarkMode } = useTheme();
  const { 
    user, 
    userProfile, 
    activeSession, 
    iniciarJornada, 
    registrarBreak, 
    finalizarBreak, 
    registrarAlmuerzo, 
    finalizarAlmuerzo, 
    finalizarJornada,
    signOut
  } = useAuth();
  
  const [tiempoTrabajado, setTiempoTrabajado] = useState('00:00:00');
  const [progress, setProgress] = useState(0);
  const [refreshing, setRefreshing] = useState(false);
  const [novedadesVisible, setNovedadesVisible] = useState(false);

  // âœ… Memoizar funciÃ³n de formateo para evitar recrearla
  const formatMs = useMemo(() => (ms) => {
    const totalSeconds = Math.max(0, Math.floor(ms / 1000));
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }, []);

  // âœ… Timer Logic
  useEffect(() => {
    const updateTimer = () => {
      if (!activeSession || activeSession.estadoActual === 'finalizado') {
        setTiempoTrabajado('00:00:00');
        setProgress(0);
        return;
      }
      
      const ahora = new Date();

      // 1. Si estÃ¡ en BREAK
      if (activeSession.estadoActual === 'break') {
        const currentBreak = activeSession.breaks ? activeSession.breaks[activeSession.breaks.length - 1] : null;
        if (currentBreak && currentBreak.inicio) {
           const inicio = currentBreak.inicio.toDate ? currentBreak.inicio.toDate() : new Date(currentBreak.inicio);
           const diff = ahora - inicio;
           setTiempoTrabajado(formatMs(diff));
           // Progreso visual para break (ej. base 15 min)
           setProgress(Math.min(diff / (15 * 60 * 1000), 1)); 
        }
        return;
      }

      // 2. Si estÃ¡ en ALMUERZO
      if (activeSession.estadoActual === 'almuerzo') {
        if (activeSession.almuerzo && activeSession.almuerzo.inicio) {
           const inicio = activeSession.almuerzo.inicio.toDate ? activeSession.almuerzo.inicio.toDate() : new Date(activeSession.almuerzo.inicio);
           const diff = ahora - inicio;
           setTiempoTrabajado(formatMs(diff));
           // Progreso visual para almuerzo (ej. base 60 min)
           setProgress(Math.min(diff / (60 * 60 * 1000), 1));
        }
        return;
      }

      // 3. Si estÃ¡ TRABAJANDO (Calcula tiempo neto trabajado)
      const entrada = activeSession.entrada.hora.toDate ? activeSession.entrada.hora.toDate() : new Date(activeSession.entrada.hora);
      let tiempoTotalMs = ahora - entrada;
      
      // Restar breaks finalizados
      if (activeSession.breaks) {
        activeSession.breaks.forEach(b => {
          if (b.fin) {
            const inicio = b.inicio.toDate ? b.inicio.toDate() : new Date(b.inicio);
            const fin = b.fin.toDate ? b.fin.toDate() : new Date(b.fin);
            tiempoTotalMs -= (fin - inicio);
          }
        });
      }
      // Restar almuerzo finalizado
      if (activeSession.almuerzo?.fin) {
        const inicio = activeSession.almuerzo.inicio.toDate ? activeSession.almuerzo.inicio.toDate() : new Date(activeSession.almuerzo.inicio);
        const fin = activeSession.almuerzo.fin.toDate ? activeSession.almuerzo.fin.toDate() : new Date(activeSession.almuerzo.fin);
        tiempoTotalMs -= (fin - inicio);
      }

      setTiempoTrabajado(formatMs(tiempoTotalMs));
      
      // Calculate progress (Goal: 9 hours = 32400 seconds)
      const goalSeconds = 9 * 3600;
      const currentProgress = Math.min((tiempoTotalMs / 1000) / goalSeconds, 1);
      setProgress(currentProgress);
    };

    const interval = setInterval(updateTimer, 1000);
    updateTimer();
    return () => clearInterval(interval);
  }, [activeSession, formatMs]);

  const handleRefresh = async () => {
    setRefreshing(true);
    // Refresh logic
    setTimeout(() => setRefreshing(false), 1000);
  };

  return (
    <SafeAreaView style={[styles.container, { backgroundColor: theme.colors.background }]}>
      <ScrollView
        contentContainerStyle={styles.scrollContent}
        refreshControl={<RefreshControl refreshing={refreshing} onRefresh={handleRefresh} />}
      >
        {/* Header */}
        <View style={styles.header}>
          <View>
            <PaperText 
              variant="headlineLarge"
              style={{ 
                color: theme.colors.primary
              }}
            >
              Hola, {userProfile?.displayName?.split(' ')[0] || 'Usuario'}
            </PaperText>
            <PaperText 
              variant="bodyLarge"
              style={{ 
                color: theme.colors.secondary,
                marginTop: 4
              }}
            >
              {new Date().toLocaleDateString('es-CO', { weekday: 'long', day: 'numeric', month: 'long' })}
            </PaperText>
          </View>
          <View style={{ flexDirection: 'row', gap: 8 }}>
            <IconButton 
              icon={isDarkMode ? "white-balance-sunny" : "moon-waning-crescent"} 
              mode="contained-tonal"
              onPress={toggleDarkMode} 
            />
            <IconButton 
              icon="bell-outline" 
              mode="contained-tonal"
              onPress={() => navigation.navigate('Notifications')} 
            />
            {(userProfile?.role === 'ADMIN' || userProfile?.role === 'SUPER_ADMIN') && (
              <IconButton 
                icon="cog-outline" 
                mode="contained-tonal"
                onPress={() => navigation.navigate('AdminSettings')} 
              />
            )}
            <IconButton 
              icon="logout" 
              mode="contained-tonal"
              iconColor={theme.colors.error}
              onPress={() => {
                Alert.alert(
                  "Cerrar SesiÃ³n",
                  "Â¿EstÃ¡s seguro que deseas salir?",
                  [
                    { text: "Cancelar", style: "cancel" },
                    { text: "Salir", style: "destructive", onPress: () => signOut() }
                  ]
                );
              }} 
            />
          </View>
        </View>

        {/* Ring Chart Section */}
        <View style={styles.chartContainer}>
          <RingChart 
            progress={progress} 
            label={tiempoTrabajado}
            subLabel={activeSession?.estadoActual === 'trabajando' ? 'Tiempo Trabajado' : activeSession?.estadoActual?.toUpperCase() || 'INACTIVO'}
            status={activeSession?.estadoActual || 'idle'}
            color={
              activeSession?.estadoActual === 'break' ? theme.colors.tertiary :
              activeSession?.estadoActual === 'almuerzo' ? theme.colors.secondary :
              theme.colors.primary
            }
          />
        </View>

        {/* Quick Stats Row */}
        <View style={styles.statsRow}>
          <Surface style={[styles.statCard, { backgroundColor: theme.colors.surface }]} elevation={1}>
            <Avatar.Icon size={40} icon="clock-start" style={{ backgroundColor: theme.colors.primaryContainer }} color={theme.colors.primary} />
            <View style={styles.statText}>
              <PaperText variant="labelMedium" style={{ color: theme.colors.secondary }}>Entrada</PaperText>
              <PaperText variant="titleMedium" style={{ fontWeight: 'bold' }}>
                {activeSession?.entrada?.hora ? 
                  (activeSession.entrada.hora.toDate ? activeSession.entrada.hora.toDate() : new Date(activeSession.entrada.hora))
                  .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) 
                  : '--:--'}
              </PaperText>
            </View>
          </Surface>

          <Surface style={[styles.statCard, { backgroundColor: theme.colors.surface }]} elevation={1}>
            <Avatar.Icon size={40} icon="clock-end" style={{ backgroundColor: theme.colors.errorContainer }} color={theme.colors.error} />
            <View style={styles.statText}>
              <PaperText variant="labelMedium" style={{ color: theme.colors.secondary }}>Salida</PaperText>
              <PaperText variant="titleMedium" style={{ fontWeight: 'bold' }}>
                {activeSession?.salida?.hora ? 
                  (activeSession.salida.hora.toDate ? activeSession.salida.hora.toDate() : new Date(activeSession.salida.hora))
                  .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) 
                  : '--:--'}
              </PaperText>
            </View>
          </Surface>
        </View>

        {/* Novedades Button */}
        <Surface style={[styles.actionCard, { backgroundColor: theme.colors.secondaryContainer }]} elevation={0}>
          <View style={styles.actionContent}>
            <PaperText variant="titleMedium" style={{ fontWeight: 'bold', color: theme.colors.onSecondaryContainer }}>
              Â¿Alguna Novedad?
            </PaperText>
            <PaperText variant="bodyMedium" style={{ color: theme.colors.onSecondaryContainer }}>
              Reporta llegadas tarde, permisos o incapacidades.
            </PaperText>
          </View>
          <Button 
            mode="contained" 
            onPress={() => setNovedadesVisible(true)}
            style={{ borderRadius: 12 }}
          >
            Reportar
          </Button>
        </Surface>

      </ScrollView>

      {/* Floating Action Bar */}
      <FloatingActionBar
        status={activeSession?.estadoActual || 'off'}
        onPressStart={() => iniciarJornada()}
        onPressBreak={() => registrarBreak()}
        onPressLunch={() => registrarAlmuerzo()}
        onPressEnd={() => finalizarJornada()}
        onPressResume={() => {
          if (activeSession?.estadoActual === 'break') finalizarBreak();
          if (activeSession?.estadoActual === 'almuerzo') finalizarAlmuerzo();
        }}
        breaksCount={activeSession?.breaks ? activeSession.breaks.length : 0}
      />

      {/* Novedades Bottom Sheet Modal */}
      <Portal>
        <Modal
          visible={novedadesVisible}
          onDismiss={() => setNovedadesVisible(false)}
          contentContainerStyle={{ 
            position: 'absolute', 
            bottom: 0, 
            left: 0, 
            right: 0, 
          }}
        >
          <NovedadesSheet onClose={() => setNovedadesVisible(false)} />
        </Modal>
      </Portal>

    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  scrollContent: {
    padding: 24,
    paddingBottom: 100,
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 32,
  },
  chartContainer: {
    alignItems: 'center',
    marginBottom: 40,
  },
  statsRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 24,
    gap: 16,
  },
  statCard: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    padding: 16,
    borderRadius: 24,
    gap: 12,
  },
  statText: {
    flex: 1,
  },
  actionCard: {
    padding: 24,
    borderRadius: 24,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    gap: 16,
  },
  actionContent: {
    flex: 1,
  },
  fab: {
    paddingBottom: 90,
  },
  fabExtended: {
    position: 'absolute',
    margin: 16,
    right: 0,
    left: 0,
    bottom: 90, // Just above the bottom tab bar (80px height + padding)
    borderRadius: 100,
    justifyContent: 'center',
  },
  modalContent: {
    margin: 20,
    borderRadius: 28,
    padding: 20,
    height: '80%',
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 16,
  }
});



========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\screens\notifications\NotificationsScreen.js
========================================
import React from 'react';
import { View, StyleSheet, FlatList } from 'react-native';
import { Text, useTheme, Surface, Avatar, IconButton } from 'react-native-paper';
import { SafeAreaView } from 'react-native-safe-area-context';

export default function NotificationsScreen({ navigation }) {
  const theme = useTheme();

  // Mock data for now
  const notifications = [
    {
      id: '1',
      title: 'Bienvenido a la nueva App',
      message: 'Disfruta del nuevo diseÃ±o Material You.',
      time: 'Hace 5 min',
      icon: 'party-popper',
      color: theme.colors.primary
    },
    {
      id: '2',
      title: 'Recordatorio de Jornada',
      message: 'No olvides registrar tu salida hoy.',
      time: 'Hace 2 horas',
      icon: 'clock-outline',
      color: theme.colors.tertiary
    }
  ];

  const renderItem = ({ item }) => (
    <Surface style={styles.card} elevation={0}>
      <Avatar.Icon 
        size={48} 
        icon={item.icon} 
        style={{ backgroundColor: theme.colors.secondaryContainer }} 
        color={item.color}
      />
      <View style={styles.textContainer}>
        <Text variant="titleMedium" style={{ fontWeight: 'bold' }}>{item.title}</Text>
        <Text variant="bodyMedium" style={{ color: theme.colors.secondary }}>{item.message}</Text>
        <Text variant="labelSmall" style={{ color: theme.colors.outline, marginTop: 4 }}>{item.time}</Text>
      </View>
    </Surface>
  );

  return (
    <SafeAreaView style={[styles.container, { backgroundColor: theme.colors.background }]}>
      <View style={styles.header}>
        <IconButton icon="arrow-left" onPress={() => navigation.goBack()} />
        <Text variant="headlineSmall" style={{ fontWeight: 'bold', marginLeft: 8 }}>Notificaciones</Text>
      </View>

      <FlatList
        data={notifications}
        renderItem={renderItem}
        keyExtractor={item => item.id}
        contentContainerStyle={styles.list}
        ListEmptyComponent={
          <View style={styles.empty}>
            <Text variant="bodyLarge">No tienes notificaciones nuevas</Text>
          </View>
        }
      />
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 16,
  },
  list: {
    padding: 16,
  },
  card: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 16,
    marginBottom: 12,
    borderRadius: 16,
    backgroundColor: 'rgba(255, 255, 255, 0.5)', // Semi-transparent
  },
  textContainer: {
    flex: 1,
    marginLeft: 16,
  },
  empty: {
    alignItems: 'center',
    marginTop: 40,
  }
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\screens\novedades\NovedadesScreen.js
========================================
import React, { useState, useEffect } from 'react';
import {
  View,
  StyleSheet,
  ScrollView,
  Alert,
  KeyboardAvoidingView,
  Platform,
  FlatList,
  RefreshControl
} from 'react-native';
import { 
  Text, 
  Surface, 
  Button, 
  TextInput, 
  Chip, 
  useTheme, 
  Avatar, 
  SegmentedButtons, 
  Card, 
  IconButton, 
  ActivityIndicator,
  Divider,
  Badge
} from 'react-native-paper';
import { SafeAreaView } from 'react-native-safe-area-context';
import * as DocumentPicker from 'expo-document-picker';
import * as ImagePicker from 'expo-image-picker';
import { collection, addDoc, Timestamp, query, where, orderBy, onSnapshot, deleteDoc, doc, updateDoc } from 'firebase/firestore';
import { ref, uploadBytes, getDownloadURL, deleteObject } from 'firebase/storage';
import { db, storage } from '../../services/firebase';
import { useAuth } from '../../contexts/AuthContext';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';

export default function NovedadesScreen({ navigation, isModal = false, onClose }) {
  const { user, userProfile } = useAuth();
  const theme = useTheme();
  
  const dynamicStyles = {
    container: { backgroundColor: theme.colors.background },
    surface: { backgroundColor: theme.colors.surface },
    text: { color: theme.colors.onSurface },
    textSecondary: { color: theme.colors.onSurfaceVariant }
  };
  
  const [activeTab, setActiveTab] = useState('reportar'); // 'reportar' | 'historial'
  const [type, setType] = useState('llegada_tarde');
  const [description, setDescription] = useState('');
  const [attachment, setAttachment] = useState(null);
  const [loading, setLoading] = useState(false);
  
  // Edit states
  const [editingId, setEditingId] = useState(null);
  const [existingAttachment, setExistingAttachment] = useState(null);
  const [originalAttachment, setOriginalAttachment] = useState(null);
  
  // Historial states
  const [historial, setHistorial] = useState([]);
  const [loadingHistorial, setLoadingHistorial] = useState(true);

  const tiposNovedad = [
    { id: 'llegada_tarde', label: 'Llegada Tarde', icon: 'clock-alert-outline' },
    { id: 'olvido_salida', label: 'Olvido de Salida', icon: 'exit-run' },
    { id: 'urgencia_medica', label: 'Urgencia MÃ©dica', icon: 'hospital-box-outline' },
    { id: 'calamidad', label: 'Calamidad', icon: 'alert-circle-outline' },
    { id: 'otro', label: 'Otro', icon: 'pencil-outline' },
  ];

  useEffect(() => {
    if (activeTab === 'historial') {
      const q = query(
        collection(db, 'novedades'),
        where('uid', '==', user.uid),
        orderBy('date', 'desc')
      );

      const unsubscribe = onSnapshot(q, (snapshot) => {
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setHistorial(data);
        setLoadingHistorial(false);
      });

      return () => unsubscribe();
    }
  }, [activeTab, user.uid]);

  const pickDocument = async () => {
    try {
      const result = await DocumentPicker.getDocumentAsync({
        type: ['image/*', 'application/pdf'],
        copyToCacheDirectory: true,
      });

      if (result.assets && result.assets.length > 0) {
        setAttachment(result.assets[0]);
      }
    } catch (err) {
      console.error('Error picking document:', err);
      Alert.alert('Error', 'No se pudo seleccionar el archivo');
    }
  };

  const takePhoto = async () => {
    try {
      const { status } = await ImagePicker.requestCameraPermissionsAsync();
      if (status !== 'granted') {
        Alert.alert('Permiso denegado', 'Se necesita acceso a la cÃ¡mara para tomar fotos.');
        return;
      }

      const result = await ImagePicker.launchCameraAsync({
        mediaTypes: ImagePicker.MediaTypeOptions.Images,
        quality: 0.7,
        allowsEditing: false,
      });

      if (!result.canceled && result.assets && result.assets.length > 0) {
        const asset = result.assets[0];
        setAttachment({
          uri: asset.uri,
          name: asset.fileName || `foto_${Date.now()}.jpg`,
          mimeType: 'image/jpeg',
          size: asset.fileSize
        });
      }
    } catch (err) {
      console.error('Error taking photo:', err);
      Alert.alert('Error', 'No se pudo tomar la foto');
    }
  };

  const handleEdit = (item) => {
    setEditingId(item.id);
    setType(item.type);
    setDescription(item.description);
    if (item.attachmentUrl) {
      const att = { url: item.attachmentUrl, name: item.attachmentName };
      setExistingAttachment(att);
      setOriginalAttachment(att);
    } else {
      setExistingAttachment(null);
      setOriginalAttachment(null);
    }
    setAttachment(null);
    setActiveTab('reportar');
  };

  const cancelEdit = () => {
    setEditingId(null);
    setType('llegada_tarde');
    setDescription('');
    setAttachment(null);
    setExistingAttachment(null);
    setOriginalAttachment(null);
  };

  const handleDelete = (item) => {
    Alert.alert(
      'Eliminar Reporte',
      'Â¿EstÃ¡s seguro de que deseas eliminar este reporte? Esta acciÃ³n no se puede deshacer.',
      [
        { text: 'Cancelar', style: 'cancel' },
        { 
          text: 'Eliminar', 
          style: 'destructive',
          onPress: async () => {
            try {
              setLoading(true);
              // 1. Delete attachment if exists
              if (item.attachmentUrl) {
                try {
                  const fileRef = ref(storage, item.attachmentUrl);
                  await deleteObject(fileRef);
                } catch (e) {
                  console.warn('Error deleting file:', e);
                }
              }
              // 2. Delete document
              await deleteDoc(doc(db, 'novedades', item.id));
              // Alert.alert('Ã‰xito', 'Reporte eliminado correctamente'); // Removed to avoid double alert/interruption
            } catch (error) {
              console.error(error);
              Alert.alert('Error', 'No se pudo eliminar el reporte');
            } finally {
              setLoading(false);
            }
          }
        }
      ]
    );
  };

  const handleSubmit = async () => {
    if (!description.trim()) {
      Alert.alert('Error', 'Por favor describe la novedad');
      return;
    }

    // Validation for medical urgency
    if (type === 'urgencia_medica') {
      if (editingId && !attachment && !existingAttachment) {
        Alert.alert('Requerido', 'Para urgencias mÃ©dicas es obligatorio adjuntar la incapacidad o comprobante.');
        return;
      }
      if (!editingId && !attachment) {
        Alert.alert('Requerido', 'Para urgencias mÃ©dicas es obligatorio adjuntar la incapacidad o comprobante.');
        return;
      }
    }

    setLoading(true);
    try {
      let attachmentUrl = existingAttachment?.url || null;
      let attachmentName = existingAttachment?.name || null;

      // If new attachment is selected
      if (attachment) {
        const response = await fetch(attachment.uri);
        const blob = await response.blob();
        const filename = `novedades/${user.uid}/${Date.now()}_${attachment.name}`;
        const storageRef = ref(storage, filename);
        
        await uploadBytes(storageRef, blob);
        attachmentUrl = await getDownloadURL(storageRef);
        attachmentName = attachment.name;
      }

      // Handle deletion of old file if it was replaced or removed
      if (originalAttachment?.url && originalAttachment.url !== attachmentUrl) {
        try {
          const oldFileRef = ref(storage, originalAttachment.url);
          await deleteObject(oldFileRef);
        } catch (e) {
          console.warn('Error deleting old file:', e);
        }
      }

      const data = {
        uid: user.uid,
        userName: userProfile?.name || user.email,
        userEmail: user.email,
        type,
        description: description.trim(),
        attachmentUrl,
        attachmentName,
        ...(editingId ? { updatedAt: Timestamp.now() } : { date: Timestamp.now(), createdAt: Timestamp.now() }),
        status: 'pending'
      };

      if (editingId) {
        await updateDoc(doc(db, 'novedades', editingId), data);
        Alert.alert('Ã‰xito', 'Reporte actualizado correctamente', [
          { text: 'OK', onPress: () => {
            cancelEdit();
            setActiveTab('historial');
          }}
        ]);
      } else {
        await addDoc(collection(db, 'novedades'), data);
        Alert.alert('Ã‰xito', 'Novedad reportada correctamente', [
          { 
            text: 'Ver Historial', 
            onPress: () => {
              cancelEdit();
              setActiveTab('historial');
            } 
          }
        ]);
      }
    } catch (error) {
      console.error(error);
      Alert.alert('Error', `No se pudo ${editingId ? 'actualizar' : 'enviar'} el reporte`);
    } finally {
      setLoading(false);
    }
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'approved': return theme.colors.primary;
      case 'rejected': return theme.colors.error;
      default: return theme.colors.tertiary;
    }
  };

  const getStatusLabel = (status) => {
    switch (status) {
      case 'approved': return 'Aprobado';
      case 'rejected': return 'Rechazado';
      default: return 'Pendiente';
    }
  };

  const renderHistorialItem = ({ item }) => (
    <Card style={[styles.card, { backgroundColor: theme.colors.surface }]} mode="elevated">
      <Card.Title
        title={tiposNovedad.find(t => t.id === item.type)?.label || item.type}
        subtitle={format(item.date.toDate(), "d 'de' MMMM, yyyy - h:mm a", { locale: es })}
        left={(props) => <Avatar.Icon {...props} icon={tiposNovedad.find(t => t.id === item.type)?.icon || 'alert'} style={{ backgroundColor: theme.colors.secondaryContainer }} color={theme.colors.onSecondaryContainer} />}
        right={(props) => (
          <Chip 
            style={{ marginRight: 16, backgroundColor: getStatusColor(item.status) + '20' }} 
            textStyle={{ color: getStatusColor(item.status), fontSize: 12 }}
          >
            {getStatusLabel(item.status)}
          </Chip>
        )}
      />
      <Card.Content>
        <Text variant="bodyMedium" style={{ color: theme.colors.onSurfaceVariant, marginTop: 8 }}>
          {item.description}
        </Text>
        {item.attachmentUrl && (
          <View style={styles.attachmentBadge}>
            <IconButton icon="paperclip" size={16} />
            <Text variant="bodySmall" style={{ color: theme.colors.primary }}>Archivo adjunto</Text>
          </View>
        )}
        {item.adminResponse && (
          <Surface style={[styles.responseBox, { backgroundColor: theme.colors.surfaceVariant }]}>
            <Text variant="labelMedium" style={{ color: theme.colors.primary, fontWeight: 'bold' }}>Respuesta Admin:</Text>
            <Text variant="bodySmall">{item.adminResponse}</Text>
          </Surface>
        )}
      </Card.Content>
      {item.status === 'pending' && (
        <Card.Actions>
          <Button onPress={() => handleEdit(item)} textColor={theme.colors.primary}>Editar</Button>
          <Button onPress={() => handleDelete(item)} textColor={theme.colors.error}>Eliminar</Button>
        </Card.Actions>
      )}
    </Card>
  );

  return (
    <SafeAreaView style={[styles.container, { backgroundColor: theme.colors.background }]} edges={['top', 'left', 'right']}>
      {/* Header */}
      <View style={styles.header}>
        <View>
          <Text variant="headlineMedium" style={{ fontWeight: 'bold', color: theme.colors.primary }}>
            Novedades
          </Text>
          <Text variant="bodyLarge" style={{ color: theme.colors.secondary }}>
            Reporta incidencias laborales
          </Text>
        </View>
        {isModal && (
          <IconButton icon="close" onPress={onClose} />
        )}
      </View>

      {/* Tabs */}
      <View style={styles.tabContainer}>
        <SegmentedButtons
          value={activeTab}
          onValueChange={setActiveTab}
          buttons={[
            {
              value: 'reportar',
              label: 'Reportar',
              icon: 'pencil-plus',
            },
            {
              value: 'historial',
              label: 'Historial',
              icon: 'history',
            },
          ]}
        />
      </View>

      {activeTab === 'reportar' ? (
        <KeyboardAvoidingView 
          behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
          style={{ flex: 1 }}
        >
          <ScrollView contentContainerStyle={styles.formContent}>
            {editingId && (
              <Surface style={[styles.editBanner, { backgroundColor: theme.colors.tertiaryContainer }]}>
                <Text style={{ color: theme.colors.onTertiaryContainer }}>Editando reporte</Text>
                <IconButton icon="close" size={20} onPress={cancelEdit} />
              </Surface>
            )}

            <Text variant="titleMedium" style={styles.sectionTitle}>Tipo de Novedad</Text>
            <View style={styles.chipContainer}>
              {tiposNovedad.map((t) => (
                <Chip
                  key={t.id}
                  selected={type === t.id}
                  onPress={() => {
                    setType(t.id);
                    if (t.id === 'olvido_salida') {
                      setAttachment(null);
                      setExistingAttachment(null);
                    }
                  }}
                  showSelectedOverlay
                  style={styles.chip}
                  icon={t.icon}
                >
                  {t.label}
                </Chip>
              ))}
            </View>

            <Text variant="titleMedium" style={styles.sectionTitle}>DescripciÃ³n</Text>
            <TextInput
              mode="outlined"
              placeholder="Describe detalladamente lo sucedido..."
              multiline
              numberOfLines={4}
              value={description}
              onChangeText={setDescription}
              style={styles.input}
            />

            {type !== 'olvido_salida' && (
              <>
                <Text variant="titleMedium" style={styles.sectionTitle}>
                  {type === 'urgencia_medica' ? 'Adjuntar Incapacidad (Obligatorio)' : 'Adjuntar Evidencia'}
                </Text>
                <View style={styles.attachButtons}>
                  {type !== 'urgencia_medica' && (
                    <Button 
                      mode="outlined" 
                      icon="camera" 
                      onPress={takePhoto}
                      style={{ flex: 1 }}
                    >
                      CÃ¡mara
                    </Button>
                  )}
                  <Button 
                    mode="outlined" 
                    icon="file-document" 
                    onPress={pickDocument}
                    style={{ flex: 1 }}
                  >
                    {type === 'urgencia_medica' ? 'Subir Comprobante' : 'Archivo'}
                  </Button>
                </View>

                {(attachment || existingAttachment) && (
                  <Surface style={[styles.filePreview, { backgroundColor: theme.colors.secondaryContainer }]}>
                    <IconButton icon="file-check" />
                    <Text style={{ flex: 1, color: theme.colors.onSecondaryContainer }} numberOfLines={1}>
                      {attachment ? attachment.name : existingAttachment.name}
                    </Text>
                    <IconButton 
                      icon="close" 
                      onPress={() => {
                        setAttachment(null);
                        setExistingAttachment(null);
                      }} 
                    />
                  </Surface>
                )}
              </>
            )}

            <Button 
              mode="contained" 
              onPress={handleSubmit} 
              loading={loading}
              disabled={loading}
              style={styles.submitButton}
              contentStyle={{ height: 50 }}
            >
              {editingId ? 'Actualizar Reporte' : 'Enviar Reporte'}
            </Button>
            
            {editingId && (
               <Button onPress={cancelEdit} style={{ marginTop: 10 }}>Cancelar EdiciÃ³n</Button>
            )}
          </ScrollView>
        </KeyboardAvoidingView>
      ) : (
        <View style={{ flex: 1 }}>
          {loadingHistorial ? (
            <ActivityIndicator style={{ marginTop: 50 }} size="large" />
          ) : (
            <FlatList
              data={historial}
              renderItem={renderHistorialItem}
              keyExtractor={item => item.id}
              contentContainerStyle={styles.listContent}
              ListEmptyComponent={
                <View style={styles.emptyState}>
                  <Avatar.Icon size={80} icon="clipboard-text-outline" style={{ backgroundColor: theme.colors.surfaceVariant }} color={theme.colors.onSurfaceVariant} />
                  <Text variant="titleMedium" style={{ marginTop: 16, color: theme.colors.onSurfaceVariant }}>No hay reportes registrados</Text>
                </View>
              }
            />
          )}
        </View>
      )}
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  header: {
    padding: 24,
    paddingBottom: 16,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'flex-start',
  },
  tabContainer: {
    paddingHorizontal: 24,
    marginBottom: 16,
  },
  formContent: {
    padding: 24,
    paddingTop: 0,
    paddingBottom: 100,
  },
  sectionTitle: {
    marginTop: 16,
    marginBottom: 8,
    fontWeight: 'bold',
  },
  chipContainer: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: 8,
  },
  chip: {
    marginBottom: 4,
  },
  input: {
    backgroundColor: 'transparent',
  },
  attachButtons: {
    flexDirection: 'row',
    gap: 12,
    marginBottom: 16,
  },
  filePreview: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 8,
    borderRadius: 12,
    marginBottom: 24,
  },
  submitButton: {
    marginTop: 8,
    borderRadius: 12,
  },
  listContent: {
    padding: 20,
    paddingBottom: 100,
  },
  card: {
    marginBottom: 16,
    borderRadius: 16,
  },
  attachmentBadge: {
    flexDirection: 'row',
    alignItems: 'center',
    marginTop: 8,
  },
  responseBox: {
    marginTop: 12,
    padding: 12,
    borderRadius: 8,
  },
  emptyState: {
    alignItems: 'center',
    marginTop: 60,
  },
  editBanner: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    padding: 8,
    paddingHorizontal: 16,
    borderRadius: 8,
    marginBottom: 16,
  }
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\screens\reportes\ReportesScreen.js
========================================
import React, { useState, useEffect, useCallback } from 'react';
import {
  View,
  StyleSheet,
  ScrollView,
  RefreshControl,
  Dimensions,
  Pressable,
  Platform
} from 'react-native';
import { 
  Text, 
  Surface, 
  SegmentedButtons, 
  Card, 
  Avatar, 
  useTheme, 
  ActivityIndicator 
} from 'react-native-paper';
import { MaterialCommunityIcons } from '@expo/vector-icons';
import * as Haptics from 'expo-haptics';
import materialTheme from '../../../material-theme.json';
import { SafeAreaView } from 'react-native-safe-area-context';
import { BarChart } from 'react-native-chart-kit';
import { collection, query, getDocs, where, doc, getDoc } from 'firebase/firestore';
import { db } from '../../services/firebase';
import { useAuth } from '../../contexts/AuthContext';
import { format, startOfWeek, endOfWeek, startOfMonth, endOfMonth, startOfYear, endOfYear } from 'date-fns';
import { es } from 'date-fns/locale';

const { width } = Dimensions.get('window');

export default function ReportesScreen() {
  const { userProfile, user } = useAuth();
  const theme = useTheme();
  
  // âœ… Surface colors dinÃ¡micos (Material You Expressive)
  const surfaceColors = theme.dark 
    ? materialTheme.schemes.dark 
    : materialTheme.schemes.light;
  
  const dynamicStyles = {
    container: { backgroundColor: surfaceColors.surface },
    surfaceContainerLow: { backgroundColor: surfaceColors.surfaceContainerLow },
    surfaceContainer: { backgroundColor: surfaceColors.surfaceContainer },
    text: { color: surfaceColors.onSurface },
    textSecondary: { color: surfaceColors.onSurfaceVariant }
  };
  
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [rangoSeleccionado, setRangoSeleccionado] = useState('semana');
  const [stats, setStats] = useState({
    totalHoras: 0,
    diasTrabajados: 0,
    promedioDiario: 0,
    puntualidad: 100,
    chartData: [0, 0, 0, 0, 0, 0, 0],
    chartLabels: ['L', 'M', 'M', 'J', 'V', 'S', 'D']
  });

  const cargarDatos = useCallback(async () => {
    try {
      setLoading(true);
      const hoy = new Date();
      let fechaDesde, fechaHasta;
      
      if (rangoSeleccionado === 'semana') {
        fechaDesde = startOfWeek(hoy, { weekStartsOn: 1 });
        fechaHasta = endOfWeek(hoy, { weekStartsOn: 1 });
      } else if (rangoSeleccionado === 'mes') {
        fechaDesde = startOfMonth(hoy);
        fechaHasta = endOfMonth(hoy);
      } else {
        // AÃ±o actual
        fechaDesde = startOfYear(hoy);
        fechaHasta = endOfYear(hoy);
      }
      
      const fechaDesdeStr = format(fechaDesde, 'yyyy-MM-dd');
      const fechaHastaStr = format(fechaHasta, 'yyyy-MM-dd');
      
      let q = query(
        collection(db, 'asistencias'),
        where('fecha', '>=', fechaDesdeStr),
        where('fecha', '<=', fechaHastaStr)
      );

      // Si no es admin, solo ver sus propios datos
      if (userProfile?.role !== 'ADMIN' && userProfile?.role !== 'SUPER_ADMIN') {
        const targetUid = userProfile?.uid || user?.uid;
        if (!targetUid) {
          setLoading(false);
          return;
        }
        q = query(
          collection(db, 'asistencias'),
          where('uid', '==', targetUid),
          where('fecha', '>=', fechaDesdeStr),
          where('fecha', '<=', fechaHastaStr)
        );
      }
      
      const querySnapshot = await getDocs(q);
      const asistencias = querySnapshot.docs.map(doc => doc.data());
      
      // âœ… Filtrar dÃ­as Ãºnicos y vÃ¡lidos
      const fechasUnicas = new Set();
      const asistenciasValidas = asistencias.filter(a => {
        // Si tiene fecha y entrada, cuenta como dÃ­a asistido
        // Independientemente de si completÃ³ las horas o no
        if (a.fecha && a.entrada) {
          fechasUnicas.add(a.fecha);
          return true;
        }
        return false;
      });

      const diasReales = fechasUnicas.size;
      
      // Calcular mÃ©tricas
      let totalMinutos = 0;
      let onTimeCount = 0;
      let chartData = [];
      let chartLabels = [];
      
      if (rangoSeleccionado === 'semana') {
        chartLabels = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
        const days = new Array(7).fill(0);
        
        asistenciasValidas.forEach(a => {
          if (a.fecha) {
            const [year, month, day] = a.fecha.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const dayIndex = date.getDay(); 
            const index = dayIndex === 0 ? 6 : dayIndex - 1;
            
            if (a.horasTrabajadas) {
              const [h, m] = a.horasTrabajadas.split(':').map(Number);
              days[index] += h + (m / 60);
            }
          }
        });
        chartData = days.map(v => Number(v.toFixed(1)));
      } else if (rangoSeleccionado === 'mes') {
        chartLabels = ['S1', 'S2', 'S3', 'S4', 'S5'];
        const weeks = new Array(5).fill(0);
        
        asistenciasValidas.forEach(a => {
          if (a.fecha) {
            const [year, month, day] = a.fecha.split('-').map(Number);
            const weekIndex = Math.floor((day - 1) / 7);
            
            if (a.horasTrabajadas && weekIndex < 5) {
              const [h, m] = a.horasTrabajadas.split(':').map(Number);
              weeks[weekIndex] += h + (m / 60);
            }
          }
        });
        chartData = weeks.map(v => Number(v.toFixed(1)));
      } else {
        // Vista Anual
        chartLabels = ['E', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];
        const months = new Array(12).fill(0);
        
        asistenciasValidas.forEach(a => {
          if (a.fecha) {
            const [year, month, day] = a.fecha.split('-').map(Number);
            // month es 1-12, index es 0-11
            const monthIndex = month - 1;
            
            if (a.horasTrabajadas && monthIndex >= 0 && monthIndex < 12) {
              const [h, m] = a.horasTrabajadas.split(':').map(Number);
              months[monthIndex] += h + (m / 60);
            }
          }
        });
        chartData = months.map(v => Number(v.toFixed(1)));
      }

      // ConfiguraciÃ³n de jornada para puntualidad
      let workStartHour = 8;
      let workStartMinute = 0;
      let gracePeriod = 15;
      let workDays = [1, 2, 3, 4, 5];

      try {
        const settingsDoc = await getDoc(doc(db, 'settings', 'work_schedule'));
        if (settingsDoc.exists()) {
          const data = settingsDoc.data();
          if (data.startTime) {
            const [h, m] = data.startTime.split(':').map(Number);
            workStartHour = h;
            workStartMinute = m;
          }
          if (data.gracePeriod !== undefined) gracePeriod = Number(data.gracePeriod);
          if (data.workDays) workDays = data.workDays;
        }
      } catch (e) {
        console.log('Usando configuraciÃ³n por defecto');
      }

      let punctualityBaseCount = 0;

      asistenciasValidas.forEach(a => {
        if (a.horasTrabajadas) {
          const [h, m] = a.horasTrabajadas.split(':').map(Number);
          totalMinutos += (h * 60) + m;
        }
        
        if (a.entrada?.hora) {
          const date = a.entrada.hora.toDate ? a.entrada.hora.toDate() : new Date(a.entrada.hora);
          const dayOfWeek = date.getDay();
          
          if (workDays.includes(dayOfWeek)) {
            punctualityBaseCount++;
            const hour = date.getHours();
            const minute = date.getMinutes();
            const entryTime = hour * 60 + minute;
            const limitTime = workStartHour * 60 + workStartMinute + gracePeriod;

            if (entryTime <= limitTime) {
              onTimeCount++;
            }
          }
        }
      });

      setStats({
        totalHoras: Math.floor(totalMinutos / 60),
        diasTrabajados: diasReales,
        promedioDiario: diasReales ? (totalMinutos / diasReales / 60).toFixed(1) : 0,
        puntualidad: punctualityBaseCount > 0 ? Math.round((onTimeCount / punctualityBaseCount) * 100) : 100,
        chartData,
        chartLabels
      });
      
    } catch (err) {
      console.error(err);
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  }, [rangoSeleccionado, userProfile, user]);

  useEffect(() => {
    if (userProfile) {
      cargarDatos();
    }
  }, [cargarDatos, userProfile]);

  const onRefresh = () => {
    setRefreshing(true);
    cargarDatos();
  };

  const StatCard = ({ title, value, subtitle, icon, color }) => (
    <Pressable
      onPress={() => Haptics.selectionAsync()}
      android_ripple={{ color: surfaceColors.primary + '1F' }}
      style={({ pressed }) => [
        styles.statCard,
        {
          backgroundColor: pressed 
            ? surfaceColors.surfaceContainer
            : surfaceColors.surfaceContainerLow,
          borderWidth: 1,
          borderColor: color + '20'
        }
      ]}
    >
      <View style={[styles.iconContainer, { backgroundColor: color + '15' }]}>
        <MaterialCommunityIcons name={icon} size={28} color={color} />
      </View>
      <View style={styles.statContent}>
        <Text variant="headlineMedium" style={{ fontWeight: '600', color: surfaceColors.onSurface, letterSpacing: -0.5 }}>{value}</Text>
        <Text variant="bodyMedium" style={{ color: surfaceColors.onSurfaceVariant, fontWeight: '500', marginTop: 4 }}>{title}</Text>
        {subtitle && <Text variant="labelSmall" style={{ color: surfaceColors.onSurfaceVariant, textTransform: 'uppercase', letterSpacing: 0.8, marginTop: 2 }}>{subtitle}</Text>}
      </View>
    </Pressable>
  );

  return (
    <SafeAreaView style={[styles.container, { backgroundColor: theme.colors.background }]} edges={['top', 'left', 'right']}>
      <ScrollView
        contentContainerStyle={styles.scrollContent}
        refreshControl={
          <RefreshControl refreshing={refreshing} onRefresh={onRefresh} colors={[theme.colors.primary]} />
        }
      >
        {/* Header */}
        <View style={styles.header}>
          <Text variant="headlineLarge" style={{ fontWeight: '600', color: surfaceColors.primary, letterSpacing: -0.5 }}>
            EstadÃ­sticas
          </Text>
          <Text variant="bodyLarge" style={{ color: surfaceColors.onSurfaceVariant, marginTop: 4 }}>
            Tu desempeÃ±o laboral
          </Text>
        </View>

        {/* Filters */}
        <View style={styles.filterContainer}>
          <SegmentedButtons
            value={rangoSeleccionado}
            onValueChange={setRangoSeleccionado}
            buttons={[
              { value: 'semana', label: 'Semana', icon: 'calendar-week' },
              { value: 'mes', label: 'Mes', icon: 'calendar-month' },
              { value: 'anio', label: 'AÃ±o', icon: 'calendar-today' },
            ]}
          />
        </View>

        {loading ? (
          <ActivityIndicator style={{ marginTop: 50 }} size="large" />
        ) : (
          <>
            {/* Chart */}
            <View style={[styles.chartCard, { backgroundColor: surfaceColors.surfaceContainerLow, borderWidth: 1, borderColor: surfaceColors.primary + '20' }]}>
              <View style={{ padding: 20 }}>
                <Text variant="titleLarge" style={{ marginBottom: 20, fontWeight: '600', color: surfaceColors.onSurface, letterSpacing: -0.25 }}>
                  Horas Trabajadas
                </Text>
                <BarChart
                  data={{
                    labels: stats.chartLabels,
                    datasets: [{ data: stats.chartData }]
                  }}
                  width={width - 80}
                  height={220}
                  yAxisLabel=""
                  yAxisSuffix="h"
                  chartConfig={{
                    backgroundColor: surfaceColors.surfaceContainerLow,
                    backgroundGradientFrom: surfaceColors.surfaceContainerLow,
                    backgroundGradientTo: surfaceColors.surfaceContainerLow,
                    decimalPlaces: 1,
                    color: (opacity = 1) => `rgba(${parseInt(surfaceColors.primary.slice(1,3), 16)}, ${parseInt(surfaceColors.primary.slice(3,5), 16)}, ${parseInt(surfaceColors.primary.slice(5,7), 16)}, ${opacity})`,
                    labelColor: (opacity = 1) => surfaceColors.onSurfaceVariant,
                    barPercentage: 0.7,
                    propsForBackgroundLines: {
                      strokeDasharray: '', // solid lines
                      stroke: surfaceColors.surfaceVariant
                    }
                  }}
                  style={{
                    borderRadius: 20,
                    paddingRight: 40
                  }}
                  showValuesOnTopOfBars
                />
              </View>
            </View>

            {/* Stats Grid */}
            <View style={styles.statsGrid}>
              <StatCard 
                title="Total Horas" 
                value={stats.totalHoras} 
                subtitle="Acumulado"
                icon="clock" 
                color={surfaceColors.primary} 
              />
              <StatCard 
                title="DÃ­as" 
                value={stats.diasTrabajados} 
                subtitle="Trabajados"
                icon="calendar-check" 
                color={surfaceColors.secondary} 
              />
              <StatCard 
                title="Promedio" 
                value={`${stats.promedioDiario}h`} 
                subtitle="Diario"
                icon="chart-line" 
                color={surfaceColors.tertiary} 
              />
              <StatCard 
                title="Puntualidad" 
                value={`${stats.puntualidad}%`} 
                subtitle="Llegadas a tiempo"
                icon="star" 
                color={stats.puntualidad > 90 ? surfaceColors.primary : surfaceColors.error} 
              />
            </View>
          </>
        )}
      </ScrollView>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  scrollContent: {
    padding: 20,  // âœ… Espaciado generoso (24â†’20)
    paddingBottom: 100,
  },
  header: {
    marginBottom: 24,
  },
  filterContainer: {
    marginBottom: 24,
  },
  chartCard: {
    marginBottom: 24,
    borderRadius: 24,  // âœ… OrgÃ¡nico
    elevation: 0,  // âœ… Tonal Elevation
    overflow: 'hidden',
  },
  statsGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: 16,
  },
  statCard: {
    width: (width - 40 - 16) / 2,  // âœ… Ajustado para padding 20
    padding: 20,  // âœ… Espaciado generoso (16â†’20)
    borderRadius: 24,  // âœ… OrgÃ¡nico (20â†’24)
    alignItems: 'flex-start',
    elevation: 0,  // âœ… Tonal Elevation
  },
  iconContainer: {
    width: 56,  // âœ… TamaÃ±o fijo para consistencia
    height: 56,
    borderRadius: 28,  // âœ… CÃ­rculo perfecto
    marginBottom: 16,  // âœ… Espaciado generoso (12â†’16)
    alignItems: 'center',
    justifyContent: 'center',
  },
  statContent: {
    alignItems: 'flex-start',
  }
});


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\services\firebase.js
========================================
import { initializeApp } from 'firebase/app';
import { getAuth, initializeAuth, getReactNativePersistence } from 'firebase/auth';
import { getFirestore } from 'firebase/firestore';
import { getStorage } from 'firebase/storage';
import AsyncStorage from '@react-native-async-storage/async-storage';

// Firebase configuration - Mismo proyecto que el dashboard web
const firebaseConfig = {
  apiKey: "AIzaSyDpjCcOe4CRvAdeClCskt0-jLQeXGf62tY",
  authDomain: "dr-group-cd21b.firebaseapp.com",
  projectId: "dr-group-cd21b",
  storageBucket: "dr-group-cd21b.firebasestorage.app",
  messagingSenderId: "629470690851",
  appId: "1:629470690851:web:cbda5f4b29c0a93bb17e97",
  databaseURL: "https://dr-group-cd21b-default-rtdb.firebaseio.com"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

// Initialize Firebase Auth with AsyncStorage persistence for React Native
const auth = initializeAuth(app, {
  persistence: getReactNativePersistence(AsyncStorage)
});

// Initialize Firestore
const db = getFirestore(app);

// Initialize Storage
const storage = getStorage(app);

export { auth, db, storage };
export default app;


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\services\NotificationService.js
========================================
import * as Notifications from 'expo-notifications';
import { Platform } from 'react-native';

// ConfiguraciÃ³n global de cÃ³mo se muestran las notificaciones
Notifications.setNotificationHandler({
  handleNotification: async () => ({
    shouldShowAlert: true,
    shouldPlaySound: true,
    shouldSetBadge: true,
  }),
});

class NotificationService {
  /**
   * Solicita permisos de notificaciones al usuario
   * @returns {Promise<boolean>} true si se otorgaron permisos
   */
  async requestPermissions() {
    try {
      const { status: existingStatus } = await Notifications.getPermissionsAsync();
      let finalStatus = existingStatus;

      if (existingStatus !== 'granted') {
        const { status } = await Notifications.requestPermissionsAsync();
        finalStatus = status;
      }

      if (finalStatus !== 'granted') {
        console.warn('No se otorgaron permisos de notificaciÃ³n');
        return false;
      }

      // Configurar canal de notificaciones para Android
      if (Platform.OS === 'android') {
        await Notifications.setNotificationChannelAsync('default', {
          name: 'Default',
          importance: Notifications.AndroidImportance.MAX,
          vibrationPattern: [0, 250, 250, 250],
          lightColor: '#6366F1',
        });
      }

      return true;
    } catch (error) {
      console.error('Error requesting notification permissions:', error);
      return false;
    }
  }

  /**
   * Programa una notificaciÃ³n local
   * @param {Object} options - Opciones de la notificaciÃ³n
   * @param {string} options.title - TÃ­tulo de la notificaciÃ³n
   * @param {string} options.body - Cuerpo de la notificaciÃ³n
   * @param {number} options.seconds - Segundos hasta que se muestre (opcional)
   * @param {Object} options.data - Datos adicionales (opcional)
   * @returns {Promise<string>} ID de la notificaciÃ³n programada
   */
  async scheduleNotification({ title, body, seconds = 0, data = {} }) {
    try {
      const id = await Notifications.scheduleNotificationAsync({
        content: {
          title,
          body,
          data,
          sound: true,
        },
        trigger: seconds > 0 ? { seconds } : null,
      });
      return id;
    } catch (error) {
      console.error('Error scheduling notification:', error);
      return null;
    }
  }

  /**
   * Cancela una notificaciÃ³n programada
   * @param {string} notificationId - ID de la notificaciÃ³n a cancelar
   */
  async cancelNotification(notificationId) {
    try {
      await Notifications.cancelScheduledNotificationAsync(notificationId);
    } catch (error) {
      console.error('Error canceling notification:', error);
    }
  }

  /**
   * Cancela todas las notificaciones programadas
   */
  async cancelAllNotifications() {
    try {
      await Notifications.cancelAllScheduledNotificationsAsync();
    } catch (error) {
      console.error('Error canceling all notifications:', error);
    }
  }

  /**
   * Notifica al usuario cuando debe finalizar su jornada
   * @param {number} horasMeta - Horas de meta de trabajo (default 9)
   */
  async notifyWorkDayComplete(horasMeta = 9) {
    const horasEnSegundos = horasMeta * 3600;
    return this.scheduleNotification({
      title: 'ðŸŽ‰ Â¡Meta Cumplida!',
      body: `Has completado ${horasMeta} horas de trabajo. Â¡Finaliza tu jornada!`,
      seconds: horasEnSegundos,
      data: { type: 'work_goal_reached' },
    });
  }

  /**
   * Notifica al usuario que su break es muy largo
   * @param {number} minutos - Minutos de break (default 15)
   */
  async notifyLongBreak(minutos = 15) {
    return this.scheduleNotification({
      title: 'â° Break Extendido',
      body: `Llevas ${minutos} minutos en break. Â¿Olvidaste reanudar?`,
      seconds: minutos * 60,
      data: { type: 'long_break' },
    });
  }

  /**
   * Notifica al usuario sobre una novedad aprobada
   * @param {string} tipo - Tipo de novedad
   */
  async notifyNovedadApproved(tipo) {
    return this.scheduleNotification({
      title: 'âœ… Solicitud Aprobada',
      body: `Tu solicitud de ${tipo.replace('_', ' ')} ha sido aprobada.`,
      data: { type: 'novedad_approved' },
    });
  }

  /**
   * Notifica al usuario sobre una novedad rechazada
   * @param {string} tipo - Tipo de novedad
   * @param {string} razon - RazÃ³n del rechazo (opcional)
   */
  async notifyNovedadRejected(tipo, razon = '') {
    return this.scheduleNotification({
      title: 'âŒ Solicitud Rechazada',
      body: razon || `Tu solicitud de ${tipo.replace('_', ' ')} fue rechazada. Contacta a tu supervisor.`,
      data: { type: 'novedad_rejected' },
    });
  }

  /**
   * Recordatorio para iniciar jornada (si no ha iniciado a cierta hora)
   * @param {number} hora - Hora del dÃ­a (0-23)
   */
  async notifyStartWorkReminder(hora = 8) {
    const now = new Date();
    const target = new Date(now);
    target.setHours(hora, 0, 0, 0);
    
    if (target < now) {
      target.setDate(target.getDate() + 1); // Si ya pasÃ³ la hora, programar para maÃ±ana
    }

    const diffSeconds = Math.floor((target - now) / 1000);

    return this.scheduleNotification({
      title: 'ðŸ‘‹ Hora de Trabajar',
      body: 'No olvides iniciar tu jornada laboral',
      seconds: diffSeconds,
      data: { type: 'work_reminder' },
    });
  }

  /**
   * Notifica al admin sobre una nueva novedad reportada
   * @param {string} empleado - Nombre del empleado
   * @param {string} tipo - Tipo de novedad
   */
  async notifyAdminNewNovedad(empleado, tipo) {
    return this.scheduleNotification({
      title: 'ðŸ“ Nueva Solicitud',
      body: `${empleado} reportÃ³: ${tipo.replace('_', ' ')}`,
      data: { type: 'admin_new_novedad' },
    });
  }
}

export default new NotificationService();


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\services\UpdateService.js
========================================
import * as Updates from 'expo-updates';
import { Alert } from 'react-native';

export const checkForUpdates = async (silent = true) => {
  if (__DEV__) {
    if (!silent) {
      Alert.alert('Modo Desarrollo', 'Las actualizaciones OTA no funcionan en modo desarrollo.');
    }
    return;
  }

  try {
    const update = await Updates.checkForUpdateAsync();

    if (update.isAvailable) {
      if (!silent) {
        Alert.alert(
          'ActualizaciÃ³n Disponible',
          'Descargando nueva versiÃ³n...',
          [{ text: 'OK' }]
        );
      }
      
      await Updates.fetchUpdateAsync();
      
      Alert.alert(
        'ActualizaciÃ³n Lista',
        'La aplicaciÃ³n se reiniciarÃ¡ para aplicar los cambios.',
        [
          {
            text: 'Reiniciar ahora',
            onPress: async () => {
              await Updates.reloadAsync();
            },
          },
        ]
      );
    } else {
      if (!silent) {
        Alert.alert('Actualizado', 'Ya tienes la Ãºltima versiÃ³n disponible.');
      }
    }
  } catch (error) {
    console.log('Error verificando actualizaciones:', error);
    if (!silent) {
      Alert.alert('Error', 'No se pudo verificar actualizaciones: ' + error.message);
    }
  }
};


========================================
FILE: C:\Users\darg1\Desktop\Dr-Group\mobile\src\utils\dateUtils.js
========================================
import { addDays, getDay, parseISO } from 'date-fns';

/**
 * FunciÃ³n para verificar si un dÃ­a es hÃ¡bil (no fin de semana ni festivo)
 */
export const esHabil = (fecha, holidays = []) => {
  const dayOfWeek = getDay(fecha);
  const isWeekendDay = dayOfWeek === 0 || dayOfWeek === 6; // 0 = domingo, 6 = sÃ¡bado
  
  // Verificar si es festivo
  const fechaNormalizada = new Date(fecha);
  fechaNormalizada.setHours(0, 0, 0, 0);
  const fechaISO = fechaNormalizada.toISOString().split('T')[0];
  const isHoliday = Array.isArray(holidays) && holidays.some(holiday => holiday.date === fechaISO);
  
  return !isWeekendDay && !isHoliday;
};

/**
 * FunciÃ³n para sumar dÃ­as hÃ¡biles desde una fecha base
 * Empieza a contar desde el dÃ­a SIGUIENTE a la fecha base
 */
export const sumarDiasHabiles = (fechaBase, diasAsumar, holidays) => {
  let fecha = addDays(new Date(fechaBase), 1); // Empezar desde el dÃ­a siguiente
  let contador = 0;
  
  while (contador < diasAsumar) {
    if (esHabil(fecha, holidays)) {
      contador++;
    }
    if (contador < diasAsumar) {
      fecha = addDays(fecha, 1);
    }
  }
  
  return fecha;
};

/**
 * Calcula el dÃ©cimo dÃ­a hÃ¡bil de un mes especÃ­fico
 * excluyendo fines de semana y festivos colombianos
 */
export const calculateTenthBusinessDay = (year, month, holidays) => {
  // Obtener el Ãºltimo dÃ­a del mes anterior como base
  // month es 1-based (1=Enero), asÃ­ que month-1 es el Ã­ndice 0-based del mes actual.
  // new Date(year, monthIndex, 0) da el Ãºltimo dÃ­a del mes ANTERIOR a monthIndex.
  // Si queremos el Ãºltimo dÃ­a del mes anterior a "month", usamos new Date(year, month-1, 0).
  const fechaBase = new Date(year, month - 1, 0); 
  
  // Sumar 10 dÃ­as hÃ¡biles desde la fecha base
  const result = sumarDiasHabiles(fechaBase, 10, holidays);
  
  return result;
};

/**
 * Calcula el tercer dÃ­a hÃ¡bil de un mes especÃ­fico
 * excluyendo fines de semana y festivos colombianos
 */
export const calculateThirdBusinessDay = (year, month, holidays) => {
  // Obtener el Ãºltimo dÃ­a del mes anterior como base
  const fechaBase = new Date(year, month - 1, 0); 
  
  // Sumar 3 dÃ­as hÃ¡biles desde la fecha base
  const result = sumarDiasHabiles(fechaBase, 3, holidays);
  
  return result;
};
